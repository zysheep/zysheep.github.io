<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Flask学习 | 三月三</title><meta name="description" content="#Flask概述 Flask 是一个微型的 Python 开发的 Web框架，基于Werkzeug WSGI工具箱和Jinja2 模板引擎。 Flask使用BSD授权。 Flask也被称为“microframework”，因为它使用简单的核心，用extension增加其他功能。Flask没有默认使用的数据库、窗体验证工具。然而，Flask保留了扩增的弹性，可以用Flask-extension加入这"><meta name="keywords" content="Python,Flask"><meta name="author" content="三月三"><meta name="copyright" content="三月三"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="http://cdn.panyucable.cn/zysheep/ico.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Flask学习"><meta name="twitter:description" content="#Flask概述 Flask 是一个微型的 Python 开发的 Web框架，基于Werkzeug WSGI工具箱和Jinja2 模板引擎。 Flask使用BSD授权。 Flask也被称为“microframework”，因为它使用简单的核心，用extension增加其他功能。Flask没有默认使用的数据库、窗体验证工具。然而，Flask保留了扩增的弹性，可以用Flask-extension加入这"><meta name="twitter:image" content="http://cdn.panyucable.cn/zysheep/flask_cover1.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Flask学习"><meta property="og:url" content="https://zysheep.cn/2020/04/06/Python/%E5%AD%A6%E4%B9%A0Flask/"><meta property="og:site_name" content="三月三"><meta property="og:description" content="#Flask概述 Flask 是一个微型的 Python 开发的 Web框架，基于Werkzeug WSGI工具箱和Jinja2 模板引擎。 Flask使用BSD授权。 Flask也被称为“microframework”，因为它使用简单的核心，用extension增加其他功能。Flask没有默认使用的数据库、窗体验证工具。然而，Flask保留了扩增的弹性，可以用Flask-extension加入这"><meta property="og:image" content="http://cdn.panyucable.cn/zysheep/flask_cover1.jpg"><meta property="article:published_time" content="2020-04-06T04:30:45.000Z"><meta property="article:modified_time" content="2020-08-18T08:44:46.588Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://zysheep.cn/2020/04/06/Python/%E5%AD%A6%E4%B9%A0Flask/"><link rel="prev" title="Android开发环境搭建" href="https://zysheep.cn/2020/04/07/Android/Android%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><link rel="next" title="TinyMCE富文本" href="https://zysheep.cn/2020/04/06/Python/TinyMCE%E5%AF%8C%E6%96%87%E6%9C%AC/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7f671f0f6d996680d21d5c32a23a9313";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://zysheep.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: false,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/hideCategory.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="http://cdn.panyucable.cn/zysheep/xiaoman.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">217</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">49</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">70</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bug" aria-hidden="true"></i><span> 编程路线</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/java/"><i class="fa-fw fa fa-coffee"></i><span> Java</span></a></li><li><a class="site-page" href="/python/"><i class="fa-fw fa fa-binoculars"></i><span> Python</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder-open" aria-hidden="true"></i><span> 面试宝典</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/interview/"><i class="fa-fw fa fa-file-text-o"></i><span> Java面试题</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 我的生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-picture-o"></i><span> Gallery</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-环境"><span class="toc-number">1.</span> <span class="toc-text">Flask 环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#为开发环境安装virtualenv"><span class="toc-number">1.1.</span> <span class="toc-text">为开发环境安装virtualenv</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-路由"><span class="toc-number">2.</span> <span class="toc-text">Flask 路由</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-变量规则"><span class="toc-number">3.</span> <span class="toc-text">Flask 变量规则</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-变量规则-1"><span class="toc-number">3.1.</span> <span class="toc-text">Flask 变量规则</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-URL构建"><span class="toc-number">4.</span> <span class="toc-text">Flask URL构建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-URL构建-1"><span class="toc-number">4.1.</span> <span class="toc-text">Flask URL构建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-Request对象"><span class="toc-number">5.</span> <span class="toc-text">Flask Request对象</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-Response对象与模板"><span class="toc-number">6.</span> <span class="toc-text">Flask Response对象与模板</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Response对象"><span class="toc-number">6.1.</span> <span class="toc-text">Response对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#flask里组装过程"><span class="toc-number">6.1.1.</span> <span class="toc-text">flask里组装过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模板"><span class="toc-number">6.2.</span> <span class="toc-text">模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#标签呈现‘Hello-World’"><span class="toc-number">6.2.1.</span> <span class="toc-text">标签呈现‘Hello World’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#render-template"><span class="toc-number">6.2.2.</span> <span class="toc-text">render_template()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模板语法"><span class="toc-number">6.2.3.</span> <span class="toc-text">模板语法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#过滤器"><span class="toc-number">6.3.</span> <span class="toc-text">过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义过滤器"><span class="toc-number">6.4.</span> <span class="toc-text">自定义过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模板代码的复用"><span class="toc-number">6.5.</span> <span class="toc-text">模板代码的复用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#宏"><span class="toc-number">6.5.1.</span> <span class="toc-text">宏</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用"><span class="toc-number">6.5.1.1.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#方式一"><span class="toc-number">6.5.1.1.1.</span> <span class="toc-text">方式一</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#方式二"><span class="toc-number">6.5.1.1.2.</span> <span class="toc-text">方式二</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#继承"><span class="toc-number">6.5.2.</span> <span class="toc-text">继承</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#父模板"><span class="toc-number">6.5.2.1.</span> <span class="toc-text">父模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#子模板"><span class="toc-number">6.5.2.2.</span> <span class="toc-text">子模板</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#包含"><span class="toc-number">6.5.3.</span> <span class="toc-text">包含</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-静态文件"><span class="toc-number">7.</span> <span class="toc-text">Flask 静态文件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-蓝图"><span class="toc-number">8.</span> <span class="toc-text">Flask 蓝图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是蓝图"><span class="toc-number">8.1.</span> <span class="toc-text">什么是蓝图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#蓝图的运行机制"><span class="toc-number">8.2.</span> <span class="toc-text">蓝图的运行机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#蓝图的使用"><span class="toc-number">8.3.</span> <span class="toc-text">蓝图的使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-Script"><span class="toc-number">9.</span> <span class="toc-text">Flask-Script</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">9.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集成Flask-Script到falsk应用中"><span class="toc-number">9.2.</span> <span class="toc-text">集成Flask-Script到falsk应用中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义命令"><span class="toc-number">9.3.</span> <span class="toc-text">自定义命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-Flask-Migrate"><span class="toc-number">9.3.1.</span> <span class="toc-text">安装 Flask-Migrate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例"><span class="toc-number">9.3.2.</span> <span class="toc-text">实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看指令-manager-db-的可用选项"><span class="toc-number">9.3.3.</span> <span class="toc-text">查看指令 manager db 的可用选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化-DB-Migrate"><span class="toc-number">9.3.4.</span> <span class="toc-text">初始化 DB Migrate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开始第一次跟踪"><span class="toc-number">9.3.5.</span> <span class="toc-text">开始第一次跟踪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#根据记录文件生成数据库"><span class="toc-number">9.3.6.</span> <span class="toc-text">根据记录文件生成数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回滚到某历史版本"><span class="toc-number">9.3.7.</span> <span class="toc-text">回滚到某历史版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">9.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题一-修改字段长度无法迁移"><span class="toc-number">9.5.</span> <span class="toc-text">问题一:修改字段长度无法迁移</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-SQLAlchemy"><span class="toc-number">10.</span> <span class="toc-text">Flask SQLAlchemy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-SQLAlchemy-1"><span class="toc-number">10.1.</span> <span class="toc-text">Flask SQLAlchemy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-SQLAlchemy环境搭建"><span class="toc-number">10.2.</span> <span class="toc-text">Flask SQLAlchemy环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试添加数据"><span class="toc-number">10.3.</span> <span class="toc-text">测试添加数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CRUD方法"><span class="toc-number">10.4.</span> <span class="toc-text">CRUD方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查询"><span class="toc-number">10.4.1.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加"><span class="toc-number">10.4.2.</span> <span class="toc-text">添加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除"><span class="toc-number">10.4.3.</span> <span class="toc-text">删除</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#逻辑删除"><span class="toc-number">10.4.3.1.</span> <span class="toc-text">逻辑删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更新"><span class="toc-number">10.4.4.</span> <span class="toc-text">更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分页paginate"><span class="toc-number">10.4.5.</span> <span class="toc-text">分页paginate</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-模型关系"><span class="toc-number">11.</span> <span class="toc-text">Flask 模型关系</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一对多"><span class="toc-number">11.1.</span> <span class="toc-text">一对多</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多对多"><span class="toc-number">11.2.</span> <span class="toc-text">多对多</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-Boostrap"><span class="toc-number">12.</span> <span class="toc-text">Flask-Boostrap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#内置的block"><span class="toc-number">12.1.</span> <span class="toc-text">内置的block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题一-访问资源404"><span class="toc-number">12.2.</span> <span class="toc-text">问题一:访问资源404</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用其他CDN"><span class="toc-number">12.2.1.</span> <span class="toc-text">使用其他CDN</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-会话机制"><span class="toc-number">13.</span> <span class="toc-text">Flask 会话机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cookie"><span class="toc-number">13.1.</span> <span class="toc-text">cookie</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cookie和session的结合使用"><span class="toc-number">13.2.</span> <span class="toc-text">cookie和session的结合使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现方式："><span class="toc-number">13.3.</span> <span class="toc-text">实现方式：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cookie方式："><span class="toc-number">13.3.1.</span> <span class="toc-text">cookie方式：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session方式："><span class="toc-number">13.3.2.</span> <span class="toc-text">session方式：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-密码加密解密"><span class="toc-number">14.</span> <span class="toc-text">Flask 密码加密解密</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-钩子函数"><span class="toc-number">15.</span> <span class="toc-text">Flask 钩子函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-文件上传"><span class="toc-number">16.</span> <span class="toc-text">Flask 文件上传</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-邮件"><span class="toc-number">17.</span> <span class="toc-text">Flask 邮件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Message类"><span class="toc-number">17.1.</span> <span class="toc-text">Message类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Message类方法"><span class="toc-number">17.1.1.</span> <span class="toc-text">Message类方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask短信服务"><span class="toc-number">18.</span> <span class="toc-text">Flask短信服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-caching-缓存"><span class="toc-number">19.</span> <span class="toc-text">Flask-caching(缓存)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#相关使用"><span class="toc-number">19.1.</span> <span class="toc-text">相关使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存视图函数"><span class="toc-number">19.1.1.</span> <span class="toc-text">缓存视图函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存普通函数（无参）"><span class="toc-number">19.1.2.</span> <span class="toc-text">缓存普通函数（无参）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存普通函数（有参）"><span class="toc-number">19.1.3.</span> <span class="toc-text">缓存普通函数（有参）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存对象（键值对）"><span class="toc-number">19.1.4.</span> <span class="toc-text">缓存对象（键值对）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cache-对象的主要方法"><span class="toc-number">19.2.</span> <span class="toc-text">cache 对象的主要方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask对象储存"><span class="toc-number">20.</span> <span class="toc-text">Flask对象储存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-WTF"><span class="toc-number">21.</span> <span class="toc-text">Flask-WTF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WTForms和Flask-WTF的关系"><span class="toc-number">21.1.</span> <span class="toc-text">WTForms和Flask-WTF的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#功能"><span class="toc-number">21.2.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相关使用-1"><span class="toc-number">21.3.</span> <span class="toc-text">相关使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一丶创建基础表单"><span class="toc-number">21.3.1.</span> <span class="toc-text">一丶创建基础表单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-基础表单"><span class="toc-number">21.3.1.1.</span> <span class="toc-text">1. 基础表单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-CSRF-跨站点请求伪造-保护"><span class="toc-number">21.3.1.2.</span> <span class="toc-text">2.CSRF(跨站点请求伪造)保护</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-使用"><span class="toc-number">21.3.1.3.</span> <span class="toc-text">3. 使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-提交验证"><span class="toc-number">21.3.1.4.</span> <span class="toc-text">4. 提交验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二丶文件上传"><span class="toc-number">21.3.2.</span> <span class="toc-text">二丶文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三丶验证码"><span class="toc-number">21.3.3.</span> <span class="toc-text">三丶验证码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-安装"><span class="toc-number">21.3.3.0.1.</span> <span class="toc-text">1. 安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-utils-py工具类"><span class="toc-number">21.3.3.0.2.</span> <span class="toc-text">2. utils.py工具类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#页面user-html"><span class="toc-number">21.3.3.0.3.</span> <span class="toc-text">页面user.html</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WTForms"><span class="toc-number">21.4.</span> <span class="toc-text">WTForms</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本了解"><span class="toc-number">21.4.1.</span> <span class="toc-text">基本了解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用法："><span class="toc-number">21.4.2.</span> <span class="toc-text">用法：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-field字段"><span class="toc-number">21.4.2.0.1.</span> <span class="toc-text">1.field字段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Validators验证器"><span class="toc-number">21.4.2.0.2.</span> <span class="toc-text">2.Validators验证器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-自定义Validators验证器"><span class="toc-number">21.4.2.0.3.</span> <span class="toc-text">3.自定义Validators验证器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-Widget组件"><span class="toc-number">21.4.2.0.4.</span> <span class="toc-text">4.Widget组件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结-1"><span class="toc-number">21.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-消息闪现"><span class="toc-number">22.</span> <span class="toc-text">Flask 消息闪现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-日志"><span class="toc-number">23.</span> <span class="toc-text">Flask 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#logging-模块"><span class="toc-number">23.1.</span> <span class="toc-text">logging 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#logging-模块的日志级别"><span class="toc-number">23.1.1.</span> <span class="toc-text">logging 模块的日志级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logging-模块的使用方式介绍"><span class="toc-number">23.1.2.</span> <span class="toc-text">logging 模块的使用方式介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用logging提供的模块级别的函数记录日志"><span class="toc-number">23.2.</span> <span class="toc-text">使用logging提供的模块级别的函数记录日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#最简单的日志输出"><span class="toc-number">23.2.1.</span> <span class="toc-text">最简单的日志输出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-restful"><span class="toc-number">24.</span> <span class="toc-text">Flask-restful</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#快速入门"><span class="toc-number">24.1.</span> <span class="toc-text">快速入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#请求参数解析"><span class="toc-number">24.2.</span> <span class="toc-text">请求参数解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#响应数据格式化"><span class="toc-number">24.3.</span> <span class="toc-text">响应数据格式化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义fields和Url"><span class="toc-number">24.3.1.</span> <span class="toc-text">自定义fields和Url</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#返回复杂的结构对象"><span class="toc-number">24.3.2.</span> <span class="toc-text">返回复杂的结构对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#marchal"><span class="toc-number">24.3.2.1.</span> <span class="toc-text">marchal()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#marchal-with"><span class="toc-number">24.3.2.2.</span> <span class="toc-text">@marchal_with()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-restful-API跨域问题"><span class="toc-number">25.</span> <span class="toc-text">Flask-restful-API跨域问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-restful-API与蓝图的使用"><span class="toc-number">26.</span> <span class="toc-text">Flask-restful-API与蓝图的使用</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(http://cdn.panyucable.cn/zysheep/flask_top.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">三月三</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bug" aria-hidden="true"></i><span> 编程路线</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/java/"><i class="fa-fw fa fa-coffee"></i><span> Java</span></a></li><li><a class="site-page" href="/python/"><i class="fa-fw fa fa-binoculars"></i><span> Python</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder-open" aria-hidden="true"></i><span> 面试宝典</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/interview/"><i class="fa-fw fa fa-file-text-o"></i><span> Java面试题</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 我的生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-picture-o"></i><span> Gallery</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Flask学习</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-04-06 12:30:45"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-04-06</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-08-18 16:44:46"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-08-18</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/">Python</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/Flask/">Flask</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">25.6k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 106 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/04/06/Python/%E5%AD%A6%E4%B9%A0Flask/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p>#Flask概述</p>
<p>Flask 是一个微型的 <code>Python</code> 开发的 <code>Web</code>框架，基于<a href="https://www.oschina.net/p/werkzeug" target="_blank" rel="noopener">Werkzeug</a> WSGI工具箱和<a href="https://www.oschina.net/p/jinja" target="_blank" rel="noopener">Jinja2</a> 模板引擎。 Flask使用BSD授权。 Flask也被称为“microframework”，因为它使用简单的核心，用extension增加其他功能。Flask没有默认使用的数据库、窗体验证工具。然而，Flask保留了扩增的弹性，可以用<code>Flask-extension</code>加入这些功能：ORM、窗体验证工具、文件上传、各种开放式身份验证技术。</p>
<p>示例代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;&#x2F;&quot;)</span><br><span class="line">def hello():</span><br><span class="line">    return &quot;Hello World!&quot;</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>必须在项目中导入<code>Flask</code>模块。 <code>Flask类</code>的一个对象是我们的<strong>WSGI</strong>应用程序。</p>
<p>Flask构造函数使用<strong>当前模块（<code>__name __</code>）</strong>的名称作为参数。</p>
<p>Flask类的<strong>route()</strong>函数是一个装饰器，它告诉应用程序哪个URL应该调用相关的函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.route(rule, options)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>rule</strong> 参数表示与该函数的URL绑定。</li>
<li><strong>options</strong> 是要转发给基础Rule对象的参数列表。</li>
</ul>
<p>在上面的示例中，’/ ‘ URL与<strong>hello_world()</strong>函数绑定。因此，当在浏览器中打开web服务器的主页时，将呈现该函数的输出。</p>
<p>最后，Flask类的<strong>run()</strong>方法在本地开发服务器上运行应用程序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.run(host&#x3D;&#39;192.168.0.235&#39;,port&#x3D;8081,debug&#x3D;True)</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>host: 要监听的主机名。 默认为127.0.0.1（localhost）。设置为“0.0.0.0”以使服务器在外部可用</li>
<li>port: 指定端口,默认值为5000</li>
<li>debug=True: 相当于热部署,代码改变服务器会重新加载最新代码,用于开发环境。默认为Flase,代码发生改变不会自动加载,用于生产环境</li>
</ul>
</blockquote>
<p>启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pip install Flask</span><br><span class="line">$ python hello.py</span><br></pre></td></tr></table></figure>

<p>##特性</p>
<ul>
<li>内置开发用服务器和debugger</li>
<li>集成单元测试（unit testing）</li>
<li>RESTful request dispatching</li>
<li>使用Jinja2模板引擎</li>
<li>支持secure cookies（client side sessions）</li>
<li>100% WSGI 1.0兼容</li>
<li>Unicode based</li>
<li>详细的文件、教学</li>
<li>Google App Engine兼容</li>
<li>可用Extensions增加其他功能</li>
</ul>
<h1 id="Flask-环境"><a href="#Flask-环境" class="headerlink" title="Flask 环境"></a>Flask 环境</h1><h2 id="为开发环境安装virtualenv"><a href="#为开发环境安装virtualenv" class="headerlink" title="为开发环境安装virtualenv"></a>为开发环境安装virtualenv</h2><p><strong>virtualenv</strong>是一个虚拟的Python环境构建器。它可以帮助用户并行创建多个Python环境。 因此，它可以避免不同版本的库之间的兼容性问题。</p>
<h1 id="Flask-路由"><a href="#Flask-路由" class="headerlink" title="Flask 路由"></a>Flask 路由</h1><p>现代<code>Web</code>框架使用路由技术来帮助用户记住应用程序URL。可以直接访问所需的页面，而无需从主页导航。</p>
<p>Flask中的<strong>route()</strong>装饰器用于将URL绑定到函数。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 这个装饰器其实就是将rule字符串跟视图函数进行了绑定，通过add_url_rule()实现的绑定</span><br><span class="line">@app.route(‘&#x2F;hello’)</span><br><span class="line">def hello_world():</span><br><span class="line">   return ‘hello world’</span><br></pre></td></tr></table></figure>

<p>在这里，URL <strong>‘/ hello’</strong> 规则绑定到<strong>hello_world()</strong>函数。 因此，如果用户访问<strong>http：// localhost：5000 / hello</strong> URL，<strong>hello_world()</strong>函数的输出将在浏览器中呈现。</p>
<p>application对象的<strong>add_url_rule()</strong>函数也可用于将URL与函数绑定，如上例所示，使用<strong>route()</strong>。</p>
<p>装饰器的目的也由以下表示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def hello_world():</span><br><span class="line">   return ‘hello world’</span><br><span class="line">   </span><br><span class="line">app.add_url_rule(‘&#x2F;’, ‘hello’, hello_world)</span><br></pre></td></tr></table></figure>

<h1 id="Flask-变量规则"><a href="#Flask-变量规则" class="headerlink" title="Flask 变量规则"></a>Flask 变量规则</h1><h2 id="Flask-变量规则-1"><a href="#Flask-变量规则-1" class="headerlink" title="Flask 变量规则"></a>Flask 变量规则</h2><p>通过向规则参数添加变量部分，可以动态构建URL。此变量部分标记为<strong><variable-name></strong>。它作为关键字参数传递给与规则相关联的函数。</p>
<p>在以下示例中，<strong>route()</strong>装饰器的规则参数包含附加到URL <strong>‘/hello’</strong>的<strong><name>。</strong>因此，如果在浏览器中输入<strong><a href="http://localhost:5000/hello/w3cschool" target="_blank" rel="noopener">http://localhost:5000/hello/w3cschool</a></strong>作为<strong>URL</strong>，则<strong>‘w3cschool’</strong>将作为参数提供给<strong>hello()</strong>函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;hello&#x2F;&lt;name&gt;&#39;)</span><br><span class="line">def hello_name(name):</span><br><span class="line">   return &#39;Hello %s!&#39; % name</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">   app.run(debug &#x3D; True)</span><br></pre></td></tr></table></figure>

<p>将上述脚本保存为<strong>hello.py</strong>并从Python shell运行它。接下来，打开浏览器并输入URL <strong>http:// localhost:5000/hello/w3cschool。</strong></p>
<p>以下输出将显示在浏览器中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello w3cschool!</span><br></pre></td></tr></table></figure>

<p>除了默认字符串变量部分之外，还可以使用以下转换器构建规则：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>转换器和描述</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><strong>int</strong>接受整数</td>
</tr>
<tr>
<td>2</td>
<td><strong>float</strong>对于浮点值</td>
</tr>
<tr>
<td>3</td>
<td><strong>path</strong>接受用作目录分隔符的斜杠</td>
</tr>
</tbody></table>
<p>在下面的代码中，使用了所有这些构造函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;blog&#x2F;&lt;int:postID&gt;&#39;)</span><br><span class="line">def show_blog(postID):</span><br><span class="line">   return &#39;Blog Number %d&#39; % postID</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;rev&#x2F;&lt;float:revNo&gt;&#39;)</span><br><span class="line">def revision(revNo):</span><br><span class="line">   return &#39;Revision Number %f&#39; % revNo</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">   app.run()</span><br></pre></td></tr></table></figure>

<p>从Python Shell运行上面的代码。访问浏览器中的URL <strong><a href="http://localhost:5000/blog/11" target="_blank" rel="noopener">http://localhost:5000/blog/11</a></strong>。</p>
<p>给定的数字用作<strong>show_blog()</strong>函数的参数。浏览器显示以下输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Blog Number 11</span><br></pre></td></tr></table></figure>

<p>在浏览器中输入此URL - <strong><a href="http://localhost:5000/rev/1.1" target="_blank" rel="noopener">http://localhost:5000/rev/1.1</a></strong></p>
<p><strong>revision()</strong>函数将浮点数作为参数。以下结果显示在浏览器窗口中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Revision Number 1.100000</span><br></pre></td></tr></table></figure>

<p>Flask的URL规则基于<strong>Werkzeug</strong>的路由模块。这确保形成的URL是唯一的，并且基于Apache规定的先例。</p>
<p>考虑以下脚本中定义的规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;flask&#39;)</span><br><span class="line">def hello_flask():</span><br><span class="line">   return &#39;Hello Flask&#39;</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;python&#x2F;&#39;)</span><br><span class="line">def hello_python():</span><br><span class="line">   return &#39;Hello Python&#39;</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">   app.run()</span><br></pre></td></tr></table></figure>

<p>这两个规则看起来类似，但在第二个规则中，使用斜杠<strong>（/）</strong>。因此，它成为一个规范的URL。因此，使用 <strong>/python</strong> 或 <strong>/python/</strong>返回相同的输出。但是，如果是第一个规则，<strong>/flask/ URL</strong>会产生“404 Not Found”页面。</p>
<h1 id="Flask-URL构建"><a href="#Flask-URL构建" class="headerlink" title="Flask URL构建"></a>Flask URL构建</h1><h2 id="Flask-URL构建-1"><a href="#Flask-URL构建-1" class="headerlink" title="Flask URL构建"></a><strong>Flask URL构建</strong></h2><p><strong>url_for()</strong>函数对于动态构建特定函数的URL非常有用。该函数接受函数的名称作为第一个参数，以及一个或多个关键字参数，每个参数对应于URL的变量部分。</p>
<p>以下脚本演示了如何使用<strong>url_for()</strong>函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, redirect, url_for</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line">@app.route(&#39;&#x2F;admin&#39;)</span><br><span class="line">def hello_admin():</span><br><span class="line">   return &#39;Hello Admin&#39;</span><br><span class="line">@app.route(&#39;&#x2F;guest&#x2F;&lt;guest&gt;&#39;)def hello_guest(guest):</span><br><span class="line">   return &#39;Hello %s as Guest&#39; % guest</span><br><span class="line">@app.route(&#39;&#x2F;user&#x2F;&lt;name&gt;&#39;)</span><br><span class="line">def hello_user(name):</span><br><span class="line">   if name &#x3D;&#x3D;&#39;admin&#39;:</span><br><span class="line">      return redirect(url_for(&#39;hello_admin&#39;))</span><br><span class="line">   else:</span><br><span class="line">      return redirect(url_for(&#39;hello_guest&#39;,guest &#x3D; name))</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">   app.run(debug &#x3D; True)</span><br></pre></td></tr></table></figure>

<p>上述脚本有一个函数<strong>user(name)</strong>，它接受来自URL的参数的值。</p>
<p><strong>User()</strong>函数检查接收的参数是否与<strong>‘admin’</strong>匹配。如果匹配，则使用<strong>url_for()</strong>将应用程序重定向到<strong>hello_admin()</strong>函数，否则重定向到将接收的参数作为guest参数传递给它的<strong>hello_guest()</strong>函数。</p>
<p>保存上面的代码并从Python shell运行。</p>
<p>打开浏览器并输入URL - <strong><a href="http://localhost:5000/user/admin" target="_blank" rel="noopener">http://localhost:5000/user/admin</a></strong></p>
<p>浏览器中的应用程序响应是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello Admin</span><br></pre></td></tr></table></figure>

<p>在浏览器中输入以下URL - <strong><a href="http://localhost:5000/user/mvl" target="_blank" rel="noopener">http://localhost:5000/user/mvl</a></strong></p>
<p>应用程序响应现在更改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello mvl as Guest</span><br></pre></td></tr></table></figure>

<h1 id="Flask-Request对象"><a href="#Flask-Request对象" class="headerlink" title="Flask Request对象"></a>Flask Request对象</h1><p>来自客户端网页的数据作为全局请求对象发送到服务器。为了处理请求数据，应该从Flask模块导入。</p>
<p><code>Request</code>对象的重要属性如下所列：</p>
<ul>
<li><strong>Form</strong> - 它是一个字典对象，包含表单参数及其值的键和值对。</li>
<li><strong>args</strong> - 解析查询字符串的内容，它是问号（？）之后的URL的一部分。</li>
<li><strong>Cookies</strong>  - 保存Cookie名称和值的字典对象。</li>
<li><strong>files</strong> - 与上传文件有关的数据。</li>
<li><strong>method</strong> - 当前请求方法。</li>
</ul>
<p>默认情况下，Flask路由响应<strong>GET</strong>请求。但是，可以通过为<strong>route()</strong>装饰器提供方法参数来更改此首选项。</p>
<p>为了演示在URL路由中使用<strong>POST</strong>方法，首先让我们创建一个HTML表单，并使用<strong>POST</strong>方法将表单数据发送到URL。将以下脚本另存为login.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      </span><br><span class="line">      &lt;form action &#x3D; &quot;http:&#x2F;&#x2F;localhost:5000&#x2F;login&quot; method &#x3D; &quot;post&quot;&gt;</span><br><span class="line">         &lt;p&gt;Enter Name:&lt;&#x2F;p&gt;</span><br><span class="line">         &lt;p&gt;&lt;input type &#x3D; &quot;text&quot; name &#x3D; &quot;nm&quot; &#x2F;&gt;&lt;&#x2F;p&gt;</span><br><span class="line">         &lt;p&gt;&lt;input type &#x3D; &quot;submit&quot; value &#x3D; &quot;submit&quot; &#x2F;&gt;&lt;&#x2F;p&gt;</span><br><span class="line">      &lt;&#x2F;form&gt;</span><br><span class="line">      </span><br><span class="line">   &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>现在在Python shell中输入以下脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, redirect, url_for, request</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;success&#x2F;&lt;name&gt;&#39;)</span><br><span class="line">def success(name):</span><br><span class="line">   return &#39;welcome %s&#39; % name</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;login&#39;,methods &#x3D; [&#39;POST&#39;, &#39;GET&#39;])</span><br><span class="line">def login():</span><br><span class="line">   if request.method &#x3D;&#x3D; &#39;POST&#39;:</span><br><span class="line">   	  # 获取post请求的参数</span><br><span class="line">      user &#x3D; request.form[&#39;nm&#39;]</span><br><span class="line">      return redirect(url_for(&#39;success&#39;,name &#x3D; user))</span><br><span class="line">   else:</span><br><span class="line">      # 获取get请求的参数</span><br><span class="line">      user &#x3D; request.args.get(&#39;nm&#39;)</span><br><span class="line">      return redirect(url_for(&#39;success&#39;,name &#x3D; user))</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">   app.run(debug &#x3D; True)</span><br></pre></td></tr></table></figure>

<p>开发服务器开始运行后，在浏览器中打开<strong>login.html</strong>，在文本字段中输入name，然后单击<strong>提交</strong>。</p>
<h1 id="Flask-Response对象与模板"><a href="#Flask-Response对象与模板" class="headerlink" title="Flask Response对象与模板"></a>Flask Response对象与模板</h1><h2 id="Response对象"><a href="#Response对象" class="headerlink" title="Response对象"></a>Response对象</h2><blockquote>
<p>Flask的视图函数return可以返回那些值?</p>
</blockquote>
<ol>
<li><p>可以返回字符串: 返回的字符串其实也是做了一个<code>response</code>对象的封装。最终的返回结果还是<code>response</code>对象</p>
</li>
<li><p>dict对象:  转换成了application/json数据</p>
</li>
<li><p>tuple对象: 返回元组时，顺序依次是：返回内容，返回状态码，返回的header</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return &#39;hello world&#39;, 200, &#123;&#39;Locateion&#39;:&#39;www.baidu.com&#39;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>response对象</p>
</li>
<li><p>make_response()</p>
</li>
<li><p>redirect() : 有两次响应：1. 302状态码 + location  2.  返回location请求地址内容</p>
</li>
<li><p>render_template()  模板渲染 + 模板</p>
</li>
<li><p>jsonify()函数,它把JSON输出到一个flask.Response与应用程序/ JSON的mimetype对象</p>
</li>
</ol>
<p>###标准WSGI接口</p>
<p>实际上，<code>flask</code>是基于<code>Werkzeug</code>工具包的一个web服务框架，所以flask里视图函数的实现，实际上是对werkzeug的一层封装，我们先看一下一个简单的werkzeug应用是怎么实现的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from werkzeug.wrappers import Request, Response</span><br><span class="line"></span><br><span class="line">def application(environ, start_response):</span><br><span class="line">    request &#x3D; Request(environ)</span><br><span class="line">    text &#x3D; &#39;Hello %s!&#39; % request.args.get(&#39;name&#39;, &#39;World&#39;)</span><br><span class="line">    response &#x3D; Response(text, mimetype&#x3D;&#39;text&#x2F;plain&#39;)</span><br><span class="line">    return response(environ, start_response)</span><br></pre></td></tr></table></figure>

<p>可以看到，实际上<code>werkzeug</code>要求每次请求的返回值是<code>Response</code>类型。所以实际上，<code>flask</code>的视图函数返回值无论如何变，它都不会离开<code>Response</code>类型。</p>
<h3 id="flask里组装过程"><a href="#flask里组装过程" class="headerlink" title="flask里组装过程"></a>flask里组装过程</h3><p>flask视图函数调用过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rv &#x3D; full_dispatch_request() </span><br><span class="line">     dispatch_request()   </span><br><span class="line">        self.view_functions[rule.endpoint](**req.view_args)</span><br><span class="line">finalize_request(rv)</span><br><span class="line">   	make_response(rv)   </span><br><span class="line">        rv &#x3D; self.response_class(rv, status&#x3D;status, headers&#x3D;headers)</span><br><span class="line">        # 这里response_class实际上就是Response类</span><br><span class="line">        return rv</span><br></pre></td></tr></table></figure>

<p>可以看到，无论<code>flask</code>里视图函数的返回值是什么样式，最终都会调用<code>Flask.make_response()</code>里的<code>response_class</code>构造一个<code>Response</code>对象。回头看flask视图函数的返回值：</p>
<ul>
<li>如果返回的是3个元素的元组，则会在构造Response时使用元组里的后两个作为Response的返回code以及header</li>
<li>如果返回的值是单个元素<ul>
<li>如果是字符串，那么在Flask.make_response()里会加上默认的code和header，并且header里content-type是text/html</li>
<li>如果是jsonify(), 会在jsonify()方法里组装一个Response对象，并在header里添加content-type为text/json。然后返回</li>
</ul>
</li>
<li>如果返回的是render_template, 会通过flask里的渲染引擎将html渲染成字符串返回，之后便和返回字符串形式相同</li>
<li>如果返因的是make_response, 则会直接生成Response对象</li>
</ul>
<p>在Flask.make_response()里，会根据视图函数返回的值的个数，类型的不同，来做不同的处理，生成最终的Response对象，并为字添加code和header等。</p>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><h3 id="标签呈现‘Hello-World’"><a href="#标签呈现‘Hello-World’" class="headerlink" title="标签呈现‘Hello World’"></a>标签呈现<strong>‘Hello World’</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask  import Flask</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;&#39;)</span><br><span class="line">def index():</span><br><span class="line">   return &#39;&lt;html&gt;&lt;body&gt;&lt;h1&gt;&#39;Hello World&#39;&lt;&#x2F;h1&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;&#39;</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">   app.run(debug &#x3D; True)</span><br></pre></td></tr></table></figure>

<p>但是，从<code>Python</code>代码生成HTML内容很麻烦，尤其是在需要放置变量数据和Python语言元素（如条件或循环）时。这需要经常从HTML中转义。</p>
<h3 id="render-template"><a href="#render-template" class="headerlink" title="render_template()"></a>render_template()</h3><p>这是可以利用<code>Flask</code>所基于的<strong>Jinja2模板引擎</strong>的地方。而不是从函数返回硬编码<code>HTML</code>，可以通过<strong>render_template()</strong>函数呈现HTML文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask，render_template</span><br><span class="line">app &#x3D; Flask(name)</span><br><span class="line">@app.route(&#39;&#x2F;&#39;)</span><br><span class="line">def index():</span><br><span class="line">   return render_template(‘hello.html’)</span><br><span class="line">if name &#x3D;&#x3D; &#39;main&#39;:</span><br><span class="line">   app.run(debug &#x3D; True)</span><br></pre></td></tr></table></figure>

<p>Flask将尝试在templates文件夹中找到HTML文件，该文件存在于此脚本所在的文件夹中。</p>
<ul>
<li>Application folder<ul>
<li>Hello.py</li>
<li>templates<ul>
<li>hello.html</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>术语<strong>‘web templating system（web模板系统）’</strong>指的是设计一个HTML脚本，其中可以动态插入变量数据。web模板系统包括模板引擎，某种数据源和模板处理器。</p>
<p>Flask使用<strong>jinga2</strong>模板引擎。Web模板包含用于变量和表达式（在这些情况下为Python表达式）的HTML语法散布占位符，这些是在呈现模板时替换的值。</p>
<p>以下代码在<code>templates</code>文件夹中另存为<strong>hello.html</strong> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">	  &#123;# 变量部分插入&#123;&#123;name&#125;&#125;占位符。#&#125;</span><br><span class="line">      &lt;h1&gt;Hello &#123;&#123; name &#125;&#125;!&lt;&#x2F;h1&gt;</span><br><span class="line"></span><br><span class="line">   &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>接下来，从Python shell运行以下脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, render_template</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line">@app.route(&#39;&#x2F;hello&#x2F;&#39;)</span><br><span class="line">def hello_name(user):</span><br><span class="line">   # render_template(&#39;模板名字&#39;,**context)</span><br><span class="line">   return render_template(&#39;hello.html&#39;, name &#x3D; user)</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">   app.run(debug &#x3D; True)</span><br></pre></td></tr></table></figure>

<p>当开发服务器开始运行时，打开浏览器并输入URL - <strong><a href="http://localhost:5000/hello/mvl" target="_blank" rel="noopener">http://localhost:5000/hello/mvl</a></strong></p>
<h3 id="模板语法"><a href="#模板语法" class="headerlink" title="模板语法"></a>模板语法</h3><p><strong>Jinja2</strong>模板引擎使用以下分隔符从HTML转义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">1.&#123;% ... %&#125;用于语句</span><br><span class="line">      # 1. 条件判断</span><br><span class="line">      &#123;% if 条件 %&#125;</span><br><span class="line">      </span><br><span class="line">      &#123;% endif %&#125;</span><br><span class="line">      </span><br><span class="line">      # 2. 嵌套条件</span><br><span class="line">      &#123;% if  条件 %&#125;</span><br><span class="line">          条件为True</span><br><span class="line">      &#123;% else %&#125;</span><br><span class="line">          条件为False</span><br><span class="line">      &#123;% endif %&#125;</span><br><span class="line">      </span><br><span class="line">      &#123;% if 条件 %&#125;</span><br><span class="line">          pass</span><br><span class="line">      &#123;% elif 条件 %&#125;</span><br><span class="line">          pass</span><br><span class="line">       ....</span><br><span class="line">      &#123;% endif %&#125;</span><br><span class="line">      # 3. 循环遍历</span><br><span class="line">      &#123;% for 变量 in 可迭代的对象 %&#125;</span><br><span class="line">          for循环要做的任务</span><br><span class="line">          # 可以使用loop变量</span><br><span class="line">          loop.index  序号从1开始</span><br><span class="line">          loop.index0  序号从0开始</span><br><span class="line">          loop.revindex  reverse  序号是倒着的</span><br><span class="line">          loop.revindex0</span><br><span class="line">          loop.first 布尔类型   是否是第一行</span><br><span class="line">          loop.last  布尔类型   是否是第二行</span><br><span class="line">      &#123;% endfor %&#125;</span><br><span class="line">2.&#123;&#123; ... &#125;&#125;用于表达式可以打印到模板输出</span><br><span class="line">      在模板中获取view中传递的变量值：&#123;&#123; 变量名key &#125;&#125;</span><br><span class="line">      # render_template(&#39;模板名字&#39;,key&#x3D;value,key&#x3D;value)</span><br><span class="line">      	name &#x3D; &#39;沈凯&#39;  # str</span><br><span class="line">          age &#x3D; 18  # int</span><br><span class="line">          friends &#x3D; [&#39;建义&#39;, &#39;陈璟&#39;, &#39;小岳岳&#39;, &#39;郭麒麟&#39;]  # list</span><br><span class="line">          dict1 &#x3D; &#123;&#39;gift&#39;: &#39;大手镯&#39;, &#39;gift1&#39;: &#39;鲜花&#39;, &#39;gift2&#39;: &#39;费列罗&#39;&#125;  # dict</span><br><span class="line">          # 创建对象</span><br><span class="line">          girlfriend &#x3D; Girl(&#39;美美&#39;, &#39;安徽阜阳&#39;)  # 自定义的类构建的类型：Girl对象</span><br><span class="line">      </span><br><span class="line">      模板：</span><br><span class="line">      	&#123;&#123;name&#125;&#125;</span><br><span class="line">      	&#123;&#123;age&#125;&#125;</span><br><span class="line">          &#123;&#123; list.0 &#125;&#125;  同 &#123;&#123; list[0] &#125;&#125;</span><br><span class="line">          &#123;&#123; dict.key &#125;&#125; 同 &#123;&#123; dict.get(key) &#125;&#125;</span><br><span class="line">          &#123;&#123; girl.name &#125;&#125; 同 &#123;&#123; 对象.属性 &#125;&#125;</span><br><span class="line">3.&#123;# ... #&#125;用于未包含在模板输出中的注释</span><br></pre></td></tr></table></figure>

<h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><blockquote>
<p>当遇到特殊的值需要打印到模板输出时,我们可以使用过滤器,过滤器的本质就是函数</p>
</blockquote>
<p>模板语法中过滤器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; 变量名 | 过滤器(*args) &#125;&#125;</span><br><span class="line">&#123;&#123; 变量名 | 过滤器 &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>常见的过滤器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">1。 safe ： 禁用转译</span><br><span class="line">msg &#x3D; &#39;&lt;h1&gt;520快乐！&lt;&#x2F;h1&gt;&#39;</span><br><span class="line">return render_template(&#39;show_2.html&#39;, girls&#x3D;girls, users&#x3D;users, msg&#x3D;msg)</span><br><span class="line">不想让其转译：</span><br><span class="line">&#123;&#123; msg | safe &#125;&#125;</span><br><span class="line">2。 capitalize：单词的首字母大写</span><br><span class="line">&#123;&#123; n1 | capitalize &#125;&#125;</span><br><span class="line">3。lower和upper</span><br><span class="line">大小写的转换</span><br><span class="line">4。title 一句话中每个单词的首字母大写</span><br><span class="line"> msg &#x3D; &#39;She is a beautiful girl&#39;</span><br><span class="line"> &#123;&#123; msg | title&#125;&#125;</span><br><span class="line">5。reverse  翻转</span><br><span class="line">&#123;&#123; n1 | reverse&#125;&#125;</span><br><span class="line">6。format</span><br><span class="line">&#123;&#123; &#39;%s is %d years old&#39; | format(&#39;lily&#39;,18) &#125;&#125;</span><br><span class="line">7.truncate 字符串截断</span><br><span class="line">list的操作：</span><br><span class="line">&#123;# 列表过滤器的使用 #&#125;</span><br><span class="line">&#123;&#123; girls | first &#125;&#125;&lt;br&gt;</span><br><span class="line">&#123;&#123; girls | last &#125;&#125;&lt;br&gt;</span><br><span class="line">&#123;&#123; girls | length &#125;&#125;&lt;br&gt;</span><br><span class="line">&#123;#&#123;&#123; girls | sum &#125;&#125; 整型的计算 #&#125;</span><br><span class="line">&#123;&#123; [1,3,5,7,9] | sum &#125;&#125;&lt;br&gt;</span><br><span class="line">&#123;&#123; [1,8,5,7,3] | sort &#125;&#125;&lt;br&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dict:</span><br><span class="line">&#123;% for v in users.0.values() %&#125;   ----&gt;获取值</span><br><span class="line">    &lt;p&gt;&#123;&#123; v &#125;&#125;&lt;&#x2F;p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&#123;% for k in users.0.keys() %&#125;   ----》获取键</span><br><span class="line">    &lt;p&gt;&#123;&#123; k &#125;&#125;&lt;&#x2F;p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">&lt;hr&gt;</span><br><span class="line"></span><br><span class="line">&#123;% for k,v in users.0.items() %&#125;  ---》获取键值</span><br><span class="line">    &lt;p&gt;&#123;&#123; k &#125;&#125;---&#123;&#123; v &#125;&#125;&lt;&#x2F;p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#第一种方式</span><br><span class="line">通过flask模块中的add_template_filter方法</span><br><span class="line">1. 定义函数，带有参数和返回值</span><br><span class="line">2. 添加过滤器  app.add_template_filter(function,name&#x3D;&#39;&#39;)</span><br><span class="line">3. 在模板中使用： &#123;&#123; 变量 | 自定义过滤器 &#125;&#125;</span><br><span class="line"></span><br><span class="line">    def replace_hello(value):</span><br><span class="line">        print(&#39;------&gt;&#39;, value)</span><br><span class="line">        value &#x3D; value.replace(&#39;hello&#39;, &#39;&#39;)</span><br><span class="line">        print(&#39;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&#39;, value)</span><br><span class="line">        return value.strip()  # 将 替换的结果返回</span><br><span class="line">        </span><br><span class="line">    app.add_template_filter(replace_hello, &#39;replace&#39;) # replace 自定义过滤器的名字</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用装饰器完成</span><br><span class="line">1. 定义函数，带有参数和返回值</span><br><span class="line">2. 通过装饰器完成，@app.template_filter(&#39;过滤器名字&#39;)装饰步骤一的函数</span><br><span class="line">3. 在模板中使用： &#123;&#123; 变量 | 自定义过滤器 &#125;&#125;</span><br><span class="line"># 第二种方式 装饰器</span><br><span class="line">@app.template_filter(&#39;listreverse&#39;)</span><br><span class="line">def reverse_list(li):</span><br><span class="line">    temp_li &#x3D; list(li)</span><br><span class="line">    temp_li.reverse()</span><br><span class="line">    return temp_li</span><br></pre></td></tr></table></figure>

<h2 id="模板代码的复用"><a href="#模板代码的复用" class="headerlink" title="模板代码的复用"></a>模板代码的复用</h2><p><strong>在模板中，可能会遇到以下情况：</strong></p>
<ol>
<li>多个模板具有完全相同的顶部和底部内容</li>
<li>多个模板中具有相同的模板代码内容，但是内容中部分值不一样</li>
<li>多个模板中具有完全相同的 html 代码块内容</li>
</ol>
<h3 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h3><p>对宏(macro)的理解：</p>
<ul>
<li>可以把宏理解为一个函数，它会返回一个模板或者 HTML 字符串</li>
<li>为了避免反复地编写同样的模板代码，出现代码冗余，可以把他们写成函数以进行重用</li>
<li>需要在多处重复使用的模板代码片段可以写入单独的文件，再包含在所有模板中，以避免重复</li>
</ul>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><h5 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h5><p>1、定义宏</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro input(name,value=<span class="string">''</span>,type=<span class="string">'text'</span>) %&#125;</span><br><span class="line">    &lt;input type="&#123;&#123;type&#125;&#125;" name="&#123;&#123;name&#125;&#125;" value="&#123;&#123;value&#125;&#125;" class="form-control"&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br></pre></td></tr></table></figure>

<p>2、调用宏</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; input(<span class="string">'name'</span> value=<span class="string">'zs'</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>3、这会输出</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type="text" name="name" value="zs" class="form-control"&gt;</span><br></pre></td></tr></table></figure>

<h5 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h5><p>4、把宏单独抽取出来，封装成html文件，其它模板中导入使用，文件名可以自定义macro.html</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro function(type=<span class="string">'text'</span>, name=<span class="string">''</span>, value=<span class="string">''</span>) %&#125;</span><br><span class="line">		&lt;input type="&#123;&#123;type&#125;&#125;" name="&#123;&#123;name&#125;&#125;" value="&#123;&#123;value&#125;&#125;" class="form-control"&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br></pre></td></tr></table></figure>

<p>5、在其它模板文件中先导入，再调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">import</span> <span class="string">'macro.html'</span> <span class="keyword">as</span> func %&#125;</span><br><span class="line">&#123;% func.function() %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>模板继承是为了重用模板中的公共内容。一般Web开发中，继承主要使用在网站的顶部菜单、底部。这些内容可以定义在父模板中，子模板直接继承，而不需要重复书写。</p>
<ul>
<li>相当于在父模板中挖个坑，当子模板继承父模板时，可以进行填充。</li>
<li>子模板使用 extends 指令声明这个模板继承自哪个模板</li>
<li>父模板中定义的块在子模板中被重新定义，在子模板中调用父模板的内容可以使用super()</li>
</ul>
<h4 id="父模板"><a href="#父模板" class="headerlink" title="父模板"></a>父模板</h4><p>base.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block top %&#125;</span><br><span class="line">  顶部菜单</span><br><span class="line">&#123;% endblock top %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">&#123;% endblock content %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block bottom %&#125;</span><br><span class="line">  底部</span><br><span class="line">&#123;% endblock bottom %&#125;</span><br></pre></td></tr></table></figure>

<h4 id="子模板"><a href="#子模板" class="headerlink" title="子模板"></a>子模板</h4><p>extends指令声明这个模板继承自哪</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#39;base.html&#39; %&#125;</span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"> 需要填充的内容</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>

<p>模板继承使用时注意点：</p>
<ol>
<li>不支持多继承</li>
<li>为了便于阅读，在子模板中使用extends时，尽量写在模板的第一行。</li>
<li>不能在一个模板文件中定义多个相同名字的block标签。</li>
<li>当在页面中使用多个block标签时，建议给结束标签起个名字，当多个block嵌套时，阅读性更好。</li>
</ol>
<h3 id="包含"><a href="#包含" class="headerlink" title="包含"></a>包含</h3><p><code>Jinja2</code>模板中，除了宏和继承，还支持一种代码重用的功能，叫包含(Include)。它的功能是将<strong>另一个模板整个加载到当前模板中，并直接渲染。</strong></p>
<p>1、include的使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include &#39;hello.html&#39; %&#125;</span><br></pre></td></tr></table></figure>

<p>包含在使用时，如果包含的模板文件不存在时，程序会抛出TemplateNotFound异常，可以加上 <code>ignore missing</code> 关键字。如果包含的模板文件不存在，会忽略这条include语句。</p>
<p>2、include 的使用加上关键字ignore missing</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include &#39;hello.html&#39; ignore missing %&#125;</span><br></pre></td></tr></table></figure>

<p><strong>小结：</strong></p>
<ol>
<li>宏(Macro)、继承(Block)、包含(include)均能实现代码的复用。</li>
<li>继承(Block)的本质是代码替换，一般用来实现多个页面中重复不变的区域。</li>
<li>宏(Macro)的功能类似函数，可以传入参数，需要定义、调用。</li>
<li>包含(include)是直接将目标模板文件整个渲染出来。</li>
</ol>
<h1 id="Flask-静态文件"><a href="#Flask-静态文件" class="headerlink" title="Flask 静态文件"></a>Flask 静态文件</h1><p> Web应用程序通常需要静态文件，例如<strong>javascript</strong>文件或支持网页显示的<strong>CSS</strong>文件。通常，配置Web服务器并为您提供这些服务，但在开发过程中，这些文件是从您的包或模块旁边的<code>static</code>文件夹中提供，它将在应用程序的<strong>/static</strong>中提供。</p>
<p>特殊端点<code>static</code>用于生成静态文件的URL。</p>
<p>在下面的示例中，在<strong>index.html</strong>中的HTML按钮的<strong>OnClick</strong>事件上调用<strong>hello.js</strong>中定义的<strong>javascript</strong>函数，该函数在Flask应用程序的<strong>“/”</strong>URL上呈现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, render_template</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;&#x2F;&quot;)</span><br><span class="line">def index():</span><br><span class="line">   return render_template(&quot;index.html&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">   app.run(debug &#x3D; True)</span><br></pre></td></tr></table></figure>

<p><strong>index.html</strong>的HTML脚本如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">   &lt;head&gt;</span><br><span class="line">      &lt;script type &#x3D; &quot;text&#x2F;javascript&quot; src &#x3D; &quot;&#123;&#123; url_for(&#39;static&#39;, filename &#x3D; &#39;hello.js&#39;) &#125;&#125;&quot; &gt;		&lt;&#x2F;script&gt;</span><br><span class="line">   &lt;&#x2F;head&gt;</span><br><span class="line">   &lt;body&gt;</span><br><span class="line">      &lt;input type &#x3D; &quot;button&quot; onclick &#x3D; &quot;sayHello()&quot; value &#x3D; &quot;Say Hello&quot; &#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;body&gt; </span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Hello.js</strong>包含<strong>sayHello()</strong>函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function sayHello() &#123;</span><br><span class="line">   alert(&quot;Hello World&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Flask-蓝图"><a href="#Flask-蓝图" class="headerlink" title="Flask 蓝图"></a>Flask 蓝图</h1><h2 id="什么是蓝图"><a href="#什么是蓝图" class="headerlink" title="什么是蓝图"></a>什么是蓝图</h2><p><code>蓝图（blueprint）</code>：用于实现单个应用的视图、模板、静态文件的集合</p>
<p>蓝图就是模块化处理的类。类似于django中app，子应用。简单来说，蓝图就是一个存储操作路由映射方法的容器，主要用来实现客户端请求和URL相互关联的功能。 在<code>Flask</code>中，将项目模块化(<strong>把写在一个文件里的路由拆封成多个文件里写路由</strong>)，blueprint，是flask自带的一种开发模式，目的是为了方便开发大型的项目</p>
<h2 id="蓝图的运行机制"><a href="#蓝图的运行机制" class="headerlink" title="蓝图的运行机制"></a>蓝图的运行机制</h2><p>蓝图是保存了一组将来可以在应用对象上执行的操作。</p>
<p>注册路由就是一种操作,当在程序实例上调用<code>route</code>装饰器注册路由时，这个操作将修改对象的<code>url_map</code>路由映射列表。当我们在蓝图对象上调用<code>route</code>装饰器注册路由时，它只是在内部的一个延迟操作记录列表<code>defered_functions</code>中添加了一个项。当执行应用对象的 <code>register_blueprint()</code> 方法时，应用对象从蓝图对象的 <code>defered_functions</code> 列表中取出每一项，即调用应用对象的 <code>add_url_rule()</code>方法，这将会修改程序实例的路由映射列表。</p>
<h2 id="蓝图的使用"><a href="#蓝图的使用" class="headerlink" title="蓝图的使用"></a>蓝图的使用</h2><ol>
<li><p>创建项目并设置settings.py文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># app配置类</span><br><span class="line">class Config:</span><br><span class="line">    # 步骤3 - 现在创建一个Flask应用程序对象并为要使用的数据库设置URI。</span><br><span class="line">    DEBUG &#x3D; True</span><br><span class="line">    # mysql+pymysql:&#x2F;&#x2F;user:password@hostip:port&#x2F;databasename</span><br><span class="line">    SQLALCHEMY_DATABASE_URI &#x3D; &#39;mysql+pymysql:&#x2F;&#x2F;root:1234561@172.16.0.192:3306&#x2F;flaskday05&#39;</span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS &#x3D; False</span><br><span class="line">    SQLALCHEMY_ECHO &#x3D; True</span><br><span class="line"></span><br><span class="line"># 开发环境</span><br><span class="line">class DevelopmentConfig(Config):</span><br><span class="line">    ENV &#x3D; &#39;development&#39;</span><br><span class="line"></span><br><span class="line"># 生产环境</span><br><span class="line">class ProductionConfig(Config):</span><br><span class="line">    ENV &#x3D; &#39;production&#39;</span><br><span class="line">    DDEBUG &#x3D; False</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除app.py中的部分内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">from flask_migrate import Migrate, MigrateCommand</span><br><span class="line">from flask_script import Manager</span><br><span class="line"></span><br><span class="line">from apps import create_app</span><br><span class="line">from exts import db</span><br><span class="line"></span><br><span class="line">app &#x3D; create_app()</span><br><span class="line"></span><br><span class="line"># flask-script</span><br><span class="line">manager &#x3D; Manager(app&#x3D;app)</span><br><span class="line"># 使用里面的Manager进行命令得到管理和使用：</span><br><span class="line">migrate &#x3D; Migrate(app&#x3D;app, db&#x3D;db)</span><br><span class="line">manager.add_command(&#39;db&#39;, MigrateCommand)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建包apps,并在包中<code>__init__.py</code>中创建app的工厂函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> apps.user.view <span class="keyword">import</span> user_bp</span><br><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">()</span>:</span></span><br><span class="line">    app = Flask(__name__, template_folder=<span class="string">'../templates'</span>, static_folder=<span class="string">'../static'</span>)  <span class="comment"># app是一个核心对象</span></span><br><span class="line">    <span class="comment"># 加载配置</span></span><br><span class="line">    app.config.from_object(settings.DevelopmentConfig)</span><br><span class="line">    <span class="comment"># 初始化配置db</span></span><br><span class="line">    db.init_app(app=app)</span><br><span class="line">    <span class="comment"># 注册蓝图</span></span><br><span class="line">    <span class="comment"># app.register_blueprint(user_bp) # 将蓝图对象绑定到app上</span></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>
</li>
<li><p>在apps中创建项目的程序包比如user，goods，order等</p>
</li>
<li><p>以user为例，在user包中创建view.py，在view.py中<code>定义蓝图</code></p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user_bp &#x3D; Blueprint(&#39;user&#39;, __name__)</span><br><span class="line"># 其中第一个参数是蓝图的名字，第二个参数是import_name</span><br></pre></td></tr></table></figure></code></pre></li>
<li><p>使用蓝图定义路由和视图函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@user_bp.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_center</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'user/show.html'</span>, users=users)</span><br></pre></td></tr></table></figure>

<p>注意在蓝图中进行了模板的加载，而模板的文件夹默认是跟flask对象是同级的，如果不是同级的注意在Flask对象创建的时候初始化设置</p>
</li>
<li><p>注册蓝图到app对象上,在<code>__init__.py</code>方法<code>create_app()</code>中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 注册蓝图</span><br><span class="line"># app.register_blueprint(user_bp) # 将蓝图对象绑定到app上</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="Flask-Script"><a href="#Flask-Script" class="headerlink" title="Flask-Script"></a>Flask-Script</h1><p><strong>Flask-Script是一个让你的命令行支持自定义命令的工具，它为Flask程序添加一个命令行解释器。可以让我们的程序从命令行直接执行相应的程序</strong>。</p>
<p>通过使用<code>Flask-Script</code>扩展，我们可以在Flask服务器启动的时候，通过命令行的方式传入参数。而不仅仅通过<code>app.run</code>()方法中传参，比如我们可以通过<code>python hello.py runserver –h ip地址 -p 端口</code>地址，告诉服务器在哪个网络接口监听来自客户端的连接。默认情况下，服务器只监听来自服务器所在计算机发起的连接，即<code>localhost</code>连接。我们可以通过<code>python hello.py runserver --help</code>来查看参数。</p>
<p><code>Flask-Script</code>插件为在Flask里编写额外的脚本提供了支持。包括了一个开发服务器，一个定制的Python命令行，用于执行初始化数据库、定时任务和其他属于web应用之外的命令行任务的脚本</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-script</span><br></pre></td></tr></table></figure>

<h2 id="集成Flask-Script到falsk应用中"><a href="#集成Flask-Script到falsk应用中" class="headerlink" title="集成Flask-Script到falsk应用中"></a>集成Flask-Script到falsk应用中</h2><p><code>app.py</code>文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;使用flask-script启动项目&quot;&quot;&quot;</span><br><span class="line">from flask_script import Manager</span><br><span class="line"></span><br><span class="line"># 使用里面的Manager进行命令得到管理和使用：</span><br><span class="line">manager &#x3D; Manager(app&#x3D;app)</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;&#39;)</span><br><span class="line">def index():</span><br><span class="line">    return &#39;hello world&#39;</span><br><span class="line"></span><br><span class="line">if  __name__ &#x3D;&#x3D; &quot;__main__&quot;</span><br><span class="line">	# 使用manager启动</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure>

<p>在终端使用命令启动:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python app.py runserver</span><br></pre></td></tr></table></figure>

<p>设置主机和端口启动:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python app.py runserver -h 0.0.0.0 -p 5001</span><br></pre></td></tr></table></figure>

<h2 id="自定义命令"><a href="#自定义命令" class="headerlink" title="自定义命令"></a>自定义命令</h2><p>使用<code>@manager.command</code>装饰器,<strong>注意:</strong>必须要引入当前的app对象(即<code>Flask</code>的初始化对象,app只是一个变量名)，然后传入给<code>Manager</code>对象,赋值给一个变量为<code>manager</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 装饰命令的功能添加到注册表中</span><br><span class="line">@manager.command</span><br><span class="line">def init():</span><br><span class="line">    print(&#39;初始化&#39;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@manager.command</code>中的manager为Manager对象的变量引用,只要遵循变量的命令规则即可使用</p>
</blockquote>
<p>终端:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python app.py init</span><br></pre></td></tr></table></figure>

<p>#Flask-migrate</p>
<p>Flask-Migrate 插件提供了和 Django 自带的 migrate 类似的功能。</p>
<p>即 Alembic（<code>Database migration</code>数据迁移跟踪记录）提供的数据库升级和降级的功能。它所能实现的效果有如 Git 管理项目代码一般。</p>
<h3 id="安装-Flask-Migrate"><a href="#安装-Flask-Migrate" class="headerlink" title="安装 Flask-Migrate"></a>安装 Flask-Migrate</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-migrate</span><br></pre></td></tr></table></figure>

<blockquote>
<p>多数情况下 <code>Flask-Migrate</code> 是会和命令行工具插件 <code>Flask-Script</code> 和数据库插件 <code>flask_sqlalchemy</code> 一起使用的，所有也把 Flask-Script 安装一下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-script</span><br></pre></td></tr></table></figure>

<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>官方文档给出的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate, MigrateCommand</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SQLALCHEMY_DATABASE_URI'</span>] = <span class="string">'sqlite:///app.db'</span></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 migrate</span></span><br><span class="line"><span class="comment"># 两个参数一个是 Flask 的 app，一个是数据库 db</span></span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化管理器</span></span><br><span class="line">manager = Manager(app)</span><br><span class="line"><span class="comment"># 添加 db 命令，并与 MigrateCommand 绑定</span></span><br><span class="line">manager.add_command(<span class="string">'db'</span>, MigrateCommand)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建我们的数据模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">128</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure>

<p>假设上面的代码保存在文件 <code>manage.py</code> 中，我们可以这样执行相关命令：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ python manage.py db init</span><br><span class="line">$ python manage.py db migrate</span><br><span class="line">$ python manage.py db upgrade</span><br><span class="line">$ python manage.py db --help</span><br></pre></td></tr></table></figure>

<p>当然，更多情况下我们不会把代码都放到一个文件里面，我们应该建立一个 <code>manage.py</code> 来放置相关代码，详细源码我传到 Github 上面：<a href="https://github.com/SingleDiego/flask-migrate" target="_blank" rel="noopener">https://github.com/SingleDiego/flask-migrate</a> </p>
<h3 id="查看指令-manager-db-的可用选项"><a href="#查看指令-manager-db-的可用选项" class="headerlink" title="查看指令 manager db 的可用选项"></a>查看指令 manager db 的可用选项</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; python manage.py db</span><br><span class="line">usage: Perform database migrations</span><br><span class="line"></span><br><span class="line">Perform database migrations</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  &#123;init,revision,migrate,edit,merge,upgrade,downgrade,show,history,heads,branches,current,stamp&#125;</span><br><span class="line">    init                创建新的迁移存储库</span><br><span class="line">    revision           	创建新修订文件。.</span><br><span class="line">    migrate             “修订--自动生成”的别名</span><br><span class="line">    edit                编辑当前版本。</span><br><span class="line">    merge				将两个修订合并在一起。创建新迁移文件</span><br><span class="line">    upgrade             升级到更高版本</span><br><span class="line">    downgrade           还原为以前的版本</span><br><span class="line">    show                显示用给定符号表示的修订。</span><br><span class="line">    history             按时间顺序列出变更集脚本。</span><br><span class="line">    heads               在脚本目录中显示当前可用的头</span><br><span class="line">    branches            显示当前分支点</span><br><span class="line">    current             显示每个数据库的当前修订。</span><br><span class="line">    stamp               在修订表上“盖章”给定版本；不要运行任何迁移</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -?, --help            show this help message <span class="keyword">and</span> <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<h3 id="初始化-DB-Migrate"><a href="#初始化-DB-Migrate" class="headerlink" title="初始化 DB Migrate"></a>初始化 DB Migrate</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; python manage.py db init</span><br></pre></td></tr></table></figure>

<p>执行该命令后会创建一个 <code>migrations</code> 目录，所有的更改记录文件都会被保存在该目录下。</p>
<h3 id="开始第一次跟踪"><a href="#开始第一次跟踪" class="headerlink" title="开始第一次跟踪"></a>开始第一次跟踪</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; python manage.py db migrate -m <span class="string">"Initial migration"</span></span><br></pre></td></tr></table></figure>

<p>该指令会扫描所有的 SQLAlchemy 对象，并将没有记录过的行和列记录成为一个 python 文件并保存到 <code>migrations/versions</code> 路径下。<code>-m 的描述相对于提交说明,会在版本文件_后显示</code>然后给本次扫描结果分配一个版本号。生成的数据库会有一张名为 <code>alembic_version</code> 的空表来记录数据库版本号。</p>
<p>例如，我的例子中第一个版本的版本号就是： <code>6c1971cccc11_initial_migration.py</code>，打开该文件，可以看到该文件记录了数据库的结果，比如这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># ### commands auto generated by Alembic - please adjust! ###</span></span><br><span class="line">    op.create_table(<span class="string">'user'</span>,</span><br><span class="line">    sa.Column(<span class="string">'id'</span>, sa.Integer(), nullable=<span class="literal">False</span>),</span><br><span class="line">    sa.Column(<span class="string">'name'</span>, sa.String(length=<span class="number">128</span>), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.PrimaryKeyConstraint(<span class="string">'id'</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># ### end Alembic commands ###</span></span><br></pre></td></tr></table></figure>

<h3 id="根据记录文件生成数据库"><a href="#根据记录文件生成数据库" class="headerlink" title="根据记录文件生成数据库"></a>根据记录文件生成数据库</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; python manage.py db upgrade</span><br></pre></td></tr></table></figure>

<p>该命令会根据 <code>migrations/versions</code> 路径下的文件来创建或修改数据库，生成的数据库会有一张名为 <code>alembic_version</code> 的表来记录数据库版本号。</p>
<h3 id="回滚到某历史版本"><a href="#回滚到某历史版本" class="headerlink" title="回滚到某历史版本"></a>回滚到某历史版本</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取 History ID</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; python manage.py db history</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到某个 history</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; python manage.py db downgrade &lt;history_id&gt;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>flask_migrate</code>相关的命令： </p>
<ul>
<li><code>python manage.py db init</code>：初始化一个迁移脚本的环境，只需要执行一次。</li>
<li><code>python manage.py db migrate</code>：将模型生成迁移文件，只要模型更改了，就需要执行一遍这个命令。</li>
<li><code>python manage.py db upgrade</code>：将迁移文件真正的映射到数据库中。每次运行了<code>migrate</code>命令后，就记得要运行这个命令。</li>
</ul>
<h2 id="问题一-修改字段长度无法迁移"><a href="#问题一-修改字段长度无法迁移" class="headerlink" title="问题一:修改字段长度无法迁移"></a>问题一:修改字段长度无法迁移</h2><blockquote>
<p>使用<code>flask-migrate</code>进行数据库迁移时，如果更改db.String()的长度？该如何同步</p>
</blockquote>
<p>比如有一个简单的模型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class User(db.Model):</span><br><span class="line">    id &#x3D; db.Column(db.Integer, primary_key&#x3D;True)</span><br><span class="line">    username &#x3D; db.Column(db.String(32), index&#x3D;True)</span><br></pre></td></tr></table></figure>

<p>一开始，<code>username</code>的长度限制在32,现在将其增大，比如说变为128，<code>flask-migrate</code>似乎不会检测到这个<code>String</code>变长的变化。</p>
<p>我使用了命令自动生成迁移脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python app.py db migrate -m &quot;some comment&quot;</span><br><span class="line">python app.py db upgrade</span><br></pre></td></tr></table></figure>

<p>之后，发现<code>username</code>的列的长度依旧被限制在32.</p>
<p><strong>如何进行String长度的变化这种迁移？</strong></p>
<blockquote>
<p>解决问题:</p>
<p><code>alem­bic</code> 支持检测字段长度改变，不过它不是默认的，需要配置；找到 <code>mi­gra­tions/env.py</code>文件，在 <code>run_mi­gra­tions_on­line</code> 函数(<code>87行左右</code>)加入如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">context.configure(</span><br><span class="line">    connection&#x3D;connection,</span><br><span class="line">    target_metadata&#x3D;target_metadata,</span><br><span class="line">    process_revision_directives&#x3D;process_revision_directives,</span><br><span class="line">    compare_type&#x3D;True,  # 检查字段类型</span><br><span class="line">    compare_server_default&#x3D;True,  # 比较默认值</span><br><span class="line">    **current_app.extensions[&#39;migrate&#39;].configure_args</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>重新进行模型迁移</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py db migrate</span><br></pre></td></tr></table></figure>

<p>查看 up­grade 函数内，可以发现更改的内容已在里面。</p>
</blockquote>
<p>##问题二:Target database is not up to date</p>
<blockquote>
<p>flask-migrate数据迁移添加新的表，执行python manager.py db migrate 出现<code>Target database is not up to date</code>(目标数据库不是最新的。)</p>
</blockquote>
<p>解决:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$: python manager.py db heads    # 1. 查看migrate的状态</span><br><span class="line">$ python manager.py db current   # 2. 查看当前的状态</span><br><span class="line">								 # 3. 发现版本号不一致</span><br><span class="line">$ python manager.py db stamp head  # 4. 更新版本一致</span><br><span class="line">$ python manager.py db migrate	# 5. 将模型生成迁移文件</span><br><span class="line">$ python manager.py db upgrade	# 6. 将迁移文件真正的映射到数据库中</span><br></pre></td></tr></table></figure>

<h1 id="Flask-SQLAlchemy"><a href="#Flask-SQLAlchemy" class="headerlink" title="Flask SQLAlchemy"></a>Flask SQLAlchemy</h1><h2 id="Flask-SQLAlchemy-1"><a href="#Flask-SQLAlchemy-1" class="headerlink" title="Flask SQLAlchemy"></a>Flask SQLAlchemy</h2><p>在<code>Flask Web</code>应用程序中使用原始SQL对数据库执行CRUD操作可能很繁琐。相反， <strong>SQLAlchemy</strong> ，Python工具包是一个强大的<strong>ORMapper</strong>，它为应用程序开发人员提供了SQL的全部功能和灵活性。Flask-SQLAlchemy是Flask扩展，它将对SQLAlchemy的支持添加到Flask应用程序中。</p>
<p><strong>什么是ORM（Object Relation Mapping，对象关系映射）？</strong></p>
<p>大多数编程语言平台是面向对象的。另一方面，RDBMS服务器中的数据存储为表。对象关系映射是将对象参数映射到底层RDBMS表结构的技术。ORM API提供了执行CRUD操作的方法，而不必编写原始SQL语句。</p>
<h2 id="Flask-SQLAlchemy环境搭建"><a href="#Flask-SQLAlchemy环境搭建" class="headerlink" title="Flask SQLAlchemy环境搭建"></a>Flask SQLAlchemy环境搭建</h2><p><strong>步骤1</strong> - 安装<code>Flask-SQLAlchemy</code>扩展。<code>pymysql</code>,<code>flask-migrate</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install pymysql   # mysql连接</span><br><span class="line">pip install flask-migrate  # 发布命令工具</span><br><span class="line">pip install flask-sqlalchemy  # 实现ORM映射</span><br></pre></td></tr></table></figure>

<p><strong>步骤2</strong>-创建<code>settings.py</code>配置数据库的连接路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class Config:</span><br><span class="line">    DEBUG &#x3D; True</span><br><span class="line">    # mysql+pymysql:&#x2F;&#x2F;user:password@hostip:port&#x2F;databasename</span><br><span class="line">    SQLALCHEMY_DATABASE_URI &#x3D; &#39;mysql+pymysql:&#x2F;&#x2F;root:root@127.0.0.1:3306&#x2F;flaskday05&#39;</span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS &#x3D; False</span><br><span class="line">    SQLALCHEMY_ECHO &#x3D; True</span><br><span class="line"></span><br><span class="line">class DevelopmentConfig(Config):</span><br><span class="line">    ENV &#x3D; &#39;development&#39;</span><br><span class="line"></span><br><span class="line">class ProductionConfig(Config):</span><br><span class="line">    ENV &#x3D; &#39;production&#39;</span><br><span class="line">    DDEBUG &#x3D; False</span><br></pre></td></tr></table></figure>

<p><strong>步骤2</strong> - 创建包<code>ext</code>,在<code>__init__.py</code>中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#创建一个映射对象</span><br><span class="line">from flask_sqlalchemy import SQLAlchemy</span><br><span class="line">db &#x3D; SQLAlchemy()  # 必须跟app联系</span><br></pre></td></tr></table></figure>

<p><strong>步骤3</strong> - 创建包<code>apps</code>,在<code>__init__.py</code>中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line"></span><br><span class="line">import settings</span><br><span class="line"># 敲黑板：需要将你想要映射到数据库中的模型，都要导入到manage(app).py文件中，如果没有导入进去，就不会映射到数据库中</span><br><span class="line">from apps.user.view import user_bp</span><br><span class="line">from ext import db</span><br><span class="line"></span><br><span class="line">def create_app():</span><br><span class="line">    app &#x3D; Flask(__name__, template_folder&#x3D;&#39;..&#x2F;templates&#39;, static_folder&#x3D;&#39;..&#x2F;static&#39;)</span><br><span class="line">    app.config.from_object(settings.DevelopmentConfig)</span><br><span class="line">    db.init_app(app)  # 将db对象与app进行了关联</span><br><span class="line">    # 注册蓝图</span><br><span class="line">    app.register_blueprint(user_bp)</span><br><span class="line">    return app</span><br></pre></td></tr></table></figure>

<p><strong>步骤4</strong> - 在<code>app.py</code>配置<code>flask-migrate</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">from flask_migrate import Migrate, MigrateCommand</span><br><span class="line">from flask_script import Manager</span><br><span class="line">from apps.user.models import User,UserInfo</span><br><span class="line">from apps import create_app</span><br><span class="line">from ext import db</span><br><span class="line"></span><br><span class="line">app &#x3D; create_app()</span><br><span class="line">manager &#x3D; Manager(app&#x3D;app)</span><br><span class="line"># flask-migrate命令工具</span><br><span class="line">migrate &#x3D; Migrate(app&#x3D;app, db&#x3D;db)</span><br><span class="line">manager.add_command(&#39;db&#39;, MigrateCommand)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure>

<p><strong>步骤5</strong>- 然后使用应用程序对象作为参数创建<code>SQLAlchemy</code>类的对象。该对象包含用于<code>ORM</code>操作的辅助函数。它还提供了一个父<code>Model</code>类，使用它来声明用户定义的模型。在下面的代码段中，创建了<strong>students</strong>模型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># ORM   类 ----》 表</span><br><span class="line"># 类对象  ---〉表中的一条记录</span><br><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line">from ext import db</span><br><span class="line"></span><br><span class="line">#相当于SQL:create table user(id int primarykey auto_increment,username varchar(20) not null,..)</span><br><span class="line">class User(db.Model):</span><br><span class="line">    # db.Column(类型，约束)  映射表中的列</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    类型： </span><br><span class="line">    Integer        整型</span><br><span class="line">    String(size)   字符串类型，务必指定大小</span><br><span class="line">    Text          长文本类型</span><br><span class="line">    DateTime       日期时间</span><br><span class="line">    Float         浮点类型</span><br><span class="line">    Boolean        布尔类型</span><br><span class="line">    PickleType     存储pickle类型  主要跟序列化有关</span><br><span class="line">    LargeBinary    存储大的二进制类型</span><br><span class="line">    </span><br><span class="line">    可选的：</span><br><span class="line">    primary_key&#x3D;True   主键</span><br><span class="line">    autoincrement&#x3D;True  自增</span><br><span class="line">    nullable&#x3D;False      不允许为空</span><br><span class="line">    unique&#x3D;True         唯一</span><br><span class="line">    default&#x3D;datetime.now  默认值  可以设置成当前系统时间或者其他的值</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    id &#x3D; db.Column(db.Integer, primary_key&#x3D;True, autoincrement&#x3D;True)</span><br><span class="line">    username &#x3D; db.Column(db.String(15), nullable&#x3D;False)</span><br><span class="line">    password &#x3D; db.Column(db.String(12), nullable&#x3D;False)</span><br><span class="line">    phone &#x3D; db.Column(db.String(11), unique&#x3D;True)</span><br><span class="line">    email &#x3D; db.Column(db.String(20))</span><br><span class="line">    rdatetime &#x3D; db.Column(db.DateTime, default&#x3D;datetime.now)</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.username</span><br><span class="line"></span><br><span class="line">class UserInfo(db.Model):</span><br><span class="line">    id &#x3D; db.Column(db.Integer, primary_key&#x3D;True, autoincrement&#x3D;True)</span><br><span class="line">    realname &#x3D; db.Column(db.String(20))</span><br><span class="line">    gender &#x3D; db.Column(db.Boolean, default&#x3D;False)</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.realname</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>敲黑板</strong>：需要将你想要映射到数据库中的模型，都要导入到<code>manage(app).py</code>文件中，如果没有导入进去，就不会映射到数据库中</p>
</blockquote>
<p><strong>步骤5</strong> - 在终端使用<code>db</code>命令生成数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python app.py db init   -----》 产生一个文件夹migrations</span><br><span class="line">python app.py db migrate -----&gt; 在versions文件夹下自动产生了一个.py的版本文件</span><br></pre></td></tr></table></figure>

<p><strong>项目结构</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">| ---apps</span><br><span class="line">| ---ext</span><br><span class="line">| ---static</span><br><span class="line">| ---templates</span><br><span class="line">| ---migrations      # python app.py db init  只需要init一次</span><br><span class="line">    |---versions   版本文件夹</span><br><span class="line">        |---71edde7ee937_.py    ---》  python app.py db migrate  迁移</span><br><span class="line">        |---cc0dca61130f_.py</span><br><span class="line">                    # python app.py db upgrade   根据记录文件生成数据库</span><br><span class="line">                    # python app.py db downgrade 回滚到某历史版本</span><br></pre></td></tr></table></figure>

<h2 id="测试添加数据"><a href="#测试添加数据" class="headerlink" title="测试添加数据"></a>测试添加数据</h2><p>添加数据：以注册用户为例</p>
<ol>
<li><p>在templates文件夹中创建user/register.html页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">'&#123;&#123; url_for('</span><span class="attr">user.register</span>') &#125;&#125;' <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">placeholder</span>=<span class="string">"用户名"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"密码"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"repassword"</span> <span class="attr">placeholder</span>=<span class="string">"确认密码"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"phone"</span> <span class="attr">placeholder</span>=<span class="string">"手机号码"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"用户注册"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200805172125.png" alt=""></p>
</li>
<li><p>在apps包下创建<code>user/view.py</code>文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, request, render_template</span><br><span class="line"><span class="keyword">from</span> apps.user.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> ext <span class="keyword">import</span> db</span><br><span class="line">user_bp = Blueprint(<span class="string">'user'</span>, __name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@user_bp.route('/register', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        username = request.form.get(<span class="string">'username'</span>)</span><br><span class="line">        password = request.form.get(<span class="string">'password'</span>)</span><br><span class="line">        repassword = request.form.get(<span class="string">'repassword'</span>)</span><br><span class="line">        phone = request.form.get(<span class="string">'phone'</span>)</span><br><span class="line">        <span class="keyword">if</span> password == repassword:</span><br><span class="line">            <span class="comment"># 1. 找到模型类并创建对象</span></span><br><span class="line">            user = User()</span><br><span class="line">            <span class="comment"># 2. 给对象的属性赋值</span></span><br><span class="line">            user.username = username</span><br><span class="line">            user.password = hashlib.sha256(password.encode(<span class="string">'utf-8'</span>)).hexdigest()</span><br><span class="line">            user.phone = phone</span><br><span class="line">            <span class="comment"># 3. 将user对象添加到session中（类似缓存）</span></span><br><span class="line">            db.session.add(user)</span><br><span class="line">            <span class="comment"># 4.提交数据</span></span><br><span class="line">            db.session.commit()</span><br><span class="line">            <span class="comment"># 在使用蓝图的情况下使用url_for(),必须带有蓝图名</span></span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'user.user_center'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'user/register.html'</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意:在view中定义了蓝图,需要在app对象中进行注册 <code># app.register_blueprint(user_bp)</code></p>
</blockquote>
</li>
<li><p>center.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户中心<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; url_for('user.register') &#125;&#125;"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; url_for('user.login') &#125;&#125;"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>所有用户信息如下：<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;% if users %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"1"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"50%"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>序号<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>手机号<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>注册时间<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            &#123;% for user in users %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>&#123;&#123; loop.index &#125;&#125;<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>&#123;&#123; user.username &#125;&#125;<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>&#123;&#123; user.phone &#125;&#125;<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>&#123;&#123; user.rdatetime &#125;&#125;<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>更新<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"color: red; font-size: 20px;"</span>&gt;</span>当前还没有任何的用户，抓紧时间注册吧！！！<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200805172256.png" alt=""></p>
</li>
</ol>
<h2 id="CRUD方法"><a href="#CRUD方法" class="headerlink" title="CRUD方法"></a>CRUD方法</h2><p><strong>SQLAlchemy</strong>的<strong>Session</strong>对象管理<strong>ORM</strong>对象的所有持久性操作。</p>
<p>以下<code>session</code>方法执行CRUD操作：</p>
<ul>
<li><strong>db.session.add</strong> (模型对象) - 将记录插入到映射表中</li>
<li><strong>db.session.delete</strong> (模型对象) - 从表中删除记录</li>
<li><strong>model.query.all()</strong> - 从表中检索所有记录（对应于<code>select * from user</code>）。</li>
</ul>
<p>您可以通过使用<code>filter</code>属性将过滤器应用于检索到的记录集。例如，要在学生表中检索<strong>city =’Hyderabad’</strong>的记录，请使用以下语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Students.query.filter_by(city &#x3D; ’Hyderabad’).all()</span><br></pre></td></tr></table></figure>

<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>1)查询所有： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">模型类.query.all()    ~  select * from user;</span><br></pre></td></tr></table></figure>

<p>2)如果有条件的查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">模型类.query.filter_by(字段名 &#x3D; 值)   ～  select * from user where 字段&#x3D;值；</span><br><span class="line">模型类.query.filter_by(字段名 &#x3D; 值).first()   ～  select * from user where 字段&#x3D;值 limit..</span><br></pre></td></tr></table></figure>

<p>3)模型类.query.filter()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. 模型类.query.filter().all()   -----&gt; 列表</span><br><span class="line">2. 模型类.query.filter().first()  -----&gt;对象</span><br><span class="line">3.  User.query.filter(User.username.endswith(&#39;z&#39;)).all()  </span><br><span class="line">	select * from user where username like &#39;%z&#39;;</span><br><span class="line">    User.query.filter(User.username.startswith(&#39;z&#39;)).all() </span><br><span class="line">    # select * from user where username like &#39;z%&#39;;</span><br><span class="line">    User.query.filter(User.username.contains(&#39;z&#39;)).all() </span><br><span class="line">    # select * from user where username like &#39;%z%&#39;;</span><br><span class="line">  User.query.filter(User.username.like(&#39;z%&#39;)).all()</span><br></pre></td></tr></table></figure>

<p>4)多条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">并且： and_    获取： or_   非： not_</span><br><span class="line"></span><br><span class="line">1. User.query.filter(or_(User.username.like(&#39;z%&#39;), User.username.contains(&#39;i&#39;))).all()</span><br><span class="line">类似： select * from user where username like &#39;z%&#39; or username like &#39;%i%&#39;;</span><br><span class="line">2. User.query.filter(and_(User.username.contains(&#39;i&#39;), User.rdatetime.__gt__(&#39;2020-05-25 10:30:00&#39;))).all()</span><br><span class="line"> # select * from user where username like &#39;%i%&#39; and rdatetime &lt; &#39;xxxx&#39;</span><br><span class="line">3. User.query.filter(not_(User.username.contains(&#39;i&#39;))).all()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>补充：<code>__gt__,__lt__,__ge__(gt equal),__le__</code>（le equal）  —-》通常应用在范围（整型，日期） 也可以直接使用 &gt;  &lt;  &gt;=  &lt;=  !=</p>
</blockquote>
<p>5)排序：order_by</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user_list &#x3D; User.query.filter(User.username.contains(&#39;z&#39;)).order_by(-User.rdatetime).all() </span><br><span class="line"># 先筛选再排序</span><br><span class="line">user_list &#x3D; User.query.order_by(-User.id).all()  对所有的进行排序</span><br><span class="line">注意：order_by(参数)：</span><br><span class="line">1. 直接是字符串： &#39;字段名&#39;  但是不能倒序</span><br><span class="line">2. 填字段名： 模型.字段    order_by(-模型.字段)  倒序</span><br></pre></td></tr></table></figure>

<p>6)限制： limit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># limit的使用 + offset</span><br><span class="line"># user_list &#x3D; User.query.limit(2).all()   默认获取前两条</span><br><span class="line">user_list &#x3D; User.query.offset(2).limit(2).all()   跳过2条记录再获取两条记录</span><br></pre></td></tr></table></figure>

<p><strong>总结:</strong></p>
<ol>
<li>User.query.all()  所有</li>
<li>User.query.get(pk)  一个</li>
<li>User.query.filter() <ul>
<li>如果要检索的字段是字符串（varchar，db.String）:<ul>
<li>User.username.startswith(‘’)</li>
<li>User.username.endswith(‘’)</li>
<li>User.username.contains(‘’)</li>
<li>User.username.like(‘’)</li>
<li>User.username.in_([‘’,’’,’’])</li>
<li>User.username == ‘zzz’</li>
</ul>
</li>
<li>如果要检索的字段是整型或者日期类型：<ul>
<li><code>User.age.__lt__(18)</code></li>
<li><code>User.rdatetime.__gt__(&#39;.....&#39;)</code></li>
<li><code>User.age.__le__(18)</code></li>
<li><code>User.age.__ge__(18)</code></li>
<li><code>User.age.between(15,30)</code></li>
</ul>
</li>
<li>多个条件一起检索：<code>and_, or_</code></li>
<li>非的条件： <code>not_</code></li>
<li>排序：order_by()</li>
<li>获取指定数量： limit() offset()</li>
</ul>
</li>
<li>User.query.filter_by()</li>
</ol>
<h3 id="添加"><a href="#添加" class="headerlink" title="添加"></a>添加</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 1. 找到模型类并创建对象</span><br><span class="line">user &#x3D; User()</span><br><span class="line"># 2. 给对象的属性赋值</span><br><span class="line">user.username &#x3D; username</span><br><span class="line">user.password &#x3D; hashlib.sha256(password.encode(&#39;utf-8&#39;)).hexdigest()</span><br><span class="line">user.phone &#x3D; phone</span><br><span class="line"># 3. 将user对象添加到session中（类似缓存）</span><br><span class="line">db.session.add(user)</span><br><span class="line"># 4.提交数据</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>

<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><h4 id="逻辑删除"><a href="#逻辑删除" class="headerlink" title="逻辑删除"></a>逻辑删除</h4><p>逻辑删除（定义数据库中的表的时候，添加一个字段isdelete，通过此字段控制是否删除）,实际上是更新操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id &#x3D; request.args.get(id)</span><br><span class="line">user &#x3D; User.query.get(id)</span><br><span class="line">user.isdelete &#x3D; True</span><br><span class="line"># 提交更改</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>

<p>####物理删除</p>
<p>物理删除(彻底从数据库中删掉)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id &#x3D; request.args.get(id)</span><br><span class="line">user &#x3D; User.query.get(id)</span><br><span class="line">db.session.delete(user)</span><br><span class="line"># 提交更改</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>

<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">id &#x3D; request.args.get(id)</span><br><span class="line">user &#x3D; User.query.get(id)</span><br><span class="line"># 修改对象的属性</span><br><span class="line">user.username&#x3D; xxxx</span><br><span class="line">user.phone &#x3D;xxxx</span><br><span class="line"># 提交更改</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>

<h3 id="分页paginate"><a href="#分页paginate" class="headerlink" title="分页paginate"></a>分页paginate</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@user_bp.route(&#39;&#x2F;&#39;)</span><br><span class="line">def index():</span><br><span class="line">    page &#x3D; int(request.args.get(&#39;page&#39;, 1))</span><br><span class="line">    pagination &#x3D; Article.query.order_by(-Article.pdatetime).paginate(page&#x3D;page, per_page&#x3D;3)</span><br><span class="line">    print(pagination.items)  # [&lt;Article 4&gt;, &lt;Article 3&gt;, &lt;Article 2&gt;]</span><br><span class="line">    print(pagination.page)  # 当前的页码数</span><br><span class="line">    print(pagination.prev_num)  # 当前页的前一个页码数</span><br><span class="line">    print(pagination.next_num)  # 当前页的后一页的页码数</span><br><span class="line">    print(pagination.has_next)  # True</span><br><span class="line">    print(pagination.has_prev)  # True</span><br><span class="line">    print(pagination.pages)  # 总共有几页</span><br><span class="line">    print(pagination.total)  # 总的记录条数</span><br><span class="line">    return render_template(&#39;user&#x2F;index.html&#39;, user&#x3D;user, types&#x3D;types, pagination&#x3D;pagination)</span><br></pre></td></tr></table></figure>

<p>为了显示某页中的记录，要把 <code>all()</code>换成 Flask-SQLAlchemy 提供的<code>paginate()</code> 方法。页 数是 <code>paginate()</code>方法的第一个参数，也是唯一必需的参数。可选参数 <code>per_page</code>用来指定 每页显示的记录数量；如果没有指定，则默认显示 20 个记录。另一个可选参数为 error_ out，当其设为 True 时（默认值），如果请求的页数超出了范围，则会返回 404 错误；如果 设为 False，页数超出范围时会返回一个空列表。</p>
<p><code>paginate()</code>方法的返回值是一个 <code>Pagination</code> 类对象，这个类在 Flask-SQLAlchemy 中定义。 这个对象包含很多属性，用于在模板中生成分页链接，因此将其作为参数传入了模板。</p>
<ul>
<li>print(pagination.items)  # 当前页面中的记录</li>
<li>print(pagination.query) # 分页的源查询 </li>
<li>print(pagination.page)  # 当前的页码数</li>
<li>print(pagination.prev_num)  # 当前页的前一个页码数</li>
<li>print(pagination.next_num)  # 当前页的后一页的页码数</li>
<li>print(pagination.has_next)  #  如果有下一页,返回True</li>
<li>print(pagination.has_prev)  # 如果有上一页,返回True</li>
<li>print(pagination.pages)  # 查询得到的总页数</li>
<li>print(pagination.total)  # 总的记录条数</li>
<li>print(pagination.per_page)  # 每页显示的记录数</li>
</ul>
<h1 id="Flask-模型关系"><a href="#Flask-模型关系" class="headerlink" title="Flask 模型关系"></a>Flask 模型关系</h1><p><code>python</code>框架中不方便直接写表连接查询和子查询。<code>python</code>框架为了简化多表的查询，制定了多表的关系：</p>
<h2 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h2><p> 在<code>flask</code>的框架中如何体现一对多的模型关系？</p>
<blockquote>
<p>就是通过外键<code>ForignKey</code>(一般在多的一方维护一的数据,即把外键创建在多的一方,对一的一方的引用,就好比一个班级有一名老师(teacher)多名学生(student),老师记住所有学生的名字简单还是学生记住老师的名字简单,很明显学生记住老师的名字简单)和<code>relationship</code>体现。</p>
<p><code>ForignKey</code>是给映射关系(表)说的，一般写在多的一方。<code>relationship</code>是给模板(models)使用的,双方模型多可以写,一般写在一的一方</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">15</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    password = db.Column(db.String(<span class="number">64</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    phone = db.Column(db.String(<span class="number">11</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    email = db.Column(db.String(<span class="number">30</span>))</span><br><span class="line">    icon = db.Column(db.String(<span class="number">100</span>))</span><br><span class="line">    isdelete = db.Column(db.Boolean, default=<span class="literal">False</span>)</span><br><span class="line">    rdatetime = db.Column(db.DateTime, default=datetime.now)</span><br><span class="line">    <span class="comment"># 增加一个字段,相当于放到了一个list集合中,只需要模型.articles就可以拿到数据</span></span><br><span class="line">    articles = db.relationship(<span class="string">'Article'</span>, backref=<span class="string">'user'</span>)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.username</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">50</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    content = db.Column(db.Text, nullable=<span class="literal">False</span>)</span><br><span class="line">    pdatetime = db.Column(db.DateTime, default=datetime.now)</span><br><span class="line">    click_num = db.Column(db.Integer, default=<span class="number">0</span>)</span><br><span class="line">    save_num = db.Column(db.Integer, default=<span class="number">0</span>)</span><br><span class="line">    love_num = db.Column(db.Integer, default=<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># 外键 同步到数据库的外键关系</span></span><br><span class="line">    user_id = db.Column(db.Integer, db.ForeignKey(<span class="string">'user.id'</span>), nullable=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h2 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Page</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    tags = db.relationship(<span class="string">'Tag'</span>, secondary=<span class="string">'Page_tag'</span>,backref=<span class="string">'pages'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">20</span>),nullable=<span class="literal">False</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 中间表 维护多对多关系</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Page_tag</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    db.Column(<span class="string">'tag_id'</span>, db.Integer, db.ForeignKey(<span class="string">'tag.id'</span>))</span><br><span class="line">    db.Column(<span class="string">'page_id'</span>, db.Integer, db.ForeignKey(<span class="string">'page.id'</span>))</span><br></pre></td></tr></table></figure>

<h1 id="Flask-Boostrap"><a href="#Flask-Boostrap" class="headerlink" title="Flask-Boostrap"></a>Flask-Boostrap</h1><p>我们可以手动引入Bootstrap框架用来美化界面,也可以使用Flask的扩展Flask-Bootstrap,作用</p>
<ul>
<li>自动引用 CDN</li>
<li>可以与 WTForm 或其他 Flask 插件比如 Flask-nav 一起使用</li>
</ul>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200806163648.png" alt=""></p>
<p>##安装 Flask-Bootstrap:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-bootstrap</span><br></pre></td></tr></table></figure>

<p>##关联 Flask app</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200806163929.png" alt=""></p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200806163959.png" alt=""></p>
<h2 id="内置的block"><a href="#内置的block" class="headerlink" title="内置的block"></a>内置的block</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block title %&#125;首页&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block navbar %&#125; &#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125; &#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block styles %&#125;&#123;&#123;super()&#125;&#125; &#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block srcipts %&#125; &#123;&#123;super()&#125;&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block head %&#125; &#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block body %&#125; &#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>



<p>##使用 Flask-Bootstrap 渲染 WTF Form</p>
<p>以 <code>edit_form.html</code> 为例，之前的代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Edit Note<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Edit Note<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">        &#123;&#123; form.body(rows='10',cols='100') &#125;&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        &#123;&#123; form.submit &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中 Form 中的字段是通过 WTForm 传入的，对这些字段如何套用 Bootstrap 的样式呢？</p>
<ul>
<li>引用 Flask-Bootstrap 的 <code>wtf.html</code> 文件</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">import</span> <span class="string">'bootstrap/wtf.html'</span> <span class="keyword">as</span> wtf %&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用 <code>wtf.form_field()</code> 表单宏：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; wtf.form_field(some_field) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>经过改写的 <code>edit_form.html</code> 如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% import 'bootstrap/wtf.html' as wtf %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block body_content %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Edit Note<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">        &#123;&#123; wtf.form_field(form.body) &#125;&#125;</span><br><span class="line">        &#123;&#123; wtf.form_field(form.submit) &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>##自定义表单样式</p>
<p>对于表单的样式，比如希望输入 body 的时候有多行，有两种定义方法。方法一是在定义 Form 字段的时候，传入一个 <code>render_kw</code> 参数，这个参数为 dict 类型，如下面这样：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EditNoteForm</span><span class="params">(Form)</span>:</span></span><br><span class="line">    body = TextAreaField(<span class="string">'body'</span>, render_kw=&#123;<span class="string">'class'</span>: <span class="string">'text-body'</span>, <span class="string">'rows'</span>: <span class="number">10</span>, <span class="string">'placeholder'</span>: <span class="string">'输入您的想法...'</span>&#125;)</span><br><span class="line">    submit = SubmitField(<span class="string">'Update'</span>)</span><br></pre></td></tr></table></figure>

<p>方法二是在渲染时控制样式：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; wtf.form_field(form.body, , <span class="keyword">class</span>=<span class="string">"text-body"</span>, rows=<span class="string">"10"</span>)) &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="问题一-访问资源404"><a href="#问题一-访问资源404" class="headerlink" title="问题一:访问资源404"></a>问题一:访问资源404</h2><h3 id="使用其他CDN"><a href="#使用其他CDN" class="headerlink" title="使用其他CDN"></a><strong>使用其他CDN</strong></h3><p>如果你想使用其他CDN资源，那么可以直接在Flask-Bootstrap的源码里修改，找到<strong>\venv\Lib\site-packages\flask_bootstrap_<em>init_</em>.py</strong>，在文件末尾，将下面这些文件的地址修改成你想引用的CDN地址即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bootstrap &#x3D; lwrap(</span><br><span class="line">     WebCDN(&#39;&#x2F;&#x2F;cdnjs.cloudflare.com&#x2F;ajax&#x2F;libs&#x2F;twitter-bootstrap&#x2F;%s&#x2F;&#39; %</span><br><span class="line">                   BOOTSTRAP_VERSION), local)</span><br><span class="line"> </span><br><span class="line">jquery &#x3D; lwrap(</span><br><span class="line">     WebCDN(&#39;&#x2F;&#x2F;cdnjs.cloudflare.com&#x2F;ajax&#x2F;libs&#x2F;jquery&#x2F;%s&#x2F;&#39; %</span><br><span class="line">                   JQUERY_VERSION), local)</span><br><span class="line"> </span><br><span class="line">html5shiv &#x3D; lwrap(</span><br><span class="line">    WebCDN(&#39;&#x2F;&#x2F;cdnjs.cloudflare.com&#x2F;ajax&#x2F;libs&#x2F;html5shiv&#x2F;%s&#x2F;&#39; %</span><br><span class="line">                   HTML5SHIV_VERSION))</span><br><span class="line"> </span><br><span class="line">respondjs &#x3D; lwrap(</span><br><span class="line">    WebCDN(&#39;&#x2F;&#x2F;cdnjs.cloudflare.com&#x2F;ajax&#x2F;libs&#x2F;respond.js&#x2F;%s&#x2F;&#39; %</span><br><span class="line">                   RESPONDJS_VERSION))</span><br></pre></td></tr></table></figure>

<p>比如换成<code>cdn.bootcss.com</code>提供的资源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bootstrap &#x3D; lwrap(</span><br><span class="line">    WebCDN(&#39;&#x2F;&#x2F;cdn.bootcss.com&#x2F;bootstrap&#x2F;%s&#x2F;&#39; % BOOTSTRAP_VERSION), local)</span><br><span class="line"> </span><br><span class="line">jquery &#x3D; lwrap(</span><br><span class="line">    WebCDN(&#39;&#x2F;&#x2F;cdn.bootcss.com&#x2F;jquery&#x2F;%s&#x2F;&#39; % JQUERY_VERSION), local)</span><br><span class="line"> </span><br><span class="line">html5shiv &#x3D; lwrap(</span><br><span class="line">    WebCDN(&#39;&#x2F;&#x2F;cdn.bootcss.com&#x2F;html5shiv&#x2F;%s&#x2F;&#39; % HTML5SHIV_VERSION))</span><br><span class="line"> </span><br><span class="line">respondjs &#x3D; lwrap(</span><br><span class="line">    WebCDN(&#39;&#x2F;&#x2F;cdn.bootcss.com&#x2F;respond.js&#x2F;%s&#x2F;&#39; % RESPONDJS_VERSION))</span><br></pre></td></tr></table></figure>



<h1 id="Flask-会话机制"><a href="#Flask-会话机制" class="headerlink" title="Flask 会话机制"></a>Flask 会话机制</h1><h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><p>　　在网站中，HTTP请求是无状态的。也就是说，即使第一次用户访问服务器并登录成功后，第二次请求服务器依然不知道当前发起请求的是哪个用户。<code>cookie</code>的出现就是为了解决这个问题，第一次登录后服务器返回一些数据（<code>cookie</code>）给浏览器，浏览器将这些数据保存在本地。当用户发起第二次请求的时候，浏览器自动的将上次请求得到的<code>cookie</code>数据携带给服务器，服务器通过这些<code>cookie</code>数据就能分辨出当前发起请求的是哪个用户了。cookie存储的数据量有限，不同的浏览器有不同的存储大小，但一般不超过4K，因此使用<code>cookie</code>只能存储一些少量的数据。</p>
<p>##session</p>
<p>　　<code>session</code>与<code>cookie</code>的作用有点类似，都是为了存储用户相关的信息。不同的是，<code>cookie</code>是存储在本地浏览器，<code>session</code>存储在服务器。存储在服务器的数据会更加的安全，不容易被窃取。但存储在服务器也有一定的弊端，就是会占用服务器的资源。</p>
<h2 id="cookie和session的结合使用"><a href="#cookie和session的结合使用" class="headerlink" title="cookie和session的结合使用"></a>cookie和session的结合使用</h2><p>web开发发展至今，<code>cookie</code>和<code>session</code>的使用已经出现了一些非常成熟的方案。在如今的市场和企业里，一般有两种存储方式：</p>
<ul>
<li>存储在服务器：通过cookie存储一个session_id，然后具体的数据则保存在session中。当用户已经登录时，会在浏览器的cookie中保存一个session_id，下次再次请求的时候，会把session_id携带上来，服务器根session_id在session库中获取用户的session数据，从而能够辨别用户身份，以及得到之前保存的状态信息。这种专业术语叫做server side session</li>
<li>将session数据加密，然后存储在cookie中。这种专业术语叫做client side session，flask采用的就是这种方式，但是也可以替换成其它形式</li>
</ul>
<h2 id="实现方式："><a href="#实现方式：" class="headerlink" title="实现方式："></a>实现方式：</h2><h3 id="cookie方式："><a href="#cookie方式：" class="headerlink" title="cookie方式："></a>cookie方式：</h3><ul>
<li><p>保存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">通过response对象保存。</span><br><span class="line">    response &#x3D; redirect(xxx)</span><br><span class="line">    response &#x3D; render_template(xxx)</span><br><span class="line">    response &#x3D; Response()</span><br><span class="line">    response &#x3D; make_response()</span><br><span class="line">    response &#x3D; jsonify()</span><br><span class="line">通过对象调用方法</span><br><span class="line">    response.set_cookie(key,value,max_age)</span><br><span class="line">    其中max_age表示过期时间，单位是秒</span><br><span class="line">    也可以使用expires设置过期时间，expires&#x3D;datetime.now()+timedelta(hour&#x3D;1)</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取：    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">通过request对象获取。</span><br><span class="line">    request.form.get()</span><br><span class="line">    request.args.get()</span><br><span class="line">cookie也在request对象中</span><br><span class="line">    request.cookies.get(key) ----&gt; value</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">通过response对象删除。 把浏览器中的key&#x3D;value删除了</span><br><span class="line">   response &#x3D; redirect(xxx)</span><br><span class="line">   response &#x3D; render_template(xxx)</span><br><span class="line">   response &#x3D; Response()</span><br><span class="line">   response &#x3D; make_response()</span><br><span class="line">   response &#x3D; jsonify()</span><br><span class="line">  通过对象调用方法</span><br><span class="line">   response.delete_cookie(key)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="session方式："><a href="#session方式：" class="headerlink" title="session方式："></a>session方式：</h3><p><code>session:</code>是在服务器端进行用户信息的保存。一个字典</p>
<blockquote>
<p><strong>注意：</strong>使用<code>session</code>必须要设置配置文件，在配置文件中添加<code>SECRET_KEY=&#39;xxxxx&#39;</code>，<br>添加<code>SECRET_KEY</code>的目的就是用于<code>sessionid</code>的加密。如果不设置会报错。</p>
</blockquote>
<ul>
<li><p>设置：</p>
<p>如果要使用session，需要直接导入：</p>
<p><code>from flask import session</code><br>把session当成字典使用，因此：<code>session[key]=value</code>就会将key=value保存到session的内存空间并会在响应的时候自动在response中自动添加有一个cookie：<code>session=加密后的id</code></p>
</li>
<li><p>获取<br>用户请求页面的时候就会携带上次保存在客户端浏览器的cookie值，其中包含session=加密后的id<br>获取session值的话通过session直接获取，因为session是一个字典，就可以采用字典的方式获取即可。<br><code>value = session[key]</code>或者<code>value = session.get(key)</code></p>
</li>
</ul>
<blockquote>
<p>这个时候大家可能会考虑携带的cookie怎么用的？？？？</p>
<p>其实是如果使用<code>session</code>获取内容,底层会自动获取<code>cookie</code>中的<code>sessionid</code>值，进行查找并找到对应的<code>session</code>空间</p>
</blockquote>
<ul>
<li>删除<br><code>session.clear() :</code> 删除session的内存空间和删除cookie<br><code>del session[key]:</code> 只会删除session中的这个键值对，不会删除session空间和cookie</li>
</ul>
<h1 id="Flask-密码加密解密"><a href="#Flask-密码加密解密" class="headerlink" title="Flask 密码加密解密"></a>Flask 密码加密解密</h1><ul>
<li><p>使用<code>werkzeug.security</code>自带的函数实现加密：<code>generate_password_hash</code>,一般用于用户注册写入数据库加密后的密码</p>
</li>
<li><p>使用<code>werkzeug.security</code>自带的函数实现解密：<code>check_password_hash(pwdHash,password)</code>,一般用于登录</p>
<ul>
<li>返回值为bool,如果flag=True表示匹配，否则密码不匹配</li>
<li>pwhash -数据库哈希加密字符串</li>
<li>password -明文密码进行比较的哈希值</li>
</ul>
</li>
</ul>
<h1 id="Flask-钩子函数"><a href="#Flask-钩子函数" class="headerlink" title="Flask 钩子函数"></a>Flask 钩子函数</h1><blockquote>
<p>钩子函数是指在执行函数和目标函数之间挂载的函数，框架开发者给调用方提供一个point-挂载点，至于挂载什么函数由调用方决定，大大提供了灵活性。</p>
</blockquote>
<p>##常用的钩子函数</p>
<p>###@before_first_request<br> 在对应用程序实例的第一个请求之前注册要运行的函数，只会运行一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 服务器被第一次访问执行的钩子函数</span><br><span class="line">@app.before_first_request</span><br><span class="line">def first_request():</span><br><span class="line">    print(&quot;Hello World&quot;)</span><br></pre></td></tr></table></figure>

<p>###@before_request<br> 在每次请求之前执行. 通常使用这个钩子函数预处理一些变量, 视图函数可以更好调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 在服务器接收的请求还没分发到视图函数之前执行的钩子函数</span><br><span class="line">@app.before_request</span><br><span class="line">def before_request():</span><br><span class="line">    # print(&quot;我勾住了每次请求&quot;)</span><br><span class="line">    user_id &#x3D; session.get(&quot;user_id&quot;)</span><br><span class="line">    if user_id:</span><br><span class="line">        g.user &#x3D; &quot;DaYe&quot;</span><br></pre></td></tr></table></figure>

<p>###@after_request<br> 在每个请求之后注册一个要运行的函数，每次请求完成后都会执行。<br> 需要接受一个Response对象作为参数，并返回一个新的Response对象，或者返回接收的Response对象</p>
<p>###@teardown_request<br>注册一个函数,同样在每次请求之后运行.注册的函数至少需要含有一个参数,这个参数实际上为服务器的响应,且函数中需要返回这个响应参数.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@app.teardown_request</span><br><span class="line">def td_request(param):</span><br><span class="line">    return param</span><br></pre></td></tr></table></figure>

<p>###@teardown_appcontext</p>
<p>当APP上下文被移除之后执行的函数, 可以进行数据库的提交或者回滚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@app.teardown_appcontext</span><br><span class="line">def teardown(exc&#x3D;None):</span><br><span class="line">    if exc is None:</span><br><span class="line">        db.session.commit()</span><br><span class="line">    else:</span><br><span class="line">        db.session.rollback()</span><br><span class="line">    db.session.remove()</span><br></pre></td></tr></table></figure>

<p>###@context_processor</p>
<p> 上下文处理器，返回的字典可以在全部的模板中使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@app.context_processor()</span><br><span class="line">def context():</span><br><span class="line">    # 必须返回一个字典</span><br><span class="line">    # hasattr(obj, attr) 判断obj是否有attr属性, 注意此时的attr应该是字符串</span><br><span class="line">    if hasattr(g, &quot;user&quot;):</span><br><span class="line">        return &#123;&quot;current_username&quot;: &quot;DaYe&quot;&#125;</span><br><span class="line">    else:</span><br><span class="line">        # 注意: 必须返回一个字典</span><br><span class="line">        return &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>###@template_filter(‘xxxxxx’)<br> 增加模板过滤器，可以在模板中使用该函数，后面的参数是名称，在模板中用到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@app.template_filter</span><br><span class="line">def upper_filter(s):</span><br><span class="line">    return s.upper()</span><br></pre></td></tr></table></figure>

<p>###@errorhandler(400)<br> 发生一些异常时，比如404,500，或者抛出异常(Exception)之类的，就会自动调用该钩子函数</p>
<ol>
<li>发生请求错误时，框架会自动调用相应的钩子函数，并向钩子函数中传入error参数</li>
<li>如果钩子函数没有定义error参数，就会报错</li>
<li>可以使用abort函数来手动终止请求抛出异常，如果要是发生参数错误，可以abort(404)之类的</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@app.errorhander(404)</span><br><span class="line">def page_not_found(error):</span><br><span class="line">    return render_template(&quot;error400.html&quot;), 404</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">@app.errorhander(500)</span><br><span class="line">def server_error(error):</span><br><span class="line">    return render_template(&quot;error505.html&quot;), 500</span><br></pre></td></tr></table></figure>

<h1 id="Flask-文件上传"><a href="#Flask-文件上传" class="headerlink" title="Flask 文件上传"></a>Flask 文件上传</h1><p>在Flask中处理文件上传非常简单。它需要一个<code>HTML</code>表单，其<code>enctype</code>属性设置为<code>“multipart / form-data”</code>，将文件发布到URL。URL处理程序从<strong>request.files[‘icon’]</strong>对象中提取文件，并将其保存到所需的位置。</p>
<p>每个上传的文件首先会保存在服务器上的临时位置，然后将其实际保存到它的最终位置。目标文件的名称可以是硬编码的，也可以从<strong>request.files[file]</strong>或<strong>request.files.get(‘icon’)</strong>对象的<code>filename</code>属性中获取。但是，建议使用<strong>secure_filename()</strong>函数获取它的安全版本。</p>
<p>可以在Flask对象的配置设置中定义默认上传文件夹的路径和上传文件的最大大小。</p>
<table>
<thead>
<tr>
<th>app.config[‘UPLOAD_FOLDER’]</th>
<th>定义上传文件夹的路径</th>
</tr>
</thead>
<tbody><tr>
<td>app.config[‘MAX_CONTENT_PATH’]</td>
<td>指定要上传的文件的最大大小（以字节为单位）</td>
</tr>
</tbody></table>
<p>以下代码具有’<strong>/ upload’</strong> URL规则，该规则在templates文件夹中显示’<strong>upload.html’</strong>，以及<strong>‘/ upload-file’</strong> URL规则，用于调用<strong>uploader()</strong>函数处理上传过程。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> = <span class="string">"http://localhost:5000/uploader"</span> <span class="attr">method</span> = <span class="string">"POST"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">enctype</span> = <span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">"file"</span> <span class="attr">name</span> = <span class="string">"file"</span> /&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> = <span class="string">"submit"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">      </span><br><span class="line">   <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> werkzeug <span class="keyword">import</span> secure_filename</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/upload')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">   <span class="keyword">return</span> render_template(<span class="string">'upload.html'</span>)</span><br><span class="line">	</span><br><span class="line"><span class="meta">@app.route('/uploader', methods = ['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">   <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">      f = request.files[<span class="string">'file'</span>]  <span class="comment"># FileStorage 相当于一个储存文件的大容器</span></span><br><span class="line">      <span class="comment"># 或者 f = request.files.get('file')</span></span><br><span class="line">      f.save(secure_filename(f.filename))</span><br><span class="line">      <span class="comment"># secure_filename()保证文件名是符合python的命名规则</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'file uploaded successfully'</span></span><br><span class="line">		</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">   app.run(debug = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>思考:</strong>如果用户量足够多图片都放在服务器,硬盘要足够大,加载会很慢</p>
<p>实际开发我们的文件会保存在第三方的云储存服务器上如:(七牛云,腾讯云,阿里云…),可以加快访问和节空间,但是需要收费</p>
</blockquote>
<h1 id="Flask-邮件"><a href="#Flask-邮件" class="headerlink" title="Flask 邮件"></a>Flask 邮件</h1><p>基于<code>web</code>的应用程序通常需要具有向用户/客户端发送邮件的功能。<strong>Flask-Mail</strong>扩展使得与任何电子邮件服务器建立简单的接口变得非常容易。</p>
<p><strong>步骤1</strong>-首先，应该在pip实用程序的帮助下安装<code>Flask-Mail</code>扩展。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install Flask-Mail</span><br></pre></td></tr></table></figure>

<p>然后需要通过设置以下应用程序参数的值来配置Flask-Mail。</p>
<p><strong>步骤2 -</strong> 然后按照以下设置配置<code>Flask-Mail</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.config[&#39;MAIL_SERVER&#39;]&#x3D;&#39;smtp.qq.com&#39;  # 电子邮件服务器的名称&#x2F;IP地址</span><br><span class="line">app.config[&#39;MAIL_PORT&#39;] &#x3D; 465  # 使用的服务器的端口号</span><br><span class="line">app.config[&#39;MAIL_USERNAME&#39;] &#x3D; &#39;15096000421@qq.com&#39; # 发件人的用户名</span><br><span class="line">app.config[&#39;MAIL_PASSWORD&#39;] &#x3D; &#39;nukhrruyvdhkdjff&#39;  # 发件人的密码</span><br><span class="line">app.config[&#39;MAIL_USE_TLS&#39;] &#x3D; False  # 启用&#x2F;禁用传输安全层加密</span><br><span class="line">app.config[&#39;MAIL_USE_SSL&#39;] &#x3D; True  # 启用&#x2F;禁用安全套接字层加密</span><br></pre></td></tr></table></figure>

<p><strong>步骤3</strong> - 创建Mail类的实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mail &#x3D; Mail(app)  # 与Flask对象关联</span><br></pre></td></tr></table></figure>

<p>##Mail类的方法</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>方法与描述</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><strong>send()</strong>发送Message类对象的内容</td>
</tr>
<tr>
<td>2</td>
<td><strong>connect()</strong>打开与邮件主机的连接</td>
</tr>
<tr>
<td>3</td>
<td><strong>send_message()</strong>发送消息对象</td>
</tr>
</tbody></table>
<p><strong>步骤4</strong> - 创建路由规则映射的Python函数中设置Message对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&quot;&#x2F;send&quot;)</span><br><span class="line">def index():</span><br><span class="line">   # Message 它封装了一封电子邮件</span><br><span class="line">   msg &#x3D; Message(&#39;Hello&#39;, sender &#x3D; &#39;15096000421@qq.com&#39;, recipients &#x3D; [&#39;zysheep@126.com&#39;])</span><br><span class="line">   # 纯文本邮件</span><br><span class="line">   msg.body &#x3D; &quot;Hello Flask message sent from Flask-Mail&quot;</span><br><span class="line"></span><br><span class="line">   # 发送Message类对象的内容</span><br><span class="line">   mail.send(msg)</span><br><span class="line">   return &quot;Sent&quot;</span><br></pre></td></tr></table></figure>

<h2 id="Message类"><a href="#Message类" class="headerlink" title="Message类"></a>Message类</h2><p>它封装了一封电子邮件。Message类构造函数有几个参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flask-mail.Message(subject, recipients, body, html, sender, cc, bcc, </span><br><span class="line">   reply-to, date, charset, extra_headers, mail_options, rcpt_options)</span><br></pre></td></tr></table></figure>

<ul>
<li>subject -电子邮件的主题标题</li>
<li>recipients -电子邮件地址列表</li>
<li>body -纯文本邮件</li>
<li>html - HTML邮件</li>
<li>sender -电子邮件发件人地址，或** ** MAIL_DEFAULT_SENDER默认</li>
<li>cc - CC列表</li>
<li>bcc - BCC列表</li>
<li>attachments -附件实例列表</li>
<li>reply_to -回复地址</li>
<li>date -发送日期</li>
<li>charset -消息字符集</li>
<li>extra_headers -为消息的附加标题的字典</li>
<li>mail_options -的ESMTP选项列表在Mail中使用FROM指令</li>
<li>rcpt_options -的ESMTP选项列表在RCPT命令中使用</li>
</ul>
<h3 id="Message类方法"><a href="#Message类方法" class="headerlink" title="Message类方法"></a>Message类方法</h3><p><strong>attach()</strong> - 为邮件添加附件。此方法采用以下参数：</p>
<ul>
<li><strong>filename</strong> - 要附加的文件的名称</li>
<li><strong>content_type</strong> - MIME类型的文件</li>
<li><strong>data</strong> - 原始文件数据</li>
<li><strong>处置</strong> - 内容处置（如果有的话）。</li>
</ul>
<p><strong>add_recipient()</strong> - 向邮件添加另一个收件人</p>
<h1 id="Flask短信服务"><a href="#Flask短信服务" class="headerlink" title="Flask短信服务"></a>Flask短信服务</h1><p><a href="https://yunxin.163.com/sms" target="_blank" rel="noopener"><strong>短信服务（Short Message Service）</strong></a>这里我们使用第三方<strong>网易易盾</strong>提供的服务。<strong>网易易盾</strong>为用户提供的一种通信服务的能力，目前支持验证码类短信、通知类短信、运营类短信、语音类短信、国际短信等事务性短信。</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200812084548.png" alt=""></p>
<p><code>smssend.py</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import hashlib</span><br><span class="line">import json</span><br><span class="line">import random</span><br><span class="line">import ssl</span><br><span class="line">import time</span><br><span class="line">import urllib</span><br><span class="line">import urllib.parse</span><br><span class="line">import urllib.request</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class SecretPair(object):</span><br><span class="line">    def __init__(self, secret_id, secret_key):</span><br><span class="line">        self.secret_id &#x3D; secret_id</span><br><span class="line">        self.secret_key &#x3D; secret_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class SmsSendAPIDemo(object):</span><br><span class="line">    &quot;&quot;&quot;易盾短信发送接口示例代码&quot;&quot;&quot;</span><br><span class="line">    API_URL &#x3D; &quot;https:&#x2F;&#x2F;sms.dun.163yun.com&#x2F;v2&#x2F;sendsms&quot;</span><br><span class="line">    VERSION &#x3D; &quot;v2&quot;</span><br><span class="line"></span><br><span class="line">    def __init__(self, business_id, secret_pair):</span><br><span class="line">        self.business_id &#x3D; business_id</span><br><span class="line">        self.secret_pair &#x3D; secret_pair</span><br><span class="line"></span><br><span class="line">    def gen_signature(self, params&#x3D;None):</span><br><span class="line">        &quot;&quot;&quot;生成签名信息</span><br><span class="line">        Args:</span><br><span class="line">            params (object) 请求参数</span><br><span class="line">        Returns:</span><br><span class="line">            参数签名md5值</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        buff &#x3D; &quot;&quot;</span><br><span class="line">        for k in sorted(params.keys()):</span><br><span class="line">            buff +&#x3D; str(k) + str(params[k])</span><br><span class="line">        buff +&#x3D; self.secret_pair.secret_key</span><br><span class="line">        buff &#x3D; buff.encode(&#39;utf-8&#39;)</span><br><span class="line">        return hashlib.md5(buff).hexdigest()</span><br><span class="line"></span><br><span class="line">    def send(self, params):</span><br><span class="line">        &quot;&quot;&quot;请求易盾接口</span><br><span class="line">        Args:</span><br><span class="line">            params (object) 请求参数</span><br><span class="line">        Returns:</span><br><span class="line">            请求结果，json格式</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        params[&quot;secretId&quot;] &#x3D; self.secret_pair.secret_id</span><br><span class="line">        params[&quot;businessId&quot;] &#x3D; self.business_id</span><br><span class="line">        params[&quot;version&quot;] &#x3D; self.VERSION</span><br><span class="line">        params[&quot;timestamp&quot;] &#x3D; int(time.time() * 1000)</span><br><span class="line">        params[&quot;nonce&quot;] &#x3D; int(random.random() * 100000000)</span><br><span class="line">        params[&quot;signature&quot;] &#x3D; self.gen_signature(params)</span><br><span class="line"></span><br><span class="line">        try:</span><br><span class="line">            params &#x3D; urllib.parse.urlencode(params)</span><br><span class="line">            params &#x3D; params.encode(&#39;utf-8&#39;)</span><br><span class="line">            context &#x3D; ssl._create_unverified_context()  # 忽略安全</span><br><span class="line">            request &#x3D; urllib.request.Request(self.API_URL, params)</span><br><span class="line">            response &#x3D; urllib.request.urlopen(request, timeout&#x3D;1, context&#x3D;context)</span><br><span class="line">            content &#x3D; response.read()</span><br><span class="line"></span><br><span class="line">            return json.loads(content)</span><br><span class="line">        except Exception as ex:</span><br><span class="line">            print(&quot;调用API接口失败:&quot;, str(ex))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    &quot;&quot;&quot;示例代码入口&quot;&quot;&quot;</span><br><span class="line">    SECRET_ID &#x3D; &quot;dcc535cbfaefa2a24c1e6610035b6586&quot;  # 产品密钥ID，产品标识</span><br><span class="line">    SECRET_KEY &#x3D; &quot;d28f0ec3bf468baa7a16c16c9474889e&quot;  # 产品私有密钥，服务端生成签名信息使用，请严格保管，避免泄露</span><br><span class="line">    BUSINESS_ID &#x3D; &quot;748c53c3a363412fa963ed3c1b795c65&quot;  # 业务ID，易盾根据产品业务特点分配</span><br><span class="line">    secret_pair &#x3D; SecretPair(SECRET_ID, SECRET_KEY)</span><br><span class="line">    api &#x3D; SmsSendAPIDemo(BUSINESS_ID, secret_pair)</span><br><span class="line"></span><br><span class="line">    params &#x3D; &#123;</span><br><span class="line">    	# 短信接收者</span><br><span class="line">        &quot;mobile&quot;: &quot;15010185644&quot;,</span><br><span class="line">        # 模板Id</span><br><span class="line">        &quot;templateId&quot;: &quot;11732&quot;,</span><br><span class="line">        &quot;paramType&quot;: &quot;json&quot;,</span><br><span class="line">        # 验证码</span><br><span class="line">        &quot;params&quot;: &#123;&quot;code&quot;: &quot;2901&quot;&#125;</span><br><span class="line">        # 国际短信对应的国际编码(非国际短信接入请注释掉该行代码)</span><br><span class="line">        # &quot;internationalCode&quot;: &quot;对应的国家编码&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    ret &#x3D; api.send(params)</span><br><span class="line">    print(ret)</span><br><span class="line">    if ret is not None:</span><br><span class="line">        if ret[&quot;code&quot;] &#x3D;&#x3D; 200:</span><br><span class="line">            taskId &#x3D; ret[&quot;data&quot;][&quot;requestId&quot;]</span><br><span class="line">            print(&quot;taskId &#x3D; %s&quot; % taskId)</span><br><span class="line">        else:</span><br><span class="line">            print(&quot;ERROR: ret.code&#x3D;%s,msg&#x3D;%s&quot; % (ret[&#39;code&#39;], ret[&#39;msg&#39;]))</span><br></pre></td></tr></table></figure>

<p><strong>网易易盾</strong>工具类<code>utils.py</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">from smssend import SmsSendAPIDemo, SecretPair</span><br><span class="line"></span><br><span class="line"># 发送短信息</span><br><span class="line">def send_duanxin(phone):</span><br><span class="line">    SECRET_ID &#x3D; &quot;dcc535cbfaefa2a24c1e6610035b6586&quot;  # 产品密钥ID，产品标识</span><br><span class="line">    SECRET_KEY &#x3D; &quot;d28f0ec3bf468baa7a16c16c9474889e&quot;  # 产品私有密钥，服务端生成签名信息使用，请严格保管，避免泄露</span><br><span class="line">    BUSINESS_ID &#x3D; &quot;748c53c3a363412fa963ed3c1b795c65&quot;  # 业务ID，易盾根据产品业务特点分配</span><br><span class="line">    secret_pair &#x3D; SecretPair(SECRET_ID, SECRET_KEY)</span><br><span class="line">    api &#x3D; SmsSendAPIDemo(BUSINESS_ID, secret_pair)</span><br><span class="line">    # 验证码随机产生</span><br><span class="line">    code &#x3D; &quot;&quot;</span><br><span class="line">    for i in range(4):</span><br><span class="line">        ran &#x3D; random.randint(0, 9)</span><br><span class="line">        code +&#x3D; str(ran)</span><br><span class="line"></span><br><span class="line">    params &#x3D; &#123;</span><br><span class="line">        &quot;mobile&quot;: phone,</span><br><span class="line">        &quot;templateId&quot;: &quot;11732&quot;,</span><br><span class="line">        &quot;paramType&quot;: &quot;json&quot;,</span><br><span class="line">        # 以前是网易产生的,现在需要自己产生</span><br><span class="line">        &quot;params&quot;: &#123;&quot;code&quot;: code&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret &#x3D; api.send(params)</span><br><span class="line">    return ret, code</span><br></pre></td></tr></table></figure>

<p><code>view</code>视图页面调用工具类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 发送短信息</span><br><span class="line">@user_bp1.route(&#39;&#x2F;sendMsg&#39;)</span><br><span class="line">def send_message():</span><br><span class="line">    phone &#x3D; request.args.get(&#39;phone&#39;)</span><br><span class="line">    # 补充验证手机号码是否注册，去数据库查询</span><br><span class="line">    ret, code &#x3D; send_duanxin(phone)</span><br><span class="line">    # 验证是否发送成功</span><br><span class="line">    if ret is not None:</span><br><span class="line">        if ret[&quot;code&quot;] &#x3D;&#x3D; 200:</span><br><span class="line">            # cache.set(key,value,timeout&#x3D;second)</span><br><span class="line">            # 设置短信验证码保存到redis中,设置过期时间</span><br><span class="line">            # 1,安装  pip3 install flask-caching</span><br><span class="line">            cache.set(phone, code, timeout&#x3D;180)</span><br><span class="line">            return jsonify(code&#x3D;200, msg&#x3D;&#39;短信发送成功！&#39;)</span><br><span class="line">        else:</span><br><span class="line">            print(&quot;ERROR: ret.code&#x3D;%s,msg&#x3D;%s&quot; % (ret[&#39;code&#39;], ret[&#39;msg&#39;]))</span><br><span class="line">            return jsonify(code&#x3D;400, msg&#x3D;&#39;短信发送失败！&#39;)</span><br></pre></td></tr></table></figure>

<h1 id="Flask-caching-缓存"><a href="#Flask-caching-缓存" class="headerlink" title="Flask-caching(缓存)"></a>Flask-caching(缓存)</h1><blockquote>
<p>什么是缓存？为什么使用缓存？</p>
</blockquote>
<p>由于短信验证码有过期有过期时间,很显然存入到数据库解决不了过期时间的需求,所以就需要使用redis缓存技术。数据库是 <code>web</code> 应⽤性能的瓶颈，为了提⾼<code>web 应</code>用访问效率，尽可能减少数据库的操作，可以将经常访问的数据缓存起来，再次使⽤用时直接从缓存中获取，而不是每次都操作数据库。</p>
<p>第一步：先下载<code>flask-caching</code>,<code>redis</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install redis</span><br><span class="line">pip install flask-caching</span><br></pre></td></tr></table></figure>

<p>第二步：引入缓存并注册</p>
<p>在exts包下<code>__init__.py</code>文件中引入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from flask_caching  import Cache  #引入</span><br><span class="line">cache &#x3D; Cache() #缓存  初始化</span><br></pre></td></tr></table></figure>

<p>在apps包下<code>__init__.py</code>文件中注册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># redis配置</span><br><span class="line">config &#x3D;&#123;</span><br><span class="line">    CACHE_NO_NULL_WARNING &#x3D; &quot;warning&quot; # null类型时的警告消息</span><br><span class="line">    CACHE_ARGS &#x3D; []	# 在缓存类实例化过程中解包和传递的可选列表，用来配置相关后端的额外的参数</span><br><span class="line">    CACHE_OPTIONS &#x3D; &#123;&#125;	# 可选字典,在缓存类实例化期间传递，也是用来配置相关后端的额外的键值对参数</span><br><span class="line">    CACHE_DEFAULT_TIMEOUT # 默认过期&#x2F;超时时间，单位为秒</span><br><span class="line">    CACHE_THRESHOLD	# 缓存的最大条目数</span><br><span class="line"></span><br><span class="line">    CACHE_TYPE &#x3D; null # 默认的缓存类型，无缓存</span><br><span class="line">    CACHE_TYPE &#x3D; &#39;simple&#39; # 使用本地python字典进行存储，线程非安全</span><br><span class="line"></span><br><span class="line">    CACHE_TYPE &#x3D; &#39;filesystem&#39; # 使用文件系统来存储缓存的值</span><br><span class="line">    CACHE_DIR &#x3D; &quot;&quot; # 文件目录</span><br><span class="line"></span><br><span class="line">    CACHE_TYPE &#x3D; &#39;memcached&#39; # 使用memcached服务器缓存</span><br><span class="line">    CACHE_KEY_PREFIX # 设置cache_key的前缀</span><br><span class="line">    CAHCE_MEMCACHED_SERVERS	# 服务器地址的列表或元组</span><br><span class="line">    CACHE_MEMCACHED_USERNAME # 用户名</span><br><span class="line">    CACHE_MEMCACHED_PASSWORD # 密码</span><br><span class="line"></span><br><span class="line">    CACHE_TYPE &#x3D; &#39;uwsgi&#39; # 使用uwsgi服务器作为缓存</span><br><span class="line">    CACHE_UWSGI_NAME # 要连接的uwsgi缓存实例的名称</span><br><span class="line"></span><br><span class="line">    CACHE_TYPE &#x3D; &#39;redis&#39; # 使用redis作为缓存</span><br><span class="line">    CACHE_KEY_PREFIX # 设置cache_key的前缀</span><br><span class="line">    CACHE_REDIS_HOST  # redis地址</span><br><span class="line">    CACHE_REDIS_PORT  # redis端口</span><br><span class="line">    CACHE_REDIS_PASSWORD # redis密码</span><br><span class="line">    CACHE_REDIS_DB # 使用哪个数据库</span><br><span class="line">    # 也可以一键配置</span><br><span class="line">    CACHE_REDIS_URL	连接到Redis服务器的URL。示例redis:&#x2F;&#x2F;user:password@localhost:6379&#x2F;2</span><br><span class="line">&#125;</span><br><span class="line"># 初始化缓存文件</span><br><span class="line">cache.init_app(app&#x3D;app,config&#x3D;config)</span><br></pre></td></tr></table></figure>

<p>第三步:在Views.py中引入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">from exts import  cache </span><br><span class="line"></span><br><span class="line"># 发送短信息</span><br><span class="line">@user_bp.route(&#39;&#x2F;sendMsg&#39;)</span><br><span class="line">def send_message():</span><br><span class="line">    phone &#x3D; request.args.get(&#39;phone&#39;)</span><br><span class="line">    # 补充验证手机号码是否注册，去数据库查询</span><br><span class="line">    ret, code &#x3D; send_duanxin(phone)</span><br><span class="line">    # 验证是否发送成功</span><br><span class="line">    if ret is not None:</span><br><span class="line">        if ret[&quot;code&quot;] &#x3D;&#x3D; 200:</span><br><span class="line">            # cache.set(key,value,timeout&#x3D;second)</span><br><span class="line">            # 设置短信验证码保存到redis中,设置过期时间</span><br><span class="line">            # 1,安装  pip3 install flask-caching</span><br><span class="line">            cache.set(phone, code, timeout&#x3D;180)</span><br><span class="line">            return jsonify(code&#x3D;200, msg&#x3D;&#39;短信发送成功！&#39;)</span><br><span class="line">        else:</span><br><span class="line">            print(&quot;ERROR: ret.code&#x3D;%s,msg&#x3D;%s&quot; % (ret[&#39;code&#39;], ret[&#39;msg&#39;]))</span><br><span class="line">            return jsonify(code&#x3D;400, msg&#x3D;&#39;短信发送失败！&#39;)</span><br></pre></td></tr></table></figure>

<h2 id="相关使用"><a href="#相关使用" class="headerlink" title="相关使用"></a>相关使用</h2><h3 id="缓存视图函数"><a href="#缓存视图函数" class="headerlink" title="缓存视图函数"></a>缓存视图函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#39;&#x2F;&#39;)</span><br><span class="line">@cache.cached(timeout&#x3D;30)  # timeout 设置超时时间</span><br><span class="line">def index():</span><br><span class="line">		print(&#39;查询数据库&#39;)</span><br><span class="line">    return &#39;缓存视图函数&#39;</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;clear&#x2F;&#39;)</span><br><span class="line">def index():</span><br><span class="line">		cache.clear()</span><br><span class="line">    return &#39;清除所有的缓存，操作需慎重，不推荐使用&#39;</span><br></pre></td></tr></table></figure>

<h3 id="缓存普通函数（无参）"><a href="#缓存普通函数（无参）" class="headerlink" title="缓存普通函数（无参）"></a>缓存普通函数（无参）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 缓存普通函数时，推荐指定 key_prefix，缓存 key 的前缀</span><br><span class="line"># 否则 key 即为调⽤的视图函数所在的路由</span><br><span class="line"># 单独缓存某个函数，提供更好的复用性</span><br><span class="line">@cache.cached(timeout&#x3D;50, key_prefix&#x3D;&#39;get_list&#39;)</span><br><span class="line">def get_list():</span><br><span class="line">    return [random.randint(0, 10) for i in range(10)]</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;random&#x2F;&#39;)</span><br><span class="line">def random():</span><br><span class="line">		return get_list()</span><br></pre></td></tr></table></figure>

<h3 id="缓存普通函数（有参）"><a href="#缓存普通函数（有参）" class="headerlink" title="缓存普通函数（有参）"></a>缓存普通函数（有参）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@cache.memoize(timeout&#x3D;50, make_name&#x3D;&#39;param_func&#39;)</span><br><span class="line">def param_func(a, b):</span><br><span class="line">    return a+b+random.randint(1, 50)</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;cache&#x2F;&#39;)</span><br><span class="line">def cache():</span><br><span class="line">    param_func(1, 2)</span><br><span class="line">		return &#39;cache&#39;</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;delete&#x2F;&#39;)</span><br><span class="line">def delete():</span><br><span class="line">    cache.delete_memoized(param_func, 1, 2)</span><br><span class="line">		return &#39;delete&#39;</span><br></pre></td></tr></table></figure>

<h3 id="缓存对象（键值对）"><a href="#缓存对象（键值对）" class="headerlink" title="缓存对象（键值对）"></a>缓存对象（键值对）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#39;&#x2F;test&#39;)</span><br><span class="line">def test():</span><br><span class="line">    cache.set(&#39;name&#39;,&#39;小明&#39;, timeout&#x3D;30)</span><br><span class="line">    cache.set(&#39;person&#39;, &#123;&#39;name&#39;:&#39;小明&#39;, &#39;age&#39;:18&#125;)</span><br><span class="line">    x &#x3D; cache.get(&#39;name&#39;)</span><br><span class="line">    print(x)</span><br><span class="line">    cache.set_many([(&#39;name1&#39;,&#39;小明&#39;),(&#39;name2&#39;,&#39;老王&#39;)])</span><br><span class="line">    print(cache.get_many(&quot;name1&quot;,&quot;name2&quot;))</span><br><span class="line">    print(cache.delete(&quot;name&quot;))</span><br><span class="line">    print(cache.delete_many(&quot;name1&quot;,&quot;name2&quot;))</span><br><span class="line">    return &#39;test&#39;</span><br></pre></td></tr></table></figure>

<h2 id="cache-对象的主要方法"><a href="#cache-对象的主要方法" class="headerlink" title="cache 对象的主要方法"></a>cache 对象的主要方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cache.cached：装饰器，装饰无参数函数，使得该函数结果可以缓存</span><br><span class="line">    参数:</span><br><span class="line">    timeout:超时时间</span><br><span class="line">    key_prefix：设置该函数的标志</span><br><span class="line">    unless：设置是否启用缓存，如果为True，不启用缓存</span><br><span class="line">    forced_update：设置缓存是否实时更新，如果为True，无论是否过期都将更新缓存</span><br><span class="line">    query_string：为True时，缓存键是先将参数排序然后哈希的结果</span><br><span class="line"></span><br><span class="line">cache.memoize：装饰器，装饰有参数函数，使得该函数结果可以缓存</span><br><span class="line">		make_name：设置函数的标志，如果没有就使用装饰的函数</span><br><span class="line">		# 其他参数同cached</span><br><span class="line"></span><br><span class="line">cache.delete_memoized：删除缓存</span><br><span class="line">  参数：</span><br><span class="line">  func_name：缓存函数的引用</span><br><span class="line">  *args：函数参数</span><br><span class="line"></span><br><span class="line">cache.clear() # 清除缓存所有的缓存，这个操作需要慎重</span><br><span class="line">cache.</span><br><span class="line">	get(key)  #获取一个键的值，如果值是json格式会自动转化成字典</span><br><span class="line">	set(key,value,timeout)  #设置一个键值，value可以是字典，会自动转化json格式的字符串,timeout过期时间</span><br><span class="line">	add(key, value, timeout&#x3D;None)  #设置一个键值,如果存在就pass，注意和set的区别</span><br><span class="line">	delete(key)  #删除键 如果删除成功就返回True,否则返回 False</span><br></pre></td></tr></table></figure>

<h1 id="Flask对象储存"><a href="#Flask对象储存" class="headerlink" title="Flask对象储存"></a>Flask对象储存</h1><blockquote>
<p>为什么使用对象储存?</p>
</blockquote>
<ol>
<li>本地去存储图片,占用自己的服务器资源</li>
<li>本地资源太多,加载时间长</li>
</ol>
<p><strong>总结:</strong>所以使用第三方平台七牛云提供的对象储存,因为它提供了一定时间免费时间和第三方服务商有提供数据分析方便观察,节省服务器空间,缺点需要收费</p>
<p><strong>七牛云工具类</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">from qiniu import Auth, put_file, etag, put_data, BucketManager</span><br><span class="line">import qiniu.config</span><br><span class="line"></span><br><span class="line"># 文件上传</span><br><span class="line">def upload_qiniu(filestorage):</span><br><span class="line">    # 需要填写你的 Access Key 和 Secret Key</span><br><span class="line">    access_key &#x3D; &#39;3lObV41wal56iu2nqfsbpNg5E8XNHn3raOiMiahM&#39;</span><br><span class="line">    secret_key &#x3D; &#39;c8BhUBveLYC9DXEQa71CZflOLY9uiNYdZrHUccVB&#39;</span><br><span class="line">    # 构建鉴权对象</span><br><span class="line">    q &#x3D; Auth(access_key, secret_key)</span><br><span class="line">    # 要上传的空间</span><br><span class="line">    bucket_name &#x3D; &#39;flask-upload-test&#39;</span><br><span class="line">    # 上传后保存的文件名</span><br><span class="line">    filename &#x3D; filestorage.filename</span><br><span class="line">    ran &#x3D; random.randint(1, 1000)</span><br><span class="line">    suffix &#x3D; filename.rsplit(&#39;.&#39;)[-1]</span><br><span class="line">    key &#x3D; filename.rsplit(&#39;.&#39;)[0] + &#39;_&#39; + str(ran) + &#39;.&#39; + suffix</span><br><span class="line">    # 生成上传 Token，可以指定过期时间等</span><br><span class="line">    token &#x3D; q.upload_token(bucket_name, key, 3600)</span><br><span class="line">    # 要上传文件的本地路径</span><br><span class="line">    # localfile &#x3D; &#39;.&#x2F;sync&#x2F;bbb.jpg&#39;</span><br><span class="line">    # ret, info &#x3D; put_file(token, key, localfile)</span><br><span class="line">    ret, info &#x3D; put_data(token, key, filestorage.read())</span><br><span class="line">    return ret, info</span><br><span class="line"></span><br><span class="line"># 文件删除</span><br><span class="line">def delete_qiniu(filename):</span><br><span class="line">    # 需要填写你的 Access Key 和 Secret Key</span><br><span class="line">    access_key &#x3D; &#39;3lObV41wal56iu2nqfsbpNg5E8XNHn3raOiMiahM&#39;</span><br><span class="line">    secret_key &#x3D; &#39;c8BhUBveLYC9DXEQa71CZflOLY9uiNYdZrHUccVB&#39;</span><br><span class="line">    # 构建鉴权对象</span><br><span class="line">    q &#x3D; Auth(access_key, secret_key)</span><br><span class="line">    # 要上传的空间</span><br><span class="line">    bucket_name &#x3D; &#39;flask-upload-test&#39;</span><br><span class="line">    # 初始化BucketManager</span><br><span class="line">    bucket &#x3D; BucketManager(q)</span><br><span class="line">    # key就是要删除的文件的名字</span><br><span class="line">    key &#x3D; filename</span><br><span class="line">    ret, info &#x3D; bucket.delete(bucket_name, key)</span><br><span class="line">    return info</span><br></pre></td></tr></table></figure>

<p>调用执行实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 上传照片</span><br><span class="line">@user_bp.route(&#39;&#x2F;upload_photo&#39;, methods&#x3D;[&#39;GET&#39;, &#39;POST&#39;])</span><br><span class="line">def upload_photo():</span><br><span class="line">    # 获取上传的内容</span><br><span class="line">    photo &#x3D; request.files.get(&#39;photo&#39;)  # FileStorage</span><br><span class="line">    # photo.filename,photo.save(path)</span><br><span class="line">    # 工具模块中封装方法</span><br><span class="line">    ret, info &#x3D; upload_qiniu(photo)</span><br><span class="line">    if info.status_code &#x3D;&#x3D; 200:</span><br><span class="line">        photo &#x3D; Photo()</span><br><span class="line">        photo.photo_name &#x3D; ret[&#39;key&#39;]</span><br><span class="line">        photo.user_id &#x3D; session.get(&#39;uid&#39;)</span><br><span class="line">        db.session.add(photo)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        return &#39;上传成功！&#39;</span><br><span class="line">    else:</span><br><span class="line">        return &#39;上传失败！&#39;</span><br></pre></td></tr></table></figure>

<h1 id="Flask-WTF"><a href="#Flask-WTF" class="headerlink" title="Flask-WTF"></a>Flask-WTF</h1><p>Web应用程序的一个重要方面是为用户提供用户界面。HTML提供了一个<strong><form></strong>标签，用于设计界面。可以适当地使用<strong>Form（表单）</strong>元素，例如文本输入，单选按钮，选择等。</p>
<p>用户输入的数据以Http请求消息的形式通过GET或POST方法提交给服务器端脚本。</p>
<ul>
<li>服务器端脚本必须从http请求数据重新创建表单元素。因此，实际上，表单元素必须定义两次 - 一次在HTML中，另一次在服务器端脚本中。</li>
<li>使用HTML表单的另一个缺点是很难（如果不是不可能的话）动态呈现表单元素。HTML本身无法验证用户的输入。</li>
</ul>
<p>这就是<strong>WTForms</strong>的作用，一个灵活的表单，渲染和验证库，能够方便使用。Flask-WTF扩展为这个<strong>WTForms</strong>库提供了一个简单的接口。</p>
<p>使用<strong>Flask-WTF</strong>，我们可以在Python脚本中定义表单字段，并使用HTML模板进行渲染。还可以将验证应用于<strong>WTF</strong>字段。</p>
<h2 id="WTForms和Flask-WTF的关系"><a href="#WTForms和Flask-WTF的关系" class="headerlink" title="WTForms和Flask-WTF的关系"></a>WTForms和Flask-WTF的关系</h2><p>WTForms是一个Flask集成的框架，或者是说库。用于处理浏览器表单提交的数据。它在Flask-WTF 的基础上扩展并添加了一些随手即得的精巧的帮助函数，这些函数将会使在 Flask 里使用表单更加有趣。</p>
<p>Flask-WTF是集成WTForms，并带有 csrf 令牌的安全表单和全局的 csrf 保护的功能。每次我们在建立表单所创建的类都是继承与flask_wtf中的FlaskForm，而FlaskForm是继承WTForms中forms。</p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><ul>
<li>集成 wtforms。</li>
<li>带有 csrf 令牌的安全表单。</li>
<li>全局的 csrf 保护。</li>
<li>支持验证码（Recaptcha）。</li>
<li>与 Flask-Uploads 一起支持文件上传。</li>
<li>国际化集成。</li>
</ul>
<h2 id="相关使用-1"><a href="#相关使用-1" class="headerlink" title="相关使用"></a>相关使用</h2><p>首先，需要安装Flask-WTF扩展。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-WTF</span><br></pre></td></tr></table></figure>

<h3 id="一丶创建基础表单"><a href="#一丶创建基础表单" class="headerlink" title="一丶创建基础表单"></a>一丶创建基础表单</h3><h4 id="1-基础表单"><a href="#1-基础表单" class="headerlink" title="1. 基础表单"></a>1. 基础表单</h4><p>例如，form.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserForm</span><span class="params">(FlaskForm)</span>:</span></span><br><span class="line">       name = StringField(label=<span class="string">'用户名'</span>, validators=[DataRequired(), Length(min=<span class="number">6</span>, max=<span class="number">12</span>, message=<span class="string">'用户名长度必须在6～12位之间'</span>)])</span><br><span class="line">       password = PasswordField(label=<span class="string">'密码'</span>, validators=[DataRequired(), Length(min=<span class="number">6</span>, max=<span class="number">12</span>, message=<span class="string">'密码长度必须在6～12位之间'</span>)])</span><br><span class="line">       confirm_pwd = PasswordField(label=<span class="string">'确认密码'</span>,</span><br><span class="line">                                   validators=[DataRequired(), Length(min=<span class="number">6</span>, max=<span class="number">12</span>, message=<span class="string">'密码长度必须在6～12位之间'</span>),</span><br><span class="line">                                               EqualTo(<span class="string">'password'</span>, <span class="string">'两次密码不一致'</span>)])</span><br><span class="line">       phone = StringField(label=<span class="string">'手机号码'</span>, validators=[DataRequired(), Length(min=<span class="number">11</span>, max=<span class="number">11</span>, message=<span class="string">'手机号码必须11位长度'</span>)])</span><br></pre></td></tr></table></figure>

<h4 id="2-CSRF-跨站点请求伪造-保护"><a href="#2-CSRF-跨站点请求伪造-保护" class="headerlink" title="2.CSRF(跨站点请求伪造)保护"></a>2.CSRF(跨站点请求伪造)保护</h4><p>CSRF概念：CSRF跨站点请求伪造(Cross—Site Request Forgery)，跟XSS攻击一样，存在巨大的危害性，你可以这样来理解：</p>
<blockquote>
<p>攻击者盗用了你的身份，以你的名义发送恶意请求，对服务器来说这个请求是完全合法的，但是却完成了攻击者所期望的一个操作，比如以你的名义发送邮件、发消息，盗取你的账号，添加系统管理员，甚至于购买商品、虚拟货币转账等。 如下：其中Web A为存在CSRF漏洞的网站，Web B为攻击者构建的恶意网站，User C为Web A网站的合法用户。</p>
<p>CSRF攻击攻击原理及过程如下：</p>
<ol>
<li><p>用户C打开浏览器，访问受信任网站A，输入用户名和密码请求登录网站A；</p>
</li>
<li><p>在用户信息通过验证后，网站A产生Cookie信息并返回给浏览器，此时用户登录网站A成功，可以正常发送请求到网站A；</p>
</li>
<li><p>用户未退出网站A之前，在同一浏览器中，打开一个TAB页访问网站B；</p>
</li>
<li><p>网站B接收到用户请求后，返回一些攻击性代码，并发出一个请求要求访问第三方站点A；</p>
</li>
<li><p>浏览器在接收到这些攻击性代码后，根据网站B的请求，在用户不知情的情况下携带Cookie信息，向网站A发出请求。网站A并不知道该请求其实是由B发起的，所以会根据用户C的Cookie信息以C的权限处理该请求，导致来自网站B的恶意代码被执行。 </p>
</li>
</ol>
</blockquote>
<p>任何使用FlaskForm创建的表单发送请求，都会有CSRF的全部保护，需要在app中添加<code>secret_key</code>的值,否则报错,在对应的template中HTML渲染表单时，可以加入form.csrf_token：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 全局使用csrf保护，</span><br><span class="line">csrf &#x3D; CSRFProtect(app&#x3D;app)</span><br><span class="line"># 必须需要设置SECRET_KEY这个配置项</span><br><span class="line">app.config[&#39;SECRET_KEY&#39;] &#x3D; &#39;fgfhdf4564&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    &#123;&#123; form.csrf_token &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是如果模板中没有表单，则可以使用一个隐藏的input标签加入csrf_token。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"csrf_token"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; csrf_token() &#125;&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h4><p>视图中必须渲染form对象带页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">form &#x3D;UserForm()</span><br><span class="line">return render_template(&#39;user.html&#39;,form&#x3D;form)</span><br></pre></td></tr></table></figure>

<p>在<code>user.html</code>中获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action&#x3D;&#39;&#39; method&#x3D;&#39;&#39;&gt;</span><br><span class="line">    &#123;&#123;form.csrf_token&#125;&#125;</span><br><span class="line">    &#123;&#123;form.name&#125;&#125;</span><br><span class="line">    &#123;&#123;form.password&#125;&#125;</span><br><span class="line">    &lt;input type&#x3D;&#39;submit&#39; value&#x3D;&#39;&#39;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br></pre></td></tr></table></figure>

<h4 id="4-提交验证"><a href="#4-提交验证" class="headerlink" title="4. 提交验证"></a>4. 提交验证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#39;&#x2F;&#39;,methods&#x3D;[&#39;GET&#39;,&#39;POST&#39;])</span><br><span class="line">def hello_world():</span><br><span class="line">    uform &#x3D; UserForm()</span><br><span class="line">    if uform.validate_on_submit():   -------&gt;主要通过validate_on_submit进行校验</span><br><span class="line">        print(uform.name)</span><br><span class="line">        print(uform.password)</span><br><span class="line">        return &#39;提交成功！&#39;</span><br><span class="line">    return render_template(&#39;user.html&#39;, uform&#x3D;uform)</span><br></pre></td></tr></table></figure>

<p>使用<code>validate_on_submit</code> 来检查是否是一个 POST 请求并且请求是否有效。</p>
<h3 id="二丶文件上传"><a href="#二丶文件上传" class="headerlink" title="二丶文件上传"></a>二丶文件上传</h3><p>Flask-WTF 提供 <a href="https://wizardforcel.gitbooks.io/flask-extension-docs/content/api.html#flask_wtf.file.FileField" target="_blank" rel="noopener"><code>FileField</code></a> 来处理文件上传，它在表单提交后，自动从 <code>flask.request.files</code> 中抽取数据。<a href="https://wizardforcel.gitbooks.io/flask-extension-docs/content/api.html#flask_wtf.file.FileField" target="_blank" rel="noopener"><code>FileField</code></a> 的 <code>data</code> 属性是一个 Werkzeug FileStorage 实例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">from</span> flask_wtf.file <span class="keyword">import</span> FileField</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取项目的绝对路径</span></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"><span class="comment"># 路径后面添加staitc目录</span></span><br><span class="line">STATIC_DIR = os.path.join(BASE_DIR, <span class="string">'static'</span>)</span><br><span class="line"><span class="comment"># 路径后面添加upload目录</span></span><br><span class="line">UPLOAD_DIR = os.path.join(STATIC_DIR, <span class="string">'upload'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhotoForm</span><span class="params">(Form)</span>:</span></span><br><span class="line">     <span class="comment"># 上传使用的就是FileField，如果需要指定上传文件的类型需要使用：FileAllowed</span></span><br><span class="line">    photo = FileField(label=<span class="string">'用户头像'</span>, validators=[FileRequired(), FileAllowed([<span class="string">'jpg'</span>, <span class="string">'png'</span>, <span class="string">'gif'</span>], message=<span class="string">'必须是图片文件格式'</span>)])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/upload/', methods=('GET', 'POST'))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    form = PhotoForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        filename = secure_filename(form.photo.data.filename)  </span><br><span class="line">        form.photo.data.save(os.path.join(UPLOAD_DIR, filename))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        filename = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'upload.html'</span>, form=form, filename=filename)</span><br></pre></td></tr></table></figure>

<p>注意：在 HTML 表单的 enctype 设置成<code>multipart/form-data</code>，如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/upload/"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    ....</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="三丶验证码"><a href="#三丶验证码" class="headerlink" title="三丶验证码"></a>三丶验证码</h3><p>Flask-WTF 通过 RecaptchaField 也提供对验证码的支持:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> Form, RecaptchaField</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> TextField</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SignupForm</span><span class="params">(Form)</span>:</span></span><br><span class="line">    <span class="comment"># recaptcha = RecaptchaField() </span></span><br><span class="line">    <span class="comment"># 因为使用的是google的,所以这里使用Python3图像处理库pillow</span></span><br><span class="line">    recaptcha = StringField(label=<span class="string">'验证码'</span>) <span class="comment"># 把图形验证码显示在后面</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Pillow是PIL的一个派生分支，但如今已经发展成为比PIL本身更具活力的图像处理库。pillow可以说已经取代了PIL，将其封装成python的库（pip即可安装），且支持python2和python3，目前最新版本是3.0.0。</p>
</blockquote>
<p>还需要配置一下信息：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>RECAPTCHA_PUBLIC_KEY</td>
<td><strong>必须</strong> 公钥</td>
</tr>
<tr>
<td>RECAPTCHA_PRIVATE_KEY</td>
<td><strong>必须</strong> 私钥</td>
</tr>
<tr>
<td>RECAPTCHA_API_SERVER</td>
<td><strong>可选</strong> 验证码 API 服务器</td>
</tr>
<tr>
<td>RECAPTCHA_PARAMETERS</td>
<td><strong>可选</strong> 一个 JavaScript（api.js）参数的字典</td>
</tr>
<tr>
<td>RECAPTCHA_DATA_ATTRS</td>
<td><strong>可选</strong> 一个数据属性项列表 <a href="https://developers.google.com/recaptcha/docs/display" target="_blank" rel="noopener">https://developers.google.com/recaptcha/docs/display</a></td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="comment"># csrf保护</span></span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = <span class="string">'jfkdk73434kjfk3'</span></span><br><span class="line"><span class="comment"># 测试环境</span></span><br><span class="line">app.config[<span class="string">'ENV'</span>] = <span class="string">'testing'</span></span><br><span class="line"><span class="comment"># 必须 公钥</span></span><br><span class="line">app.config[<span class="string">'RECAPTCHA_PUBLIC_KEY'</span>] = <span class="string">'6LeYIbsSAAAAACRPIllxA7wvXjIE411PfdB2gt2J'</span></span><br><span class="line"><span class="comment"># 必须 私钥</span></span><br><span class="line">app.config[<span class="string">'RECAPTCHA_PRIVATE_KEY'</span>] = <span class="string">'6LeYIbsSAAAAAJezaIq3Ft_hSTo0YtyeFG-JgRtu'</span></span><br><span class="line"><span class="comment"># 可选 一个 JavaScript（api.js）参数的字典</span></span><br><span class="line">app.config[<span class="string">'RECAPTCHA_PARAMETERS'</span>] = &#123;<span class="string">'hl'</span>: <span class="string">'zh'</span>, <span class="string">'render'</span>: <span class="string">'explicit'</span>&#125;</span><br><span class="line"><span class="comment">#可选 一个数据属性项列表</span></span><br><span class="line">app.config[<span class="string">'RECAPTCHA_DATA_ATTRS'</span>] = &#123;<span class="string">'theme'</span>: <span class="string">'dark'</span>&#125;</span><br><span class="line"><span class="comment"># 初始化全局csrf保护</span></span><br><span class="line">csrf = CSRFProtect(app=app)</span><br><span class="line"><span class="comment"># 初始化bootstrap</span></span><br><span class="line">bootstrap = Bootstrap(app=app)</span><br></pre></td></tr></table></figure>

<h5 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow</span><br></pre></td></tr></table></figure>

<h5 id="2-utils-py工具类"><a href="#2-utils-py工具类" class="headerlink" title="2. utils.py工具类"></a>2. utils.py工具类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import random</span><br><span class="line">from PIL import Image, ImageFont, ImageDraw, ImageFilter</span><br><span class="line"></span><br><span class="line">def get_random_color():</span><br><span class="line">    return (random.randint(0, 255), random.randint(0, 255), random.randint(0, 255))</span><br><span class="line"></span><br><span class="line">def generate_image(length):</span><br><span class="line">    s &#x3D; &#39;qwerQWERTYUIOtyuiopas123456dfghjklPASDFGHJKLZXCVBNMxcvbnm7890&#39;</span><br><span class="line">    size &#x3D; (130, 50)</span><br><span class="line">    # 创建画布</span><br><span class="line">    im &#x3D; Image.new(&#39;RGB&#39;, size, color&#x3D;get_random_color())</span><br><span class="line">    # 创建字体</span><br><span class="line">    font &#x3D; ImageFont.truetype(&#39;font&#x2F;方正正中黑简体.ttf&#39;, size&#x3D;35)</span><br><span class="line">    # 创建ImageDraw对象</span><br><span class="line">    draw &#x3D; ImageDraw.Draw(im)</span><br><span class="line">    # 绘制验证码</span><br><span class="line">    code &#x3D; &#39;&#39;</span><br><span class="line">    for i in range(length):</span><br><span class="line">        c &#x3D; random.choice(s)</span><br><span class="line">        code +&#x3D; c</span><br><span class="line">        draw.text((5 + random.randint(4, 7) + 25 * i, 1),</span><br><span class="line">                  text&#x3D;c,</span><br><span class="line">                  fill&#x3D;get_random_color(),</span><br><span class="line">                  font&#x3D;font)</span><br><span class="line">    # 绘制干扰线</span><br><span class="line">    for i in range(8):</span><br><span class="line">        x1 &#x3D; random.randint(0, 130)</span><br><span class="line">        y1 &#x3D; random.randint(0, 50 &#x2F; 2)</span><br><span class="line"></span><br><span class="line">        x2 &#x3D; random.randint(0, 130)</span><br><span class="line">        y2 &#x3D; random.randint(50 &#x2F; 2, 50)</span><br><span class="line"></span><br><span class="line">        draw.line(((x1, y1), (x2, y2)), fill&#x3D;get_random_color())</span><br><span class="line"></span><br><span class="line">    im &#x3D; im.filter(ImageFilter.EDGE_ENHANCE)</span><br><span class="line">    return im, code</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    generate_image(4)</span><br></pre></td></tr></table></figure>

<h5 id="页面user-html"><a href="#页面user-html" class="headerlink" title="页面user.html"></a>页面user.html</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;</span><br><span class="line">&#123;&#123; uform.recaptcha.label &#125;&#125;:&#123;&#123; uform.recaptcha &#125;&#125; </span><br><span class="line">&lt;img src&#x3D;&quot;&#123;&#123; url_for(&#39;get_image&#39;) &#125;&#125;&quot; alt&#x3D;&quot;&quot; id&#x3D;&quot;img&quot;&gt;</span><br><span class="line">&lt;&#x2F;p&gt;</span><br><span class="line">&lt;p&gt;&#123;% if  uform.recaptcha.errors %&#125;</span><br><span class="line">&#123;&#123; uform.recaptcha.errors.0 &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	&lt;!--点击图片刷新验证码--&gt;</span><br><span class="line">    $(&#39;#img&#39;).click(function () &#123;</span><br><span class="line">        console.log(&#39;-------&#39;)</span><br><span class="line">        $(this).attr(&#39;src&#39;, &quot;&#123;&#123; url_for(&#39;get_image&#39;) &#125;&#125;?ran&#x3D;&quot; + Math.random());</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="WTForms"><a href="#WTForms" class="headerlink" title="WTForms"></a><a href="https://wtforms.readthedocs.io/en/stable/" target="_blank" rel="noopener">WTForms</a></h2><h3 id="基本了解"><a href="#基本了解" class="headerlink" title="基本了解"></a>基本了解</h3><p>WTForms是一个Flask集成的框架，或者是说库。用于处理浏览器表单提交的数据。它在Flask-WTF 的基础上扩展并添加了一些随手即得的精巧的帮助函数，这些函数将会使在 Flask 里使用表单更加有趣。</p>
<h3 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h3><h5 id="1-field字段"><a href="#1-field字段" class="headerlink" title="1.field字段"></a>1.field字段</h5><p>WTForms支持HTML字段：</p>
<table>
<thead>
<tr>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>StringField</td>
<td>文本字段， 相当于type类型为text的input标签</td>
</tr>
<tr>
<td>TextAreaField</td>
<td>多行文本字段</td>
</tr>
<tr>
<td>PasswordField</td>
<td>密码文本字段</td>
</tr>
<tr>
<td>HiddenField</td>
<td>隐藏文本字段</td>
</tr>
<tr>
<td>DateField</td>
<td>文本字段， 值为datetime.date格式</td>
</tr>
<tr>
<td>DateTimeField</td>
<td>文本字段， 值为datetime.datetime格式</td>
</tr>
<tr>
<td>IntegerField</td>
<td>文本字段， 值为整数</td>
</tr>
<tr>
<td>DecimalField</td>
<td>文本字段， 值为decimal.Decimal</td>
</tr>
<tr>
<td>FloatField</td>
<td>文本字段， 值为浮点数</td>
</tr>
<tr>
<td>BooleanField</td>
<td>复选框， 值为True 和 False</td>
</tr>
<tr>
<td>RadioField</td>
<td>一组单选框</td>
</tr>
<tr>
<td>SelectField</td>
<td>下拉列表</td>
</tr>
<tr>
<td>SelectMultipleField</td>
<td>下拉列表， 可选择多个值</td>
</tr>
<tr>
<td>FileField</td>
<td>文件上传字段</td>
</tr>
<tr>
<td>SubmitField</td>
<td>表单提交按钮</td>
</tr>
<tr>
<td>FormFiled</td>
<td>把表单作为字段嵌入另一个表单</td>
</tr>
<tr>
<td>FieldList</td>
<td>子组指定类型的字段</td>
</tr>
</tbody></table>
<h5 id="2-Validators验证器"><a href="#2-Validators验证器" class="headerlink" title="2.Validators验证器"></a>2.Validators验证器</h5><p>WTForms可以支持很多表单的验证函数：</p>
<table>
<thead>
<tr>
<th>验证函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Email</td>
<td>验证是电子邮件地址</td>
</tr>
<tr>
<td>EqualTo</td>
<td>比较两个字段的值； 常用于要求输入两次密钥进行确认的情况</td>
</tr>
<tr>
<td>IPAddress</td>
<td>验证IPv4网络地址</td>
</tr>
<tr>
<td>Length</td>
<td>验证输入字符串的长度</td>
</tr>
<tr>
<td>NumberRange</td>
<td>验证输入的值在数字范围内</td>
</tr>
<tr>
<td>Optional</td>
<td>无输入值时跳过其它验证函数</td>
</tr>
<tr>
<td>DataRequired</td>
<td>确保字段中有数据</td>
</tr>
<tr>
<td>Regexp</td>
<td>使用正则表达式验证输入值</td>
</tr>
<tr>
<td>URL</td>
<td>验证url</td>
</tr>
<tr>
<td>AnyOf</td>
<td>确保输入值在可选值列表中</td>
</tr>
<tr>
<td>NoneOf</td>
<td>确保输入值不在可选列表中</td>
</tr>
</tbody></table>
<p>现在，我们将对联系表单中的<strong>name</strong>字段应用<strong>‘DataRequired’</strong>验证规则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name &#x3D; TextField(&quot;Name Of Student&quot;,[validators.Required(&quot;Please enter your name.&quot;)])</span><br></pre></td></tr></table></figure>

<p>如果验证失败，表单对象的<strong>validate()</strong>函数将验证表单数据并抛出验证错误。<strong>Error</strong>消息将发送到模板。在HTML模板中，动态呈现error消息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for message in form.name.errors %&#125;</span><br><span class="line">   &#123;&#123; message &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-自定义Validators验证器"><a href="#3-自定义Validators验证器" class="headerlink" title="3.自定义Validators验证器"></a>3.自定义Validators验证器</h5><p>第一种： <a href="https://wtforms.readthedocs.io/en/latest/forms.html#inline-validators" target="_blank" rel="noopener">in-line validator</a>（内联验证器）<br> 也就是自定义一个验证函数，在定义表单类的时候，在对应的字段中加入该函数进行认证。下面的<code>my_length_check</code>函数就是用于判<code>name</code>字段长度不能超过50.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_length_check</span><span class="params">(form, field)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(field.data) &gt; <span class="number">50</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">'Field must be less than 50 characters'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyForm</span><span class="params">(Form)</span>:</span></span><br><span class="line">    name = StringField(<span class="string">'Name'</span>, [InputRequired(), my_length_check])</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>第二种：</strong>通用且可重用的验证函数,为常用的自定义Validators验证器</p>
</blockquote>
<p>一般是以<code>validate</code>开头，加上下划线再加上对应的field字段（validate_filed），浏览器在提交表单数据时，会自动识别对应字段所有的验证器，然后执行验证器进行判断。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegistrationForm</span><span class="params">(FlaskForm)</span>:</span></span><br><span class="line">    email = StringField(<span class="string">'Email'</span>, validators=[DataRequired(), Length(<span class="number">1</span>, <span class="number">60</span>), Email()])</span><br><span class="line">    username = StringField(<span class="string">'Username'</span>, validators=[DataRequired(), Length(<span class="number">1</span>, <span class="number">60</span>),</span><br><span class="line">        Regexp(<span class="string">'^[A-Za-z][A-Za-z0-9_.]*$'</span>, <span class="number">0</span>, <span class="string">'username must have only letters, numbers dots or underscores'</span>)])</span><br><span class="line">    password = PasswordField(<span class="string">'Password'</span>, validators=[DataRequired(), EqualTo(<span class="string">'password2'</span>, message=<span class="string">'password must match'</span>)])</span><br><span class="line">    password2 = PasswordField(<span class="string">'Confirm password'</span>, validators=[DataRequired()])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_email</span><span class="params">(self, field)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> User.objects.filter(email=field.data).count() &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'Email already registered'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_username</span><span class="params">(self, field)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> User.objects.filter(username=field.data).count() &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'Username has exist'</span>)</span><br></pre></td></tr></table></figure>

<p>第三种：比较高级的validators</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Length</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, min=<span class="number">-1</span>, max=<span class="number">-1</span>, message=None)</span>:</span></span><br><span class="line">        self.min = min</span><br><span class="line">        self.max = max</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> message:</span><br><span class="line">            message = <span class="string">u'Field must be between %i and %i characters long.'</span> % (min, max)</span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, form, field)</span>:</span></span><br><span class="line">        l = field.data <span class="keyword">and</span> len(field.data) <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> l &lt; self.min <span class="keyword">or</span> self.max != <span class="number">-1</span> <span class="keyword">and</span> l &gt; self.max:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(self.message)</span><br><span class="line"></span><br><span class="line">length = Length</span><br></pre></td></tr></table></figure>

<h5 id="4-Widget组件"><a href="#4-Widget组件" class="headerlink" title="4.Widget组件"></a>4.Widget组件</h5><p>下面可以以登录界面为实例：<br> login.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> Form</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> validators</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> widgets</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span><span class="params">(Form)</span>:</span></span><br><span class="line">    name = simple.StringField(</span><br><span class="line">        label=<span class="string">'用户名'</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">'用户名不能为空.'</span>),</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.TextInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">'class'</span>: <span class="string">'form-control'</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    pwd = simple.PasswordField(</span><br><span class="line">        label=<span class="string">'密码'</span>,</span><br><span class="line">        validators=[</span><br><span class="line">            validators.DataRequired(message=<span class="string">'密码不能为空.'</span>),</span><br><span class="line">        ],</span><br><span class="line">        widget=widgets.PasswordInput(),</span><br><span class="line">        render_kw=&#123;<span class="string">'class'</span>: <span class="string">'form-control'</span>&#125;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>其实flask表单这一部分我们都是使用Flask-WTF与WTForms来进行实现，比如说做一下简单的系统登录界面、注册界面等等，可以利用它们来做一些小demo，你就可以深入理解它的原理并且可以强化flask的基础。</p>
<h1 id="Flask-消息闪现"><a href="#Flask-消息闪现" class="headerlink" title="Flask 消息闪现"></a>Flask 消息闪现</h1><p>一个好的基于GUI的应用程序会向用户提供有关交互的反馈。例如，桌面应用程序使用对话框或消息框，JavaScript使用警报用于类似目的。</p>
<p>在Flask Web应用程序中生成这样的信息性消息很容易。Flask框架的闪现系统可以在一个视图中创建消息，并在名为<strong>next</strong>的视图函数中呈现它</p>
<p>Flask模块包含<strong>flash()</strong>方法。它将消息传递给下一个请求，该请求通常是一个模板。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flash(message, category)</span><br></pre></td></tr></table></figure>

<p>其中，</p>
<ul>
<li><strong>message</strong>参数是要闪现的实际消息。</li>
<li><strong>category</strong>参数是可选的。它可以是“error”，“info”或“warning”。</li>
</ul>
<p>为了从会话中删除消息，模板调用<strong>get_flashed_messages()</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get_flashed_messages(with_categories, category_filter)</span><br></pre></td></tr></table></figure>

<p>两个参数都是可选的。如果接收到的消息具有类别，则第一个参数是元组。第二个参数仅用于显示特定消息。</p>
<p>以下闪现在模板中接收消息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% with messages &#x3D; get_flashed_messages() %&#125;</span><br><span class="line">   &#123;% if messages %&#125;</span><br><span class="line">      &#123;% for message in messages %&#125;</span><br><span class="line">         &#123;&#123; message &#125;&#125;</span><br><span class="line">      &#123;% endfor %&#125;</span><br><span class="line">   &#123;% endif %&#125;</span><br><span class="line">&#123;% endwith %&#125;</span><br></pre></td></tr></table></figure>

<p>获取类型的闪现消息</p>
<p>view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#39;&#x2F;login&#39;, methods&#x3D;[&#39;GET&#39;, &#39;POST&#39;])</span><br><span class="line">def login():</span><br><span class="line">    if request.method &#x3D;&#x3D; &#39;POST&#39;:</span><br><span class="line">        # 验证是否是admin</span><br><span class="line">        username &#x3D; request.form.get(&#39;username&#39;)</span><br><span class="line">        if username &#x3D;&#x3D; &#39;admin&#39;:</span><br><span class="line">            flash(&#39;恭喜！验证成功啦！&#39;, &#39;info&#39;)</span><br><span class="line">            flash(&#39;哈哈哈&#39;, &#39;error&#39;)</span><br><span class="line">            flash(username, &#39;warning&#39;)</span><br><span class="line">            return redirect(url_for(&#39;index&#39;))</span><br><span class="line">        else:</span><br><span class="line">            # app.logger.debug(&#39;这是一个debug测试&#39;)</span><br><span class="line">            # app.logger.error(&#39;这个是一个error测试&#39;)</span><br><span class="line">            app.logger.warning(&#39;这个是一个warning测试&#39;)</span><br><span class="line">    return render_template(&#39;login.html&#39;)</span><br></pre></td></tr></table></figure>

<p>html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;测试&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        .info &#123;</span><br><span class="line">            color: deepskyblue;</span><br><span class="line">        &#125;</span><br><span class="line">        .warning &#123;</span><br><span class="line">            color: orange;</span><br><span class="line">        &#125;</span><br><span class="line">        .error &#123;</span><br><span class="line">            color: red;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;&#x2F;style&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&#123;% with messages &#x3D; get_flashed_messages(with_categories&#x3D;True) %&#125;</span><br><span class="line">    &#123;% if messages %&#125;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">            &#123;% for category, message in messages %&#125;</span><br><span class="line">                &lt;li class&#x3D;&quot;&#123;&#123; category &#125;&#125;&quot;&gt;&#123;&#123; message &#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line">        &lt;&#x2F;ul&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endwith %&#125;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Flask-日志"><a href="#Flask-日志" class="headerlink" title="Flask 日志"></a>Flask 日志</h1><p>Python 自身提供了一个用于记录日志的标准库模块：<code>logging</code>。</p>
<h2 id="logging-模块"><a href="#logging-模块" class="headerlink" title="logging 模块"></a>logging 模块</h2><ul>
<li>logging 模块定义的函数和类为应用程序和库的开发实现了一个灵活的事件日志系统</li>
<li>logging 模块是 Python 的一个标准库模块，由标准库模块提供日志记录 API 的关键好处是所有 Python 模块都可以使用这个日志记录功能。</li>
</ul>
<h3 id="logging-模块的日志级别"><a href="#logging-模块的日志级别" class="headerlink" title="logging 模块的日志级别"></a>logging 模块的日志级别</h3><ul>
<li><p>logging模块默认定义了以下几个日志等级，它允许开发人员自定义其他日志级别，但是这是不被推荐的，尤其是在开发供别人使用的库时，因为这会导致日志级别的混乱。</p>
<ul>
<li>DEBUG 最详细的日志信息，典型应用场景是 问题诊断</li>
<li>INFO 信息详细程度仅次于DEBUG，通常只记录关键节点信息，用于确认一切都是按照我们预期的那样进行工作</li>
<li>WARNING 当某些不期望的事情发生时记录的信息（如，磁盘可用空间较低），但是此时应用程序还是正常运行的</li>
<li>ERROR 由于一个更严重的问题导致某些功能不能正常运行时记录的信息</li>
<li>FATAL/CRITICAL 整个系统即将/完全崩溃</li>
</ul>
</li>
<li><p>开发应用程序或部署开发环境时，可以使用 DEBUG 或 INFO 级别的日志获取尽可能详细的日志信息来进行开发或部署调试；</p>
</li>
<li><p>应用上线或部署生产环境时，应该使用 WARNING 或 ERROR 或 CRITICAL 级别的日志来降低机器的I/O压力和提高获取错误日志信息的效率。</p>
</li>
</ul>
<blockquote>
<p>日志级别的指定通常都是在应用程序的配置文件中进行指定的。</p>
</blockquote>
<h3 id="logging-模块的使用方式介绍"><a href="#logging-模块的使用方式介绍" class="headerlink" title="logging 模块的使用方式介绍"></a>logging 模块的使用方式介绍</h3><ul>
<li>loggers 提供应用程序代码直接使用的接口</li>
<li>handlers 用于将日志记录发送到指定的目的位置</li>
<li>filters 提供更细粒度的日志过滤功能，用于决定哪些日志记录将会被输出（其它的日志记录将会被忽略）</li>
<li>formatters 用于控制日志信息的最终输出格式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logger &#x3D; logging.getLogger(__name__)</span><br><span class="line"># 设置日志的记录等级</span><br><span class="line">logger.setLevel(level&#x3D;logging.INFO)</span><br><span class="line"># 处理程序类到磁盘文件写入格式化的日志记录</span><br><span class="line">handler &#x3D; logging.FileHandler(&quot;log1.txt&quot;)</span><br><span class="line"># 设置此处理程序的日志记录级别</span><br><span class="line">handler.setLevel(logging.INFO)</span><br><span class="line"># 创建日志记录的格式 时间 输入日志信息的文件名 日志等级 日志信息</span><br><span class="line">formatter &#x3D; logging.Formatter(&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39;)</span><br><span class="line"># 为刚创建的日志记录器设置日志记录格式</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line"># 为全局的日志工具对象（flask app使用的）添加日志记录器</span><br><span class="line">logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line">logger.debug(&quot;Do something&quot;)</span><br><span class="line">logger.info(&quot;Start print log&quot;)</span><br><span class="line">logger.warning(&quot;Something maybe fail.&quot;)</span><br><span class="line">logger.info(&quot;Finish&quot;)</span><br></pre></td></tr></table></figure>

<h2 id="使用logging提供的模块级别的函数记录日志"><a href="#使用logging提供的模块级别的函数记录日志" class="headerlink" title="使用logging提供的模块级别的函数记录日志"></a>使用logging提供的模块级别的函数记录日志</h2><h3 id="最简单的日志输出"><a href="#最简单的日志输出" class="headerlink" title="最简单的日志输出"></a>最简单的日志输出</h3><p>先来试着分别输出一条不同日志级别的日志记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.debug(&quot;This is a debug log.&quot;)</span><br><span class="line">logging.info(&quot;This is a info log.&quot;)</span><br><span class="line">logging.warning(&quot;This is a warning log.&quot;)</span><br><span class="line">logging.error(&quot;This is a error log.&quot;)</span><br><span class="line">logging.critical(&quot;This is a critical log.&quot;)</span><br></pre></td></tr></table></figure>

<p>也可以这样写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logging.log(logging.DEBUG, &quot;This is a debug log.&quot;)</span><br><span class="line">logging.log(logging.INFO, &quot;This is a info log.&quot;)</span><br><span class="line">logging.log(logging.WARNING, &quot;This is a warning log.&quot;)</span><br><span class="line">logging.log(logging.ERROR, &quot;This is a error log.&quot;)</span><br><span class="line">logging.log(logging.CRITICAL, &quot;This is a critical log.&quot;)</span><br></pre></td></tr></table></figure>

<h1 id="Flask-restful"><a href="#Flask-restful" class="headerlink" title="Flask-restful"></a>Flask-restful</h1><blockquote>
<p>rest api 是前后端分离最佳实践，是开发的一套标准或者说是一套规范，不是框架。</p>
</blockquote>
<p>好处：<br> 1、轻量，直接通过http，不需要额外的协议，通常有<code>post/get/put/deletec</code>操作。<br> 2、面向资源，一目了然，具有自解释性<br> 3、数据描述简单，一般通过json或者xml做数据通讯rest的概括</p>
<p>REST的名称”表现层状态转化”中，省略了主语。”表现层”其实指的是”资源”（Resources）的”表现层”。</p>
<p>所谓”资源”，就是网络上的一个实体，或者说是网络上的一个具体信息。它可以是一段文本、一张图片、一首歌曲、一种服务，总之就是一个具体的实在。你可以用一个URI（统一资源定位符）指向它，每种资源对应一个特定的URI。要获取这个资源，访问它的URI就可以，因此URI就成了每一个资源的地址或独一无二的识别符。</p>
<blockquote>
<p>综合上面的解释，我们总结一下什么是RESTful架构：</p>
</blockquote>
<p>（1）每一个URI代表一种资源；</p>
<p>（2）客户端和服务器之间，传递这种资源的某种表现层；</p>
<p>（3）客户端通过四个HTTP动词，对服务器端资源进行操作，实现”表现层状态转化”。</p>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p><strong>步骤1.</strong> 安装扩展</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip  install flask-restful</span><br></pre></td></tr></table></figure>

<p><strong>步骤2.</strong> 在ext扩展包中<code>__init__.py</code>文件中定义对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from flask_restful import Api</span><br><span class="line">from flask_sqlalchemy import SQLAlchemy</span><br><span class="line"></span><br><span class="line">db &#x3D; SQLAlchemy()</span><br><span class="line">api &#x3D; Api()</span><br></pre></td></tr></table></figure>

<p><strong>步骤3.</strong> 在app包中<code>__init__.py</code>文件中,使用api对象与flask中app对象绑定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line"></span><br><span class="line">from apps.user.view import user_bp</span><br><span class="line">from exts import db, api</span><br><span class="line">from settings import DevelopmentConfig</span><br><span class="line"></span><br><span class="line">def create_app():</span><br><span class="line">    app &#x3D; Flask(__name__)</span><br><span class="line">    app.config.from_object(DevelopmentConfig)</span><br><span class="line">	# db对象与app对象绑定</span><br><span class="line">    db.init_app(app&#x3D;app)</span><br><span class="line">    # api对象与app对象绑定</span><br><span class="line">    api.init_app(app&#x3D;app)</span><br><span class="line">	# 注册蓝图</span><br><span class="line">    app.register_blueprint(user_bp)</span><br><span class="line">    print(app.url_map)</span><br><span class="line">    return app</span><br></pre></td></tr></table></figure>

<p><strong>步骤4.</strong> 定义模型对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import datetime</span><br><span class="line"></span><br><span class="line">from exts import db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class User(db.Model):</span><br><span class="line">    id &#x3D; db.Column(db.Integer, primary_key&#x3D;True, autoincrement&#x3D;True)</span><br><span class="line">    username &#x3D; db.Column(db.String(15), nullable&#x3D;False)</span><br><span class="line">    password &#x3D; db.Column(db.String(12), nullable&#x3D;False)</span><br><span class="line">    udatetime &#x3D; db.Column(db.DateTime, default&#x3D;datetime.datetime.now)</span><br></pre></td></tr></table></figure>

<p><strong>步骤5.</strong> 初始化数据库.生成表</p>
<p>在虚拟环境下执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python app.py db init  # 创建新的迁移存储库,生成migrations文件夹</span><br><span class="line">python app.py db migrate  # 生成迁移版本文件</span><br><span class="line">python app.py db upgrade  # 同步到数据库,生成表</span><br></pre></td></tr></table></figure>

<p><strong>步骤6.</strong> 在view中定义类视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">from flask import Blueprint</span><br><span class="line">from flask_restful import Resource, marshal_with, fields</span><br><span class="line"></span><br><span class="line">from apps.user.model import User</span><br><span class="line">from exts import api</span><br><span class="line"></span><br><span class="line">user_bp &#x3D; Blueprint(&#39;user&#39;, __name__, url_prefix&#x3D;&#39;&#x2F;api&#39;)</span><br><span class="line"></span><br><span class="line"># 默认情况下，在你的返回迭代中所有字段将会原样呈现。</span><br><span class="line"># 尽管当你刚刚处理 Python 数据结构的时候，觉得这是一个伟大的工作，</span><br><span class="line"># 但是当实际处理它们的时候，会觉得十分沮丧和枯燥。为了解决这个问题，</span><br><span class="line"># Flask-RESTful 提供了 fields 模块和 marshal_with() 装饰器。</span><br><span class="line"># 类似 Django ORM 和 WTForm，你可以使用 fields 模块来在你的响应中格式化结构。</span><br><span class="line">user_fields &#x3D; &#123;</span><br><span class="line">    &#39;id&#39;: fields.Integer,</span><br><span class="line">    &#39;username&#39;: fields.String,</span><br><span class="line">    &#39;password&#39;: fields.String,</span><br><span class="line">    &#39;udatetime&#39;: fields.DateTime</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 定义类视图</span><br><span class="line">class UserResource(Resource):</span><br><span class="line">    # 上面的例子接受一个 python 对象并准备将其序列化。</span><br><span class="line">    # marshal_with() 装饰器将会应用到由 resource_fields 描述的转换。</span><br><span class="line">    # 从对象中提取的唯一字段是 task。fields.Url 域是一个特殊的域，</span><br><span class="line">    # 它接受端点（endpoint）名称作为参数并且在响应中为该端点生成一个 URL。</span><br><span class="line">    # 许多你需要的字段类型都已经包含在内。</span><br><span class="line">    # get 请求的处理</span><br><span class="line">    @marshal_with(user_fields)</span><br><span class="line">    def get(self):</span><br><span class="line">        users &#x3D; User.query.all()</span><br><span class="line">        # userList &#x3D; []</span><br><span class="line">        # for user in users:</span><br><span class="line">        #     userList.append(user.__dict__)</span><br><span class="line">        return users</span><br><span class="line">    # post</span><br><span class="line">    def post(self):</span><br><span class="line">        return &#123;&#39;msg&#39;: &#39;------&gt;post&#39;&#125;</span><br><span class="line">    # put</span><br><span class="line">    def put(self):</span><br><span class="line">        return &#123;&#39;msg&#39;: &#39;------&gt;put&#39;&#125;</span><br><span class="line">    # delete</span><br><span class="line">    def delete(self):</span><br><span class="line">        return &#123;&#39;msg&#39;: &#39;------&gt;delete&#39;&#125;</span><br><span class="line">        </span><br><span class="line">api.add_resource(UserResource, &#39;&#x2F;user&#39;)</span><br></pre></td></tr></table></figure>

<p><strong>步骤7.</strong> 类视图与资源绑定,及和类视图绑定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api.add_resource(UserResource, &#39;&#x2F;user&#39;)</span><br></pre></td></tr></table></figure>

<h2 id="请求参数解析"><a href="#请求参数解析" class="headerlink" title="请求参数解析"></a>请求参数解析</h2><p>尽管 Flask 能够简单地访问请求数据(比如查询字符串或者 POST 表单编码的数据)，验证表单数据仍然很痛苦。Flask-RESTful 内置了支持验证请求数据，它使用了一个类似 <a href="http://docs.python.org/dev/library/argparse.html" target="_blank" rel="noopener">argparse</a> 的库。</p>
<p><strong>步骤1.</strong> 创建RequestParser对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from flask.ext.restful import reqparse</span><br><span class="line"></span><br><span class="line">parser &#x3D; reqparse.RequestParser(bundle_errors&#x3D;True)  # 解析对象</span><br><span class="line">- bundle_errors&#x3D;True 错误处理为True,错误全部返回,默认为false,遇到错误返回</span><br></pre></td></tr></table></figure>

<p><strong>步骤2.</strong>给解析器添加参数</p>
<p>通过<code>parser.add_argument(&#39;名字&#39;，type=类型，required=是否必须填写，help=错误的提示信息，location=表明获取的位置form就是post表单提交)</code></p>
<p>注意在type的位置可以添加一些正则的验证等。</p>
<p><a href="http://www.pythondoc.com/Flask-RESTful/api.html#module-flask.ext.restful.inputs" target="_blank" rel="noopener"><code>inputs</code></a> 模块提供了许多的常见的转换函数，比如 <a href="http://www.pythondoc.com/Flask-RESTful/api.html#flask.ext.restful.inputs.date" target="_blank" rel="noopener"><code>inputs.date()</code></a> 和 <a href="http://www.pythondoc.com/Flask-RESTful/api.html#flask.ext.restful.inputs.url" target="_blank" rel="noopener"><code>inputs.url()</code></a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">parser.add_argument(&#39;username&#39;, type&#x3D;str, required&#x3D;True, help&#x3D;&#39;必须输入用户名&#39;, location&#x3D;[&#39;form&#39;])</span><br><span class="line">parser.add_argument(&#39;password&#39;, type&#x3D;inputs.regex(r&#39;^\d&#123;6,12&#125;$&#39;), required&#x3D;True, help&#x3D;&#39;必须输入6~12位数字密码&#39;,location&#x3D;[&#39;form&#39;])</span><br><span class="line">parser.add_argument(&#39;phone&#39;, type&#x3D;inputs.regex(r&#39;^1[356789]\d&#123;9&#125;$&#39;), location&#x3D;[&#39;form&#39;], help&#x3D;&#39;手机号码格式错误&#39;)</span><br><span class="line"># 如果是多选框添加 action&#x3D;&#39;append&#39;</span><br><span class="line">parser.add_argument(&#39;hobby&#39;, action&#x3D;&#39;append&#39;)  # [&#39;篮球&#39;, &#39;游戏&#39;, &#39;旅游&#39;]</span><br><span class="line">parser.add_argument(&#39;icon&#39;, type&#x3D;FileStorage, location&#x3D;[&#39;files&#39;])</span><br></pre></td></tr></table></figure>

<p><strong>步骤3.</strong>在请求的函数中获取数据</p>
<p>可以在<code>get，post，put</code>等中获取数据，通过<code>parser对象.parse_args()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">args &#x3D; parser.parse_args()</span><br><span class="line"># args是一个字典底层的结构中，因此我们获取具体的数据时可以通过get</span><br><span class="line">username &#x3D; args.get(&#39;username&#39;)</span><br><span class="line">password &#x3D; args.get(&#39;password&#39;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>lr_parser = parser.copy()</p>
<p>lr_parser.add_argument(‘code’, type=inputs.regex(r’^\d{4}$’), help=’必须输入四位数字验证码’, required=True,location=’form’)</p>
</blockquote>
<p><code>parser.copy():</code>相当于类型中的继承</p>
<h2 id="响应数据格式化"><a href="#响应数据格式化" class="headerlink" title="响应数据格式化"></a>响应数据格式化</h2><p>默认情况下，在你的返回迭代中所有字段将会原样呈现。如果使用<code>restful</code>接口的方式自定义对象返回时,需要转换成dist对象,即<strong>return data必须是符合json格式</strong>。为了解决这个问题，Flask-RESTful 提供了 <code>fields</code> 模块和 <a href="http://www.pythondoc.com/Flask-RESTful/api.html#flask.ext.restful.marshal_with" target="_blank" rel="noopener"><code>marshal_with()</code></a> 装饰器结合使用。你可以使用 fields 模块来在你的响应中格式化结构。</p>
<p>需要定义字典，字典的格式就是给客户端看的格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">user_fields &#x3D; &#123;</span><br><span class="line">    &#39;id&#39;: fields.Integer,</span><br><span class="line">    &#39;username&#39;: fields.String(default&#x3D;&#39;匿名&#39;),</span><br><span class="line">    &#39;pwd&#39;: fields.String(attribute&#x3D;&#39;password&#39;),</span><br><span class="line">    &#39;udatetime&#39;: fields.DateTime(dt_format&#x3D;&#39;rfc822&#39;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 定义类视图</span><br><span class="line">class UserResource(Resource):</span><br><span class="line">    # marshal_with() 装饰器将会应用到由user_fields描述的转换</span><br><span class="line">    @marshal_with(user_fields)</span><br><span class="line">    def post(self):</span><br><span class="line">        # 获取数据</span><br><span class="line">        args &#x3D; parser.parse_args()</span><br><span class="line"></span><br><span class="line">        username &#x3D; args.get(&#39;username&#39;)</span><br><span class="line">        password &#x3D; args.get(&#39;password&#39;)</span><br><span class="line">        phone &#x3D; args.get(&#39;phone&#39;)</span><br><span class="line">        bobby &#x3D; args.get(&#39;hobby&#39;)</span><br><span class="line">        print(bobby)</span><br><span class="line">        icon &#x3D; args.get(&#39;icon&#39;)</span><br><span class="line">        print(icon)</span><br><span class="line">        # 创建user对象</span><br><span class="line">        user &#x3D; User()</span><br><span class="line">        user.username &#x3D; username</span><br><span class="line">        user.password &#x3D; password</span><br><span class="line">        if icon:</span><br><span class="line">            upload_path &#x3D; os.path.join(Config.UPLOAD_ICON_DIR, icon.filename)</span><br><span class="line">            icon.save(upload_path)</span><br><span class="line">            # 保存路径个</span><br><span class="line">            user.icon &#x3D; os.path.join(&#39;upload&#x2F;icon&#x2F;&#39;, icon.filename)</span><br><span class="line">        if phone:</span><br><span class="line">            user.phone &#x3D; phone</span><br><span class="line">        db.session.add(user)</span><br><span class="line">        db.session.commit()</span><br><span class="line"></span><br><span class="line">        return user</span><br><span class="line"></span><br><span class="line">api.add_resource(UserResource, &#39;&#x2F;user&#39;, endpoint&#x3D;&#39;all_user&#39;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 客户端(前端)能看到的是：<code>id，username，pwd，udatetime</code>这四个key,默认<code>key</code>的名字是跟<code>model</code>中的模型属性名一致，如果不想让前端看到命名，则可以修改。但是必须结合<code>attribute=&#39;模型的字段名&#39;</code>,如果不想让页面显示为空,还可以设置默认值<code>default=&#39;匿名&#39;</code></p>
</blockquote>
<h3 id="自定义fields和Url"><a href="#自定义fields和Url" class="headerlink" title="自定义fields和Url"></a>自定义fields和Url</h3><ol>
<li>必须继承Raw</li>
<li>重写方法format()</li>
<li>在fields模块中使用  <code>&#39;isDelete&#39;: IsDelete(attribute=&#39;isdelete&#39;)</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">class IsDelete(fields.Raw):</span><br><span class="line">    def format(self, value):</span><br><span class="line">        # print(&#39;------------------&gt;&#39;, value)</span><br><span class="line">        return &#39;删除&#39; if value else &#39;未删除&#39;</span><br><span class="line"></span><br><span class="line">user_fields_1 &#x3D; &#123;</span><br><span class="line">    &#39;id&#39;: fields.Integer,</span><br><span class="line">    &#39;username&#39;: fields.String(default&#x3D;&#39;匿名&#39;),</span><br><span class="line">    &#39;uri&#39;: fields.Url(&#39;single_user&#39;, absolute&#x3D;True)  # 参数使用的就是endpoint的值</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">user_fields &#x3D; &#123;</span><br><span class="line">    &#39;id&#39;: fields.Integer,</span><br><span class="line">    &#39;username&#39;: fields.String(default&#x3D;&#39;匿名&#39;),</span><br><span class="line">    &#39;pwd&#39;: fields.String(attribute&#x3D;&#39;password&#39;),</span><br><span class="line">    &#39;isDelete&#39;: fields.Boolean(attribute&#x3D;&#39;isdelete&#39;),</span><br><span class="line">    &#39;isDelete1&#39;: IsDelete(attribute&#x3D;&#39;isdelete&#39;),</span><br><span class="line">    &#39;udatetime&#39;: fields.DateTime(dt_format&#x3D;&#39;rfc822&#39;),</span><br><span class="line">&#125;</span><br><span class="line"># 定义类视图</span><br><span class="line">class UserResource(Resource):</span><br><span class="line">    @marshal_with(user_fields1)</span><br><span class="line">    def get(self):</span><br><span class="line">        # 获取数据</span><br><span class="line">        args &#x3D; parser.parse_args()</span><br><span class="line">        </span><br><span class="line">        return user</span><br><span class="line"></span><br><span class="line">class UserSimpleResource(Resource):</span><br><span class="line">    @marshal_with(user_fields)  # user转成一个序列化对象，</span><br><span class="line">    def get(self, id):  </span><br><span class="line">        user &#x3D; User.query.get(id)</span><br><span class="line">        return user  # 不是str，list，int，。。。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 涉及endpoint的定义：</span><br><span class="line">api.add_resource(UserSimpleResource, &#39;&#x2F;user&#x2F;&lt;int:id&gt;&#39;, endpoint&#x3D;&#39;single_user&#39;)</span><br></pre></td></tr></table></figure>

<h3 id="返回复杂的结构对象"><a href="#返回复杂的结构对象" class="headerlink" title="返回复杂的结构对象"></a>返回复杂的结构对象</h3><p>返回的对象必须符合Json格式</p>
<p>形如:对象里面嵌套了列表对象,列表对象中又嵌套了一个列表对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &#39;aa&#39;:10,</span><br><span class="line">  &#39;bb&#39;:[</span><br><span class="line">     &#123;</span><br><span class="line">       &#39;id&#39;:1,</span><br><span class="line">       &#39;xxxs&#39;:[</span><br><span class="line">                &#123;&#125;,&#123;&#125;</span><br><span class="line">              ]</span><br><span class="line">     &#125;,</span><br><span class="line">     &#123;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong>如果直接返回不能有自定义的对象,如果有这种对象，需要：<code>marchal(),marchal_with()</code>帮助进行转换。</p>
<h4 id="marchal"><a href="#marchal" class="headerlink" title="marchal()"></a>marchal()</h4><blockquote>
<p>marchal(对象，对象的fields格式)  # 对象的fields格式是指字典的输出格式</p>
<p>marchal([对象，对象]，对象的fields格式)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">user_fields &#x3D; &#123;</span><br><span class="line">    &#39;id&#39;: fields.Integer,</span><br><span class="line">    &#39;username&#39;: fields.String(default&#x3D;&#39;匿名&#39;),</span><br><span class="line">    &#39;pwd&#39;: fields.String(attribute&#x3D;&#39;password&#39;),</span><br><span class="line">    &#39;isDelete&#39;: fields.Boolean(attribute&#x3D;&#39;isdelete&#39;),</span><br><span class="line">    &#39;isDelete1&#39;: IsDelete(attribute&#x3D;&#39;isdelete&#39;),</span><br><span class="line">    &#39;udatetime&#39;: fields.DateTime(dt_format&#x3D;&#39;rfc822&#39;),</span><br><span class="line">    &#39;uri&#39;: fields.Url(&#39;single_user&#39;, absolute&#x3D;True)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user_friend_fields &#x3D; &#123;</span><br><span class="line">    &#39;username&#39;: fields.String,</span><br><span class="line">    &#39;nums&#39;: fields.Integer,</span><br><span class="line">    &#39;friends&#39;: fields.List(fields.Nested(user_fields))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class UserFriendResource(Resource):</span><br><span class="line"></span><br><span class="line">    @marshal_with(user_friend_fields)</span><br><span class="line">    def get(self, id):</span><br><span class="line">        friends &#x3D; Friend.query.filter(Friend.uid &#x3D;&#x3D; id).all()</span><br><span class="line">        user &#x3D; User.query.get(id)</span><br><span class="line"></span><br><span class="line">        friend_list &#x3D; []</span><br><span class="line">        for friend in friends:</span><br><span class="line">            u &#x3D; User.query.get(friend.fid)</span><br><span class="line">            friend_list.append(u)</span><br><span class="line"></span><br><span class="line">        data &#x3D; &#123;</span><br><span class="line">            &#39;username&#39;: user.username,</span><br><span class="line">            &#39;nums&#39;: len(friends),</span><br><span class="line">            &#39;friends&#39;: marshal(friend_list,user_fields)  # [user,user,user]</span><br><span class="line">        &#125;</span><br><span class="line">        return data</span><br><span class="line">        </span><br><span class="line">api.add_resource(UserResource, &#39;&#x2F;user&#39;, endpoint&#x3D;&#39;all_user&#39;)</span><br><span class="line">api.add_resource(UserSimpleResource, &#39;&#x2F;user&#x2F;&lt;int:id&gt;&#39;, endpoint&#x3D;&#39;single_user&#39;)</span><br><span class="line">api.add_resource(UserFriendResource, &#39;&#x2F;friend&#x2F;&lt;int:id&gt;&#39;, endpoint&#x3D;&#39;user_friend&#39;)</span><br></pre></td></tr></table></figure>

<h4 id="marchal-with"><a href="#marchal-with" class="headerlink" title="@marchal_with()"></a>@marchal_with()</h4><blockquote>
<p>@marchal_with(user_friend_fields) 作为装饰器修饰请求方法,在user_friend_fields字典对象中定义</p>
<p><code>&#39;friends&#39;: fields.List(fields.Nested(user_fields))</code>,在<code>fields.Nested()</code>把自定义对象在进行数据格式化</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">user_fields &#x3D; &#123;</span><br><span class="line">    &#39;id&#39;: fields.Integer,</span><br><span class="line">    &#39;username&#39;: fields.String(default&#x3D;&#39;匿名&#39;),</span><br><span class="line">    &#39;pwd&#39;: fields.String(attribute&#x3D;&#39;password&#39;),</span><br><span class="line">    &#39;isDelete&#39;: fields.Boolean(attribute&#x3D;&#39;isdelete&#39;),</span><br><span class="line">    &#39;isDelete1&#39;: IsDelete(attribute&#x3D;&#39;isdelete&#39;),</span><br><span class="line">    &#39;udatetime&#39;: fields.DateTime(dt_format&#x3D;&#39;rfc822&#39;),</span><br><span class="line">    &#39;uri&#39;: fields.Url(&#39;single_user&#39;, absolute&#x3D;True)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user_friend_fields &#x3D; &#123;</span><br><span class="line">    &#39;username&#39;: fields.String,</span><br><span class="line">    &#39;nums&#39;: fields.Integer,</span><br><span class="line">    &#39;friends&#39;: fields.List(fields.Nested(user_fields))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class UserFriendResource(Resource):</span><br><span class="line"></span><br><span class="line">    @marshal_with(user_friend_fields)</span><br><span class="line">   	# 函数需要参数id，就是参数最终数据输出的格式</span><br><span class="line">   	# 列如使用路径传参&#x2F;user&#x2F;1,及id&#x3D;1</span><br><span class="line">    def get(self, id):</span><br><span class="line">        friends &#x3D; Friend.query.filter(Friend.uid &#x3D;&#x3D; id).all()</span><br><span class="line">        user &#x3D; User.query.get(id)</span><br><span class="line"></span><br><span class="line">        friend_list &#x3D; []</span><br><span class="line">        for friend in friends:</span><br><span class="line">            u &#x3D; User.query.get(friend.fid)</span><br><span class="line">            friend_list.append(u)</span><br><span class="line"></span><br><span class="line">        data &#x3D; &#123;</span><br><span class="line">            &#39;username&#39;: user.username,</span><br><span class="line">            &#39;nums&#39;: len(friends),</span><br><span class="line">            &#39;friends&#39;: friend_list  # [user,user,user]</span><br><span class="line">        &#125;</span><br><span class="line">        return data</span><br><span class="line">        </span><br><span class="line">api.add_resource(UserResource, &#39;&#x2F;user&#39;, endpoint&#x3D;&#39;all_user&#39;)</span><br><span class="line">api.add_resource(UserSimpleResource, &#39;&#x2F;user&#x2F;&lt;int:id&gt;&#39;, endpoint&#x3D;&#39;single_user&#39;)</span><br><span class="line">api.add_resource(UserFriendResource, &#39;&#x2F;friend&#x2F;&lt;int:id&gt;&#39;, endpoint&#x3D;&#39;user_friend&#39;)</span><br></pre></td></tr></table></figure>

<h1 id="Flask-restful-API跨域问题"><a href="#Flask-restful-API跨域问题" class="headerlink" title="Flask-restful-API跨域问题"></a>Flask-restful-API跨域问题</h1><p>跨域问题来源于JavaScript的”同源策略”，即只有 协议+主机名+端口号 (如存在)相同，则允许相互访问。也就是说JavaScript只能访问和操作自己域下的资源，不能访问和操作其他域下的资源。</p>
<blockquote>
<p>跨域问题是针对JS和ajax的，html本身没有跨域问题。</p>
</blockquote>
<p><strong>后端解决跨域问题</strong></p>
<blockquote>
<p>第一种解决方案</p>
</blockquote>
<p><strong>步骤1.</strong> 使用第三方扩展</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-cors</span><br></pre></td></tr></table></figure>

<p><strong>步骤2.</strong> 在扩展包<code>ext</code>下<code>__init__.py</code>文件中创建cors对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"></span><br><span class="line">cors= CORS()</span><br></pre></td></tr></table></figure>

<p><strong>步骤3.</strong> 与flask对象app进行绑定初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cors.init_app(app&#x3D;app,supports_credentials&#x3D;True)</span><br><span class="line"></span><br><span class="line"># supports_credentials 证书认证</span><br></pre></td></tr></table></figure>

<blockquote>
<p>第二种解决方案</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">response = make_response()</span><br><span class="line">response.headers[<span class="string">'Access-Control-Allow-Origin'</span>]=<span class="string">'*'</span></span><br><span class="line">response.headers[<span class="string">'Access-Control-Allow-Methods'</span>]=<span class="string">'GET,POST'</span></span><br><span class="line">response.headers[<span class="string">'Access-Control-Allow-Headers'</span>]=<span class="string">'x-request-with,Content-type'</span></span><br><span class="line"><span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<h1 id="Flask-restful-API与蓝图的使用"><a href="#Flask-restful-API与蓝图的使用" class="headerlink" title="Flask-restful-API与蓝图的使用"></a>Flask-restful-API与蓝图的使用</h1><p><strong>步骤1.</strong>声明蓝图对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_bp &#x3D; Blueprint(&#39;user&#39;, __name__)</span><br></pre></td></tr></table></figure>

<p><strong>步骤2.</strong>蓝图对象与Api进行绑定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api &#x3D; Api(user_bp)</span><br></pre></td></tr></table></figure>

<p><strong>步骤3.</strong>注册蓝图,与flask对象进行绑定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.register_blueprint(user_bp)</span><br></pre></td></tr></table></figure>

<p><strong>步骤4.</strong>声明资源视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class xxxxApi(Resource):</span><br><span class="line">     def get(self):</span><br><span class="line">      	pass</span><br><span class="line">     def post(self):</span><br><span class="line">        pass 	</span><br><span class="line">     def put(self):</span><br><span class="line">        pass</span><br><span class="line">     def delete(self):</span><br><span class="line">      	pass</span><br></pre></td></tr></table></figure>

<p><strong>步骤5.</strong>资源与api进行绑定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api.add_resource(xxxxApi,&#39;&#x2F;xxxx&#39;)</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">三月三</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zysheep.cn/2020/04/06/Python/%E5%AD%A6%E4%B9%A0Flask/">https://zysheep.cn/2020/04/06/Python/学习Flask/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zysheep.cn" target="_blank">三月三</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/Flask/">Flask</a></div><div class="post_share"><div class="social-share" data-image="http://cdn.panyucable.cn/zysheep/2010x1125.jfif" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/zysheep/picgo-imgs/imgwechat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/zysheep/picgo-imgs/imgalipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/07/Android/Android%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><img class="prev_cover" src="http://cdn.panyucable.cn/zysheep/android_logo_cover.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android开发环境搭建</div></div></a></div><div class="next-post pull_right"><a href="/2020/04/06/Python/TinyMCE%E5%AF%8C%E6%96%87%E6%9C%AC/"><img class="next_cover" src="http://cdn.panyucable.cn/zysheep/js.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">TinyMCE富文本</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/07/Python/学习Django/" title="Django学习"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/django_cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-07</div><div class="relatedPosts_title">Django学习</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/07/Python/Centos7安装Python环境/" title="Centos7安装Python环境"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/QQ截图20200818165742.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-07</div><div class="relatedPosts_title">Centos7安装Python环境</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/04/Python/虚拟环境管理/" title="虚拟环境管理"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/QQ截图20200818165742.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-04</div><div class="relatedPosts_title">虚拟环境管理</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/04/Python/uWSGI,WSGI和uwsgi/" title="WSGI，uWSGI和uwsgi区别详解"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/QQ截图20200818165742.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-04</div><div class="relatedPosts_title">WSGI，uWSGI和uwsgi区别详解</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/03/Python/Python几问/" title="Python3简介"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/QQ截图20200818165742.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-03</div><div class="relatedPosts_title">Python3简介</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '502b8308721b081071a5',
  clientSecret: '35220d15c7f8aaf585d6822cf5d49fedf5b602d6',
  repo: 'blog-comment',
  owner: 'zysheep',
  admin: ['zysheep'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" style="background-image: url(http://cdn.panyucable.cn/zysheep/flask_top.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By 三月三</div><div class="footer_custom_text">生活不只是眼前的苟且,还有诗和远方</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/third-party/click_heart.js"></script><script src="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/js/hideCategory.min.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script></body></html>