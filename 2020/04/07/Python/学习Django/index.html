<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Django学习 | 三月三</title><meta name="description" content="Django 简介Django发布于2005年,是一个由 Python 编写的一个开放源代码的 Web 应用框架（源代码是开源的，遵守BSD版权）。使用 Django，只要很少的代码，Python 的程序开发人员就可以轻松地完成一个正式网站所需要的大部分内容，并进一步开发出全功能的 Web 服务Django本身基于 MVC 模型，即 Model（模型）+ View（视图）+ Controller（"><meta name="keywords" content="Python,Django"><meta name="author" content="三月三"><meta name="copyright" content="三月三"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="http://cdn.panyucable.cn/zysheep/ico.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Django学习"><meta name="twitter:description" content="Django 简介Django发布于2005年,是一个由 Python 编写的一个开放源代码的 Web 应用框架（源代码是开源的，遵守BSD版权）。使用 Django，只要很少的代码，Python 的程序开发人员就可以轻松地完成一个正式网站所需要的大部分内容，并进一步开发出全功能的 Web 服务Django本身基于 MVC 模型，即 Model（模型）+ View（视图）+ Controller（"><meta name="twitter:image" content="http://cdn.panyucable.cn/zysheep/django_cover.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Django学习"><meta property="og:url" content="https://zysheep.cn/2020/04/07/Python/%E5%AD%A6%E4%B9%A0Django/"><meta property="og:site_name" content="三月三"><meta property="og:description" content="Django 简介Django发布于2005年,是一个由 Python 编写的一个开放源代码的 Web 应用框架（源代码是开源的，遵守BSD版权）。使用 Django，只要很少的代码，Python 的程序开发人员就可以轻松地完成一个正式网站所需要的大部分内容，并进一步开发出全功能的 Web 服务Django本身基于 MVC 模型，即 Model（模型）+ View（视图）+ Controller（"><meta property="og:image" content="http://cdn.panyucable.cn/zysheep/django_cover.jpg"><meta property="article:published_time" content="2020-04-07T04:30:45.000Z"><meta property="article:modified_time" content="2020-09-22T13:57:29.821Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://zysheep.cn/2020/04/07/Python/%E5%AD%A6%E4%B9%A0Django/"><link rel="prev" title="SpringBoot后端接口规范" href="https://zysheep.cn/2020/04/08/Spring/SpringBoot%E5%90%8E%E7%AB%AF%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83/"><link rel="next" title="Centos7安装Python环境" href="https://zysheep.cn/2020/04/07/Python/Centos7%E5%AE%89%E8%A3%85Python%E7%8E%AF%E5%A2%83/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7f671f0f6d996680d21d5c32a23a9313";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://zysheep.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: false,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/hideCategory.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="http://cdn.panyucable.cn/zysheep/xiaoman.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">214</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">50</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">71</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bug" aria-hidden="true"></i><span> 编程路线</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/java/"><i class="fa-fw fa fa-coffee"></i><span> Java</span></a></li><li><a class="site-page" href="/python/"><i class="fa-fw fa fa-binoculars"></i><span> Python</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder-open" aria-hidden="true"></i><span> 面试宝典</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/interview/"><i class="fa-fw fa fa-file-text-o"></i><span> Java面试题</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 我的生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-picture-o"></i><span> Gallery</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-简介"><span class="toc-number">1.</span> <span class="toc-text">Django 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MTV-模型"><span class="toc-number">1.1.</span> <span class="toc-text">MTV 模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django版本"><span class="toc-number">1.2.</span> <span class="toc-text">Django版本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django的安装"><span class="toc-number">2.</span> <span class="toc-text">Django的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境要求"><span class="toc-number">2.1.</span> <span class="toc-text">环境要求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pip命令安装"><span class="toc-number">2.2.</span> <span class="toc-text">pip命令安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#⼿动安装"><span class="toc-number">2.3.</span> <span class="toc-text">⼿动安装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-创建第一个项目"><span class="toc-number">3.</span> <span class="toc-text">Django 创建第一个项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Django-管理工具"><span class="toc-number">3.1.</span> <span class="toc-text">Django 管理工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建项目"><span class="toc-number">3.2.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立应用"><span class="toc-number">3.3.</span> <span class="toc-text">建立应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单视图函数"><span class="toc-number">3.4.</span> <span class="toc-text">简单视图函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本路由"><span class="toc-number">3.5.</span> <span class="toc-text">基本路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单模板"><span class="toc-number">3.6.</span> <span class="toc-text">简单模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单模型"><span class="toc-number">3.7.</span> <span class="toc-text">简单模型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-模型-M"><span class="toc-number">4.</span> <span class="toc-text">Django 模型(M)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库配置"><span class="toc-number">4.1.</span> <span class="toc-text">数据库配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ORM"><span class="toc-number">4.2.</span> <span class="toc-text">ORM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本概念"><span class="toc-number">4.2.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模型属性"><span class="toc-number">4.2.2.</span> <span class="toc-text">模型属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#字段类型"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">字段类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#字段选项"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">字段选项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定义模型"><span class="toc-number">4.3.</span> <span class="toc-text">定义模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#激活模型"><span class="toc-number">4.4.</span> <span class="toc-text">激活模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模型的使用"><span class="toc-number">4.5.</span> <span class="toc-text">模型的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#增"><span class="toc-number">4.5.1.</span> <span class="toc-text">增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删"><span class="toc-number">4.5.2.</span> <span class="toc-text">删</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#改"><span class="toc-number">4.5.3.</span> <span class="toc-text">改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据查询"><span class="toc-number">4.5.4.</span> <span class="toc-text">数据查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#返回查询集"><span class="toc-number">4.5.4.1.</span> <span class="toc-text">返回查询集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#返回单个值"><span class="toc-number">4.5.4.2.</span> <span class="toc-text">返回单个值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查询集限制"><span class="toc-number">4.5.4.3.</span> <span class="toc-text">查询集限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#字段查询"><span class="toc-number">4.5.4.4.</span> <span class="toc-text">字段查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#统计查询"><span class="toc-number">4.5.4.5.</span> <span class="toc-text">统计查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q对象和F对象"><span class="toc-number">4.5.4.6.</span> <span class="toc-text">Q对象和F对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#原始sql"><span class="toc-number">4.5.4.7.</span> <span class="toc-text">原始sql</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模型成员"><span class="toc-number">4.6.</span> <span class="toc-text">模型成员</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#重命名管理器"><span class="toc-number">4.6.1.</span> <span class="toc-text">重命名管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#⾃定义管理器"><span class="toc-number">4.6.2.</span> <span class="toc-text">⾃定义管理器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模型对应关系"><span class="toc-number">4.7.</span> <span class="toc-text">模型对应关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#⼀对⼀"><span class="toc-number">4.7.1.</span> <span class="toc-text">⼀对⼀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#⼀对多"><span class="toc-number">4.7.2.</span> <span class="toc-text">⼀对多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多对多"><span class="toc-number">4.7.3.</span> <span class="toc-text">多对多</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模型继承"><span class="toc-number">4.8.</span> <span class="toc-text">模型继承</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-模板-T"><span class="toc-number">5.</span> <span class="toc-text">Django 模板(T)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、模板位置"><span class="toc-number">5.1.</span> <span class="toc-text">一、模板位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、模板的渲染"><span class="toc-number">5.2.</span> <span class="toc-text">二、模板的渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#loader加载"><span class="toc-number">5.2.1.</span> <span class="toc-text">loader加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#render加载"><span class="toc-number">5.2.2.</span> <span class="toc-text">render加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#变量"><span class="toc-number">5.2.3.</span> <span class="toc-text">变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#过滤器"><span class="toc-number">5.2.4.</span> <span class="toc-text">过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#⾃定义过滤器"><span class="toc-number">5.2.4.1.</span> <span class="toc-text">⾃定义过滤器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内置标签"><span class="toc-number">5.2.5.</span> <span class="toc-text">内置标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#if标签"><span class="toc-number">5.2.5.1.</span> <span class="toc-text">if标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#for"><span class="toc-number">5.2.5.2.</span> <span class="toc-text">for</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ifequal-ifnotequal"><span class="toc-number">5.2.5.3.</span> <span class="toc-text">ifequal&#x2F;ifnotequal</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注释"><span class="toc-number">5.2.5.4.</span> <span class="toc-text">注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#跨站请求伪造-csrf"><span class="toc-number">5.2.5.5.</span> <span class="toc-text">跨站请求伪造 csrf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模板导⼊标签（-include）"><span class="toc-number">5.2.5.6.</span> <span class="toc-text">模板导⼊标签（ include）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#url标签"><span class="toc-number">5.2.5.7.</span> <span class="toc-text">url标签</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、模板继承"><span class="toc-number">5.3.</span> <span class="toc-text">四、模板继承</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、静态资源配置"><span class="toc-number">5.4.</span> <span class="toc-text">五、静态资源配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、jinja2模板引擎配置"><span class="toc-number">5.5.</span> <span class="toc-text">六、jinja2模板引擎配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-视图-request-response对象-和路由-V"><span class="toc-number">6.</span> <span class="toc-text">Django 视图(request,response对象)和路由(V)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#路由"><span class="toc-number">6.1.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#模式"><span class="toc-number">6.1.1.</span> <span class="toc-text">模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URL配置"><span class="toc-number">6.1.2.</span> <span class="toc-text">URL配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态url"><span class="toc-number">6.1.3.</span> <span class="toc-text">动态url</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#视图"><span class="toc-number">6.2.</span> <span class="toc-text">视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpRequest"><span class="toc-number">6.2.1.</span> <span class="toc-text">HttpRequest</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#QueryDict"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">QueryDict</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpResponse"><span class="toc-number">6.2.2.</span> <span class="toc-text">HttpResponse</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#不调用模板，直接返回内容"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">不调用模板，直接返回内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用模板返回"><span class="toc-number">6.2.2.2.</span> <span class="toc-text">调用模板返回</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JsonResponse"><span class="toc-number">6.2.3.</span> <span class="toc-text">JsonResponse</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#系统模块⾃带的json和JsonResponse"><span class="toc-number">6.2.3.1.</span> <span class="toc-text">系统模块⾃带的json和JsonResponse</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#QuerySet转Json"><span class="toc-number">6.2.3.2.</span> <span class="toc-text">QuerySet转Json</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模型转Json"><span class="toc-number">6.2.3.3.</span> <span class="toc-text">模型转Json</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重定向"><span class="toc-number">6.2.4.</span> <span class="toc-text">重定向</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#不带参数重定向"><span class="toc-number">6.2.4.1.</span> <span class="toc-text">不带参数重定向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#带参数重定向"><span class="toc-number">6.2.4.2.</span> <span class="toc-text">带参数重定向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#反向解析"><span class="toc-number">6.2.4.3.</span> <span class="toc-text">反向解析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#错误视图"><span class="toc-number">6.2.5.</span> <span class="toc-text">错误视图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#404错误及视图"><span class="toc-number">6.2.5.1.</span> <span class="toc-text">404错误及视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#500错误及视图"><span class="toc-number">6.2.5.2.</span> <span class="toc-text">500错误及视图</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django分页"><span class="toc-number">7.</span> <span class="toc-text">Django分页</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Paginator-分页器"><span class="toc-number">7.1.</span> <span class="toc-text">Paginator 分页器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#page-对象"><span class="toc-number">7.2.</span> <span class="toc-text">page 对象</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django中Cookie和Session"><span class="toc-number">8.</span> <span class="toc-text">Django中Cookie和Session</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cookie"><span class="toc-number">8.1.</span> <span class="toc-text">cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设置cookie"><span class="toc-number">8.1.1.</span> <span class="toc-text">设置cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取cookie"><span class="toc-number">8.1.2.</span> <span class="toc-text">获取cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除cookie"><span class="toc-number">8.1.3.</span> <span class="toc-text">删除cookie</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session"><span class="toc-number">8.2.</span> <span class="toc-text">Session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#session配置"><span class="toc-number">8.2.1.</span> <span class="toc-text">session配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session操作"><span class="toc-number">8.2.2.</span> <span class="toc-text">session操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#session设置"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">session设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#session获取"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">session获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#session删除"><span class="toc-number">8.2.2.3.</span> <span class="toc-text">session删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#session过期时间"><span class="toc-number">8.2.2.4.</span> <span class="toc-text">session过期时间</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cookie和session的区别与联系"><span class="toc-number">8.3.</span> <span class="toc-text">cookie和session的区别与联系</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-使用阿里云短信服务"><span class="toc-number">9.</span> <span class="toc-text">Django 使用阿里云短信服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-From表单验证"><span class="toc-number">10.</span> <span class="toc-text">Django  From表单验证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概要"><span class="toc-number">10.1.</span> <span class="toc-text">概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Form相关的对象包括"><span class="toc-number">10.2.</span> <span class="toc-text">Form相关的对象包括</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本使用"><span class="toc-number">10.3.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用的field类"><span class="toc-number">10.4.</span> <span class="toc-text">常用的field类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Form常用的属性和方法"><span class="toc-number">10.5.</span> <span class="toc-text">Form常用的属性和方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#表单渲染的选项"><span class="toc-number">10.6.</span> <span class="toc-text">表单渲染的选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#form-as-ul"><span class="toc-number">10.6.1.</span> <span class="toc-text">form.as_ul</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#手动渲染"><span class="toc-number">10.6.2.</span> <span class="toc-text">手动渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#循环渲染"><span class="toc-number">10.6.3.</span> <span class="toc-text">循环渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#循环隐藏和可⻅字段"><span class="toc-number">10.6.4.</span> <span class="toc-text">循环隐藏和可⻅字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可重⽤的表单模板"><span class="toc-number">10.6.5.</span> <span class="toc-text">可重⽤的表单模板</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-用户认证"><span class="toc-number">11.</span> <span class="toc-text">Django 用户认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概要-1"><span class="toc-number">11.1.</span> <span class="toc-text">概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前期配置"><span class="toc-number">11.2.</span> <span class="toc-text">前期配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#说明"><span class="toc-number">11.2.1.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-number">11.2.2.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#user对象"><span class="toc-number">11.3.</span> <span class="toc-text">user对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拓展-User-模型"><span class="toc-number">11.4.</span> <span class="toc-text">拓展 User 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#说明-1"><span class="toc-number">11.4.0.1.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#继承AbstractUser"><span class="toc-number">11.4.0.2.</span> <span class="toc-text">继承AbstractUser</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用操作"><span class="toc-number">11.5.</span> <span class="toc-text">常用操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#验证登录"><span class="toc-number">11.5.1.</span> <span class="toc-text">验证登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注册操作"><span class="toc-number">11.5.2.</span> <span class="toc-text">注册操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录操作"><span class="toc-number">11.5.3.</span> <span class="toc-text">登录操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登出操作"><span class="toc-number">11.5.4.</span> <span class="toc-text">登出操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改密码"><span class="toc-number">11.5.5.</span> <span class="toc-text">修改密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由保护"><span class="toc-number">11.5.6.</span> <span class="toc-text">路由保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#业务中修改密码"><span class="toc-number">11.5.7.</span> <span class="toc-text">业务中修改密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端验证登录"><span class="toc-number">11.5.8.</span> <span class="toc-text">前端验证登录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-图形验证码"><span class="toc-number">12.</span> <span class="toc-text">Django 图形验证码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装django-simple-captcha库"><span class="toc-number">12.1.</span> <span class="toc-text">安装django-simple-captcha库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setting配置"><span class="toc-number">12.2.</span> <span class="toc-text">setting配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立表单"><span class="toc-number">12.3.</span> <span class="toc-text">建立表单</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-发送邮件"><span class="toc-number">13.</span> <span class="toc-text">Django 发送邮件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#setting配置-1"><span class="toc-number">13.1.</span> <span class="toc-text">setting配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发送邮件"><span class="toc-number">13.2.</span> <span class="toc-text">发送邮件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#邮箱验证激活"><span class="toc-number">13.3.</span> <span class="toc-text">邮箱验证激活</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#说明-2"><span class="toc-number">13.3.1.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证邮箱链接"><span class="toc-number">13.3.2.</span> <span class="toc-text">验证邮箱链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注册发送邮箱"><span class="toc-number">13.3.3.</span> <span class="toc-text">注册发送邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#激活用户"><span class="toc-number">13.3.4.</span> <span class="toc-text">激活用户</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-富文本编辑器"><span class="toc-number">14.</span> <span class="toc-text">Django 富文本编辑器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">14.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置settings⽂件"><span class="toc-number">14.2.</span> <span class="toc-text">配置settings⽂件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-文件上传"><span class="toc-number">15.</span> <span class="toc-text">Django 文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#表单注意"><span class="toc-number">15.1.</span> <span class="toc-text">表单注意</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#储存路径"><span class="toc-number">15.2.</span> <span class="toc-text">储存路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件上传对象的属性和方法"><span class="toc-number">15.3.</span> <span class="toc-text">文件上传对象的属性和方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建上传文件的表单"><span class="toc-number">15.4.</span> <span class="toc-text">创建上传文件的表单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#封装文件上传的类"><span class="toc-number">15.5.</span> <span class="toc-text">封装文件上传的类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-站点管理"><span class="toc-number">16.</span> <span class="toc-text">Django 站点管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置admin应用"><span class="toc-number">16.1.</span> <span class="toc-text">配置admin应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建管理员用户"><span class="toc-number">16.2.</span> <span class="toc-text">创建管理员用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#汉化"><span class="toc-number">16.3.</span> <span class="toc-text">汉化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在App-admin-py-里面注册自己的模型类"><span class="toc-number">16.4.</span> <span class="toc-text">在App&#x2F;admin.py 里面注册自己的模型类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置后台页面和添加数据的展示"><span class="toc-number">16.5.</span> <span class="toc-text">配置后台页面和添加数据的展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关联对象"><span class="toc-number">16.6.</span> <span class="toc-text">关联对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bool值的显示男女"><span class="toc-number">16.7.</span> <span class="toc-text">bool值的显示男女</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-中间件"><span class="toc-number">17.</span> <span class="toc-text">Django 中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Django-中间件作用和可实现功能"><span class="toc-number">17.1.</span> <span class="toc-text">Django 中间件作用和可实现功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#作用"><span class="toc-number">17.1.1.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可实现功能"><span class="toc-number">17.1.2.</span> <span class="toc-text">可实现功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#中间件执行过程"><span class="toc-number">17.2.</span> <span class="toc-text">中间件执行过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django中的中间件方法"><span class="toc-number">17.3.</span> <span class="toc-text">Django中的中间件方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#process-request"><span class="toc-number">17.3.1.</span> <span class="toc-text">process_request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#process-view"><span class="toc-number">17.3.2.</span> <span class="toc-text">process_view</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#process-template-response"><span class="toc-number">17.3.3.</span> <span class="toc-text">process_template_response</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#process-response"><span class="toc-number">17.3.4.</span> <span class="toc-text">process_response</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#process-exception"><span class="toc-number">17.3.5.</span> <span class="toc-text">process_exception</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义中间件"><span class="toc-number">17.4.</span> <span class="toc-text">自定义中间件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-缓存"><span class="toc-number">18.</span> <span class="toc-text">Django 缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存配置"><span class="toc-number">18.1.</span> <span class="toc-text">缓存配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库缓存"><span class="toc-number">18.1.1.</span> <span class="toc-text">数据库缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件缓存"><span class="toc-number">18.1.2.</span> <span class="toc-text">文件缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis缓存"><span class="toc-number">18.1.3.</span> <span class="toc-text">redis缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存使用"><span class="toc-number">18.2.</span> <span class="toc-text">缓存使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#视图函数"><span class="toc-number">18.2.1.</span> <span class="toc-text">视图函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模板局部缓存"><span class="toc-number">18.2.2.</span> <span class="toc-text">模板局部缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全站缓存"><span class="toc-number">18.2.3.</span> <span class="toc-text">全站缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#手动设置缓存"><span class="toc-number">18.2.4.</span> <span class="toc-text">手动设置缓存</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-异步任务队列"><span class="toc-number">19.</span> <span class="toc-text">Django 异步任务队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Celery简介"><span class="toc-number">19.1.</span> <span class="toc-text">Celery简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Celery的相关概念"><span class="toc-number">19.2.</span> <span class="toc-text">Celery的相关概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用场景"><span class="toc-number">19.3.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Celery的安装"><span class="toc-number">19.4.</span> <span class="toc-text">Celery的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-1"><span class="toc-number">19.4.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-1"><span class="toc-number">19.4.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建celery实例"><span class="toc-number">19.4.3.</span> <span class="toc-text">创建celery实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Celery的使用"><span class="toc-number">19.5.</span> <span class="toc-text">Celery的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建任务"><span class="toc-number">19.5.1.</span> <span class="toc-text">创建任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调用"><span class="toc-number">19.5.2.</span> <span class="toc-text">调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成数据库表"><span class="toc-number">19.5.3.</span> <span class="toc-text">生成数据库表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动worker"><span class="toc-number">19.5.4.</span> <span class="toc-text">启动worker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取任务执行结果"><span class="toc-number">19.5.5.</span> <span class="toc-text">获取任务执行结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定时任务和计划任务"><span class="toc-number">19.6.</span> <span class="toc-text">定时任务和计划任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#定时任务"><span class="toc-number">19.6.1.</span> <span class="toc-text">定时任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#计划任务时间"><span class="toc-number">19.6.2.</span> <span class="toc-text">计划任务时间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其它"><span class="toc-number">19.7.</span> <span class="toc-text">其它</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查看异步任务情况"><span class="toc-number">19.7.1.</span> <span class="toc-text">查看异步任务情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内存泄漏"><span class="toc-number">19.7.2.</span> <span class="toc-text">内存泄漏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用配置清单"><span class="toc-number">19.7.3.</span> <span class="toc-text">常用配置清单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-LOG日志"><span class="toc-number">20.</span> <span class="toc-text">Django LOG日志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Log简介"><span class="toc-number">20.1.</span> <span class="toc-text">Log简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Log的用途"><span class="toc-number">20.2.</span> <span class="toc-text">Log的用途</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Log的等级"><span class="toc-number">20.3.</span> <span class="toc-text">Log的等级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Log的四大组件"><span class="toc-number">20.4.</span> <span class="toc-text">Log的四大组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Loggers"><span class="toc-number">20.4.1.</span> <span class="toc-text">Loggers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handlers"><span class="toc-number">20.4.2.</span> <span class="toc-text">Handlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filters"><span class="toc-number">20.4.3.</span> <span class="toc-text">Filters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Formatters"><span class="toc-number">20.4.4.</span> <span class="toc-text">Formatters</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-number">20.5.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django中的配置"><span class="toc-number">20.6.</span> <span class="toc-text">Django中的配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基于类的视图"><span class="toc-number">21.</span> <span class="toc-text">基于类的视图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#类视图的基本使用"><span class="toc-number">21.1.</span> <span class="toc-text">类视图的基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本视图"><span class="toc-number">21.2.</span> <span class="toc-text">基本视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#根视图View类"><span class="toc-number">21.3.</span> <span class="toc-text">根视图View类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TemplateView"><span class="toc-number">21.4.</span> <span class="toc-text">TemplateView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RedirectView"><span class="toc-number">21.5.</span> <span class="toc-text">RedirectView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通用显示视图"><span class="toc-number">21.6.</span> <span class="toc-text">通用显示视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ListView"><span class="toc-number">21.7.</span> <span class="toc-text">ListView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DetailView"><span class="toc-number">21.8.</span> <span class="toc-text">DetailView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通用编辑视图"><span class="toc-number">21.9.</span> <span class="toc-text">通用编辑视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FormView"><span class="toc-number">21.10.</span> <span class="toc-text">FormView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CreateView"><span class="toc-number">21.11.</span> <span class="toc-text">CreateView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UpdateView"><span class="toc-number">21.12.</span> <span class="toc-text">UpdateView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DeleteView"><span class="toc-number">21.13.</span> <span class="toc-text">DeleteView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#类视图使用装饰器"><span class="toc-number">21.14.</span> <span class="toc-text">类视图使用装饰器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-rest-framework"><span class="toc-number">22.</span> <span class="toc-text">Django-rest-framework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是RESTful"><span class="toc-number">22.1.</span> <span class="toc-text">什么是RESTful</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RESTful-API设计"><span class="toc-number">22.2.</span> <span class="toc-text">RESTful API设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于Django实现"><span class="toc-number">22.3.</span> <span class="toc-text">基于Django实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于Django-Rest-Framework框架实现"><span class="toc-number">22.4.</span> <span class="toc-text">基于Django Rest Framework框架实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django上线部署"><span class="toc-number">23.</span> <span class="toc-text">Django上线部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#问题描述"><span class="toc-number">23.1.</span> <span class="toc-text">问题描述:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决办法"><span class="toc-number">23.2.</span> <span class="toc-text">解决办法:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#访问可能会出现403没有权限的问题"><span class="toc-number">23.2.1.</span> <span class="toc-text">访问可能会出现403没有权限的问题</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(http://cdn.panyucable.cn/zysheep/django_top.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">三月三</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bug" aria-hidden="true"></i><span> 编程路线</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/java/"><i class="fa-fw fa fa-coffee"></i><span> Java</span></a></li><li><a class="site-page" href="/python/"><i class="fa-fw fa fa-binoculars"></i><span> Python</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder-open" aria-hidden="true"></i><span> 面试宝典</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/interview/"><i class="fa-fw fa fa-file-text-o"></i><span> Java面试题</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 我的生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-picture-o"></i><span> Gallery</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Django学习</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-04-07 12:30:45"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-04-07</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-09-22 21:57:29"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-09-22</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/">Python</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/Django/">Django</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">36.4k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 148 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/04/07/Python/%E5%AD%A6%E4%B9%A0Django/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Django-简介"><a href="#Django-简介" class="headerlink" title="Django 简介"></a>Django 简介</h1><p>Django发布于2005年,是一个由 Python 编写的一个开放源代码的 Web 应用框架（源代码是开源的，遵守BSD版权）。使用 Django，只要很少的代码，Python 的程序开发人员就可以轻松地完成一个正式网站所需要的大部分内容，并进一步开发出全功能的 Web 服务Django本身基于 MVC 模型，即 Model（模型）+ View（视图）+ Controller（控制器）设计模式，也有很多人把它称MVT（MTV）模式。MVC 模式使后续对程序的修改和扩展简化，并且使程序某一部分的重复利用成为可能。</p>
<h2 id="MTV-模型"><a href="#MTV-模型" class="headerlink" title="MTV 模型"></a>MTV 模型</h2><p>Django 的 MTV 模式本质上和 MVC 是一样的，也是为了各组件间保持松耦合关系，只是定义上有些许不同，Django 的 MTV 分别是指：</p>
<ul>
<li>M 表示模型（Model）：编写程序应有的功能，负责业务对象与数据库的映射(ORM)。</li>
<li>T 表示模板 (Template)：负责如何把页面(html)展示给用户。</li>
<li>V 表示视图（View）：负责业务逻辑，并在适当时候调用 Model和 Template。</li>
</ul>
<p>除了以上三层之外，还需要一个 URL 分发器，它的作用是将一个个 URL 的页面请求分发给不同的 View 处理，View 再调用相应的 Model 和 Template，MTV 的响应模式</p>
<p>用户操作流程图：</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200818195334.png" alt=""></p>
<p><strong>解析：</strong></p>
<p>用户通过浏览器向我们的服务器发起一个请求(request)，这个请求会去访问视图函数：</p>
<ul>
<li><strong>绿色路线</strong>:如果不涉及到数据调用，那么这个时候视图函数直接返回一个模板也就是一个网页给用户。</li>
<li><strong>红色路线</strong>:如果涉及到数据调用，那么视图函数调用模型，模型去数据库查找数据，然后逐级返回。视图函数把返回的数据填充到模板中空格中，最后返回网页给用户。</li>
</ul>
<h2 id="Django版本"><a href="#Django版本" class="headerlink" title="Django版本"></a>Django版本</h2><p>  <img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200818194314.png" alt=""></p>
<p>django各个版本对python的要求：</p>
<table>
<thead>
<tr>
<th>Django version</th>
<th>Python versions</th>
</tr>
</thead>
<tbody><tr>
<td>1.11</td>
<td>2.7, 3.4, 3.5, 3.6</td>
</tr>
<tr>
<td>2.0</td>
<td>3.4, 3.5, 3.6, 3.7</td>
</tr>
<tr>
<td>2.1, 2.2</td>
<td>3.5, 3.6, 3.7</td>
</tr>
</tbody></table>
<h1 id="Django的安装"><a href="#Django的安装" class="headerlink" title="Django的安装"></a>Django的安装</h1><h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><ul>
<li>操作系统: Windows</li>
<li>python版本：&gt;=3.5</li>
<li>Django版本：2.2</li>
</ul>
<h2 id="pip命令安装"><a href="#pip命令安装" class="headerlink" title="pip命令安装"></a>pip命令安装</h2><p>⾸先使用<a href="https://zysheep.cn/2020/04/04/Python/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86/">virtualenvwrapper-win</a>建⽴⼀个虚拟开发环境，然后使用pip安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv django-env   # 新建虚拟环境</span><br><span class="line">workon django-env  # 进入虚拟环境</span><br><span class="line">pip install django==2.2 -i http://mirrors.aliyun.com/pypi/simple/  #安装指定版本的django</span><br></pre></td></tr></table></figure>

<p>安装完毕后，测试⼀下是否安装成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#在虚拟开发环境中</span><br><span class="line">&gt;&gt;&gt;python #开启python</span><br><span class="line">&gt;&gt;&gt;import django</span><br><span class="line">&gt;&gt;&gt;django.get_version()</span><br></pre></td></tr></table></figure>

<h2 id="⼿动安装"><a href="#⼿动安装" class="headerlink" title="⼿动安装"></a>⼿动安装</h2><p>到django官⽹上下载：<a href="https://www.djangoproject.com/download/2.2.9/tarball/安装包,然后解压，到解压⽬录下，打开虚拟开发环境，执行以下命令" target="_blank" rel="noopener">https://www.djangoproject.com/download/2.2.9/tarball/安装包,然后解压，到解压⽬录下，打开虚拟开发环境，执行以下命令</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install .</span><br></pre></td></tr></table></figure>

<h1 id="Django-创建第一个项目"><a href="#Django-创建第一个项目" class="headerlink" title="Django 创建第一个项目"></a>Django 创建第一个项目</h1><p>测试版本说明：</p>
<ul>
<li>Python 3.8.4</li>
<li>Django 2.2</li>
</ul>
<h2 id="Django-管理工具"><a href="#Django-管理工具" class="headerlink" title="Django 管理工具"></a>Django 管理工具</h2><p>安装 Django 之后，您现在应该已经有了可用的管理工具 django-admin.py，Windows 如果没有配置环境变量可以用 django-admin。我们可以使用 <strong>django-admin.py</strong> 来创建一个项目:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\L15096000421&gt;django-admin</span><br><span class="line">Type &#39;django-admin help &lt;subcommand&gt;&#39; for help on a specific subcommand.</span><br><span class="line">Available subcommands:</span><br><span class="line">[django]</span><br><span class="line">    check</span><br><span class="line">    compilemessages</span><br><span class="line">    createcachetable</span><br><span class="line">    dbshell</span><br><span class="line">    diffsettings</span><br><span class="line">    dumpdata</span><br><span class="line">    flush</span><br><span class="line">    inspectdb</span><br><span class="line">    loaddata</span><br><span class="line">    makemessages</span><br><span class="line">    makemigrations</span><br><span class="line">    migrate</span><br><span class="line">    runserver</span><br><span class="line">    sendtestemail</span><br><span class="line">    shell</span><br><span class="line">    showmigrations</span><br><span class="line">    sqlflush</span><br><span class="line">    sqlmigrate</span><br><span class="line">    sqlsequencereset</span><br><span class="line">    squashmigrations</span><br><span class="line">    startapp</span><br><span class="line">    startproject</span><br><span class="line">    test</span><br><span class="line">    testserver</span><br></pre></td></tr></table></figure>

<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>使用 django-admin.py 来创建 HelloWorld 项目。先切换到指定⽬录，开启虚拟环境，然后用以下指令创建⼀个项⽬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject HelloWorld</span><br></pre></td></tr></table></figure>

<p>创建完成后我们可以查看下项目的目录结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cd HelloWorld&#x2F;</span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">|-- HelloWorld</span><br><span class="line">|   |-- __init__.py</span><br><span class="line">|   |-- settings.py</span><br><span class="line">|   |-- urls.py</span><br><span class="line">|   &#96;-- wsgi.py</span><br><span class="line">&#96;-- manage.py</span><br></pre></td></tr></table></figure>

<p>目录说明：</p>
<ul>
<li><strong>HelloWorld:</strong> 项目的容器。</li>
<li><strong>manage.py:</strong> 一个实用的命令行工具，可让你以各种方式与该 Django 项目进行交互。</li>
<li><strong>HelloWorld/<strong>init</strong>.py:</strong> 一个空文件，告诉 Python 该目录是一个 Python 包。</li>
<li><strong>HelloWorld/settings.py:</strong> 该 Django 项目的设置/配置。</li>
<li><strong>HelloWorld/urls.py:</strong> 该 Django 项目的 URL 声明; 一份由 Django 驱动的网站”目录”。</li>
<li><strong>HelloWorld/wsgi.py:</strong> 一个 WSGI 兼容的 Web 服务器的入口，以便运行你的项目。</li>
</ul>
<p>接下来我们进入 HelloWorld 目录输入以下命令，启动服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver 0.0.0.0:8000</span><br></pre></td></tr></table></figure>

<blockquote>
<p>0.0.0.0 让其它电脑可连接到开发服务器，8000 为端口号。如果不说明，那么端口号默认为 8000。</p>
</blockquote>
<p>在浏览器输入你服务器的 ip（这里我们输入本机 IP 地址： <strong>127.0.0.1:8000</strong>） 及端口号，如果正常启动，输出结果如下：</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200818201801.png" alt=""></p>
<p>如果要让远程客户端连接需要修改配置⽂件，其中0.0.0.0:9000是可选的，0.0.0.0说明任何ip都可以访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#修改setting.py中的这⼀行</span><br><span class="line">ALLOWED_HOSTS &#x3D; [&#39;*&#39;]</span><br></pre></td></tr></table></figure>

<p>如果需要让页面显示中文,需要在<code>setting.py</code>中修改国际化的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 语言 国际化</span><br><span class="line">LANGUAGE_CODE &#x3D; &#39;zh-hans&#39;</span><br><span class="line">TIME_ZONE &#x3D; &#39;Asia&#x2F;Shanghai&#39;</span><br><span class="line"># 不使用世界时间,改为False,数据库储存的时间和当地时间一致</span><br><span class="line">USE_TZ &#x3D; False</span><br></pre></td></tr></table></figure>

<h2 id="建立应用"><a href="#建立应用" class="headerlink" title="建立应用"></a>建立应用</h2><p>⼀个django项⽬中可以包含多个应用，和flask只是叫法上不同,在flask中说法为可以在一个app上建议多个模块</p>
<p>可以使用以下命令建⽴应用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#命令： python manager.py startapp 应用名称</span><br><span class="line">实例： python manager.py startapp app</span><br></pre></td></tr></table></figure>

<p>创建应用后，项⽬的结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">── App</span><br><span class="line">│ ├── admin.py 站点管理</span><br><span class="line">│ ├── apps.py 应用程序⾃身信息</span><br><span class="line">│ ├── __init__.py</span><br><span class="line">│ ├── migrations 数据迁移</span><br><span class="line">│ │ └── __init__.py</span><br><span class="line">│ ├── models.py 模型</span><br><span class="line">│ ├── tests.py</span><br><span class="line">│ └── views.py 视图响应函数</span><br><span class="line">├── db.sqlite3 sqlite数据库</span><br><span class="line">├── hellodjango 项⽬</span><br><span class="line">│ ├── doc.py</span><br><span class="line">│ ├── __init__.py</span><br><span class="line">│ ├── __pycache__</span><br><span class="line">│ │ ├── __init__.cpython-36.pyc</span><br><span class="line">│ │ ├── settings.cpython-36.pyc</span><br><span class="line">│ │ ├── urls.cpython-36.pyc</span><br><span class="line">│ │ └── wsgi.cpython-36.pyc</span><br><span class="line">│ ├── settings.py 系统配置</span><br><span class="line">│ ├── urls.py 路由映射表</span><br><span class="line">│ └── wsgi.py wsgi协议</span><br><span class="line">└── manage.py 项⽬管理命令</span><br></pre></td></tr></table></figure>

<p>修改项⽬的配置⽂件<code>setting.py</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS &#x3D; [</span><br><span class="line"> &#39;django.contrib.admin&#39;,</span><br><span class="line"> &#39;django.contrib.auth&#39;,</span><br><span class="line"> &#39;django.contrib.contenttypes&#39;,</span><br><span class="line"> &#39;django.contrib.sessions&#39;,</span><br><span class="line"> &#39;django.contrib.messages&#39;,</span><br><span class="line"> &#39;django.contrib.staticfiles&#39;,</span><br><span class="line"> &#39;App&#39;, # 安装自己的应用</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="简单视图函数"><a href="#简单视图函数" class="headerlink" title="简单视图函数"></a>简单视图函数</h2><p>在django中view代表视图函数，接收用户的请求，进行处理然后返回html源代码给客户端。在框架中，我们可以在应用（app）的views.py中写⾃⼰的视图函数， 进行相应的处理</p>
<p>视图函数只是⼀个普通的python函数，它的第⼀个参数必须是⼀个请求（request）对象，这是框架传入的，我们可以通过请求对象获取提交参数等内容。它的返回值必须是⼀个web响应对象，可以文本、html源代码、重定向、404等内容。下⾯我们写⼀个简单视图函数，返回“Hello Django” </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from django.http import HttpResponse</span><br><span class="line">def index(request):</span><br><span class="line"> return HttpResponse(&quot;Hello Django&quot;)</span><br></pre></td></tr></table></figure>

<p>其中HttpResponse函数需要引⼊模块django.http，我们可以直接写HttpResponse，然后通过快捷键<code>alt+enter</code>，在下拉框中选择要导⼊的模块。</p>
<blockquote>
<p>alt+enter 代码飘红、飘⻩、查看定义、引⼊包都可以使用。</p>
</blockquote>
<h2 id="基本路由"><a href="#基本路由" class="headerlink" title="基本路由"></a>基本路由</h2><p>添加完视图函数后，还⽆法在浏览器中查看，必须添加路由。所谓路由就是将用户请求转换为访问对应的视图函数。项⽬路由在urls.py中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> App <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line"> path(<span class="string">'admin/'</span>, admin.site.urls),</span><br><span class="line"> <span class="comment"># 路由由两部分组成，第⼀部是⼀个匹配字符串（和flask规则相同），匹配用户的请求路径，第⼆部分是视图函数</span></span><br><span class="line"> path(<span class="string">''</span>, views.index)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>匹配字符串匹配用户在地址栏中键⼊的url，当用户在地址栏中键⼊<a href="http://localhost:9000时会显示Hello">http://localhost:9000时会显示Hello</a> World</p>
<h2 id="简单模板"><a href="#简单模板" class="headerlink" title="简单模板"></a>简单模板</h2><p>在上⾯我们已经能够展示简单的web⻚⾯，但要显示⼀个html⻚⾯，需要使用模板，在app下建⽴<code>templates</code>⽬录，在<code>templates</code>⽬录下建⽴⼀个<code>index.html</code>⽂件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"> &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line"> &lt;title&gt;搜狐&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">当你的才华还撑不起你的野心的时候，你就应该静下⼼来学习；&lt;br&gt;</span><br><span class="line">当你的能⼒还驾驭不了你的⽬标时，就应该沉下⼼来，历练；</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>然后修改<code>views</code>中视图函数<code>index</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from django.shortcuts import render</span><br><span class="line">def index(request):</span><br><span class="line"> return render(request,&#39;index.html&#39;)</span><br></pre></td></tr></table></figure>

<p>也可以在html中使用变量和流程控制结构，生成复杂的html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"> &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line"> &lt;!-- 模板中添加变ᰁ --&gt;</span><br><span class="line"> &lt;title&gt;&#123;&#123; title &#125;&#125;&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">当你的才华还撑不起你的野⼼的时候，你就应该静下⼼来学习；&lt;br&gt;</span><br><span class="line">当你的能⼒还驾驭不了你的⽬标时，就应该沉下⼼来，历练；</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>然后修改视图函数</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from django.shortcuts import render</span><br><span class="line">def index(request):</span><br><span class="line"> return render(request,&#39;index.html&#39;,content&#x3D;&#123;&#39;title&#39;:&#39;草榴&#39;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="简单模型"><a href="#简单模型" class="headerlink" title="简单模型"></a>简单模型</h2><p>django⾃带了⼀个sqlite数据库，可以用于测试，生产环境⼀般不用。在配置⽂件中已经设置好默认的sqlite数据库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DATABASES &#x3D; &#123;</span><br><span class="line"> &#39;default&#39;: &#123;</span><br><span class="line"> &#39;ENGINE&#39;: &#39;django.db.backends.sqlite3&#39;, #数据库引擎</span><br><span class="line"> &#39;NAME&#39;: os.path.join(BASE_DIR, &#39;db.sqlite3&#39;), #数据库⽂件路径</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在pycharm左边栏中选—-database，然后点选”+”,弹出sqlite的配置窗⼝</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200818203729.png" alt=""></p>
<p>将File改为项⽬中sqlite⽂件：db.sqlite3，然后点击测试，看看能否连接成功。第⼀次配置时，需要下载sqlite的驱动。完成后点击ok。 </p>
<p>然后到<code>app</code>中<code>models.py</code>中创建⼀个User类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class User(models.Model):</span><br><span class="line">     uname &#x3D; models.CharField(max_length&#x3D;20)</span><br><span class="line">     password &#x3D; models.CharField(max_length&#x3D;32)</span><br><span class="line">     </span><br><span class="line">     class Meta:</span><br><span class="line">        db_table &#x3D; &#39;app_user&#39; # 指定表名,默认为应用名_类名小写</span><br></pre></td></tr></table></figure>

<p>到命令行下，输⼊：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations #生成数据库迁移⽂件</span><br><span class="line">python manage.py migrate #生成数据库表</span><br></pre></td></tr></table></figure>

<p>然后到pycharm左边栏database中查看：</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200818203752.png" alt=""></p>
<p>双击app_user添加数据：</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200818203743.png" alt=""></p>
<p>到此为⽌，我们已经给app_user表添加了数据。然后给app添加⼀个模板：<code>list.html</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"> &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line"> &lt;title&gt;用户列表&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;table width&#x3D;&quot;80%&quot; align&#x3D;&quot;center&quot; border&#x3D;&quot;1&quot; cellspacing&#x3D;&quot;0&quot;&gt;</span><br><span class="line"> &lt;caption&gt;用户列表&lt;&#x2F;caption&gt;</span><br><span class="line"> &#123;% for user in users %&#125;</span><br><span class="line"> &lt;tr&gt;</span><br><span class="line"> &lt;td&gt;&#123;&#123; user.uname &#125;&#125;&lt;&#x2F;td&gt;</span><br><span class="line"> &lt;td&gt;&#123;&#123; user.password &#125;&#125;&lt;&#x2F;td&gt;</span><br><span class="line"> &lt;&#x2F;tr&gt;</span><br><span class="line"> &#123;% endfor %&#125;</span><br><span class="line">&lt;&#x2F;table&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>继续给app添加⼀个视图操作函数： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from app.models import User</span><br><span class="line">def userlist(req):</span><br><span class="line"> #获取app_user表中所有数据</span><br><span class="line"> persons &#x3D; User.objects.all()</span><br><span class="line"> return render(req,&quot;list.html&quot;, context&#x3D;&#123;&#39;users&#39;:persons&#125;)</span><br></pre></td></tr></table></figure>

<p>在项⽬的路由表中添加路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns &#x3D; [</span><br><span class="line"> url(&#39;admin&#x2F;&#39;, admin.site.urls),</span><br><span class="line"> url(&#39; &#39;,views.index),</span><br><span class="line"> url(r&#39;^list&#x2F;$&#39;,views.userlist), # 使用正则匹配url</span><br><span class="line"> url(&#39;list&#x2F;&#39;,views.userlist), # 有可以直接使用路径匹配</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>到浏览器中访问：<a href="http://localhost:9000/list/" target="_blank" rel="noopener">http://localhost:9000/list/</a></p>
<h1 id="Django-模型-M"><a href="#Django-模型-M" class="headerlink" title="Django 模型(M)"></a>Django 模型(M)</h1><p>模型使用步骤：</p>
<ol>
<li>配置数据库</li>
<li><code>models.py</code>定义模型类</li>
<li>激活模型</li>
<li>使用模型</li>
</ol>
<blockquote>
<p>Django默认使用的是sqlite，但在生产环境中⼀般会用mysql、postgrsql、oracle等关系型数据库。</p>
</blockquote>
<h2 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h2><p>在虚拟开发环境(django-env)中，安装mysql的数据库驱动mysqlclient</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mysqlclient</span><br></pre></td></tr></table></figure>

<p>在项⽬的<code>settings.py</code>⽂件中找到<code>DATABASES</code> 配置项，将其信息修改为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">     <span class="string">'default'</span>: &#123;</span><br><span class="line">     <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>, <span class="comment">#mysql数据库引擎</span></span><br><span class="line">     <span class="string">'NAME'</span>: <span class="string">'test'</span>, <span class="comment">#数据库名</span></span><br><span class="line">     <span class="string">'HOST'</span>:<span class="string">'localhost'</span>, <span class="comment">#数据库服务器地址</span></span><br><span class="line">     <span class="string">'USER'</span>: <span class="string">'test'</span>, <span class="comment">#mysql数据库用户名</span></span><br><span class="line">     <span class="string">'PASSWORD'</span>: <span class="string">'test123'</span>, <span class="comment">#密码</span></span><br><span class="line">     <span class="string">'PORT'</span>:<span class="number">3306</span>, <span class="comment">#端⼝号，可选</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h2><p>对象关系映射（Oject Relational Mapping，简称ORM）模式是⼀种为了解决⾯向对象与关系数据库存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，⾃动生成sql语句，将程序中的对象⾃动保存到关系数据库中。优点：</p>
<ul>
<li>隐藏了数据库访问的细节，简化了sql的使用，提⾼了开发效率</li>
<li>解耦业务逻辑层（view）和数据处理层（model)，简化了开发流程，提⾼了系统的可移植性</li>
<li>提⾼了安全性</li>
</ul>
<p>缺点：</p>
<ul>
<li>执行效率低</li>
<li>对复杂的sql无能为力</li>
<li>增加了学习成本</li>
</ul>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><table>
<thead>
<tr>
<th>面向对象概念</th>
<th>⾯向关系概念</th>
</tr>
</thead>
<tbody><tr>
<td>类</td>
<td>表</td>
</tr>
<tr>
<td>对象</td>
<td>记录(一行)</td>
</tr>
<tr>
<td>属性</td>
<td>字段(属性,列)</td>
</tr>
</tbody></table>
<ul>
<li>⼀个模型类对应⼀个表</li>
<li>每个模型类都必须继承django.db.models.Model</li>
</ul>
<h3 id="模型属性"><a href="#模型属性" class="headerlink" title="模型属性"></a>模型属性</h3><p>模型中的属性和数据库表的字段对应，必须定义。模型的属性需要定义成类属性</p>
<p>属性定义语法为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">属性 &#x3D; models.字段类型(选项)</span><br></pre></td></tr></table></figure>

<p>实例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">128</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'user'</span> <span class="comment"># 指定表名</span></span><br></pre></td></tr></table></figure>

<p>属性命名规则:</p>
<ul>
<li><p>不能是python的保留关键字</p>
</li>
<li><p>不允许使用连续的下划线，因为连续下划线在查询中会用到</p>
</li>
<li><p>定义属性时需要指定字段类型</p>
</li>
<li><p><strong>主键⼀般不用⾃⼰定义，django会⾃动创建⾃增⻓主键列，如果你⾃⼰定义了主键，则django不会再⾃动生成主键</strong></p>
<h4 id="字段类型"><a href="#字段类型" class="headerlink" title="字段类型"></a>字段类型</h4></li>
</ul>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段说明</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td>AutoField</td>
<td>⼀个根据实际Id⾃动增⻓的IntegerField（通常不指定 ⾃动⽣成）</td>
<td></td>
</tr>
<tr>
<td>CharField</td>
<td>字符串，默认的表单样式是TextInput</td>
<td>max_length=字符⻓度</td>
</tr>
<tr>
<td>TextField</td>
<td>⼤⽂本字段，⼀般超过4000使⽤，默认的表单控件是Textarea</td>
<td></td>
</tr>
<tr>
<td>IntegerField</td>
<td>整数</td>
<td></td>
</tr>
<tr>
<td>DecimalField</td>
<td>使⽤python的Decimal实例表示的⼗进制浮点数</td>
<td>max_digits总位数;decimal_places小数位数</td>
</tr>
<tr>
<td>FloatField</td>
<td>⽤Python的float实例来表示的 浮点数</td>
<td></td>
</tr>
<tr>
<td>BooleanField</td>
<td>true/false 字段，此字段的默认表单控制是CheckboxInput</td>
<td></td>
</tr>
<tr>
<td>NullBooleanField</td>
<td>支持null,true,false三种值</td>
<td></td>
</tr>
<tr>
<td>DateField</td>
<td>使用Python的datatime.date实例表示的日期,该字段默认对应的表单控件是⼀个TextInput</td>
<td>auto_now和 auto_now_add、default这三个参数不能同时存在</td>
</tr>
<tr>
<td>TimeField</td>
<td>使⽤Python的datetime.time实例表示的时间</td>
<td>参数同DateField</td>
</tr>
<tr>
<td>DateTimeField</td>
<td>使⽤Python的datetime.datetime实例表示的日期和时间</td>
<td>参数同DateField</td>
</tr>
<tr>
<td>ImageField</td>
<td>继承了FileField的所有属性和⽅法，但对上传的对象进⾏校验，确保它是个有效的image</td>
<td>不能同时共存</td>
</tr>
</tbody></table>
<ul>
<li>auto_now: 每次保存对象时，⾃动设置该字段为当前时间，用于”最后⼀次修改”的时间戳，它总是使用当前⽇期，默认为false</li>
<li>auto_now_add: 当对象第⼀次被创建时⾃动设置当前时间，用于创建的时间戳，它总是使用当前⽇期，默认为false</li>
</ul>
<h4 id="字段选项"><a href="#字段选项" class="headerlink" title="字段选项"></a>字段选项</h4><p>适用于任何字段，可以实现字段的约束，在生成字段时通过方法的关键字参数指定 </p>
<table>
<thead>
<tr>
<th>可选参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>null</td>
<td>如果 True ，Django将NULL在数据库中存储空值。默认 是 False 。不要在字符串字段上使⽤。null是数据库范畴的概念</td>
</tr>
<tr>
<td>blank</td>
<td>如果 True ，该字段允许为空。默认是 False 。同null不同， 如果字段有 blank=True ，则表单验证将允许输⼊空值。如果字段有 blank=False,则需要该字段</td>
</tr>
<tr>
<td>db_column</td>
<td>⽤于此字段的数据库列的名称。如果没有给出，Django将使⽤该字段的名称</td>
</tr>
<tr>
<td>db_index</td>
<td>如果为True ，将为此字段创建数据库常规索引。</td>
</tr>
<tr>
<td>unique</td>
<td>如果为True,该字段在整个表格中必须是唯一的</td>
</tr>
<tr>
<td>primary_key</td>
<td>如果为True,此字段是模型的主键</td>
</tr>
<tr>
<td>default</td>
<td>默认值,当前字段如果不给值则执行默认值</td>
</tr>
</tbody></table>
<h2 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h2><p>我们可以在应用的<code>models.py</code>中定义模型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line">class 模型名(models.Model):</span><br><span class="line">     属性名 &#x3D; models.字段名(字段选项&#x2F;参数)</span><br><span class="line">     .....</span><br><span class="line">     class Meta: #可选，任何非字段的设置可以写到Meta中</span><br><span class="line">         db_table &#x3D; &#39;user&#39; #指定表名为uesr</span><br></pre></td></tr></table></figure>

<ul>
<li><p>数据库的表名等于：应用名_模型名，如果想指定表名，可以在Meta中使用db_table指定</p>
</li>
<li><p>如果没有指定主键，Django将⾃动给表创建⼀个⾃增⻓主键id</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id &#x3D; models.AutoField(primary_key&#x3D;True)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Meta中常用设置：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>db_table</td>
<td>数据库中的表名</td>
</tr>
<tr>
<td>abstract</td>
<td>当设置为True时，说明当前模型是抽象基类</td>
</tr>
<tr>
<td>managed</td>
<td>如果设置False，则迁移不会创建或删除表，默认是True</td>
</tr>
<tr>
<td>ordering</td>
<td>⽤于记录排序，ordering = [‘pub_date’]或降序ordering = [‘- pub_date’]</td>
</tr>
</tbody></table>
</li>
<li><p>实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line">from django.utils import timezone</span><br><span class="line">#用户类</span><br><span class="line">class User(models.Model):</span><br><span class="line">     uid &#x3D; models.AutoField(primary_key&#x3D;True) #⾃增主键</span><br><span class="line">     uname &#x3D; models.CharField(max_length&#x3D;60)</span><br><span class="line">     password &#x3D; models.CharField(max_length&#x3D;32)</span><br><span class="line">     user_type &#x3D; ((1,&#39;超级管理员&#39;),(2,&#39;普通用户&#39;)) </span><br><span class="line">     type &#x3D; models.IntegerField(default&#x3D;2,choices&#x3D;user_type)</span><br><span class="line">     regtime &#x3D; models.DateTimeField(default&#x3D;timezone.now) #缺省值是当前时间</span><br><span class="line">     ip &#x3D; models.IntegerField(null&#x3D;True)</span><br><span class="line">     login_type &#x3D; ((1,&#39;允许登录&#39;),(2,&#39;禁⽌登录&#39;)) #用户⾃定义类型对应mysql的enum类型</span><br><span class="line">     allowed &#x3D; models.IntegerField(default&#x3D;1,choices&#x3D;login_type)</span><br><span class="line">     email &#x3D; models.CharField(max_length&#x3D;100,null&#x3D;True)</span><br><span class="line">     memo &#x3D; models.CharField(max_length&#x3D;1000,null&#x3D;True)</span><br><span class="line">     class Meta:</span><br><span class="line">        db_table &#x3D; &#39;user&#39; #表名</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="激活模型"><a href="#激活模型" class="headerlink" title="激活模型"></a>激活模型</h2><ul>
<li><p>创建迁移⽂件 （此刻表并没有创建到库中)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行迁移 （将模型创建到库中）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>然后在应用的migrations⽬录中应该生成了迁移⽂件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">├── app</span><br><span class="line">│ ├── admin.py</span><br><span class="line">│ ├── apps.py</span><br><span class="line">│ ├── __init__.py</span><br><span class="line">│ ├── migrations</span><br><span class="line">│ │ ├── 0001_initial.py</span><br><span class="line">│ │ ├── __init__.py</span><br></pre></td></tr></table></figure>

<p>生成的表结构如下</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;user&#96; (</span><br><span class="line">    &#96;uid&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">    &#96;uname&#96; varchar(60) NOT NULL,</span><br><span class="line">    &#96;password&#96; char(32) NOT NULL,</span><br><span class="line">    &#96;type&#96; enum(&#39;超级管理员&#39;,&#39;普通用户&#39;) DEFAULT &#39;普通用户&#39;,</span><br><span class="line">    &#96;regtime&#96; datetime DEFAULT NULL,</span><br><span class="line">    &#96;ip&#96; int(11) DEFAULT NULL,</span><br><span class="line">    &#96;allowed&#96; enum(&#39;允许登录&#39;,&#39;禁⽌登录&#39;) DEFAULT &#39;允许登录&#39;,</span><br><span class="line">    &#96;email&#96; varchar(100) DEFAULT NULL,</span><br><span class="line">    &#96;memo&#96; varchar(1000) DEFAULT NULL,</span><br><span class="line">    PRIMARY KEY (&#96;uid&#96;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<blockquote>
<p> <strong>注意：</strong>任何对字段或表的修改都需要重新迁移</p>
</blockquote>
<ul>
<li><p>反向迁移:可以根据数据库中表⾃动创建模型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py inspectdb &gt; App&#x2F;models.py</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="模型的使用"><a href="#模型的使用" class="headerlink" title="模型的使用"></a>模型的使用</h2><h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from app.models.User import User #导⼊User模型</span><br><span class="line">from hashlib import md5</span><br><span class="line">user &#x3D; User(uname&#x3D;&#39;admin&#39;,password&#x3D;md5(b&#39;123&#39;).hexdigest()) #实例化⼀个新对象</span><br><span class="line">user.save() #insert 插⼊数据库</span><br><span class="line"></span><br><span class="line">#便捷插⼊</span><br><span class="line">User.objects.create(username&#x3D;&#39;妈咪哄&#39;,password&#x3D;&#39;111&#39;)</span><br><span class="line"></span><br><span class="line"># 批量插⼊记录(不支持多对多)</span><br><span class="line">User.objects.bulk_create(User.objects.create(username&#x3D;&#39;哈哈&#39;,password&#x3D;&#39;111&#39;),User.objects.create(username&#x3D;&#39;嘻嘻&#39;,password&#x3D;&#39;111&#39;))</span><br></pre></td></tr></table></figure>

<h3 id="删"><a href="#删" class="headerlink" title="删"></a>删</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u1 &#x3D; User.objects.get(pk&#x3D;1)</span><br><span class="line">u1.delete() # 删除该记录</span><br></pre></td></tr></table></figure>

<ul>
<li><p>数据的逻辑删除</p>
<p>对于重要数据，⼀般不会直接删除，会在表中增加⼀个字段⽐如： <code>is_deleted</code>，如果删除的话，将这个字段置为True，以后查询的时候不在查询，这种操作称为逻辑删除</p>
</li>
</ul>
<h3 id="改"><a href="#改" class="headerlink" title="改"></a>改</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">u2 &#x3D; User.objects.get(pk&#x3D;2)</span><br><span class="line">u2.uname &#x3D; &#39;⼩甜甜&#39; #update 更新</span><br><span class="line">u2.save()</span><br><span class="line"></span><br><span class="line"># 修改多条记录</span><br><span class="line">users &#x3D; User.objects.all()</span><br><span class="line">users.update(password&#x3D;md5(b&#39;345&#39;).hexdigest())</span><br></pre></td></tr></table></figure>

<h3 id="数据查询"><a href="#数据查询" class="headerlink" title="数据查询"></a>数据查询</h3><p>要从数据库检索数据，⾸先要获取⼀个查询集(QuerySet)，查询集表示从数据库获取的对象集合，它可以有零个，⼀个或多个过滤器。返回查询集的方法，称为过滤器，过滤器根据给定的参数缩⼩查询结果范围，相当于sql语句中where或limit。</p>
<ul>
<li>在管理器上调用过滤器方法会返回查询集</li>
<li>查询集经过过滤器筛选后返回新的查询集，因此可以写成链式过滤 </li>
<li>惰性执行：创建查询集不会带来任何数据库的访问，直到调用数据时，才会访 问数据库</li>
<li>以下对查询集求值：迭代、切⽚、序列化、与if合用、repr()/print()/len()/list()/bool()</li>
</ul>
<table>
<thead>
<tr>
<th>管理器的方法</th>
<th>返回类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>模型类.objects.all()</td>
<td>QuerySet</td>
<td>返回表中所有数据</td>
</tr>
<tr>
<td>模型类.objects.filter()</td>
<td>QuerySet</td>
<td>返回符合条件的数据</td>
</tr>
<tr>
<td>模型类.objects.exclude()</td>
<td>QuerySet</td>
<td>返回不符合条件的数据</td>
</tr>
<tr>
<td>模型类.objects.order_by()</td>
<td>QuerySet</td>
<td>对查询结果集进⾏排序</td>
</tr>
<tr>
<td>模型类.objects.values()</td>
<td>QuerySet</td>
<td>返回⼀个Queryset，其中每个对象为⼀个 字典</td>
</tr>
<tr>
<td>模型类.objects.values_list()</td>
<td>QuerySet</td>
<td>和values()基本相同，但每个对象是⼀个元 组</td>
</tr>
<tr>
<td>模型类.objects.reverse()</td>
<td>QuerySet</td>
<td>对排序的结果反转</td>
</tr>
<tr>
<td>模型类.objects.only(字 段)</td>
<td>QuerySet</td>
<td>只显示指定字段</td>
</tr>
<tr>
<td>模型类.objects.defer(字 段)</td>
<td>QuerySet</td>
<td>去除指定字段</td>
</tr>
<tr>
<td>模型类.objects.get()</td>
<td>模型对象</td>
<td>返回⼀个满⾜条件的对象；如果没有找到符合条件的对象，会引发模型类.DoesNotExist异常;如果找到多个，会引发模型类.MultiObjectsReturned 异常</td>
</tr>
<tr>
<td>模型类.objects.first()</td>
<td>模型对象</td>
<td>返回第⼀条数据</td>
</tr>
<tr>
<td>模型类.objects.last()</td>
<td>模型对象</td>
<td>返回最后⼀条数据</td>
</tr>
<tr>
<td>模型类.objects.earliest（）</td>
<td>模型对象</td>
<td>根据指定字段返回最早增加的记录</td>
</tr>
<tr>
<td>模型类.objects.latest(field)</td>
<td>模型对象</td>
<td>根据field字段返回最近增加记录</td>
</tr>
<tr>
<td>模型类.objects.exists()</td>
<td>bool</td>
<td>判断查询的数据是否存在</td>
</tr>
<tr>
<td>模型类.objects.count()</td>
<td>int</td>
<td>返回查询集中对象的数⽬</td>
</tr>
</tbody></table>
<h4 id="返回查询集"><a href="#返回查询集" class="headerlink" title="返回查询集"></a>返回查询集</h4><ul>
<li><p>all()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 获取所有数据，对应SQL：select * from User</span><br><span class="line">User.objects.all()</span><br></pre></td></tr></table></figure>
</li>
<li><p>filter(**kwargs) 返回QuerySet包含与给定查找参数匹配的新查询集</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#等价sql：select * from User</span><br><span class="line">User.objects.filter()</span><br><span class="line"></span><br><span class="line">#等价sql：select * from User where uname &#x3D; &#39;admin&#39;</span><br><span class="line">User.objects.filter(uname&#x3D;&#39;admin&#39;)</span><br><span class="line"></span><br><span class="line">#等级sql：select * from User where uid &gt; 1 and type &#x3D; 2</span><br><span class="line">User.objects.filter(uid__gt&#x3D;1,type&#x3D;2)</span><br><span class="line"></span><br><span class="line">#链式调用，等价于User.objects.filter(uid__gt&#x3D;1,type&#x3D;2)</span><br><span class="line">User.objects.filter(uid__gt&#x3D;1).filter(type&#x3D;2)</span><br></pre></td></tr></table></figure>
</li>
<li><p>exclude(**kwargs)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 不匹配，对应SQL：select * from User where name !&#x3D; &#39;admin&#39;</span><br><span class="line">User.objects.exclude(name&#x3D;&#39;admin&#39;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>order_by(*fields)</p>
<ul>
<li>参数是字段名,可以有多个字段名,默认是升序</li>
<li>如果要按某个字段降序,在字段名前加’-‘; “-uid”表示按uid降序排列</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#按uid升序排列 等价于 order by uid</span><br><span class="line">User.objects().order_by(&#39;uid&#39;)</span><br><span class="line">#按uid降序排列 等价于 order by uid desc</span><br><span class="line">User.objects.order_by(&#39;-uid&#39;)</span><br><span class="line">#多列排序 等价于 order by password,uid desc</span><br><span class="line">User.objects.order_by(&#39;password&#39;,&#39;-uid&#39;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>values()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#返回所有字段</span><br><span class="line">User.objects.values()</span><br><span class="line"></span><br><span class="line">#返回数据：</span><br><span class="line">[&#123;&#39;uid&#39;: 2, &#39;uname&#39;: &#39;⼩甜甜&#39;, &#39;password&#39;:</span><br><span class="line">&#39;59f2443a4317918ce29ad28a14e1bdb7&#39;type&#39;: &#39;普通用户&#39;, &#39;regtime&#39;:</span><br><span class="line">None, &#39;ip&#39;: None, &#39;allowed&#39;: &#39;允许登录&#39;, &#39;email&#39;: None, None&#125;,...]</span><br><span class="line"></span><br><span class="line">#返回指定字段</span><br><span class="line">User.objects.values(&#39;uname&#39;,&#39;password&#39;)</span><br><span class="line">[&#123;&#39;uname&#39;: &#39;⼩甜甜&#39;, &#39;password&#39;:&#39;59f2443a4317918ce29ad28a14e1bdb7&#39;&#125;,...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>reverse()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User.objects.order_by(&#39;id&#39;).reverse() # 降序</span><br><span class="line">User.objects.order_by(&#39;-id&#39;).reverse() # 升序</span><br></pre></td></tr></table></figure>
</li>
<li><p>distinct() 去重</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.objects.values(&#39;password&#39;).distinct()</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="返回单个值"><a href="#返回单个值" class="headerlink" title="返回单个值"></a>返回单个值</h4><p>下⾯这些方法后⾯不能再跟其他过滤方法，因为他们不返回查询集</p>
<ul>
<li><p>get() 只匹配一条数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">u &#x3D; User.objects.get(pk&#x3D;1)  # 正常</span><br><span class="line">u &#x3D; User.objects.get(uid__gt&#x3D;20)#MultipleObjectsReturned 匹配到了多条数据</span><br><span class="line">u &#x3D; USer.objects.get(uid__lt&#x3D;1)  #DoesNotExist 匹配失败</span><br></pre></td></tr></table></figure>
</li>
<li><p>first()和last()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User.objects.all().first() #返回结果集中第⼀条数据</span><br><span class="line">User.objects.all().last() #返回结果集中最后⼀条数据</span><br></pre></td></tr></table></figure>
</li>
<li><p>count()</p>
<ul>
<li>返回结果集记录数⽬，等价于select count(*)</li>
<li>不会返回整个结果集，相⽐len方法更有效</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.objects.count()</span><br></pre></td></tr></table></figure>
</li>
<li><p>exists()</p>
<ul>
<li><p>判断查询集中是否有记录，有返回True，否则返回False</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.objects.filter(uid&#x3D;3).exists()</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="查询集限制"><a href="#查询集限制" class="headerlink" title="查询集限制"></a>查询集限制</h4><p>查询集类似列表，可以使用下标进行限制，类似sql语句中的limit子句。但索引不能是负数</p>
<ul>
<li>索引</li>
<li>切片</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">User.objects.all()[0] #等同于：limit 0,1</span><br><span class="line">User.objects.all()[2] #等同于：limit 2,1</span><br><span class="line">User.objects.all()[0:2] #等同于limit 2</span><br><span class="line">User.objects.all()[:2] #等同于limit 2</span><br><span class="line">User.objects.all()[::2]</span><br></pre></td></tr></table></figure>

<h4 id="字段查询"><a href="#字段查询" class="headerlink" title="字段查询"></a>字段查询</h4><p>相当于sql语句中where子句，它可以为filter、exclude和get方法提供参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">属性名称__比较运算符&#x3D;值 #是两个下划线</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">操作符</th>
<th align="center">说明</th>
<th align="center">事例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">exact</td>
<td align="center">精确判等</td>
<td align="center">uname = ‘admin’<code>uname__exact = &#39;admin&#39;</code> <code>uname__exact = None</code> #uname is null</td>
</tr>
<tr>
<td align="center">iexact</td>
<td align="center">不区分大小写判等</td>
<td align="center">name__iexact = ‘admin’</td>
</tr>
<tr>
<td align="center">contains</td>
<td align="center">模糊查询，等价like  ‘% 值%’</td>
<td align="center">uname__contains = ‘admin’</td>
</tr>
<tr>
<td align="center">startswith</td>
<td align="center">以..开头</td>
<td align="center">uname__startswith = ‘a’</td>
</tr>
<tr>
<td align="center">istartswith</td>
<td align="center">（不区分大小写)以… 开头</td>
<td align="center">uname__istartswith = ‘a’</td>
</tr>
<tr>
<td align="center">endswith</td>
<td align="center">以…结尾</td>
<td align="center">uname__endswith = ‘m’</td>
</tr>
<tr>
<td align="center">iendswith</td>
<td align="center">（不区分大小写)以…结尾</td>
<td align="center">uname__iendswith = ‘m’</td>
</tr>
<tr>
<td align="center">isnull</td>
<td align="center">判空(等价 = None)</td>
<td align="center">uname__isnull = True #等价于 uname is null</td>
</tr>
<tr>
<td align="center">in</td>
<td align="center">包含</td>
<td align="center">uid__in = [1,2,4] # in后面必须是可迭代对象</td>
</tr>
<tr>
<td align="center">range</td>
<td align="center">范围测试（相当 between and)</td>
<td align="center">uid__range = [2,5] #uid&gt;=2 and uid &lt;=5</td>
</tr>
<tr>
<td align="center">gt/gte</td>
<td align="center">大于/大于等于</td>
<td align="center">uid__gt = 2</td>
</tr>
<tr>
<td align="center">lt/lte</td>
<td align="center">小于/小于等于</td>
<td align="center">uid__lte = 2</td>
</tr>
<tr>
<td align="center">regex</td>
<td align="center">正值匹配</td>
<td align="center">uname__regex= r’^a’</td>
</tr>
<tr>
<td align="center">iregex</td>
<td align="center">不区分大小写正则匹配</td>
<td align="center">uname__iregex= r’^a’</td>
</tr>
</tbody></table>
<ul>
<li><p>in后面可以跟⼀个子查询，但要求子查询只能返回⼀个字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User.objects.filter(uid__in &#x3D; (2,3,4))</span><br><span class="line">User.objects.filter(uid__in &#x3D; [2,3,4])</span><br><span class="line">res &#x3D; User.objects.filter(uid__gt &#x3D; 1).values(&#39;uid&#39;) #查询集中只有⼀个字段uid</span><br><span class="line">User.objects.filter(uid__in &#x3D; res)</span><br></pre></td></tr></table></figure>
</li>
<li><p>日期查询</p>
<ul>
<li><p>year、month、day、week_day、hour、minute、second</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">等价sql: select * from User where year(regtime) &#x3D; 2018</span><br><span class="line">User.objects.filter(regtime__year &#x3D; 2018)</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="统计查询"><a href="#统计查询" class="headerlink" title="统计查询"></a>统计查询</h4><p>需要先导⼊模块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from django.db.models import Max,Min,Sum,Avg,Count</span><br></pre></td></tr></table></figure>

<ul>
<li><p>聚合查询：对多行查询结果的⼀列进行操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#统计记录总数： select count(*) from user</span><br><span class="line">User.objects.aggregate(Count(&#39;uid&#39;)) #&#123;&#39;uid__count&#39;: 4&#125;</span><br><span class="line">User.objects.aggregate(Max(&#39;uid&#39;)) #&#123;&#39;uid__max&#39;: 5&#125;</span><br><span class="line">User.objects.aggregate(Min(&#39;uid&#39;)) # &#123;&#39;uid__min&#39;:2&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>分组统计</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#等价sql: select type,count(*) from user group by type</span><br><span class="line">res &#x3D; User.objects.values(&#39;type&#39;).annotate(Count(&#39;uid&#39;))</span><br><span class="line">#统计结果： [&#123;&#39;type&#39;: &#39;普通用户&#39;, &#39;uid__count&#39;: 3&#125;, &#123;&#39;type&#39;: &#39;超级管理员&#39;, &#39;uid__count&#39;: 1&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看生成的sql语句</span><br><span class="line">print(res.query)</span><br><span class="line">#SELECT &#96;user&#96;.&#96;type&#96;, COUNT(&#96;user&#96;.&#96;uid&#96;) AS &#96;uid__count&#96; FROM &#96;user&#96; GROUP BY &#96;user&#96;.&#96;type&#96; ORDER BY NULL</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Q对象和F对象"><a href="#Q对象和F对象" class="headerlink" title="Q对象和F对象"></a>Q对象和F对象</h4><p>需要先导⼊模块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from django.db.models import Q,F</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Q对象可以对关键字参数进行封装，从而更好的应用多个查询，可以组合&amp;(and)、|(or)、~(not)操作符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#原生sql:select * from user where uid &#x3D; 2 or uid &#x3D; 3</span><br><span class="line">User.objects.filter(Q(uid&#x3D;2)|Q(uid&#x3D;3))</span><br><span class="line">User.objects.filter(Q(uid__gte&#x3D;2) &amp; Q(uid__lte&#x3D;3))</span><br><span class="line">User.objects.filter(~Q(uid__gte&#x3D;2))</span><br></pre></td></tr></table></figure>
</li>
<li><p>F对象：用于比较表中两个字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#等价sql：select * from user where uid &lt; type</span><br><span class="line">User.objects.filter(uid__lte &#x3D; F(&#39;type&#39;))</span><br></pre></td></tr></table></figure>

<h4 id="原始sql"><a href="#原始sql" class="headerlink" title="原始sql"></a>原始sql</h4></li>
</ul>
<p>您可以使用它 <code>Manager.raw()</code>来执行原始查询并返回模型实例，或者您可以完全避免模型层并直接执行⾃定义SQL。</p>
<ul>
<li><p>raw</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">users &#x3D; User.objects.raw(&quot;select * from user&quot;)</span><br><span class="line"># 会造成SQL</span><br><span class="line">users &#x3D; User.objects.raw(&quot;select * from user where username&#x3D;&#39;&#123;&#125;&#39;&quot;.format(&#39;单强&#39;))</span><br><span class="line">print(&quot;select * from user where username&#x3D;&#39;&#123;&#125;&#39;&quot;.format(&#39;单强&#39;))</span><br><span class="line">users &#x3D; User.objects.raw(&quot;select * from user where username&#x3D;&#39;&#123;&#125;&#39;&quot;.format(&#39;单强&#39;))</span><br><span class="line"># 原生SQL使用下面的写法,可以防止SQL注入</span><br><span class="line">users &#x3D; User.objects.raw(&quot;select * from user where username&#x3D;%s&quot;,[&quot;sddfsdf&#39; or &#39;1&quot;])</span><br><span class="line">print(list(users))</span><br><span class="line">print(type(users))</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义sql,聚合使用下面的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from django.db import connection</span><br><span class="line"># with语句相当与cursor&#x3D; connection.cursor() 和 cursor.close(),简化了语</span><br><span class="line">with connection.cursor() as cursor: </span><br><span class="line">     cursor.execute(&quot;UPDATE bar SET foo &#x3D; 1 WHERE baz &#x3D; %s&quot;,[para])</span><br><span class="line">     cursor.execute(&quot;SELECT foo FROM bar WHERE baz &#x3D; %s&quot;, [para2])</span><br><span class="line">     row &#x3D; cursor.fetchone()</span><br><span class="line"># 返回列表套字典</span><br><span class="line">with connection.cursor() as cursor:</span><br><span class="line">    cursor.execute(&quot;select * from publisher&quot;)</span><br><span class="line">    columns &#x3D; [col[0] for col in cursor.description]</span><br><span class="line">    res &#x3D; [dict(zip(columns, row)) for row in cursor.fetchall()]</span><br><span class="line">    print(res)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="模型成员"><a href="#模型成员" class="headerlink" title="模型成员"></a>模型成员</h2><p>模型类和数据库中表对应，模型类的对象和记录对象，模型类本身没有数据库访问功能，但模型类中有⼀个Manager类的对象，通过管理器对象可以实现和数据库的访问。</p>
<p>当我们没有为模型类定义管理器时，Django会为模型类生成⼀个名为objects的管理器，⾃定义管理器后，Django不再生成默认管理器objects</p>
<p>管理器是Django的模型进行数据库操作的接⼝，Django应用的每个模型都拥有⾄少⼀个管理器。Django⽀持⾃定义管理器类，继承⾃models.Manager</p>
<p>⾃定义管理器类主要用于两种情况：</p>
<ul>
<li>修改原始查询集</li>
<li>向管理器类中添加额外的方法，如向数据库中插⼊数据。</li>
</ul>
<h3 id="重命名管理器"><a href="#重命名管理器" class="headerlink" title="重命名管理器"></a>重命名管理器</h3><p>在模型类中⾃定义⼀个新的管理器，则原有的objects管理器不会存在，以后对数据库的操作使用⾃⼰定义的管理器</p>
<p>模型类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class Artical(models.Model):</span><br><span class="line">     aid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line">     title &#x3D; models.CharField(max_length&#x3D;100,null&#x3D;False)</span><br><span class="line">     content &#x3D; models.TextField(max_length&#x3D;10000,null&#x3D;True)</span><br><span class="line">     ....</span><br><span class="line">     art_manager &#x3D; models.Manager() #⾃定义了⼀个新的管理器，名字为art_manager</span><br></pre></td></tr></table></figure>

<p>视图views</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def article_get(request):</span><br><span class="line">    articles &#x3D; Artical.art_manager.all() #使用art_manager进行查询</span><br><span class="line">    return render(request,&quot;articlelist.html&quot;,context&#x3D;&#123;&#39;articls&#39;:articles&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="⾃定义管理器"><a href="#⾃定义管理器" class="headerlink" title="⾃定义管理器"></a>⾃定义管理器</h3><ul>
<li><p>修改原始查询集（由<code>all()</code>获取的查询集）</p>
<ul>
<li>修改管理器的<code>get_queryset</code>方法，可以改变all方法返回的原始查询集</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#⾸先⾃定义Manager的子类</span><br><span class="line">class ArticleManager(models.Manager):</span><br><span class="line"> def get_queryset(self):</span><br><span class="line">    return super().get_queryset().filter(ispublished&#x3D;True) #获取已发表的⽂章</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#模型类</span><br><span class="line">class Artical(models.Model):</span><br><span class="line">    ....</span><br><span class="line">    objects &#x3D; models.Manager() #可以有多个管理器</span><br><span class="line">    publishManager &#x3D; ArticleManager()</span><br><span class="line"> </span><br><span class="line"># 视图views</span><br><span class="line">def article_publish(request):</span><br><span class="line">    published &#x3D; Artical.publishManager.all()</span><br><span class="line">    return HttpResponse(&quot;已经发表&#123;&#125;&quot;.format(published[0].title))</span><br></pre></td></tr></table></figure>
</li>
<li><p>给管理器类中添加额外的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">class ArticleManager(models.Manager):</span><br><span class="line">    def get_queryset(self):</span><br><span class="line">    	return super().get_queryset().filter(ispublished&#x3D;True)</span><br><span class="line"></span><br><span class="line">    #新增⼀个创建对象的方法</span><br><span class="line">    def create(self,title,content,publishingdate,comments,likenum,ispublished):</span><br><span class="line">        article &#x3D; Artical()</span><br><span class="line">        article.title &#x3D; title</span><br><span class="line">        article.content &#x3D; content</span><br><span class="line">        article.publishingdate &#x3D; publishingdate</span><br><span class="line">        article.comments &#x3D; comments</span><br><span class="line">        article.likenum &#x3D; likenum</span><br><span class="line">        article.ispublished &#x3D; ispublished</span><br><span class="line">        article.save()</span><br><span class="line">        return article</span><br><span class="line">    </span><br><span class="line">#views.py中</span><br><span class="line">def article_add(request):</span><br><span class="line">    # art &#x3D; Artical(title&#x3D;&#39;⼩时代&#39;,content&#x3D;&quot;混乱的逻辑&quot;)</span><br><span class="line">    # art.save()</span><br><span class="line">    Artical.publishManager.create(&#39;中美贸易战&#39;,&#39;川朴⼀⾖⽐&#39;,&#39;2018-10-8&#39;,0,0,1)</span><br><span class="line">    return HttpResponse(&quot;&quot;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="模型对应关系"><a href="#模型对应关系" class="headerlink" title="模型对应关系"></a>模型对应关系</h2><p>关系数据库最强⼤的地方在于“关系”，也即表和表之间是有关联的，这种关联有三种类型</p>
<ul>
<li>⼀对⼀</li>
<li>⼀对多</li>
<li>多对多</li>
</ul>
<h3 id="⼀对⼀"><a href="#⼀对⼀" class="headerlink" title="⼀对⼀"></a>⼀对⼀</h3><p>⼀个学生有⼀个档案，⼀个档案属于⼀个学生，那么学生表和档案表就是⼀对⼀关系。学生表是主表，档案表是从表，从表中有⼀个外键和学生表关联，并且要求外键取值唯⼀。对应关键字为：<code>OneToOneField</code></p>
<p>模型类<code>Student</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    sno = models.CharField(max_length=<span class="number">6</span>,primary_key=<span class="literal">True</span>)</span><br><span class="line">    sname = models.CharField(max_length=<span class="number">100</span>,null=<span class="literal">False</span>)</span><br><span class="line">    ssex = models.CharField(max_length=<span class="number">2</span>,default=<span class="string">'男'</span>,null=<span class="literal">True</span>)</span><br><span class="line">    sage = models.IntegerField(null=<span class="literal">True</span>)</span><br><span class="line">    sclass = models.CharField(max_length=<span class="number">10</span>,null=<span class="literal">True</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> <span class="string">"no:&#123;&#125;,name:&#123;&#125;"</span>.format(self.sno,self.sname)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">   		db_table = <span class="string">'student'</span></span><br></pre></td></tr></table></figure>

<p>模型类<code>Archives</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Archives</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    idcard = models.CharField(max_length=<span class="number">18</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    address = models.CharField(max_length=<span class="number">200</span>,null=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># on_delete=models.CASCADE 级联删除，删除学生会连同档案⼀块删除</span></span><br><span class="line">    student = models.OneToOneField(Student, on_delete=models.CASCADE)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> <span class="string">"&#123;&#125;,&#123;&#125;"</span>.format(self.idcard,self.address)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">   		db_table = <span class="string">'archives'</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>增加数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addstudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    student = Student()</span><br><span class="line">    student.sno = <span class="string">'180502'</span></span><br><span class="line">    student.sname = <span class="string">'杨康'</span></span><br><span class="line">    student.sage = <span class="number">22</span></span><br><span class="line">    student.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"增加了⼀个学生"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addarchives</span><span class="params">(request)</span>:</span></span><br><span class="line">    stu = Student.objects.get(pk=<span class="string">'180503'</span>)</span><br><span class="line">    arc = Archives()</span><br><span class="line">    arc.idcard = <span class="string">'130098384893838953'</span></span><br><span class="line">    arc.student = stu <span class="comment">#学生对象必须已经保存到数据库，否则错误</span></span><br><span class="line">    arc.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"增加档案"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deletestudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    student = Student.objects.get(pk=<span class="string">'180503'</span>)</span><br><span class="line">    student.delete()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"删除学生"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>正向查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findstudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 获取学生信息</span></span><br><span class="line">    student = Student.objects.first()</span><br><span class="line">    print(student)</span><br><span class="line">    <span class="comment"># 通过学生对象获取档案信息</span></span><br><span class="line">    archive = student.archives</span><br><span class="line">    print(archive)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(student)</span><br></pre></td></tr></table></figure>
</li>
<li><p>反向查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findarchives</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment">#获取档案记录</span></span><br><span class="line">    archive = Archives.objects.first()</span><br><span class="line">    <span class="comment">#通过档案获取关联学生信息</span></span><br><span class="line">    student = archive.student</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(student)</span><br></pre></td></tr></table></figure>
</li>
<li><p>跨关系查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lookup</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment">#根据档案查学生</span></span><br><span class="line">    <span class="comment"># student = Student.objects.get(archives__pk=1)</span></span><br><span class="line">    student =Student.objects.get(archives__idcard=<span class="string">'13009488384383838'</span>)</span><br><span class="line">    <span class="comment">#根据学生查档案</span></span><br><span class="line">    archive = Archives.objects.get(student__sno=<span class="string">'180501'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(archive)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>on_delete</code></p>
<ul>
<li>CASECADE 默认，默认级联删除数据 </li>
<li>PROTECT 保护模式，当从表中存在级联记录的时候，删除主表记录会抛出保护异常，从表中不存在级联数据的时候.是允许删除的</li>
<li>SET_XXX<ul>
<li>NULL 外键字段本身必须允许为空</li>
<li>DEFAULT 外键字段本身有默认值</li>
</ul>
</li>
<li>DO_NOTHING 什么都不做</li>
</ul>
</li>
</ul>
<h3 id="⼀对多"><a href="#⼀对多" class="headerlink" title="⼀对多"></a>⼀对多</h3><p>⼀个出版社可以出版多本书，⼀本书只能被⼀个出版社出版。出版社和图书表属于⼀对多，⼀对多⼀般将主表中的主键并到从表中做外键。在模型中用<code>ForeignKey</code>表示多对⼀</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Publisher</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    pname = models.CharField(max_length=<span class="number">100</span>,null=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.pname</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line"> 		db_table = <span class="string">'publisher'</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    bname = models.CharField(max_length=<span class="number">200</span>,null=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment">#多对⼀模型通过ForeignKey表示多对⼀</span></span><br><span class="line">    <span class="comment">#如果publisher定义在book之后，第⼀个参数应该用字符串'Publisher'</span></span><br><span class="line">    publisher = models.ForeignKey(Publisher,on_delete=models.CASCADE,</span><br><span class="line">                                  null=<span class="literal">True</span>,</span><br><span class="line">                                  db_column=<span class="string">'pid'</span>, <span class="comment">#表中字段名</span></span><br><span class="line">                                  related_name=<span class="string">'books'</span>) <span class="comment">#通过出版社查图书时使用的关系名</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.bname</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'book'</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>增加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pub = Publisher.objects.first()</span><br><span class="line">pub.books.create(bname=<span class="string">'红岩'</span>)</span><br><span class="line">book = Book.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">pub.books.add(book) <span class="comment">#book必须已经保存到数据库</span></span><br><span class="line">books = Book.objects.filter(pk__lt=<span class="number">5</span>)</span><br><span class="line">pub.books.bulk_create(list(books))</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除和更新</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pub = Publisher.objects.first()</span><br><span class="line">pub.books.all().delete() <span class="comment">#删除出版社出版的所有图书</span></span><br><span class="line">pub.books.all().update(bname=<span class="string">'ddd'</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>正向查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findpublisher</span><span class="params">(req)</span>:</span></span><br><span class="line">    pub = Publisher.objects.first()</span><br><span class="line">    print(pub)</span><br><span class="line">    <span class="comment"># pub = Publisher()</span></span><br><span class="line">    book = pub.book_set.all()</span><br><span class="line">    print(book)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询出版社"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>反向查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findbook</span><span class="params">(req)</span>:</span></span><br><span class="line">    book = Book.objects.first()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(book.publisher.pname)</span><br></pre></td></tr></table></figure>
</li>
<li><p>跨关系查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loopup</span><span class="params">(req)</span>:</span></span><br><span class="line">    <span class="comment"># 根据图书获取出版社</span></span><br><span class="line">    pub = Publisher.objects.get(book__bname=<span class="string">'花样年华927937'</span>)</span><br><span class="line">    print(pub)</span><br><span class="line">    <span class="comment"># 根据出版社获取图书</span></span><br><span class="line">    books = Book.objects.filter(publisher__pname=<span class="string">'科技出版社5829'</span>)</span><br><span class="line">    print(books)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"跨关系查询"</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><p>⼀个买家可以购买多件商品，⼀件商品可以被多个买家购买，买家和商品之间构成多对多关系，多对多关系必然会生成⼀张中间表：买家-商品表，记录商品和买家的关系，该表包含商品表主键和买家表的主键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line"># Create your models here.</span><br><span class="line">class Buyer(models.Model):</span><br><span class="line">    bname &#x3D; models.CharField(max_length&#x3D;30)</span><br><span class="line">    level &#x3D; models.IntegerField(default&#x3D;1)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Goods(models.Model):</span><br><span class="line">    gname &#x3D; models.CharField(max_length&#x3D;100)</span><br><span class="line">    price &#x3D; models.FloatField()</span><br><span class="line">    buyer &#x3D; models.ManyToManyField(Buyer) #这种写法⾃动生成第三张表，但我们无法直接控制</span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.gname +&quot; &quot;+ str(self.price)</span><br><span class="line"></span><br><span class="line">#手动创建中间表</span><br><span class="line">class Orders(models.Model):</span><br><span class="line">    buyer &#x3D; models.ForeignKey(Buyer,on_delete&#x3D;models.CASCADE,db_column&#x3D;&#39;bid&#39;)</span><br><span class="line">    goods &#x3D; models.ForeignKey(&#39;Goods&#39;,on_delete&#x3D;models.CASCADE,db_column&#x3D;&#39;gid&#39;)</span><br><span class="line">    num &#x3D; models.Integer(default&#x3D;1)</span><br><span class="line"></span><br><span class="line">class Goods(models.Model):</span><br><span class="line">    gname &#x3D; models.CharField(max_length&#x3D;100)</span><br><span class="line">    price &#x3D; models.FloatField()</span><br><span class="line">    buyer &#x3D; models.ManyToManyField(Buyer,through&#x3D;&#39;Orders&#39;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>购买商品</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def sellgoods(req):</span><br><span class="line">    goods &#x3D; Goods.objects.get(pk&#x3D;randint(1,Goods.objects.count())</span><br><span class="line">    goods.buyer.add(Buyer.objects.get(pk&#x3D;randint(1,Buyer.objects.count())))</span><br><span class="line">    goods.save()</span><br><span class="line">    return HttpResponse(&quot;剁⼿成功&quot;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除商品</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">buyer &#x3D; Buyer.objects.get(pk&#x3D;13)</span><br><span class="line">goods &#x3D; Goods.objects.filter(pk__lt&#x3D;10)</span><br><span class="line">buyer.goods_set.clear() #删除所有商品</span><br><span class="line">buyer.goods_set.remove(Goods.objects.get(pk&#x3D;2)) #删除指定商品</span><br></pre></td></tr></table></figure>
</li>
<li><p>正向查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def findgoods_by_buyer(req):</span><br><span class="line">    buyer &#x3D; Buyer.objects.get(pk&#x3D;13)</span><br><span class="line">    res &#x3D; buyer.goods_set.all()</span><br><span class="line">    print(res)</span><br><span class="line">    return HttpResponse(&quot;由买家查询商品&quot;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>反向查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def findbuyer_by_goods(request):</span><br><span class="line">    goods &#x3D; Goods.objects.last()</span><br><span class="line">    buyer &#x3D; goods.buyer.all()</span><br><span class="line">    print(buyer)</span><br><span class="line">    return HttpResponse(&quot;由商品查询买家&quot;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="模型继承"><a href="#模型继承" class="headerlink" title="模型继承"></a>模型继承</h2><p>django中的数据库模块提供了⼀个⾮常不错的功能，就是⽀持models的⾯向对象，可以在models中添加Meta，指定是否抽象，然后进行继承</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    xxx</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    	abstract = <span class="literal">True</span>/<span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(Animal)</span>:</span></span><br><span class="line">	xxx</span><br></pre></td></tr></table></figure>

<p>默认模型就是允许继承的，但是默认的继承处理方式不是很合理:</p>
<ul>
<li>默认在⽗类中定义的字段会存在⽗类的表中，子类的数据通用部分会存在⽗表中，子类特有数据会在子表中，子类通过外键进行级联</li>
<li>默认方式比较垃圾，效率⽐较低</li>
</ul>
<p>开发中，需要将⽗类抽象化，在元信息中使用abstract=True</p>
<ul>
<li>抽象化的父类不会再数据库生成表了</li>
<li>子类会将父类中的通用数据，复制到子表中</li>
</ul>
<h1 id="Django-模板-T"><a href="#Django-模板-T" class="headerlink" title="Django 模板(T)"></a>Django 模板(T)</h1><p>模板用于快速生成动态⻚⾯返回给客户端，模板是⼀个⽂本，用于分离⽂档的表现形式和内容。 模板定义了占位符以及各种用于规范⽂档该如何显示的模板标签。模板通常用于产生HTML，但是Django的模板也能产生任何基于⽂本格式的⽂档。 </p>
<p>模板包含两部分：</p>
<ul>
<li>html代码</li>
<li>模板标签</li>
</ul>
<h2 id="一、模板位置"><a href="#一、模板位置" class="headerlink" title="一、模板位置"></a>一、模板位置</h2><ul>
<li><p>在应用中建⽴templates⽬录，好处不需要注册，不好的地方，有多个应用的时候不能复用⻚⾯</p>
</li>
<li><p>第⼆种是放在⼯程的⽬录下，好处是如果有多个应用，可以调用相同的⻚⾯，需要注册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES &#x3D; [</span><br><span class="line"> &#123;</span><br><span class="line">    &#39;BACKEND&#39;:</span><br><span class="line">    &#39;django.template.backends.django.DjangoTemplates&#39;,</span><br><span class="line">    &#39;DIRS&#39;: [os.path.join(BASE_DIR, &#39;templates&#39;)], #模板绝对路径</span><br><span class="line">    &#39;APP_DIRS&#39;: True, #是否在应用⽬录下查找模板⽂件</span><br><span class="line">    &#39;OPTIONS&#39;: &#123;</span><br><span class="line">        &#39;context_processors&#39;: [</span><br><span class="line">        &#39;django.template.context_processors.debug&#39;,</span><br><span class="line">        &#39;django.template.context_processors.request&#39;,</span><br><span class="line">        &#39;django.contrib.auth.context_processors.auth&#39;,</span><br><span class="line">        &#39;django.contrib.messages.context_processors.messages&#39;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line"> &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>Django 模板查找机制： Django 查找模板的过程是在每个 app 的 templates⽂件夹中找（行不只是当前 app 中的代码只在当前的 app 的 templates ⽂件夹中找）。各个 app 的 templates 形成⼀个⽂件夹列表，Django 遍历这个列 </p>
<p>表，⼀个个⽂件夹进行查找，当在某⼀个⽂件夹找到的时候就停⽌，所有的都遍历完了还找不到指定的模板的时候就是 Template Not Found （过程类似于Python找包）。这样设计有利当然也有弊，有利是的地方是⼀个app可以用另⼀个app的模板⽂件，弊是有可能会找错了。所以我们使用的时候在templates 中建⽴⼀个 app 同名的⽂件夹，这样就好了。</p>
<h2 id="二、模板的渲染"><a href="#二、模板的渲染" class="headerlink" title="二、模板的渲染"></a>二、模板的渲染</h2><h3 id="loader加载"><a href="#loader加载" class="headerlink" title="loader加载"></a>loader加载</h3><p>好处是可以加载⼀次模板，然后进行多次渲染</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from django.template import loader #导⼊loader</span><br><span class="line">def index(request):</span><br><span class="line">    temp &#x3D; loader.get_template(&#39;index.html&#39;)</span><br><span class="line">    print(temp.__dict__)</span><br><span class="line">    # 渲染模板，生出html源码</span><br><span class="line">    res &#x3D; temp.render(context&#x3D;&#123;&#39;content&#39;:&#39;hello index&#39;&#125;)</span><br><span class="line">    print(res)</span><br><span class="line">    return HttpResponse(res)</span><br></pre></td></tr></table></figure>

<h3 id="render加载"><a href="#render加载" class="headerlink" title="render加载"></a>render加载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from django.shortcuts import render</span><br><span class="line">render(request,templatesname,context&#x3D;None)</span><br><span class="line">参数：</span><br><span class="line"> request： 请求对象</span><br><span class="line"> templatesname：模板名称</span><br><span class="line"> context：参数字典，必须是字典</span><br></pre></td></tr></table></figure>

<p>##三、模板语法</p>
<p>django模板中包括两部分：变量和内置标签。变量会在模板渲染时被其值代替，内置标签负责逻辑控制</p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>变量在模板中的表示为：<code></code>，变量名就是render中context中的键。变量可以基本类型中的数值、字符串、布尔，也可以是字典、对象、列表等。django提供了点号来访问复杂数据结构。</p>
<ul>
<li>列表、元组的元素可以使用索引引用，不能使用负索引，语法：变量.索引</li>
<li>字典： 字典变量.key</li>
<li>对象： 对象.属性 对象.方法名（方法不能有参数）</li>
</ul>
<p>当模板系统在变量名中遇到点时，按照以下顺序尝试进行查找</p>
<ul>
<li><p>字典类型查找</p>
</li>
<li><p>属性查找</p>
</li>
<li><p>方法调用</p>
</li>
<li><p>列表类型索引</p>
</li>
</ul>
<p>如果模板中引用变量未传值，则会被置为空，不会报错，除⾮你对其进行了操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def handle_var(request):</span><br><span class="line">    num &#x3D; 10</span><br><span class="line">    name &#x3D; &quot;伟大的意大利左后卫&quot;</span><br><span class="line">    students &#x3D; [10,20,30,[50,60]]</span><br><span class="line">    student &#x3D; &#123;&#39;name&#39;:&#39;马尔蒂尼&#39;,&#39;age&#39;:30&#125;</span><br><span class="line">    # locals(): 返回包含当前范围的局部变量的字典。</span><br><span class="line">    return render(request,&quot;变量.html&quot;,locals())</span><br><span class="line">      </span><br><span class="line">    </span><br><span class="line">&#123;# 变量  #&#125;</span><br><span class="line">&#123;# 复杂类型的访问可以使用点，但不能使用下标 #&#125;</span><br><span class="line">&#123;&#123; num &#125;&#125;</span><br><span class="line">&#123;&#123; name &#125;&#125;</span><br><span class="line">&#123;#   --&#123;&#123; students[1] &#125;&#125;  不能使用下标 #&#125;</span><br><span class="line">&#123;&#123; students.0 &#125;&#125;----&#123;&#123; students.3.0 &#125;&#125;</span><br><span class="line">&#123;&#123; student.name &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><p>过滤器是在变量显示之前修改它的值的⼀个方法，过滤器使用管道符。过滤器可以串联调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; 变量|方法&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>常见的过滤器方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">|     方法名      |            作用             |                       示例                        |</span><br><span class="line">|     default     |           缺省值            |            &#123;&#123; li|default:&quot;缺省值&quot; &#125;&#125;           </span><br><span class="line">| default_if_none | 如果变量是none 则显示缺省值 |       &#123;&#123; value|default_if_none:&#39;hello&#39; &#125;&#125;        |</span><br><span class="line">|       cut       |    从字符中删除指定字符     |     &#123;&#123; value | cut:&#39; &#39; &#125;&#125; 删除value所有空格      |</span><br><span class="line">|     length      |   获取字符串或列表的⻓度    |                 &#123;&#123; str1\|length&#125;&#125;                 |</span><br><span class="line">|      lower      |    将所有字⺟都变为⼩写     |                                                   |</span><br><span class="line">|      upper      |    将所有字⺟都变为⼤写     |                                                   |</span><br><span class="line">|  truncatechars  |     截取字符串前n个字符     |           &#123;&#123; value|truncatechars:9 &#125;&#125;            |</span><br><span class="line">|      date       |      格式化⽇期字符串       |          &#123;&#123;value|date:&quot;Y-m-d H:i:s&quot;  &#125;&#125;          |</span><br><span class="line">|       add       |        增加变量的值         |                 &#123;&#123; num|add:&#39;3&#39;&#125;&#125;                 |</span><br><span class="line">|   divisibleby   |    把变量的值除以指定值     |           &#123;&#123; value|divisibleby:&quot;3&quot; &#125;&#125;            |</span><br><span class="line">|      first      |     获取列表第一个元素      |                &#123;&#123; value|first &#125;&#125;                 |</span><br><span class="line">|      last       |    获取列表最后一个元素     |                                                   |</span><br><span class="line">|      join       | 将列表内容连接为一个字符串  |               &#123;&#123; value|join:&#39;-&#39; &#125;&#125;               |</span><br><span class="line">|   autoescape    |       设置或取消转译        | &#123;% autoescape off %&#125;&#123;&#123; data &#125;&#125;&#123;% endautoescape %&#125; |</span><br></pre></td></tr></table></figure>





<h4 id="⾃定义过滤器"><a href="#⾃定义过滤器" class="headerlink" title="⾃定义过滤器"></a>⾃定义过滤器</h4><p>内置过滤器功能有限，如果不能满足需求，可以自己定义过滤器。</p>
<ul>
<li><p>在app里创建⼀个包：templatetags</p>
</li>
<li><p>在包里创建⼀个py⽂件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from django import template</span><br><span class="line"># 实例化⾃定义过滤器注册对象</span><br><span class="line">register &#x3D; template.Library()</span><br><span class="line"># name代表在模板中使用的过滤器的名称</span><br><span class="line">@register.filter(name&#x3D;&#39;hello&#39;)</span><br><span class="line">def hello(value,arg):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    :param value: 传给hello过滤的值</span><br><span class="line">    :param arg: hello自带的参数</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">	return value + str(arg)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在模板中使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load customfilter %&#125; #加载自定义过滤器的模块</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"> &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line"> &lt;title&gt;Title&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&#123;&#123; name |hello:&#39; how are you&#39; &#125;&#125; #使用自定义过滤器</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="内置标签"><a href="#内置标签" class="headerlink" title="内置标签"></a>内置标签</h3><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% tag %&#125;</span><br></pre></td></tr></table></figure>

<h4 id="if标签"><a href="#if标签" class="headerlink" title="if标签"></a>if标签</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if express1 %&#125;</span><br><span class="line"> # to do</span><br><span class="line">&#123;% elif express2 %&#125;</span><br><span class="line"> # to do</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line"> # to do</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>if表达式中使用以下运算符（优先级从高到低）：<ul>
<li>&lt; &gt;= &lt;= == !=</li>
<li>in 、not in</li>
<li>is、is not</li>
<li>not</li>
<li>and</li>
<li>or</li>
</ul>
</li>
<li>不要在表达式中使用（），可以使用if嵌套实现功能</li>
<li>不⽀持 if 3 &lt; b &lt; 5这种写法</li>
</ul>
<h4 id="for"><a href="#for" class="headerlink" title="for"></a>for</h4><p>遍历可迭代对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for x in y %&#125;</span><br><span class="line"> ...</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>反向迭代(reversed)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for value in c [1,2,3,4,5] reversed %&#125;</span><br><span class="line"> &lt;span&gt;&#123;&#123; value &#125;&#125;---&lt;&#x2F;span&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>empty 当可迭代对象为空或不存在时执行，否则不执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for value in c %&#125;</span><br><span class="line"> &lt;span&gt;&#123;&#123; value &#125;&#125;---&lt;&#x2F;span&gt;</span><br><span class="line">&#123;% empty %&#125;</span><br><span class="line"> 数据不存在</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>字典迭代</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># e &#x3D; &#123;&#39;a1&#39;:20,&#39;b1&#39;:40&#125;</span><br><span class="line">&#123;% for k,v in e.items %&#125;</span><br><span class="line"> &lt;div&gt;&#123;&#123; k &#125;&#125;---&#123;&#123; v &#125;&#125;&lt;&#x2F;div&gt;</span><br><span class="line">&#123;% endfor%&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取for循环迭代的状态</p>
<table>
<thead>
<tr>
<th align="center">变量名称</th>
<th align="center">变量说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">forloop.counter</td>
<td align="center">获取迭代的索引 从1开始</td>
</tr>
<tr>
<td align="center">forloop.counter0</td>
<td align="center">获取迭代的索引 从0开始</td>
</tr>
<tr>
<td align="center">forloop.revcounter</td>
<td align="center">迭代的索引从最⼤递减到1</td>
</tr>
<tr>
<td align="center">forloop.revcounter0</td>
<td align="center">迭代的索引从最⼤递减到0</td>
</tr>
<tr>
<td align="center">forloop.first</td>
<td align="center">是否为第⼀次迭代</td>
</tr>
<tr>
<td align="center">forloop.last</td>
<td align="center">是否为最后⼀次迭代</td>
</tr>
<tr>
<td align="center">forloop.parentloop</td>
<td align="center">获取上层的迭代对象</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for i in c %&#125;</span><br><span class="line"> &lt;li&gt;&#123;&#123; forloop.first &#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line"> &lt;li&gt;&#123;&#123; forloop.last &#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line"> &lt;li&gt;&#123;&#123; forloop.counter &#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line"> &lt;li&gt;&#123;&#123; forloop.counter0 &#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line"> &lt;li&gt;&#123;&#123; forloop.revcounter &#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line"> &lt;li&gt;&#123;&#123; forloop.revcounter0 &#125;&#125;&lt;&#x2F;li&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="ifequal-ifnotequal"><a href="#ifequal-ifnotequal" class="headerlink" title="ifequal/ifnotequal"></a>ifequal/ifnotequal</h4><p>用于判断两个值相等或不等的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% ifequal var var %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endifequal %&#125;</span><br><span class="line">&#123;% ifnotequal var var %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endifnotequal %&#125;</span><br></pre></td></tr></table></figure>

<h4 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h4><p>单行注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;# 注释的内容 #&#125;</span><br></pre></td></tr></table></figure>

<p>多行注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% comment %&#125;</span><br><span class="line"> ...</span><br><span class="line">&#123;% endcomment %&#125;</span><br></pre></td></tr></table></figure>

<h4 id="跨站请求伪造-csrf"><a href="#跨站请求伪造-csrf" class="headerlink" title="跨站请求伪造 csrf"></a>跨站请求伪造 csrf</h4><p>防⽌⽹站受第三方服务器的恶意攻击（确定表单到底是不是本⽹站的表单传递过来的）。csrf相当于在表达中增加了⼀个隐藏的input框，用于向服务器提交⼀个唯⼀的随机字符串用于服务器验证表单是否是本服务器的表单。</p>
<p>使用：</p>
<p>settings.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE &#x3D; [</span><br><span class="line"> &#39;django.middleware.csrf.CsrfViewMiddleware&#39;, </span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>

<p>表单⾥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action&#x3D;&quot;&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line"> &#123;% csrf_token %&#125;</span><br><span class="line"> &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;username&quot;&gt;</span><br><span class="line"> &lt;p&gt;&lt;input type&#x3D;&quot;submit&quot;&gt;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>全局禁用csrf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#在settings中设置</span><br><span class="line">MIDDLEWARE &#x3D; [</span><br><span class="line"> &#39;django.middleware.security.SecurityMiddleware&#39;,</span><br><span class="line"> &#39;django.contrib.sessions.middleware.SessionMiddleware&#39;,</span><br><span class="line"> &#39;django.middleware.common.CommonMiddleware&#39;,</span><br><span class="line"> #&#39;django.middleware.csrf.CsrfViewMiddleware&#39;,</span><br><span class="line"> &#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;,</span><br><span class="line"> &#39;django.contrib.messages.middleware.MessageMiddleware&#39;,</span><br><span class="line"> &#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>局部禁用csrf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#在不想检验csrf的视图函数前添加装饰器@csrf_exempt。</span><br><span class="line">from django.views.decorators.csrf import csrf_exempt,csrf_protect</span><br><span class="line">@csrf_exempt</span><br><span class="line">def csrf1(request):</span><br><span class="line"> pass</span><br></pre></td></tr></table></figure>
</li>
<li><p>ajax验证csrf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Ajax提交数据时候，携带CSRF：</span><br><span class="line">a. 放置在data中携带</span><br><span class="line">&lt;form method&#x3D;&quot;POST&quot; action&#x3D;&quot;&#x2F;csrf1.html&quot;&gt;</span><br><span class="line">     &#123;% csrf_token %&#125;</span><br><span class="line">     &lt;input id&#x3D;&quot;username&quot; type&#x3D;&quot;text&quot; name&#x3D;&quot;username&quot; &#x2F;&gt;</span><br><span class="line">     &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;提交&quot;&#x2F;&gt;</span><br><span class="line">     &lt;a onclick&#x3D;&quot;submitForm();&quot;&gt;Ajax提交&lt;&#x2F;a&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;&#x2F;static&#x2F;jquery-1.12.4.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"> function submitForm()&#123;</span><br><span class="line">     var csrf &#x3D; $(&#39;input[name&#x3D;&quot;csrfmiddlewaretoken&quot;]&#39;).val();</span><br><span class="line">     var user &#x3D; $(&#39;#user&#39;).val();</span><br><span class="line">     $.ajax(&#123;</span><br><span class="line">         url: &#39;&#x2F;csrf1.html&#39;,</span><br><span class="line">         type: &#39;POST&#39;,</span><br><span class="line">         data: &#123; &quot;user&quot;:user,&#39;csrfmiddlewaretoken&#39;: csrf&#125;,</span><br><span class="line">         success:function(arg)&#123;</span><br><span class="line">             console.log(arg);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line"> &#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong>csrf的意义在于给每⼀个表单都设置⼀个唯⼀的csrf的值并且cookie也存储⼀份当提交表单过来的时候判断cookie中的值和csrf_token中的值是否都为本⽹站生成的如果验证通过则提交否则403</p>
</li>
</ul>
<h4 id="模板导⼊标签（-include）"><a href="#模板导⼊标签（-include）" class="headerlink" title="模板导⼊标签（ include）"></a>模板导⼊标签（ include）</h4><p>可以把指定html⽂件代码导⼊到当前⽂件，实现模板代码的复用/重用。语法格 式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include &#39;路径&#x2F;xxx.html&#39; %&#125;</span><br></pre></td></tr></table></figure>

<h4 id="url标签"><a href="#url标签" class="headerlink" title="url标签"></a>url标签</h4><p>在模板中url标签可用于反向解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;&lt;a href&#x3D;&quot;&#123;% url &#39;App:index&#39; %&#125;&quot;&gt;动态生成路由地址不带参的跳转&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h2&gt;&lt;a href&#x3D;&quot;&#123;% url &#39;App:args1&#39; 1 2 %&#125;&quot;&gt;动态生成路由地址带参的跳转&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h2&gt;&lt;a href&#x3D;&quot;&#123;% url &#39;App:args1&#39; num1&#x3D;1 num2&#x3D;2 %&#125;&quot;&gt;动态生成路由地址带关键字参数的跳转&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br></pre></td></tr></table></figure>

<h2 id="四、模板继承"><a href="#四、模板继承" class="headerlink" title="四、模板继承"></a>四、模板继承</h2><p>在整个⽹站中，如何减少共用⻚⾯区域（比如站点导航）所引起的重复和冗余代码？Django 解决此类问题的⾸选方法是使用⼀种优雅的策略—— 模板继承 。</p>
<p>本质上来说，模板继承就是先构造⼀个基础框架模板，行后在其子模板中对它所包含站点公用部分和定义块进行重载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends %&#125;继承父模板</span><br><span class="line">&#123;% block %&#125;子模板可以重载这部分内容</span><br><span class="line">&#123;&#123;block.super&#125;&#125;调用父模板的代码</span><br></pre></td></tr></table></figure>

<p>使用继承的⼀种常⻅方式是下⾯的三层法</p>
<ul>
<li>创建base.html模板，在其中定义站点的主要外观感受。这些都是不常修改甚⾄从不修改的部分。</li>
<li>为每种类型的⻚⾯创建独⽴的模板，例如论坛⻚⾯或者图⽚库。这些模板拓展相应的区域模板</li>
<li>⾃⼰的⻚⾯继承⾃模板，覆盖⽗模板中指定block</li>
</ul>
<p>注意事项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 如果在模板中使用 &#123;% extends %&#125; ，必须保证其为模板中的第⼀个模板标记。否则，模板继承将不起作用</span><br><span class="line">2. ⼀般来说，基础模板中的 &#123;% block %&#125; 标签越多越好。</span><br><span class="line">3. 如果发觉⾃⼰在多个模板之间有重复代码，你应该考虑将该代码放置到⽗模板的某个 &#123;% block %&#125; 中。</span><br><span class="line">4. 不在同⼀个模板中定义多个同名的 &#123;% block %&#125; 。</span><br><span class="line">5. 多数情况下， &#123;% extends %&#125; 的参数应该是字符，但是如果直到运行时方能确定⽗模板名称，这个参数也 可以是个变量。</span><br></pre></td></tr></table></figure>

<h2 id="五、静态资源配置"><a href="#五、静态资源配置" class="headerlink" title="五、静态资源配置"></a>五、静态资源配置</h2><blockquote>
<p>什么是静态资源：css、js、images 需要从外部导⼊的资源</p>
</blockquote>
<ol>
<li><p>创建static⽂件夹（通常放在根⽬录下)</p>
</li>
<li><p>需要在settings注册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL &#x3D; &#39;&#x2F;static&#x2F;&#39;</span><br><span class="line">STATICFILES_DIRS &#x3D; [</span><br><span class="line"> os.path.join(BASE_DIR, &#39;static&#39;),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>在模板中使用静态资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125; #放置到模板开头</span><br><span class="line">&lt;img src&#x3D;&quot;&#x2F;static&#x2F;img&#x2F;img.jpeg&quot; alt&#x3D;&quot;&quot;&gt; #硬编码</span><br><span class="line">&lt;img src&#x3D;&quot;&#123;% static &#39;img&#x2F;img.jpeg&#39; %&#125;&quot; alt&#x3D;&quot;&quot;&gt; #动态写法，建议用这种</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="六、jinja2模板引擎配置"><a href="#六、jinja2模板引擎配置" class="headerlink" title="六、jinja2模板引擎配置"></a>六、jinja2模板引擎配置</h2><ul>
<li><p>安装jinja2模板引擎</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jinja2</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置jinja2环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 在应用⽬录下，创建jinja2_env.py配置⽂件</span><br><span class="line">from django.contrib.staticfiles.storage import staticfiles_storage</span><br><span class="line">from django.urls import reverse</span><br><span class="line">from jinja2 import Environment</span><br><span class="line">def environment(**options):</span><br><span class="line">     env &#x3D; Environment(**options)</span><br><span class="line">     env.globals.update(&#123;</span><br><span class="line">     &#39;static&#39;: staticfiles_storage.url,</span><br><span class="line">     &#39;url&#39;: reverse,</span><br><span class="line"> 	&#125;)</span><br><span class="line"> 	return env</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置（setting.py）</p>
<ul>
<li><p>独⽴使用jinja2，不使用Django模板引擎</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#独⽴使用jinja2</span></span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">     <span class="comment">#'django.contrib.admin', # 注释了admin</span></span><br><span class="line">     .....</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#模板配置</span></span><br><span class="line">TEMPLATES = [&#123;</span><br><span class="line"> <span class="string">'BACKEND'</span>:<span class="string">'django.template.backends.jinja2.Jinja2'</span>,<span class="comment">#jinja2模版</span></span><br><span class="line"> <span class="string">'DIRS'</span>: [</span><br><span class="line">	 os.path.join(BASE_DIR, <span class="string">'templates'</span>),<span class="comment">#模版⽂件位置</span></span><br><span class="line"> ],</span><br><span class="line"> <span class="string">'APP_DIRS'</span>: <span class="literal">True</span>, </span><br><span class="line"> <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">     <span class="string">'context_processors'</span>: [</span><br><span class="line">     <span class="string">'django.template.context_processors.debug'</span>,</span><br><span class="line">     <span class="string">'django.template.context_processors.request'</span>,</span><br><span class="line">     <span class="string">'django.contrib.auth.context_processors.auth'</span>,</span><br><span class="line">     <span class="string">'django.contrib.messages.context_processors.messages'</span>,</span><br><span class="line"> 	],</span><br><span class="line"> <span class="string">'environment'</span>: <span class="string">'App.jinja2_env.environment'</span>, <span class="comment"># 配置环境,jinja的配置⽂件位置</span></span><br><span class="line"> &#125;,</span><br><span class="line"> &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>两个同时使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#模板配置</span></span><br><span class="line">TEMPLATES = [&#123;</span><br><span class="line"> <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.jinja2.Jinja2'</span>,<span class="comment">#jinja2模版</span></span><br><span class="line"> <span class="string">'DIRS'</span>: [</span><br><span class="line"> 	os.path.join(BASE_DIR, <span class="string">'templates2'</span>),<span class="comment">#修改模版⽂件位置</span></span><br><span class="line"> ],</span><br><span class="line"> <span class="string">'APP_DIRS'</span>: <span class="literal">True</span>, </span><br><span class="line"> <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">     <span class="string">'context_processors'</span>: [</span><br><span class="line">     <span class="string">'django.template.context_processors.debug'</span>,</span><br><span class="line">     <span class="string">'django.template.context_processors.request'</span>,</span><br><span class="line">     <span class="string">'django.contrib.auth.context_processors.auth'</span>, </span><br><span class="line">     <span class="string">'django.contrib.messages.context_processors.messages'</span>,</span><br><span class="line">     ],</span><br><span class="line"> <span class="string">'environment'</span>: <span class="string">'App.jinja2_env.environment'</span>, <span class="comment"># 配置环境,jinja的配置⽂件位置</span></span><br><span class="line"> &#125;,</span><br><span class="line"> &#125;,</span><br><span class="line"> &#123;</span><br><span class="line"> <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</span><br><span class="line"> <span class="string">'DIRS'</span>: [os.path.join(BASE_DIR, <span class="string">'templates'</span>)]</span><br><span class="line"> ,</span><br><span class="line"> <span class="string">'APP_DIRS'</span>: <span class="literal">True</span>,</span><br><span class="line"> <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">     <span class="string">'context_processors'</span>: [</span><br><span class="line">     <span class="string">'django.template.context_processors.debug'</span>,</span><br><span class="line">     <span class="string">'django.template.context_processors.request'</span>,</span><br><span class="line">     <span class="string">'django.contrib.auth.context_processors.auth'</span>, </span><br><span class="line">     <span class="string">'django.contrib.messages.context_processors.messages'</span>,</span><br><span class="line">     ],</span><br><span class="line"> &#125;,</span><br><span class="line"> &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>静态资源和url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;</span><br><span class="line"> &lt;a href&#x3D;&quot;&#123;&#123; url(&#39;app:index&#39;) &#125;&#125;&quot;&gt;dddd&lt;&#x2F;a&gt;</span><br><span class="line">&lt;&#x2F;p&gt;</span><br><span class="line">&lt;img src&#x3D;&quot;&#123;&#123; static(&#39;images&#x2F;1.jpg&#39;) &#125;&#125;&quot; alt&#x3D;&quot;&quot;&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="Django-视图-request-response对象-和路由-V"><a href="#Django-视图-request-response对象-和路由-V" class="headerlink" title="Django 视图(request,response对象)和路由(V)"></a>Django 视图(request,response对象)和路由(V)</h1><p>Django中的视图主要用来接受Web请求，并做出响应。此响应可以是⽹⻚，重定向或404错误，XML⽂档或图像等的HTML内容。在mvt模式中，视图负责从模型中获取数据，然后展示在模板中，是联系模型和模板的桥梁，是业务逻辑层</p>
<p>视图响应的过程：</p>
<p>当用户从浏览器发起⼀次请求时，⾸先django获取用户的请求，然后通过路由（urls）将请求分配到指定的是视图函数。视图函数负责进行相应的业务处理，处理完毕后把结果（可能是json、html等）浏览器</p>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>当用户在您的Web应用程序上发出⻚⾯请求时，Django会获取url中请求路径（端⼝之后的部分），然后通过urls.py⽂件查找与路径相匹配的视图，然后返回HTML响应或404未找到的错误（如果未找到）。在urls.py中，最重要的是 “urlpatterns”列表。这是您定义URL和视图之间映射的地方。映射是URL模式中的path对象，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from django.conf.urls import patterns, include</span><br><span class="line">from app import views</span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line"> path(&#39;hello&#x2F;&#39;, views.hello, name&#x3D;&#39;hello&#39;),</span><br><span class="line"> path(&#39;blog&#x2F;&#39;, include(&#39;blog.urls&#39;)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>path对象有四个参数</strong></p>
<ul>
<li>模式串：匹配用户请求路径的字符串（和flflask⼀样）</li>
<li>视图函数：匹配上用户指定请求路径后调用的是视图函数名</li>
<li>kwargs：可选参数，需要额外传递的参数，是⼀个字典</li>
<li>名称（name）：给路由命名，在代码中可以使用name进行反向解析（由name获取用户请求路劲）</li>
</ul>
<blockquote>
<p>另外，如果path中模式串如果不能满⾜你路由规则，还可以使用re_path对象，re_path对象中模式串是正则表达式，其他三个参数和path对象⼀致</p>
</blockquote>
<h3 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h3><p>path中的模式串是⼀个普通字符串，用于匹配用户的请求路径。如果这种方式无法满⾜复杂路由请求的话，可以使用<code>re_path</code>完成路由映射，<code>re_path</code>中模式包含了⼀个上尖括号(^)和⼀个美元符号($)。这些都是正则符号，上尖括号表示从字符串开头匹配。美元符号表示匹配字符串的结尾，这两个符号和到⼀起就表示模式必须完全匹配路径，行不是包含⼀部分。⽐如对于模式：</p>
<p><code>r&#39;^hello/$&#39;</code>如果不包含美元符，也就是<code>r&#39;^hello/&#39;</code>，任何以/hello/的url都可以匹配，例如：/hello/world/、/hello/1/2/等，同样如果不以上尖括号开头，则任何以hello/做结尾的url都可以匹配。</p>
<blockquote>
<p>Django检查url模式之前会移除模式前的/，所以url模式前⾯的/可以不写，但如果在地址栏⾥请求的时候不带尾斜杠，则会引起重定向，重定向到带尾斜杠的地址， 所以请求的时候要带尾斜杠</p>
</blockquote>
<p>模式匹配的时候要注意：</p>
<ul>
<li>Django从上往下进行模式匹配，一旦匹配成功就不会往下继续匹配了</li>
<li>⼀个视图函数可以有多个模式匹配</li>
<li>模式前⾯不需要加/</li>
<li>如果匹配不上，则会引起异常，Django会调用错误处理视图处理（关闭调试模式）</li>
</ul>
<h3 id="URL配置"><a href="#URL配置" class="headerlink" title="URL配置"></a>URL配置</h3><p>在setting中指定根级url配置⽂件，对应的属性<code>ROOT_URLCONF</code></p>
<ol>
<li><p>urlpatterns：⼀个url实例的列表，全在根配置中搞定</p>
</li>
<li><p>导⼊其它url配置: 在应用中创建<code>urls.py</code>⽂件,编写匹配规则，在⼯程<code>urls.py</code>中进行导⼊包含</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from django.urls import include</span><br><span class="line">urlpatterns &#x3D; [ path(&#39;xxx&#x2F;&#39;,include(&#39;App.urls&#39;)) ]</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>Django的请求处理流程：</p>
<ul>
<li><p>Django获取用户发出请求</p>
</li>
<li><p>Django在⼯程配置⽂件settings.py中通过ROOT URLCOF配置来确定根URLconf</p>
</li>
<li><p>Django在URLconf中的所有URL模式中，查找第⼀个配的条⽬。</p>
</li>
<li><p>如果找到匹配，将调用相应的视图函数，并将HttpReuest对象传⼊</p>
</li>
<li><p>视图函数回⼀个HttpResponse响应</p>
</li>
</ul>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200819091718.png" alt=""></p>
<h3 id="动态url"><a href="#动态url" class="headerlink" title="动态url"></a>动态url</h3><p>前⾯写的url都是静态的，⽆法给视图函数传递数据，要想给视图函数传参数，url必须是动态，带有参数，但Django主张漂亮简介的url，所以不会使用查询字符串（/hello?name=tom），行是采用通配符：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">path(&quot;hello&#x2F;&lt;name&gt;&#x2F;&quot;,views.hello)</span><br><span class="line">path(&quot;show&#x2F;&lt;name&gt;&#x2F;&lt;int:age&gt;&quot;,views.show)</span><br><span class="line">re_path(r&#39;^hello&#x2F;(\w+)&#x2F;$&#39;,views.hello) </span><br><span class="line">#http:&#x2F;&#x2F;localhost:8000&#x2F;hello&#x2F;tom&#x2F;</span><br></pre></td></tr></table></figure>

<p>在path中使用&lt;参数名&gt;表示所传参数，视图函数中的参数名必须和&lt;&gt;中参数名⼀致。参数可以是以下类型:</p>
<ul>
<li>str：如果没有指定参数类型，默认是字符串类型。字符串参数可以匹配除/和空字符外的其他字符串</li>
<li>int：匹配0和正整数，视图函数的参数将得到⼀个整型值</li>
<li>slug：匹配由数字、字⺟、-和_组成的字符串参数</li>
<li>path：匹配任何⾮空字符串，包括/。</li>
</ul>
<p>在<code>re_path</code>中，（）部分是正则的组， django在进行url匹配时，就会⾃动把匹配成功的内容，作为参数传递给视图函数</p>
<ul>
<li><p>位置参数：url中的正则表达式组，和视图函数中的参数⼀⼀对应，函数中的参数名可以随意指定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#位置参数：hello&#x2F;name&#x2F;age</span><br><span class="line">re_path(r&#39;^hello&#x2F;(\w+)&#x2F;(\d&#123;1,2&#125;)&#x2F;$&#39;,views.hello)</span><br><span class="line">#视图函数</span><br><span class="line">def hello(req,value1,value2): #参数名字随意，但从左往右和url中分组对应</span><br><span class="line"> return HttpResponse(&quot;哈喽:&quot; + value1 + &quot; age&#x3D; &#123;&#125;&quot;.format(value2))</span><br></pre></td></tr></table></figure>
</li>
<li><p>关键字参数：对正则表达式分组进行命名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?P&lt;组名&gt;</span><br><span class="line">url(r&#39;^hello&#x2F;(?P&lt;name&gt;\w+)&#x2F;(?P&lt;age&gt;\d&#123;1,2&#125;)&#x2F;$&#39;,views.hello),</span><br><span class="line">#视图函数</span><br><span class="line">def hello(req,name,age): #参数名字必须是name和age，和url中命名⼀致，但顺序随意</span><br><span class="line"> return HttpResponse(&quot;哈喽:&quot; + name + &quot; age&#x3D; &#123;&#125;&quot;.format(age))</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>匹配/分组算法：</strong></p>
<ul>
<li><p>在⼀个匹配模式中要么使用命名分组，要么使用⽆命名分组，不能同时使用</p>
</li>
<li><p>请求的URL被看做是⼀个普通的Python字符串， URLconf在其上查找并匹配。进行匹配时将不包括GET或POST请求方式的参数以及域名。换句话讲，对同⼀个URL的⽆论是POST请求、GET请求、或HEAD请求方法等等 —— 都将路由到相同的函数。</p>
</li>
<li><p>每个捕获的参数都作为⼀个普通的Python字符串传递给视图，⽆论正则表达 </p>
<p>式使用的是什么匹配方式</p>
</li>
<li><p>每个捕获的参数都作为⼀个普通的Python字符串传递给视图，⽆论正则表达式使用的是什么匹配方式</p>
</li>
</ul>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>视图本质上是⼀个函数（类）。这个函数第⼀个参数的类型是<code>HttpReuest</code>；它返回⼀个 <code>HttpResponse</code>实例。为了使⼀个Python的函数成为⼀个Django可识别的视图，它必须 ⾜这两个条件。</p>
<p>作用：接收并处理请求，调用模型和模板，响应请求（返回<code>HttpResponse</code>或其子类）</p>
<ul>
<li>响应模板</li>
<li>重定向</li>
<li>直接响应字符串</li>
<li>响应错误模板</li>
<li>json数据</li>
</ul>
<h3 id="HttpRequest"><a href="#HttpRequest" class="headerlink" title="HttpRequest"></a>HttpRequest</h3><p><code>HttpRequest</code>是从web服务器传递过来的请求对象，经过Django框架封装产生的，封装了原始的Http请求</p>
<ul>
<li>服务器接收到http请求后，django框架会⾃动根据服务器传递的环境变量创建HttpRequest对象</li>
<li>视图的第⼀个参数必须是HttpRequest类型的对象</li>
<li>在django.http模块中定义了HttpRequest对象的API</li>
<li>使用HttpRequest对象的不同属性值，可以获取请求中多种信息</li>
</ul>
<table>
<thead>
<tr>
<th align="center">属性</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">content-type</td>
<td align="center">请求的mime类型</td>
</tr>
<tr>
<td align="center"><code>GET</code></td>
<td align="center">⼀个类似于字典的QueryDict对象，包含get请求⽅式的所有参 数，也就是“?”后⾯的内容</td>
</tr>
<tr>
<td align="center"><code>POST</code></td>
<td align="center">⼀个类似于字典的QueryDict对象，包含post请求方式的所有参 数</td>
</tr>
<tr>
<td align="center">COOKIES</td>
<td align="center">⼀个标准的Python字典，包含所有的cookie，键和值都为字符串</td>
</tr>
<tr>
<td align="center">SESSION</td>
<td align="center">⼀个类似于字典的对象，表示当前的会话，只有当Django启⽤会 话的⽀持时才可⽤</td>
</tr>
<tr>
<td align="center">PATH</td>
<td align="center">⼀个字符串，表示请求的⻚⾯的完整路径，不包含域名</td>
</tr>
<tr>
<td align="center">method</td>
<td align="center">⼀个字符串，表示请求使⽤的HTTP⽅法，常⽤值包括：GET、 POST，</td>
</tr>
<tr>
<td align="center">FILES</td>
<td align="center">⼀个类似于字典的QueryDict对象，包含所有的上传⽂件</td>
</tr>
<tr>
<td align="center">META</td>
<td align="center">请求的请求头的源信息（请求头中的键值对）</td>
</tr>
<tr>
<td align="center">encoding</td>
<td align="center">字符编码</td>
</tr>
<tr>
<td align="center">scheme</td>
<td align="center">协议</td>
</tr>
</tbody></table>
<p> META中常用的键:</p>
<table>
<thead>
<tr>
<th align="center">键</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">HTTP_REFERER</td>
<td align="center">来源⻚⾯</td>
</tr>
<tr>
<td align="center">REMOTE_ADDR</td>
<td align="center">客户端ip</td>
</tr>
<tr>
<td align="center">REMOTE_HOST</td>
<td align="center">客户端主机</td>
</tr>
</tbody></table>
<p> 下⾯是常用的方法</p>
<table>
<thead>
<tr>
<th align="center">方法名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">get_host()</td>
<td align="center">获取主机名+端⼝</td>
</tr>
<tr>
<td align="center">get_full_path()</td>
<td align="center">获取请求路径+查询字符串</td>
</tr>
<tr>
<td align="center">is_ajax()</td>
<td align="center">如果是ajax请求返回True</td>
</tr>
<tr>
<td align="center">build_absolute_uri()</td>
<td align="center">完整的url</td>
</tr>
</tbody></table>
<h4 id="QueryDict"><a href="#QueryDict" class="headerlink" title="QueryDict"></a>QueryDict</h4><p><code>QueryDict</code>是Dict的子类，和Dict最⼤的不同是，值都是列表。用于存储从请求中传递过来的参数，例如对于表单中select、checkbox等多值参数，QueryDict⾮常合适。get、post、files请求都对应⼀个<code>QueryDict</code></p>
<ul>
<li>HttpRequest中QueryDict是不可变的，只能获取值,不能修改</li>
<li>QueryDict键值对都是字符串</li>
<li>QueryDict中⼀个键可以对应多个值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#QueryDict</span><br><span class="line">&#123;&#39;hobby&#39;:[&#39;打篮球&#39;,&#39;玩游戏&#39;,&#39;k歌&#39;],&#39;name&#39;:[&#39;tom&#39;],&#39;age&#39;:&#39;21&#39;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 常用操作</p>
</blockquote>
<ol>
<li><p>判断get或post请求中包含指定键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if &#39;name&#39; in req.GET:</span><br><span class="line">	pass</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取get或post请求中指定键对应的单⼀值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(req.GET.get(&#39;name&#39;,&#39;⽆名&#39;))</span><br><span class="line">print(req.GET[&#39;name&#39;])</span><br><span class="line"># 两种方式的区别，如果用下标，键不存在，则包keyerror，get方法则会得到默认值，如果没有默认值则返回None</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取指定键对应的多个值(列表)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(req.GET.getlist(&#39;name&#39;))</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取所有键值对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for x in req.GET.lists():</span><br><span class="line">print(x)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="HttpResponse"><a href="#HttpResponse" class="headerlink" title="HttpResponse"></a>HttpResponse</h3><p>每⼀个视图函数必须返回⼀个响应对象，HttResponse对象由程序员创建并返回。</p>
<table>
<thead>
<tr>
<th align="center">属性</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">content</td>
<td align="center">字节字符串</td>
</tr>
<tr>
<td align="center">charset</td>
<td align="center">字符编码</td>
</tr>
<tr>
<td align="center">status_code</td>
<td align="center">http状态码</td>
</tr>
<tr>
<td align="center">content_type</td>
<td align="center">指定输出的MIME类型</td>
</tr>
</tbody></table>
<h4 id="不调用模板，直接返回内容"><a href="#不调用模板，直接返回内容" class="headerlink" title="不调用模板，直接返回内容"></a>不调用模板，直接返回内容</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def hello(req):</span><br><span class="line"> return HttpResponse(&quot;hello world&quot;)</span><br><span class="line">def goodbye(req):</span><br><span class="line"> res &#x3D; HttpResponse()</span><br><span class="line"> res.content &#x3D; b&#39;good bye&#39;</span><br><span class="line"> res.charset &#x3D; &quot;utf-8&quot;</span><br><span class="line"> res.content_type &#x3D; &#39;text&#x2F;html&#39;</span><br><span class="line"> return res</span><br></pre></td></tr></table></figure>

<h4 id="调用模板返回"><a href="#调用模板返回" class="headerlink" title="调用模板返回"></a>调用模板返回</h4><p>⼀般用<code>render</code>函数返回，<code>render</code>只是HttpResponse的包装，还是会返回⼀个HttpResponse对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def render_to_response(template_name, context&#x3D;None, content_type&#x3D;None,status&#x3D;None, using&#x3D;None):</span><br></pre></td></tr></table></figure>

<ul>
<li>template_name ： 模板名称。</li>
<li>context： ⼀组字典的值添加到模板中。默认情况下，这是⼀个空的字典。</li>
<li>content_type ：MIME类型用于生成⽂档</li>
<li>status ：为响应状态代码。默认值为200</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def studentlist(req):</span><br><span class="line"> for key in req.GET.lists():</span><br><span class="line"> print(key)</span><br><span class="line"> allstudent &#x3D; Student.objects.all()</span><br><span class="line"> return render(req,&#39;studentlist.html&#39;,context&#x3D;&#123;&#39;data&#39;:allstudent&#125;)</span><br></pre></td></tr></table></figure>

<p>常用方法：</p>
<ul>
<li>write(content) 设置内容 == obj.content</li>
<li>set_cookie() 设置cookie</li>
<li>delete_cookie() 删除cookie</li>
</ul>
<h3 id="JsonResponse"><a href="#JsonResponse" class="headerlink" title="JsonResponse"></a>JsonResponse</h3><p><code>JsonResponse</code> 是HttpResponse的子类，用于向客户端返回<code>json</code>数据。⼀般用于ajax请求。它的<code>content-type</code>缺省值(默认值)为：<code>application/json</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from django.http import JsonResponse #导包</span><br><span class="line">class JsonResponse(data, encoder&#x3D;DjangoJSONEncoder, safe&#x3D;True,json_dumps_params&#x3D;None, **kwargs)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>data：可以是字典(或者内置对象)，如果safe设置为False，也可以是json序列化对象</li>
<li>encoder：编码格式，缺省是django.core.serializers.json.DjangoJSONEncoder</li>
<li>safe：默认是True，如果传递非字典给data，则报TypeError</li>
</ul>
<h4 id="系统模块⾃带的json和JsonResponse"><a href="#系统模块⾃带的json和JsonResponse" class="headerlink" title="系统模块⾃带的json和JsonResponse"></a>系统模块⾃带的json和JsonResponse</h4> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from django.http import JsonResponse</span><br><span class="line">import json as myJson</span><br><span class="line">#返回json数据</span><br><span class="line">def json(req):</span><br><span class="line"> jsonStr &#x3D; JsonResponse(&#123;&#39;name&#39;:&#39;zhangsan&#39;,&#39;age&#39;:18&#125;)</span><br><span class="line"> jsonStr &#x3D; myJson.dumps(&#123;&#39;name&#39;:&#39;zhangsan&#39;,&#39;age&#39;:18&#125;)</span><br><span class="line"> return HttpResponse(jsonStr)</span><br></pre></td></tr></table></figure>

<p><code>json.dumps</code>给ajax返回数据以后 js代码中需要将json数据使用<code>Json.parse()</code>进行解析成<code>js对象</code> 而JsonResponse会⾃动转换为js对象（少了异步Json.parse()的转换）</p>
<h4 id="QuerySet转Json"><a href="#QuerySet转Json" class="headerlink" title="QuerySet转Json"></a>QuerySet转Json</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def courselist(req):</span><br><span class="line"> courses &#x3D; Course.objects.all() #QuerySet</span><br><span class="line"> data &#x3D; &#123;&#39;course&#39;:list(courses.values())&#125; #查询结果集QuerySet转字典</span><br><span class="line"> return JsonResponse(data) #传字典给JsonResponse</span><br><span class="line"> </span><br><span class="line"># 返回数据格式</span><br><span class="line">&#123;&#39;course&#39;: [&#123;&#39;cname&#39;: &#39;计算机组成原理&#39;, &#39;cid&#39;: 1&#125;, &#123;&#39;cname&#39;: &#39;英语&#39;,&#39;cid&#39;: 2&#125;, &#123;&#39;cname&#39;: &#39;数学&#39;, &#39;cidame&#39;: &#39;c语⾔程序设计&#39;, &#39;cid&#39;: 4&#125;,&#123;&#39;cname&#39;: &#39;python从⼊⻔到精通&#39;, &#39;cid&#39;: 5&#125;]&#125;</span><br><span class="line"></span><br><span class="line">def courselist(req):</span><br><span class="line"> courses &#x3D; Course.objects.all()</span><br><span class="line"> data &#x3D; json.dumps(list(courses.values())) #查询结果集QuerySet转Json字符串，序列化</span><br><span class="line"> return JsonResponse(data,safe&#x3D;False) #safe必须设置为False</span><br><span class="line"></span><br><span class="line"># 返回的数据格式</span><br><span class="line">[&#123;&quot;cname&quot;: &quot;\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406&quot;, &quot;cid&quot;: 1&#125;,&#123;&quot;cname&quot;: &quot;\u82f1\u8bed&quot;, &quot;cid&quot;: 2&#125;, &#123;&quot;cname&quot;: &quot;\u6570\u5b66&quot;, &quot;cid&quot;:3&#125;,&#123;&quot;cname&quot;:&quot;c\u8bed\u8a00\u7a0b\u5e8f\u8bbe\u8ba1&quot;, &quot;cid&quot;: 4&#125;,&#123;&quot;cname&quot;: &quot;python\u4ece\u5165\u95e8\u5230\u7cbe\u901a&quot;, &quot;cid&quot;: 5&#125;]</span><br></pre></td></tr></table></figure>

<h4 id="模型转Json"><a href="#模型转Json" class="headerlink" title="模型转Json"></a>模型转Json</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Course(models.Model):</span><br><span class="line"> cname &#x3D; models.CharField(max_length&#x3D;50)</span><br><span class="line"> cid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line"> # 给模型添加to_dict方法</span><br><span class="line"> def to_dict(self):</span><br><span class="line"> 	return dict([(key, self.__dict__[key]) for key in self.__dict__.keys() if key !&#x3D;&quot;_state&quot;])</span><br><span class="line"></span><br><span class="line"># 视图函数</span><br><span class="line">def courseshow(req):</span><br><span class="line"> course &#x3D; Course.objects.get(pk&#x3D;1) # 返回的是对象，不是QuerySet</span><br><span class="line"> return JsonResponse(course.to_dict())</span><br></pre></td></tr></table></figure>

<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p>当浏览器向server发送⼀个请求，要求获取⼀个资源时，在server接收到这个请求后发现请求的这个资源实际存放在另⼀个位置，于是server在返回的response中写⼊那个请求资源的正确的URL，并设置reponse的状态码为301（表示这是⼀个要求浏览器重定向的response)，当client接受到这个response后就会根据新的URL重新发起请求。重定向有⼀个典型的特症，即：当⼀个请求被重定向以后，最终浏览器上显示的URL往往不再是开始时请求的那个URL了。这就是重定向的由来。</p>
<p>HttpResponseRedirect是HttpResponse的子类，可以完成⻚⾯的重定向，当执行完特定动作或出现错误时，我们会希望执行的⻚⾯，如果判定用户没有登录则转到登录⻚⾯。重定向可以使用</p>
<ul>
<li>HttpResponseRedirect</li>
<li>redirect（是HttpResponseRedirect的简写）</li>
</ul>
<p>HttpResponseRedirect只⽀持硬编码url，不能直接使用命名url，在使用URL命名时，我们需要先通过URL反向解析方法reverse先对命名URL进行解析，然后再使用HttpReponseRedirect定向。</p>
<h4 id="不带参数重定向"><a href="#不带参数重定向" class="headerlink" title="不带参数重定向"></a>不带参数重定向</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#urls.py</span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">     path(&#39;&#39;,views.index),</span><br><span class="line">     re_path(r&#39;^list&#x2F;$&#39;,views.list_user),</span><br><span class="line">     #redirect 重定向路由地址</span><br><span class="line">     url(r&#39;^redirect&#x2F;$&#39;,views.Redirect)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">#views.py</span><br><span class="line">def index(req):</span><br><span class="line">     return render(req,&#39;index.html&#39;)</span><br><span class="line">def list_user():</span><br><span class="line">     return HttpResponse(&quot;list user&quot;)</span><br><span class="line">def Redirect(req):</span><br><span class="line">     # return redirect(&#39;http:&#x2F;&#x2F;localhost:9000&#x2F;&#39;)</span><br><span class="line">     # return redirect(&#39;&#x2F;&#39;)</span><br><span class="line">     return redirect(&quot;list&#x2F;&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="带参数重定向"><a href="#带参数重定向" class="headerlink" title="带参数重定向"></a>带参数重定向</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#urls.py</span><br><span class="line">path(&#39;repath&#x2F;&lt;int:num&gt;&#x2F;&#39;, views.repath),</span><br><span class="line">re_path(r&#39;^parameter&#x2F;(?P&lt;num1&gt;\d+)&#x2F;(?P&lt;num2&gt;\d+)&#x2F;$&#39;,views.parameter),</span><br><span class="line"></span><br><span class="line">#views.py</span><br><span class="line">def repath(req,num):</span><br><span class="line">     return redirect(&quot;parameter&#x2F;3&#x2F;5&quot;)</span><br><span class="line">def index(request):</span><br><span class="line">     return HttpResponse(&quot;⾸⻚&quot;)</span><br><span class="line">def parameter(req,num1, num2):</span><br><span class="line">     return HttpResponse(&quot;num1&#x3D;&#123;&#125;,num2&#x3D;&#123;&#125;&quot;.format(num1,num2)</span><br></pre></td></tr></table></figure>

<h4 id="反向解析"><a href="#反向解析" class="headerlink" title="反向解析"></a>反向解析</h4><p>根据namespace 和 name 查找真实路径：</p>
<ul>
<li>namespace 在根url 包含子url时指定</li>
<li>name 在具体的函数后 指定,子url指定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># urls.py中</span><br><span class="line">app_name &#x3D; &#39;App&#39; # namespace 命名空间</span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">     path(&#39;&#39;, views.index),</span><br><span class="line">     path(&#39;para&#x2F;&lt;int:num1&gt;&#x2F;&lt;int:num2&gt;&#x2F;&#39;),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#python代码中写法</span><br><span class="line">def repath(req):</span><br><span class="line"> #res &#x3D; reverse(&quot;App:index&quot;)</span><br><span class="line"> # print(res,type(res))</span><br><span class="line"> #return redirect(res)</span><br><span class="line"> # path中参数或re_path中的位置参数，args可以是列表或元组</span><br><span class="line"> # return redirect(reverse(&quot;App:para&quot;,args&#x3D;(1,2)))</span><br><span class="line"> # re_path中命名组，带关键字参数</span><br><span class="line"> return redirect(reverse(&quot;App:para&quot;,kwargs&#x3D;&#123;&#39;num1&#39;:1,&#39;num2&#39;:3&#125;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 模板中的写法：</span><br><span class="line">&lt;h2&gt;&lt;a href&#x3D;&quot;&#x2F;form&#x2F;&quot;&gt;展示表单&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h2&gt;&lt;a href&#x3D;&quot;&#x2F;index&#x2F;&quot;&gt;死链接⽆参的跳转&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h2&gt;&lt;a href&#x3D;&quot;&#x2F;args&#x2F;1&#x2F;2&#x2F;&quot;&gt;死链接带参的跳转&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h2&gt;&lt;a href&#x3D;&quot;&#123;% url &#39;App:index&#39; %&#125;&quot;&gt;动态生成路由地址不带参的跳转&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h2&gt;&lt;a href&#x3D;&quot;&#123;% url &#39;App:args1&#39; 1 2 %&#125;&quot;&gt;动态生成路由地址带参的跳转&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h2&gt;&lt;a href&#x3D;&quot;&#123;% url &#39;App:args1&#39; num1&#x3D;1 num2&#x3D;2 %&#125;&quot;&gt;re_path中命名组，动态生成路由地址带关键字参数的跳转&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;</span><br></pre></td></tr></table></figure>

<h3 id="错误视图"><a href="#错误视图" class="headerlink" title="错误视图"></a>错误视图</h3><p>Django内置了处理HTTP错误的视图（在django.views.defaults包下），主要错误及视图包括：</p>
<ul>
<li>403错误：permission_denied （权限拒绝）</li>
<li>404错误：page_not_found （找不到指定⽂件)</li>
<li>500错误：server_error （服务器内部错误)</li>
</ul>
<h4 id="404错误及视图"><a href="#404错误及视图" class="headerlink" title="404错误及视图"></a>404错误及视图</h4><p>url匹配失败后，django会调用内置的 django.views.defaults.page_not_found()函数，该视图函数会调用 404.html的模板进行显示。开发阶段可以开启调试模式，但产品上线后，要关闭调试模式。关闭调试模式后，会显示⼀个标准的错误⻚⾯。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 在项⽬的settings配置⽂件中设置</span><br><span class="line"># 关闭调试模式(开发模式)</span><br><span class="line">DEBUG &#x3D; False</span><br></pre></td></tr></table></figure>

<p>404错误界⾯可以⾃定义： 在项⽬templates⽬录⾯创建404.html，django找不到界⾯时，就会显示该界⾯了。缺省会传递参数request_path，就是出错的url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"> &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line"> &lt;title&gt;404 Not Found&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;对不起 您所访问的地址被外星⼈抓⾛了....&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h4&gt;请求的地址为 &#123;&#123; request_path &#125;&#125;&lt;&#x2F;h4&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="500错误及视图"><a href="#500错误及视图" class="headerlink" title="500错误及视图"></a>500错误及视图</h4><p>若是在执行视图函数时出现运行时错误，Django会默认会调用django.views.defaults.server_error 视图，加载并显示 500.html 模板，可以在项⽬的templates⽬录下，创建500.html来⾃定义该界面</p>
<h1 id="Django分页"><a href="#Django分页" class="headerlink" title="Django分页"></a>Django分页</h1><h2 id="Paginator-分页器"><a href="#Paginator-分页器" class="headerlink" title="Paginator 分页器"></a>Paginator 分页器</h2><p><code>Paginator</code>用于分页，但<code>Paginator</code>并不具体管理具体的页的处理，而是使用<code>Page</code>对象管理具体页⾯ </p>
<ol>
<li><p>创建分页器对象 </p>
<p><strong>格式：</strong> Paginator(&lt;query_set查询集&gt;,每也显示数据的条数) </p>
</li>
<li><p>对象的属性 </p>
<ul>
<li><p><code>count</code> 分页对象的个数 </p>
</li>
<li><p><code>num_pages</code> 总页数 </p>
</li>
<li><p><code>page_range</code> 页码的列表</p>
</li>
<li><p><code>per_page</code>每页显示的条数</p>
</li>
</ul>
</li>
<li><p>方法 </p>
<ul>
<li><code>page(num)</code>返回page对象 如果给定的页码不存在 则抛出异常</li>
</ul>
</li>
</ol>
<h2 id="page-对象"><a href="#page-对象" class="headerlink" title="page 对象"></a>page 对象</h2><p><code>page</code>对象具体负责每页的处理，包括每页的数据，当前页的页码，是否有上⼀页或下⼀页等</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>属性</td>
<td>object_list</td>
<td>当前页面上的所有数据</td>
</tr>
<tr>
<td>属性</td>
<td>number</td>
<td>当前页码值</td>
</tr>
<tr>
<td>属性</td>
<td>paginator</td>
<td>返回Paginator对象</td>
</tr>
<tr>
<td>方法</td>
<td>has_next</td>
<td>是否有下一页</td>
</tr>
<tr>
<td>方法</td>
<td>has_previous</td>
<td>是否有上一页</td>
</tr>
<tr>
<td>方法</td>
<td>has_other_pages</td>
<td>是否有上一页或下一页</td>
</tr>
<tr>
<td>方法</td>
<td>next_page_number</td>
<td>返回下一页的页码</td>
</tr>
<tr>
<td>方法</td>
<td>previous_page_number</td>
<td>返回上⼀页的页码</td>
</tr>
<tr>
<td>方法</td>
<td>len</td>
<td>返回当前页数据的个数</td>
</tr>
</tbody></table>
<p>实例:</p>
<p>步骤1. models.py中添加模型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class User(models.Model):</span><br><span class="line">    uid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line">    username &#x3D; models.CharField(unique&#x3D;True, max_length&#x3D;30)</span><br><span class="line">    password &#x3D; models.CharField(max_length&#x3D;128)</span><br><span class="line">    regtime &#x3D; models.DateTimeField()</span><br><span class="line">    sex &#x3D; models.IntegerField(blank&#x3D;True, null&#x3D;True)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        db_table &#x3D; &#39;user&#39;</span><br></pre></td></tr></table></figure>

<p>步骤2. 在应用App中urls.py中添加路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from App02 import views</span><br><span class="line">app_name &#x3D; &#39;App02&#39;</span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    # 分页</span><br><span class="line">    path(&#39;page&#x2F;&#39;,views.fenye, name&#x3D;&#39;page&#39;),</span><br><span class="line">    path(&#39;page&#x2F;&lt;int:page&gt;&#x2F;&#39;,views.fenye, name&#x3D;&#39;page&#39;),</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>步骤3. 在views.py中添加视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def fenye(request,page&#x3D;1):</span><br><span class="line">    users &#x3D; User.objects.all()</span><br><span class="line">    # 产生分页器 参数(&lt;query_set查询集&gt;,每⻚显示数据的条数)</span><br><span class="line">    paginator &#x3D; Paginator(users,3)</span><br><span class="line">    # 分页对象</span><br><span class="line">    # page表示当前页</span><br><span class="line">    pager &#x3D; paginator.page(page)</span><br><span class="line">    for user in paginator.object_list:</span><br><span class="line">        print(user,type(user))</span><br><span class="line">    return render(request,&quot;userlist.html&quot;,locals())</span><br></pre></td></tr></table></figure>

<p>步骤4. 在userlist.html页面中展示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;table border&#x3D;&quot;1&quot; cellspacing&#x3D;&quot;0&quot; width&#x3D;&quot;80%&quot;&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">        &lt;td&gt;用户名&lt;&#x2F;td&gt;</span><br><span class="line">        &lt;td&gt;密码&lt;&#x2F;td&gt;</span><br><span class="line">    &lt;&#x2F;tr&gt;</span><br><span class="line">    &#123;% for user in pager.object_list %&#125;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; user.username &#125;&#125;&lt;&#x2F;td&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; user.password &#125;&#125;&lt;&#x2F;td&gt;</span><br><span class="line">        &lt;&#x2F;tr&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&lt;&#x2F;table&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">&#123;#    paginator.page_range 页码列表   #&#125;</span><br><span class="line">    &#123;% for page in paginator.page_range %&#125;</span><br><span class="line">        &lt;a href&#x3D;&quot;&#123;% url &#39;App02:page&#39; page&#x3D;page %&#125;&quot;&gt;&#123;&#123; page &#125;&#125;&lt;&#x2F;a&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Django中Cookie和Session"><a href="#Django中Cookie和Session" class="headerlink" title="Django中Cookie和Session"></a>Django中Cookie和Session</h1><p>HTTP被设计为”无状态”，也就是俗称“脸盲”。 这⼀次请求和下⼀次请求之间没有任何状态保持，我们无法根据请求的任何方面(IP地址，⽤户代理等)来识别来⾃同一人的连续请求。实现状态保持的方式：在客户端或服务器端存储与会话有关的数据 （客户端与服务器端的⼀次通信，就是⼀次会话）</p>
<ul>
<li>cookie</li>
<li>session</li>
</ul>
<p>不同的请求者之间不会共享这些数据，cookie和session与请求者一一对应</p>
<h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><p>cookies 是浏览器为 Web 服务器存的一小段信息。 每次浏览器从某个服务器请求页面时，都会自动带上以前收到的cookie。cookie保存在客户端，安全性较差，注意不要保存敏感信息。典型应用：</p>
<ul>
<li>网站登录</li>
<li>购物车</li>
</ul>
<h3 id="设置cookie"><a href="#设置cookie" class="headerlink" title="设置cookie"></a>设置cookie</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HttpResponse.set_cookie(key, value&#x3D;&#39;&#39;, max_age&#x3D;None, expires&#x3D;None,path&#x3D;&#39;&#x2F;&#39;, domain&#x3D;None, secure&#x3D;None, httponly&#x3D;False)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>key： cookie的名称(*)</li>
<li>value: cookie的值,默认是空字符</li>
<li>max_age：cookies的持续有效时间（以秒计），如果设置为 None，cookies 在浏览器关闭的时候就失效了。</li>
<li>expires：cookies的过期时间，格式:”Wdy, DD-Mth-YY HH:MM:SS GMT” 如果设置这个参数，它将覆盖max_age。</li>
<li>path: cookie⽣效的路径前缀，浏览器只会把cookie回传给带有该路径的页面，这样你可以避免将cookie传给站点中的其他的应⽤。/ 表示根路径，特殊的：根路径的cookie可以被任何url的⻚⾯访问</li>
<li>domain: cookie⽣效的站点。你可⽤这个参数来构造⼀个跨站cookie。如，domain=”.example.com” 所构造的cookie对下⾯这些站点都是可读的： <a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a> 、www2.example.com。如果该参数设置为None，cookie只能由设置它的站点读取。</li>
<li>secure: 如果设置为 True ，浏览器将通过HTTPS来回传cookie。</li>
<li>httponly: 仅http传输 不能使⽤js获取cookie</li>
</ul>
<p>同<code>set_cookie</code>,不同点在于设置salt，即加盐，加密存储cookie数据</p>
<blockquote>
<p>HttpResponse.set_signed_cookie(key, value, salt=’’, max_age=None,expires=None, path=’/‘, domain=None, secure=None, httponly=False)</p>
</blockquote>
<h3 id="获取cookie"><a href="#获取cookie" class="headerlink" title="获取cookie"></a>获取cookie</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HttpRequest.COOKIES.get(key)</span><br><span class="line"># 获取加“盐”的cookie</span><br><span class="line">HttpRequest.get_signed_cookie(key, default&#x3D;RAISE_ERROR, salt&#x3D;&#39;&#39;,max_age&#x3D;None)</span><br></pre></td></tr></table></figure>

<h3 id="删除cookie"><a href="#删除cookie" class="headerlink" title="删除cookie"></a>删除cookie</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HttpResponse.delete_cookie(key, path&#x3D;&#39;&#x2F;&#39;, domain&#x3D;None)</span><br></pre></td></tr></table></figure>

<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><p>cookie看似解决了HTTP（短连接、⽆状态）的会话保持问题，但把全部⽤户数据保存在客户端，存在安全隐患,于是session出现了。我们可以把关于用户的数据保存在服务端，在客户端cookie里加⼀个sessionID（随机字符串）。其⼯作流程：</p>
<ol>
<li><p>当用户来访问服务端时,服务端会生成⼀个随机字符串；</p>
</li>
<li><p>当用户登录成功后 把 {sessionID :随机字符串} 组织成键值对加到cookie里发送给用户；</p>
</li>
<li><p>服务器以发送给客户端 cookie中的随机字符串做键，⽤户信息做值，保存用户信息</p>
</li>
<li><p>再访问服务器时客户端会带上sessionid，服务器根据sessionid来确认用户是否访问过网站</p>
</li>
</ol>
<h3 id="session配置"><a href="#session配置" class="headerlink" title="session配置"></a>session配置</h3><p>步骤1.  首先在settings.py中有如下配置（<code>系统默认已经设置了</code>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS &#x3D; [</span><br><span class="line"> &#39;django.contrib.sessions&#39;,</span><br><span class="line">]</span><br><span class="line">MIDDLEWARE &#x3D; [</span><br><span class="line"> &#39;django.contrib.sessions.middleware.SessionMiddleware&#39;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>步骤2. 进行数据迁移，⽣成session使⽤的数据库表</p>
<h3 id="session操作"><a href="#session操作" class="headerlink" title="session操作"></a>session操作</h3><h4 id="session设置"><a href="#session设置" class="headerlink" title="session设置"></a>session设置</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">doregister</span><span class="params">(request)</span>:</span></span><br><span class="line">    username = request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">    password = request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">    email = request.POST.get(<span class="string">'email'</span>)</span><br><span class="line">    user = User()</span><br><span class="line">    user.username = username</span><br><span class="line">    user.password = md5(password.encode(<span class="string">'utf8'</span>)).hexdigest()</span><br><span class="line">    user.email = email</span><br><span class="line">    user.save()</span><br><span class="line">    <span class="comment"># 设置session</span></span><br><span class="line">    request.session[<span class="string">'username'</span>] = username</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">"common/notice.html"</span>,context=&#123;</span><br><span class="line">    <span class="string">'code'</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="string">'msg'</span>:<span class="string">'注册成功'</span>,</span><br><span class="line">    <span class="string">'url'</span>:<span class="string">'three:index'</span>,</span><br><span class="line">    <span class="string">'wait'</span>:<span class="number">3</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="session获取"><a href="#session获取" class="headerlink" title="session获取"></a>session获取</h4> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line"> <span class="comment"># session获取</span></span><br><span class="line"> username = request.session.get(<span class="string">'username'</span>)</span><br><span class="line"> <span class="keyword">return</span> render(request,<span class="string">'three/index.html'</span>,context=&#123;<span class="string">'username'</span>:username&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="session删除"><a href="#session删除" class="headerlink" title="session删除"></a>session删除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def logout(request):</span><br><span class="line">    request.session.flush()</span><br><span class="line">    return redirect(reverse(&quot;three:index&quot;))</span><br></pre></td></tr></table></figure>

<ul>
<li><p>clear() 清空所有session 但是不会将session表中的数据删除</p>
</li>
<li><p>flush() 清空所有 并删除表中的数据</p>
</li>
<li><p>logout() 退出登录 清除所有 并删除表中的数据</p>
</li>
<li><p>del req.session[‘key’] 删除某⼀个session的值</p>
</li>
</ul>
<h4 id="session过期时间"><a href="#session过期时间" class="headerlink" title="session过期时间"></a>session过期时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.session.set_expiry(5)</span><br></pre></td></tr></table></figure>

<h2 id="cookie和session的区别与联系"><a href="#cookie和session的区别与联系" class="headerlink" title="cookie和session的区别与联系"></a>cookie和session的区别与联系</h2><p>区别:</p>
<ul>
<li>session将数据存储与服务器端 cookie存储在客户端</li>
<li>cookie 存储在客户端，不安全，session存储在服务器端，客户端只存sesseionid,安全</li>
<li>cookie在客户端存储值有⼤⼩的限制，⼤约⼏kb。session没有限制</li>
</ul>
<p>联系:</p>
<ul>
<li>session 基于cookie</li>
</ul>
<h1 id="Django-使用阿里云短信服务"><a href="#Django-使用阿里云短信服务" class="headerlink" title="Django 使用阿里云短信服务"></a>Django 使用阿里云短信服务</h1><p>短信服务的使用场景:</p>
<ul>
<li>APP、网站注册账号，向手机下发验证码；</li>
<li>登录账户、异地登录时的安全提醒;</li>
<li>找回密码时的安全验证；</li>
<li>⽀付认证、身份校验、⼿机绑定等。</li>
</ul>
<p>步骤1. 安装阿里云SDK核心库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install aliyun-python-sdk-core-v3</span><br></pre></td></tr></table></figure>

<p>发送步骤：</p>
<ol>
<li><p>创建Client实例。在创建Client实例时，您需要获取Region ID、AccessKey ID和AccessKey Secret</p>
</li>
<li><p>创建API请求并设置参数</p>
</li>
<li><p>发起请求并处理应答或异常</p>
</li>
</ol>
<p>工具类<code>tool.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> aliyunsdkcore.client <span class="keyword">import</span> AcsClient</span><br><span class="line"><span class="keyword">from</span> aliyunsdkcore.request <span class="keyword">import</span> CommonRequest</span><br><span class="line"></span><br><span class="line">ACCESS_KEY_ID = <span class="string">"LTAIDHOYSjYcvyVt"</span>  <span class="comment">#用户AccessKey  需要根据自己的账户修改</span></span><br><span class="line">ACCESS_KEY_SECRET = <span class="string">"qrEgykmXX4e6GUMFOqzuiLZ5gsUxSC"</span>  <span class="comment">#Access Key Secret  需要根据自己的账户修改</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMS</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,signName,templateCode)</span>:</span></span><br><span class="line">        self.signName = signName  <span class="comment">#签名</span></span><br><span class="line">        self.templateCode = templateCode  <span class="comment">#模板code</span></span><br><span class="line">        self.client = client = AcsClient(ACCESS_KEY_ID, ACCESS_KEY_SECRET, <span class="string">'cn-hangzhou'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self,phone_numbers,template_param)</span>:</span></span><br><span class="line">        request = CommonRequest()</span><br><span class="line">        request.set_accept_format(<span class="string">'json'</span>)</span><br><span class="line">        request.set_domain(<span class="string">'dysmsapi.aliyuncs.com'</span>)</span><br><span class="line">        request.set_method(<span class="string">'POST'</span>)</span><br><span class="line">        request.set_protocol_type(<span class="string">'https'</span>)  <span class="comment"># https | http</span></span><br><span class="line">        request.set_version(<span class="string">'2017-05-25'</span>)</span><br><span class="line">        request.set_action_name(<span class="string">'SendSms'</span>)</span><br><span class="line"></span><br><span class="line">        request.add_query_param(<span class="string">'RegionId'</span>, <span class="string">"cn-hangzhou"</span>)</span><br><span class="line">        request.add_query_param(<span class="string">'PhoneNumbers'</span>, phone_numbers)</span><br><span class="line">        request.add_query_param(<span class="string">'SignName'</span>, self.signName)</span><br><span class="line">        request.add_query_param(<span class="string">'TemplateCode'</span>, self.templateCode)</span><br><span class="line">        request.add_query_param(<span class="string">'TemplateParam'</span>, template_param)</span><br><span class="line">        response = self.client.do_action_with_exception(request)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"><span class="comment"># 短语发送对象  需要根据自己的签名和模板代码</span></span><br><span class="line">sms = SMS(<span class="string">"成少雷"</span>,<span class="string">"SMS_102315005"</span>)</span><br></pre></td></tr></table></figure>

<p><code>views.py</code>视图中调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_sms</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">from</span> App02.SMS <span class="keyword">import</span> sms</span><br><span class="line">    <span class="comment"># 模板参数一定要是这个格式</span></span><br><span class="line">    <span class="comment"># 一定要注意模板变量number</span></span><br><span class="line">    para = <span class="string">"&#123;'number':%d&#125;"</span>%(randint(<span class="number">1000</span>,<span class="number">100000</span>))</span><br><span class="line">    print(para)</span><br><span class="line">    res = sms.send(<span class="string">'15116905290'</span>,para)</span><br><span class="line">    print(res.decode(<span class="string">"utf-8"</span>))</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"ok"</span>)</span><br></pre></td></tr></table></figure>

<h1 id="Django-From表单验证"><a href="#Django-From表单验证" class="headerlink" title="Django  From表单验证"></a>Django  From表单验证</h1><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>通常情况下，我们需要真的手动在HTML页面中，编写form标签和其内的其它元素。但这费时费⼒，行且有可能写得不太恰当，数据验证也⽐较麻烦。有鉴于此， Django在内部集成了⼀个表单模块，专门帮助我们快速处理表单相关的内容。Django的表单模块给我们提供了下面三个主要功能：</p>
<ul>
<li>准备和重构数据⽤于⻚⾯渲染</li>
<li>为数据创建HTML表单元素</li>
<li>接收和处理用户从表单发送过来的数据</li>
</ul>
<h2 id="Form相关的对象包括"><a href="#Form相关的对象包括" class="headerlink" title="Form相关的对象包括"></a>Form相关的对象包括</h2><ul>
<li><p>Widget：⽤来渲染成HTML元素的部件，如：forms.Textarea对应HTML中的 <code>&lt;textarea&gt;</code> 标签</p>
</li>
<li><p>Field：Form对象中的⼀个字段，如：EmailField表示email字段，如果这个字段不是有效的Email地址格式，就会产⽣错误。</p>
</li>
<li><p>Form：⼀系列Field对象的集合，负责验证和显示HTML元素</p>
</li>
<li><p>Form Media：⽤来渲染表单的CSS和JavaScript资源。</p>
</li>
</ul>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p>Form对象封装了⼀系列Field和验证规则，Form类都必须直接或间接继承⾃django.forms.Form，定义Form有两种方式:</p>
<ol>
<li><p>直接继承Form</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class XXXForm(forms.Form):</span><br><span class="line"> pass</span><br></pre></td></tr></table></figure>
</li>
<li><p>结合Model，继承django.forms.ModelForm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class XXX(models.Model):</span><br><span class="line">    字段 &#x3D; models.CharField(max_length&#x3D;30)</span><br><span class="line">    字段 &#x3D; models.CharField(max_length&#x3D;20)</span><br><span class="line">class XXXForm(ModelForm):</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; XXX</span><br><span class="line">        field &#x3D; (&#39;字段&#39;, &#39;字段&#39;) # 只显示model中指定的字段，显示所有是⽤&#39;__all__&#39;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>示例代码:</p>
<p>需求: 注册验证</p>
</blockquote>
<p>步骤1. models</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    uid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = models.CharField(unique=<span class="literal">True</span>, max_length=<span class="number">30</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">128</span>)</span><br><span class="line">    regtime = models.DateTimeField()</span><br><span class="line">    sex = models.IntegerField(blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'user'</span></span><br></pre></td></tr></table></figure>

<p>步骤2. RegisterForm</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    </span><br><span class="line">    username = forms.CharField(min_length=<span class="number">3</span>,required=<span class="literal">True</span>,error_messages=&#123;</span><br><span class="line">        <span class="string">'required'</span>:<span class="string">'用户名必须输入'</span>,</span><br><span class="line">        <span class="string">'min_length'</span>:<span class="string">'用户名至少3个字符'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    password = forms.CharField(min_length=<span class="number">3</span>,required=<span class="literal">True</span>,error_messages=&#123;</span><br><span class="line">        <span class="string">'required'</span>: <span class="string">'密码名必须输入'</span>,</span><br><span class="line">        <span class="string">'min_length'</span>: <span class="string">'密码至少3个字符'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    confirm = forms.CharField(min_length=<span class="number">3</span>,required=<span class="literal">True</span>,error_messages=&#123;</span><br><span class="line">        <span class="string">'required'</span>: <span class="string">'密码名必须输入'</span>,</span><br><span class="line">        <span class="string">'min_length'</span>: <span class="string">'密码至少3个字符'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    regtime = forms.DateTimeField(required=<span class="literal">False</span>,error_messages=&#123;</span><br><span class="line">        <span class="string">'invalid'</span>:<span class="string">'日期格式错误'</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    sex = forms.BooleanField(required=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 单个字段验证: clean_xxxx 密码不能是纯数字</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_password</span><span class="params">(self)</span>:</span></span><br><span class="line">        password = self.cleaned_data.get(<span class="string">'password'</span>)</span><br><span class="line">        <span class="keyword">if</span> password <span class="keyword">and</span> password.isdigit():</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">"密码不能是纯数字"</span>)</span><br><span class="line">        <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 全局验证   两次密码输入必须一致</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(self)</span>:</span></span><br><span class="line">        password = self.cleaned_data.get(<span class="string">'password'</span>,<span class="literal">None</span>)</span><br><span class="line">        confirm = self.cleaned_data.get(<span class="string">'confirm'</span>,<span class="string">''</span>)</span><br><span class="line">        print(password,confirm)</span><br><span class="line">        <span class="keyword">if</span> password != confirm:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(&#123;<span class="string">'confirm'</span>:<span class="string">"两次密码输入不一致"</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span> self.cleaned_data</span><br></pre></td></tr></table></figure>

<p>步骤3. views.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># From表单模块</span><br><span class="line">def register(request):</span><br><span class="line">    if request.method &#x3D;&#x3D; &quot;POST&quot;:</span><br><span class="line">        #1.用提交的数据生成表单</span><br><span class="line">        form &#x3D;RegisterForm(request.POST)</span><br><span class="line">        #2.能通过验证，返回True，否则返回False</span><br><span class="line">        if form.is_valid():</span><br><span class="line">            #3.进行业务处理</span><br><span class="line">            data &#x3D; form.cleaned_data # 结果是一个字典</span><br><span class="line">            # 如果forms中表单的字段名和models模型的字段名不一致,可以把不一致的属性去除,在使用						# User.objects.create添加到数据库</span><br><span class="line">            data.pop(&quot;confirm&quot;)</span><br><span class="line">            #4.获取指定字段</span><br><span class="line">            # username &#x3D; form.cleaned_data.get(&#39;username&#39;,&#39;&#39;)</span><br><span class="line">            # print(data,type(data))</span><br><span class="line">            # 如果forms中表单的字段名和models模型的字段名一致</span><br><span class="line">            res &#x3D; User.objects.create(**data)</span><br><span class="line">            # 如果forms中表单的字段名和models模型的字段名不一致</span><br><span class="line">            # res &#x3D; User.objects.create(username&#x3D;username,password&#x3D;form.cleaned_data.get(&#39;password&#39;))</span><br><span class="line">            if res:</span><br><span class="line">                return HttpResponse(&quot;注册成功&quot;)</span><br><span class="line">        else:</span><br><span class="line">            print(form.__dict__)</span><br><span class="line">            # 验证不成功，把错误信息渲染到前端页面</span><br><span class="line">            return render(request, &quot;register.html&quot;,&#123;&#39;form&#39;:form&#125;)</span><br><span class="line">    return render(request,&quot;register.html&quot;)</span><br></pre></td></tr></table></figure>

<p>步骤4. 在模板<code>templates</code>中 <code>register.html</code>使用</p>
<blockquote>
<p><strong>建议</strong>:尽量使用自己定义的文本框信息,等于Form表单对象只渲染错误信息,不使用渲染的表单信息</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&#123;% url 'App02:user_register' %&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>&gt;</span></span><br><span class="line">    &#123;% for error in form.username.errors %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; error &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line">    &#123;&#123; form.password.errors &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    确认密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"confirm"</span>&gt;</span></span><br><span class="line">     &#123;&#123; form.confirm.errors &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    注册时间：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"regtime"</span>&gt;</span></span><br><span class="line">     &#123;&#123; form.regtime.errors &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    性别：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"sex"</span> <span class="attr">value</span>=<span class="string">"0"</span>&gt;</span>女</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"sex"</span> <span class="attr">value</span>=<span class="string">"1"</span>&gt;</span> 男</span><br><span class="line">     &#123;&#123; form.sex.errors &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"注册"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&#123;% url 'add' %&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">     &#123;% csrf_token %&#125;</span><br><span class="line">     &#123;&#123; shop_form &#125;&#125;</span><br><span class="line">     <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="常用的field类"><a href="#常用的field类" class="headerlink" title="常用的field类"></a>常用的field类</h2><p>核心字段参数</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>require</td>
<td>给字段添加必填属性，不能空着，若要表示⼀个字段不是必需的，设置required=False</td>
</tr>
<tr>
<td>label</td>
<td>label参数⽤来给字段添加‘⼈类友好’的提示信息。如果没有设置这个参数，那么就⽤字段的⾸字⺟⼤写名字</td>
</tr>
<tr>
<td>label_suffix</td>
<td>Django默认为上⾯的label参数后⾯加个冒号后缀，如果想⾃定义，可以使⽤ label_suffix 参数</td>
</tr>
<tr>
<td>initial</td>
<td>为HTML⻚⾯中表单元素定义初始值。也就是input元素的value参数的值</td>
</tr>
<tr>
<td>widget</td>
<td>指定渲染Widget时使⽤的widget类，也就是这个form字段在HTML⻚⾯中是显示为⽂本输⼊框？密码输⼊框？单选按钮？多选框？还是别的</td>
</tr>
<tr>
<td>help_text</td>
<td>该参数⽤于设置字段的辅助描述文本</td>
</tr>
<tr>
<td>error_messages</td>
<td>该参数允许你覆盖字段引发异常时的默认信息。 传递的是⼀个字典，其值为你想覆盖的错误信息</td>
</tr>
<tr>
<td>validators</td>
<td>指定⼀个列表，其中包含了为字段进⾏验证的函数</td>
</tr>
<tr>
<td>localize</td>
<td>localize参数帮助实现表单数据输⼊的本地化。</td>
</tr>
<tr>
<td>disabled</td>
<td>设置有该属性的字段在前端⻚⾯中将显示为不可编辑状态</td>
</tr>
</tbody></table>
<p>核心字段</p>
<p><strong>BooleanField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget：CheckboxInput</span><br><span class="line">空值：False </span><br><span class="line">规范：Python 的True 或 False。</span><br><span class="line">错误信息的键：required</span><br></pre></td></tr></table></figure>

<p><strong>IntegerField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget：当Field.localize是False时为NumberInput，否则</span><br><span class="line">为TextInput。</span><br><span class="line">空值：None </span><br><span class="line">规范化为：Python 整数或⻓整数。</span><br><span class="line">验证给定值是⼀个整数。 允许前导和尾随空格，类似Python的int()函数。</span><br><span class="line">错误信息的键：max_value, invalid, required, min_value</span><br></pre></td></tr></table></figure>

<p><strong>CharField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget：TextInput </span><br><span class="line">空值：&#39;&#39;（⼀个空字符串）</span><br><span class="line">规范化为：⼀个Unicode 对象。 如果提供，验证max_length 或</span><br><span class="line">min_length。 否则，所有的输⼊都是合法的。</span><br><span class="line">错误信息的键：required, max_length, min_length</span><br></pre></td></tr></table></figure>

<p><strong>ChoiceField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget：Select</span><br><span class="line">空值：&#39; &#39;（⼀个空字符串）</span><br><span class="line">规范化为：⼀个Unicode 对象。 验证给定的值在选项列表中存在。</span><br><span class="line">错误信息的键：required, invalid_choice</span><br><span class="line">invalid_choice：错误消息可能包含%(value)s，它将被选择的选项</span><br><span class="line">替换掉。接收⼀个额外的必选参数：choices⽤来作为该字段选项的</span><br><span class="line">⼀个⼆元组组成的可迭代对象（例如，列表或元组）或者⼀个可调⽤对</span><br></pre></td></tr></table></figure>

<p><strong>DateField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget：DateInput </span><br><span class="line">空值：None </span><br><span class="line">规范化为：⼀个Python datetime.date 对象。</span><br><span class="line">错误信息的键：required, invalid </span><br><span class="line">input_formats：⼀个格式的列表，验证给出的值是⼀个</span><br><span class="line">datetime.date、datetime.datetime 或指定⽇期格式的字符串。如</span><br><span class="line">果不提供，默认的⽇期格式：[&#39;%Y-%m-</span><br><span class="line">%d&#39;,&#39;%m&#x2F;%d&#x2F;%Y&#39;,&#39;%m&#x2F;%d&#x2F;%y&#39;]</span><br></pre></td></tr></table></figure>

<p><strong>DateTimeField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget: DateInput </span><br><span class="line">空值：None </span><br><span class="line">规范化为：⼀个Python datetime.datetime对象。</span><br><span class="line">错误信息的键：required, invalid</span><br><span class="line">input_formats：默认的格式[&#39;%Y-%m-%d %H:%M:%S&#39;, &#39;%Y-%m-</span><br><span class="line">%d %H:%M&#39;, &#39;%Y-%m-%d&#39;, &#39;%m&#x2F;%d&#x2F;%Y %H:%M:%S&#39;,&#39;%m&#x2F;%d&#x2F;%Y</span><br><span class="line">%H:%M&#39;,&#39;%m&#x2F;%d&#x2F;%Y&#39;, &#39;%m&#x2F;%d&#x2F;%y %H:%M:%S&#39;, &#39;%m&#x2F;%d&#x2F;%y</span><br><span class="line">%H:%M&#39;, &#39;%m&#x2F;%d&#x2F;%y&#39;]</span><br></pre></td></tr></table></figure>

<p><strong>DecimalField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget：当Field.localize是False时为NumberInput，否则</span><br><span class="line">为TextInput。</span><br><span class="line">空值：None </span><br><span class="line">规范化为：Python decimal对象。</span><br><span class="line">错误信息的键： max_whole_digits , max_digits ,</span><br><span class="line">max_decimal_places , max_value , invalid, required, min_value</span><br><span class="line">可选参数：max_value,min_value:允许的值的范围，需要赋值</span><br><span class="line">decimal.Decimal对象，不能直接给个整数类型。</span><br><span class="line">max_digits：值允许的最⼤位数（⼩数点之前和之后的数字总共的位数，前导的零将被删除）。</span><br><span class="line">decimal_places：允许的最⼤⼩数位。</span><br></pre></td></tr></table></figure>

<p><strong>FloatField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget：当Field.localize是False时为NumberInput，否则</span><br><span class="line">为TextInput。</span><br><span class="line">空值：None </span><br><span class="line">规范化为：Float 对象。</span><br><span class="line">验证给定的值是⼀个浮点数。</span><br><span class="line">错误信息的键：max_value, invalid, required, min_value</span><br><span class="line">可选的参数:max_value和min_value</span><br></pre></td></tr></table></figure>

<p><strong>EmailField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget：EmailInput </span><br><span class="line">空值：&#39;&#39;（⼀个空字符串）</span><br><span class="line">规范化为：Unicode 对象。 使⽤正则表达式验证给出的值是⼀个合</span><br><span class="line">法的邮件地址。</span><br><span class="line">错误信息的键：required, invalid</span><br><span class="line">两个可选的参数⽤于验证，max_length 和min_length。</span><br></pre></td></tr></table></figure>

<p><strong>ImageField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">默认Widget： ClearableFileInput </span><br><span class="line">空值： None </span><br><span class="line">规范化为： UploadedFile 将⽂件内容和⽂件名称封装到单个对象</span><br><span class="line">中的对象。</span><br><span class="line">验证⽂件数据是否已绑定到表单，并且该⽂件是Pillow可以理解的</span><br><span class="line">图像格式。</span><br><span class="line">错误信息键： required ， invalid ， missing ， empty ，invalid_image</span><br></pre></td></tr></table></figure>

<p><strong>FileField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">默认Widget: ClearableFileInput </span><br><span class="line">空值： None</span><br><span class="line">规范化为： UploadedFile 将⽂件内容和⽂件名称封装到单个对象</span><br><span class="line">中的对象。</span><br><span class="line">可以验证⾮空⽂件数据已被绑定到表单。</span><br><span class="line">错误信息键： required ， invalid ， missing ， empty ，</span><br><span class="line">max_length</span><br></pre></td></tr></table></figure>

<p><strong>ModelChoiceField</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">默认的Widget：Select </span><br><span class="line">空值：None </span><br><span class="line">规范化为：⼀个模型实例。</span><br><span class="line">验证给定的id存在于查询集中。</span><br><span class="line">错误信息的键：required, invalid_choice 可以选择⼀个单独的模型</span><br><span class="line">对像，适⽤于表示⼀个外键字段。 ModelChoiceField默认widet不</span><br><span class="line">适⽤选择数量很⼤的情况，在⼤于100项时应该避免使⽤它。</span><br><span class="line">可选参数:</span><br><span class="line">empty_label:默认情况下，ModelChoiceField使⽤的</span><br></pre></td></tr></table></figure>

<h2 id="Form常用的属性和方法"><a href="#Form常用的属性和方法" class="headerlink" title="Form常用的属性和方法"></a>Form常用的属性和方法</h2><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>cleaned_data（字典)</td>
<td>表单中验证通过的⼲净数据</td>
<td>form.cleaned_data form.cleaned_data.get(‘username’)</td>
</tr>
<tr>
<td>changed_data</td>
<td>有变化的字段的列表</td>
<td>form.changed_data</td>
</tr>
<tr>
<td>fields（字典）</td>
<td>表单中的字段属性</td>
<td>form.fiedls[‘username’]</td>
</tr>
<tr>
<td>is_bound</td>
<td>表单是否绑定数据</td>
<td>form.is_bound</td>
</tr>
<tr>
<td>errors(字典)</td>
<td>错误信息</td>
<td>form.errors</td>
</tr>
<tr>
<td>is_valid()</td>
<td>表单中数据是否验证通过，通过返回True，否则返回False</td>
<td>form.is_valid()</td>
</tr>
<tr>
<td>has_changed()</td>
<td>检查表单数据是否已从初始数据更改</td>
<td>form.has_changed()</td>
</tr>
<tr>
<td>errors.as_json(escape_html=False)</td>
<td>返回JSON序列化后的错误信息字典</td>
<td>form.errors.as_json()</td>
</tr>
</tbody></table>
<h2 id="表单渲染的选项"><a href="#表单渲染的选项" class="headerlink" title="表单渲染的选项"></a>表单渲染的选项</h2><p>对于 <label>/<input> 对，还有⼏个输出选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. &#123;&#123; form.as_table &#125;&#125; 以表格的形式将它们渲染在 &lt;tr&gt; 标签中</span><br><span class="line">2. &#123;&#123; form.as_p &#125;&#125; 将它们渲染在 &lt;p&gt; 标签中</span><br><span class="line">3. &#123;&#123; form.as_ul &#125;&#125; 将它们渲染在 &lt;li&gt; 标签中</span><br></pre></td></tr></table></figure>

<p>注意，你必须自己提供 <table> 或 <ul> 元素。</p>
<p>常⽤渲染项：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">有⽤的属性包括：&#123;&#123; field &#125;&#125;</span><br><span class="line">&#123;&#123; field.label &#125;&#125;</span><br><span class="line">该领域的标签，例如。Email address</span><br><span class="line">&#123;&#123; field.label_tag &#125;&#125;</span><br><span class="line">字段的标签包含在适当的HTML &lt;label&gt;标记中。这包括表格label_suffix。例</span><br><span class="line">如，默认label_suffix值为冒号：</span><br><span class="line">&lt;label for&#x3D;&quot;id_email&quot;&gt;Email address:&lt;&#x2F;label&gt;</span><br><span class="line">&#123;&#123; field.id_for_label &#125;&#125;</span><br><span class="line">将⽤于此字段的ID（id_email在上⾯的示例中）。如果您⼿动构建标签，则可能</span><br><span class="line">需要使⽤此代替label_tag。例如，如果你有⼀些内联JavaScript并且想要避免</span><br><span class="line">硬编码字段的ID，它也很有⽤。</span><br><span class="line">&#123;&#123; field.value &#125;&#125;</span><br><span class="line">该字段的值。例如someone@example.com。</span><br><span class="line">&#123;&#123; field.html_name &#125;&#125;</span><br><span class="line">将在输⼊元素的名称字段中使⽤的字段的名称。这会将表单前缀考虑在内，如果已</span><br><span class="line">设置的话。</span><br><span class="line">&#123;&#123; field.help_text &#125;&#125;</span><br><span class="line">与该字段关联的任何帮助⽂本。</span><br><span class="line">&#123;&#123; field.errors &#125;&#125;</span><br><span class="line">输出包含与此字段对应的任何验证错误的a 。您可以使⽤循环⾃定义错误的表示。</span><br><span class="line">在这种情况下，循环中的每个对象都是包含错误消息的简单字符串。&lt;ul</span><br><span class="line">class&#x3D;&quot;errorlist&quot;&gt;&#123;% for error in field.errors %&#125;</span><br><span class="line">&#123;&#123; field.is_hidden &#125;&#125;</span><br><span class="line">True如果表单字段是隐藏字段， False则此属性。它作为模板变量并不是特别有</span><br><span class="line">⽤，但在条件测试中可能很有⽤，例如：</span><br><span class="line">&#123;% if field.is_hidden %&#125;</span><br><span class="line"> &#123;# Do something special #&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;&#123; field.field &#125;&#125;</span><br><span class="line">Field来⾃此BoundField包装的表单类的实例。您可以使⽤它来访问 Field属</span><br><span class="line">性，例如 。&#123;&#123; char_field.field.max_length &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="form-as-ul"><a href="#form-as-ul" class="headerlink" title="form.as_ul"></a>form.as_ul</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action&#x3D;&quot;&#x2F;add&#x2F;&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line"> &#123;% csrf_token %&#125;</span><br><span class="line"> &lt;ul&gt;</span><br><span class="line"> &#123;&#123; form.as_ul &#125;&#125;</span><br><span class="line"> &lt;&#x2F;ul&gt;</span><br><span class="line"> &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;注册⼀个学⽣&quot;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br></pre></td></tr></table></figure>

<h3 id="手动渲染"><a href="#手动渲染" class="headerlink" title="手动渲染"></a>手动渲染</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action&#x3D;&quot;&#x2F;add&#x2F;&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;&#123;&#123; form.name.id_for_label &#125;&#125;&quot;&gt;姓名:&lt;&#x2F;label&gt;</span><br><span class="line">    &#123;&#123; form.name &#125;&#125;</span><br><span class="line">    &#123;&#123; form.name.errors &#125;&#125;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;&#123;&#123; form.sex.id_for_label &#125;&#125;&quot;&gt;性别:&lt;&#x2F;label&gt;</span><br><span class="line">    &#123;&#123; form.sex &#125;&#125;</span><br><span class="line">    &#123;&#123; form.sex.errors &#125;&#125;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;&#123;&#123; form.age.id_for_label &#125;&#125;&quot;&gt;年龄:&lt;&#x2F;label&gt;</span><br><span class="line">    &#123;&#123; form.age &#125;&#125;</span><br><span class="line">    &#123;&#123; form.age.errors &#125;&#125;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;submit&quot;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br></pre></td></tr></table></figure>

<h3 id="循环渲染"><a href="#循环渲染" class="headerlink" title="循环渲染"></a>循环渲染</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for field in form %&#125;</span><br><span class="line">     &lt;div class&#x3D;&quot;fieldWrapper&quot;&gt;</span><br><span class="line">     &#123;&#123; field.errors &#125;&#125;</span><br><span class="line">     &#123;&#123; field.label_tag &#125;&#125; &#123;&#123; field &#125;&#125;</span><br><span class="line">         &#123;% if field.help_text %&#125;</span><br><span class="line">         &lt;p class&#x3D;&quot;help&quot;&gt;&#123;&#123; field.help_text|safe &#125;&#125;&lt;&#x2F;p&gt;</span><br><span class="line">         &#123;% endif %&#125;</span><br><span class="line">     &lt;&#x2F;div&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="循环隐藏和可⻅字段"><a href="#循环隐藏和可⻅字段" class="headerlink" title="循环隐藏和可⻅字段"></a>循环隐藏和可⻅字段</h3>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;# Include the hidden fields #&#125;</span><br><span class="line">&#123;% for hidden in form.hidden_fields %&#125;</span><br><span class="line">&#123;&#123; hidden &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#123;# Include the visible fields #&#125;</span><br><span class="line">&#123;% for field in form.visible_fields %&#125;</span><br><span class="line"> &lt;div class&#x3D;&quot;fieldWrapper&quot;&gt;</span><br><span class="line"> &#123;&#123; field.errors &#125;&#125;</span><br><span class="line"> &#123;&#123; field.label_tag &#125;&#125; &#123;&#123; field &#125;&#125;</span><br><span class="line"> &lt;&#x2F;div&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="可重⽤的表单模板"><a href="#可重⽤的表单模板" class="headerlink" title="可重⽤的表单模板"></a>可重⽤的表单模板</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># In your form template:</span><br><span class="line">&#123;% include &quot;form_snippet.html&quot; %&#125;</span><br><span class="line"># In form_snippet.html:</span><br><span class="line">&#123;% for field in form %&#125;</span><br><span class="line">     &lt;div class&#x3D;&quot;fieldWrapper&quot;&gt;</span><br><span class="line">     &#123;&#123; field.errors &#125;&#125;</span><br><span class="line">     &#123;&#123; field.label_tag &#125;&#125; &#123;&#123; field &#125;&#125;</span><br><span class="line">     &lt;&#x2F;div&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Django-用户认证"><a href="#Django-用户认证" class="headerlink" title="Django 用户认证"></a>Django 用户认证</h1><h2 id="概要-1"><a href="#概要-1" class="headerlink" title="概要"></a>概要</h2><p>auth模块是Django提供的标准权限管理系统,可以提供用户身份认证, 用户组和权限管理。auth可以和admin模块配合使用， 快速建立网站的管理系统。在INSTALLED_APPS中添加’django.contrib.auth’使⽤该APP, auth模块默认启⽤。主要的操作包括:</p>
<ul>
<li><code>create_user</code> 创建用户</li>
<li><code>authenticate</code> 验证登录</li>
<li><code>login</code> 记住⽤户的登录状态</li>
<li><code>logout</code>退出登录</li>
<li><code>is_authenticated</code> 判断⽤户是否登录</li>
<li><code>@login_required</code> 判断⽤户是否登录的装饰器</li>
</ul>
<h2 id="前期配置"><a href="#前期配置" class="headerlink" title="前期配置"></a>前期配置</h2><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>Django 在新建⼯程时已经为使⽤⽤户认证系统做好了全部必要的配置。不过有可能你并⾮使⽤ django-admin 命令新建的⼯程，或者你使⽤的是⼀个正在开发中的项⽬，因此最好再检查⼀下 settings.py ⽂件中是否已经做好了全部必要配置。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ol>
<li><p>在setting.py的INSTALLED_APPS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS &#x3D; [</span><br><span class="line"> &#39;django.contrib.auth&#39;, </span><br><span class="line"> # 用户权限处理部分依赖的应⽤ </span><br><span class="line"> &#39;django.contrib.contenttypes&#39;,</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>
</li>
<li><p>在setting.py的MIDDLEWARE</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line"><span class="comment"># 会话⽀持中间件</span></span><br><span class="line"><span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line"><span class="comment"># 认证⽀持中间件</span></span><br><span class="line"><span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>, </span><br><span class="line">]</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="user对象"><a href="#user对象" class="headerlink" title="user对象"></a>user对象</h2><blockquote>
<p>属性</p>
</blockquote>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>username</td>
<td>小于等于30个字符。 ⽤户名可以包含字⺟、 数字、_、@、+、.和- 字符</td>
<td>必选</td>
</tr>
<tr>
<td>password</td>
<td>密码的哈希及元数据。（Django 不保存原始密码）。原始密码可以⽆限⻓⽽且可以包含任意字符。参⻅密码相关的⽂档</td>
<td>必选</td>
</tr>
<tr>
<td>is_active</td>
<td>布尔值。指示⽤户的账号是否激活，缺省值为True</td>
<td>必选</td>
</tr>
<tr>
<td>first_name</td>
<td>少于等于30个字符</td>
<td>可选</td>
</tr>
<tr>
<td>last_name</td>
<td>少于30个字符</td>
<td>可选</td>
</tr>
<tr>
<td>email</td>
<td>邮箱地址</td>
<td>可选</td>
</tr>
<tr>
<td>groups</td>
<td>与Group 之间的多对多关系</td>
<td>可选</td>
</tr>
<tr>
<td>user_permissions</td>
<td>与Permission之间的多对多关系</td>
<td>可选</td>
</tr>
<tr>
<td>is_staff</td>
<td>布尔值,指示⽤户是否可以访问Admin 站点</td>
<td>可选</td>
</tr>
<tr>
<td>is_superuser</td>
<td>布尔值。只是这个⽤户拥有所有的权限⽽不需要给他们分配明确的权限。</td>
<td>可选</td>
</tr>
<tr>
<td>last_login</td>
<td>⽤户最后⼀次登录的时间</td>
<td>默认值</td>
</tr>
<tr>
<td>date_joined</td>
<td>账户创建的时间。当账号创建时，默认设置为当前的date/time</td>
<td>默认值</td>
</tr>
</tbody></table>
<blockquote>
<p>说明</p>
</blockquote>
<ul>
<li>User 对象属性：username， password（必填项）password用哈希算法保存到数据库</li>
<li>is_staff： 用户是否拥有网站的管理权限.</li>
<li>is_active ： 是否允许用户登录, 设置为 False ，可以不用删除⽤户来禁止用户登录</li>
</ul>
<h2 id="拓展-User-模型"><a href="#拓展-User-模型" class="headerlink" title="拓展 User 模型"></a>拓展 User 模型</h2><h4 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h4><p>用户可能还包含有头像、昵称、介绍等等其它属性，因此仅仅使⽤ Django 内置的 User 模型是不够。所有有些时候我们必须使⽤在系统的User上进⾏拓展  </p>
<h4 id="继承AbstractUser"><a href="#继承AbstractUser" class="headerlink" title="继承AbstractUser"></a>继承AbstractUser</h4><p>说明</p>
<blockquote>
<p>推荐方式、django.contrib.auth.models.User 也是继承⾃ AbstractUser 抽象基类，而且仅仅就是继承了 AbstractUser ，没有对 AbstractUser 做任何的拓展</p>
</blockquote>
<p>在app的models.py中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    phone = models.CharField(max_length=<span class="number">12</span>,null=<span class="literal">True</span>,verbose_name=<span class="string">"⼿机号"</span>)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span><span class="params">(AbstractUser.Meta)</span>:</span></span><br><span class="line">        db_table=<span class="string">'user'</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意:</strong></p>
</blockquote>
<p>为了让 Django ⽤户认证系统使⽤我们自定义的用户模型，必须在 <code>settings.py</code>里通过 AUTH_USER_MODEL 指定⾃定义用户模型所在的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AUTH_USER_MODEL &#x3D; &#39;app名字.User&#39;</span><br></pre></td></tr></table></figure>

<p>迁移</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>

<h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><h3 id="验证登录"><a href="#验证登录" class="headerlink" title="验证登录"></a>验证登录</h3><blockquote>
<p>当用户登录的时候用 authenticate(username=username,password=password) 验证⽤户是否登录，如果数据库中存在用户输⼊的账号和密码，返回⼀个user对象，否则返回None。底层将password⽤hash算法加密后和数据库中password进⾏对比</p>
</blockquote>
<p>示例代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myauthenticate</span><span class="params">(request)</span>:</span></span><br><span class="line">    pwd = request.POST.get(<span class="string">"pwd"</span>, <span class="string">""</span>)</span><br><span class="line">    u_name = request.POST.get(<span class="string">"u_name"</span>, <span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span> len(pwd) &lt;= <span class="number">0</span> <span class="keyword">or</span> len(u_name) &lt;= <span class="number">0</span>:</span><br><span class="line">    	<span class="keyword">return</span> HttpResponse(<span class="string">"账号或密码不能为空"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        user = authenticate(username=u_name, password=pwd)</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">        	<span class="keyword">return</span> HttpResponse(<span class="string">"验证成功"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">return</span> HttpResponse(<span class="string">"账号或密码错误"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="注册操作"><a href="#注册操作" class="headerlink" title="注册操作"></a>注册操作</h3><blockquote>
<p>当⽤户注册的时候⽤ create_user(username,password,email) 默认情况下is_active=True,is_staff=False,is_superuser=False 。底层将password⽤hash算法加密之后存储到数据库中</p>
</blockquote>
<p>示例代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_view</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            username = request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">            password = request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">            phone = request.POST.get(<span class="string">'phone'</span>)</span><br><span class="line">            email = request.POST.get(<span class="string">'email'</span>)</span><br><span class="line">            <span class="comment"># 验证⽤户是否存在</span></span><br><span class="line">            user = User.objects.filter(username=username).first()</span><br><span class="line">            <span class="keyword">if</span> user:</span><br><span class="line">                <span class="comment"># ⽤户已经存在</span></span><br><span class="line">                <span class="keyword">return</span> render(request, <span class="string">'register.html'</span>, &#123;<span class="string">'msg'</span>: <span class="string">'⽤户名已存在'</span>&#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 保存⽤户                     </span></span><br><span class="line">                User.objects.create_user</span><br><span class="line">            				(username=username,password=password,phone=phone,email=email)</span><br><span class="line">         <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">'register.html'</span>, &#123;<span class="string">'msg'</span>: <span class="string">'注册失败'</span>&#125;)    </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'register.html'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="登录操作"><a href="#登录操作" class="headerlink" title="登录操作"></a>登录操作</h3><blockquote>
<p>当⽤户登录的时候⽤ login(request,user) 来记住⽤户的登录状态该函数接受⼀个HttpRequest对象，以及⼀个认证了的User对象此函数使⽤django的session框架给某个已认证的⽤户附加上session id等信息</p>
</blockquote>
<p>示例代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def login_view(request):</span><br><span class="line">	if request.method &#x3D;&#x3D; &#39;POST&#39;:</span><br><span class="line">        username &#x3D; request.POST.get(&#39;username&#39;)</span><br><span class="line">        password &#x3D; request.POST.get(&#39;password&#39;)</span><br><span class="line">        # 验证⽤户是否存在</span><br><span class="line">        user &#x3D; authenticate(request, username&#x3D;username,password&#x3D;password)</span><br><span class="line">        if user:</span><br><span class="line">            login(request,user)</span><br><span class="line">            return redirect(&#39;&#x2F;&#39;)</span><br><span class="line">        else:</span><br><span class="line">            return render(request, &#39;test&#x2F;login.html&#39;, &#123;&#39;msg&#39;: &#39;⽤户密码错误&#39;&#125;)</span><br><span class="line">    else:</span><br><span class="line">		return render(request, &#39;login.html&#39;)</span><br></pre></td></tr></table></figure>

<h3 id="登出操作"><a href="#登出操作" class="headerlink" title="登出操作"></a>登出操作</h3><blockquote>
<p>当⽤户注销的时候⽤ logout(request) ,只需要⼀个参数request</p>
</blockquote>
<p>示例代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> logout</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout_view</span><span class="params">(request)</span>:</span></span><br><span class="line">     logout(request)</span><br></pre></td></tr></table></figure>

<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><p>第一种: 自动签名,使用<code>set_password</code>修改,底层最终还是使用<code>make_password</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user = auth.authenticate(username=username,password=old_password)</span><br><span class="line"><span class="keyword">if</span> user:</span><br><span class="line">    user.set_password(new_password)</span><br><span class="line">    user.save()</span><br></pre></td></tr></table></figure>

<p>第二种: 手动签名,使用<code>make_password</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_pass</span><span class="params">(request)</span>:</span></span><br><span class="line">    password = make_password(<span class="string">"123"</span>)</span><br><span class="line">    print(password)</span><br><span class="line">    <span class="comment"># 加密后的password: 		pbkdf2_sha256$150000$3ZMHSagCWJLt$89MAwmlUIE8S+zi+Cpv13/ny/AyzI1nLTkfES6mGqhY=</span></span><br><span class="line">    <span class="comment"># 比较明文密码和加密后的密码比较</span></span><br><span class="line">    print(check_password(<span class="string">'123'</span>,password))</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"ok"</span>)</span><br></pre></td></tr></table></figure>

<p>如果报错需要在setting.py中添加密码配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PASSWORD_HASHERS &#x3D; [</span><br><span class="line">    &#39;django.contrib.auth.hashers.PBKDF2PasswordHasher&#39;,</span><br><span class="line">    &#39;django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher&#39;,</span><br><span class="line">    &#39;django.contrib.auth.hashers.Argon2PasswordHasher&#39;,</span><br><span class="line">    &#39;django.contrib.auth.hashers.BCryptSHA256PasswordHasher&#39;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="路由保护"><a href="#路由保护" class="headerlink" title="路由保护"></a>路由保护</h3><blockquote>
<p>@login_required 修饰器修饰的view函数会先通过session key检查是否登录,已登录⽤户可以正常的执⾏操作, 未登录⽤户将被重定向到login_url指定的位置. 若未指定login_url参数, 则重定向到settings.LOGIN_URL</p>
</blockquote>
<p>示例代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings 配置</span></span><br><span class="line">LOGIN_URL = <span class="string">'/day05/login/'</span></span><br><span class="line"><span class="comment"># views</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_user_info</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required(login_url='/day05/phone/login')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_user_info</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h3 id="业务中修改密码"><a href="#业务中修改密码" class="headerlink" title="业务中修改密码"></a>业务中修改密码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_password</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 修改密码</span></span><br><span class="line">    user = User.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">    user.set_password(<span class="string">'123'</span>)</span><br><span class="line">    user.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"修改密码"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="前端验证登录"><a href="#前端验证登录" class="headerlink" title="前端验证登录"></a>前端验证登录</h3><blockquote>
<p>如果是真正的 User 对象，返回值恒为 True 。 ⽤于检查⽤户是否已经通过了认证。 通过认证并不意味着⽤户拥有任何权限，甚⾄也不检查该⽤户是否处于激活状态，这只是表明⽤户成功的通过了认证。 这个方法很重要, 在后台⽤request.user.is_authenticated()判断⽤户是否已经登录，如果true则可以向前台展示request.user.name</p>
</blockquote>
<p> 示例代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 在后台的视图函数⾥可以⽤request.user.is_authenticated()判断⽤户是否登录在前端页面中可以用</span><br><span class="line">&#123;% if user.is_authenticated %&#125;</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line"># 判断用户是否登录</span><br></pre></td></tr></table></figure>

<h1 id="Django-图形验证码"><a href="#Django-图形验证码" class="headerlink" title="Django 图形验证码"></a>Django 图形验证码</h1><h2 id="安装django-simple-captcha库"><a href="#安装django-simple-captcha库" class="headerlink" title="安装django-simple-captcha库"></a>安装django-simple-captcha库</h2><p>在⽹站开发的登录⻚⾯中，经常会需要使⽤到图形验证码来验证。在Django中，django-simple-captcha库包提供了图形验证码的使⽤。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install django-simple-captcha</span><br><span class="line"># 如果安装有依赖库问题，请执⾏下⾯的安装</span><br><span class="line">apt-get -y install libz-dev libjpeg-dev libfreetype6-dev python-dev</span><br></pre></td></tr></table></figure>

<h2 id="setting配置"><a href="#setting配置" class="headerlink" title="setting配置"></a>setting配置</h2><p>步骤一.  settings.py中安装应用,在INSTALL_APPS 添加如下代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">'captcha'</span>  <span class="comment"># 安装应用</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>步骤二.  settings.py中设置验证码样式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 图形验证码配置</span><br><span class="line"># 证码设置</span><br><span class="line">CAPTCHA_IMAGESIZE &#x3D; (8,45)   # 设置captcha图片大小</span><br><span class="line"></span><br><span class="line">CAPTCHA_LENGTH &#x3D;4   #字符个数</span><br><span class="line">CAPTCHA_TIMEOUT &#x3D;1  #超时(minutes)*</span><br><span class="line"></span><br><span class="line"># 输出格式：输入框验证码图片隐藏域•</span><br><span class="line"># &#39;%(image)s %(hidden_field)s %(text_field)s&#39;</span><br><span class="line">CAPTCHA_OUTPUT_FORMAT &#x3D;&#39;%(text_field)s %(image)s %(hidden_field)s&#39;</span><br><span class="line">CAPTCHA_NOISE_FUNCTIONS &#x3D;(</span><br><span class="line">    &#39;captcha.helpers.noise_null&#39;,</span><br><span class="line">    &#39;captcha.helpers.noise_arcs&#39;,</span><br><span class="line">    &#39;captcha.helpers.noise_dots&#39;,</span><br><span class="line">)</span><br><span class="line">CAPTCHA_CHALLENGE_FUNCT &#x3D; &#39;captcha.helpers.random_char_challenge&#39;</span><br></pre></td></tr></table></figure>

<p> 步骤三. urls.py中设置路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    path(&#39;captcha&#x2F;&#39;,include(&quot;captcha.urls&quot;))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>步骤四. 迁移数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>

<h2 id="建立表单"><a href="#建立表单" class="headerlink" title="建立表单"></a>建立表单</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> captcha.fields <span class="keyword">import</span> CaptchaField</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">	username = forms.CharField(max_length=<span class="number">20</span>,min_length=<span class="number">3</span>)</span><br><span class="line">	password =forms.CharField(max_length=<span class="number">128</span>,widget=forms.PasswordInput())</span><br><span class="line">	captcha = CaptchaField() <span class="comment"># 验证码字段</span></span><br></pre></td></tr></table></figure>

<p>##实现</p>
<p>步骤一. 在应用的<code>urls.py</code>中添加路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 应⽤的urls.py</span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line"> .....</span><br><span class="line"> path(&#39;yzm&#x2F;&#39;,views.user_login,name&#x3D;&#39;yzm&#39;),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>步骤二. 前端页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 前端⻚⾯</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"> &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line"> &lt;title&gt;登录&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div&gt;&#123;&#123; msg &#125;&#125;&lt;&#x2F;div&gt;</span><br><span class="line">&lt;form action&#x3D;&quot;&#123;% url &#39;App03:yzm&#39; %&#125;&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">     &#123;% csrf_token %&#125;</span><br><span class="line">     ⽤户：&#123;&#123; form.username &#125;&#125; &lt;span&gt;&#123;&#123; form.username.errors.0 &#125;&#125;&lt;&#x2F;span&gt; &lt;br&gt;</span><br><span class="line">     密码：&#123;&#123; form.password &#125;&#125; &lt;span&gt;&#123;&#123; form.password.errors.0 &#125;&#125;&lt;&#x2F;span&gt;&lt;br&gt;</span><br><span class="line">     验证码：&#123;&#123; form.captcha &#125;&#125; &lt;span&gt;&#123;&#123; form.captcha.errors.0 &#125;&#125;&lt;&#x2F;span&gt;&lt;br&gt;</span><br><span class="line">     &lt;input type&#x3D;&quot;submit&quot;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;jquery&#x2F;1.12.3&#x2F;jquery.min.js&quot;&gt;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"> &#x2F;&#x2F;点击刷新验证码</span><br><span class="line"> $(function () &#123;</span><br><span class="line">     $(&#39;.captcha&#39;).css(&#123;</span><br><span class="line">     		&#39;cursor&#39;: &#39;pointer&#39;</span><br><span class="line">     &#125;);</span><br><span class="line">     &#x2F;&#x2F; ajax刷新</span><br><span class="line">     $(&#39;.captcha&#39;).click(function () &#123;</span><br><span class="line">     	console.log(&#39;click&#39;);</span><br><span class="line">    	 $.get(&quot;&#x2F;app3&#x2F;refresh&#x2F;&quot;,function (result) &#123;</span><br><span class="line">     			$(&#39;.captcha&#39;).attr(&#39;src&#39;, result[&#39;image_url&#39;]);</span><br><span class="line">     			$(&#39;#id_captcha_0&#39;).val(result[&#39;key&#39;])</span><br><span class="line">     &#125;);</span><br><span class="line"> &#125;);</span><br><span class="line"> &#125;)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>步骤三.  views.py视图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import json</span><br><span class="line">from captcha.helpers import captcha_image_url</span><br><span class="line">from captcha.models import CaptchaStore</span><br><span class="line">from django.contrib.auth import authenticate</span><br><span class="line">import django.contrib.auth as auth</span><br><span class="line">from django.contrib.auth.decorators import login_required</span><br><span class="line">from django.http import HttpResponse, JsonResponse</span><br><span class="line">from django.shortcuts import render, redirect</span><br><span class="line">def user_login(request):</span><br><span class="line">	if request.method &#x3D;&#x3D; &quot;POST&quot;:</span><br><span class="line">		form &#x3D; LoginForm(request.POST)</span><br><span class="line">		if form.is_valid():</span><br><span class="line">			username &#x3D; form.cleaned_data.get(&#39;username&#39;)</span><br><span class="line">			password &#x3D; form.cleaned_data.get(&#39;password&#39;)</span><br><span class="line">			user &#x3D;authenticate(request,username&#x3D;username,password&#x3D;password)</span><br><span class="line">			if user:</span><br><span class="line">				auth.login(request,user)</span><br><span class="line">				return redirect(reverse(&quot;App03:home&quot;))</span><br><span class="line">	else:</span><br><span class="line">		form &#x3D; LoginForm()</span><br><span class="line">		# 跳转登录⻚⾯</span><br><span class="line">	return render(request,&#39;App03&#x2F;login.html&#39;,context&#x3D;&#123;&#39;form&#39;:form&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="Django-发送邮件"><a href="#Django-发送邮件" class="headerlink" title="Django 发送邮件"></a>Django 发送邮件</h1><h2 id="setting配置-1"><a href="#setting配置-1" class="headerlink" title="setting配置"></a>setting配置</h2><p>网易邮箱发送配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># smtp服务的邮箱服务器</span></span><br><span class="line">EMAIL_HOST = <span class="string">'smtp.126.com'</span></span><br><span class="line"><span class="comment"># smtp服务固定的端口是25</span></span><br><span class="line">EMAIL_PORT = <span class="number">25</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#发送邮件的邮箱</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">'zysheep@126.com'</span></span><br><span class="line"><span class="comment">#在邮箱中设置的客户端授权密码</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">'TLNOFJSYQPYWISOA'</span></span><br><span class="line"><span class="comment">#收件人看到的发件人 &lt;此处要和发送邮件的邮箱相同&gt;</span></span><br><span class="line">EMAIL_FROM = <span class="string">'小满&lt;zysheep@126.com&gt;'</span></span><br></pre></td></tr></table></figure>

<p>QQ邮箱发送配置:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># smtp服务的邮箱服务器</span></span><br><span class="line">EMAIL_HOST = <span class="string">'smtp.qq.com'</span></span><br><span class="line"><span class="comment"># smtp服务固定的端口是25 如果不好使,就换成465</span></span><br><span class="line">EMAIL_PORT = <span class="number">25</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#发送邮件的邮箱</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">'xxx@qq.com'</span> </span><br><span class="line"><span class="comment">#在邮箱中设置的客户端授权密码</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">'TLNOFJSYQPYWISOA'</span></span><br><span class="line">EMAIL_USE_TLS = <span class="literal">True</span> <span class="comment"># 必须设置为True,否则发送不成功</span></span><br><span class="line"><span class="comment">#收件人看到的发件人 &lt;此处要和发送邮件的邮箱相同&gt;</span></span><br><span class="line">EMAIL_FROM = <span class="string">'xxx@qq.com'</span></span><br></pre></td></tr></table></figure>

<h2 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h2>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mail_send</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment">#1.发送一封邮件</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    subject: 主题</span></span><br><span class="line"><span class="string">    message: 内容</span></span><br><span class="line"><span class="string">    from_email: 收件人看到的发件人 &lt;此处要和发送邮件的邮箱相同&gt; 如  EMAIL_FROM = '小满&lt;zysheep@126.com&gt;'</span></span><br><span class="line"><span class="string">    recipient_list: 收件人名单可以发送个多个</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">   	res = send_mail(<span class="string">'习近平回信勉励北京大学援鄂医疗队全体'</span>,<span class="string">'习近平指出，青年一代有理想、有本领、有担当，国家就有前途'</span>,EMAIL_FROM,[<span class="string">'ivan15096000421@163.com'</span>,<span class="string">'15096000421@qq.com'</span>])</span><br><span class="line">   </span><br><span class="line">    <span class="comment">#2.发送多封邮件</span></span><br><span class="line">    </span><br><span class="line">     <span class="comment"># 发送多封邮件</span></span><br><span class="line">    message1 = (<span class="string">'习近平回信勉励北京大学'</span>, <span class="string">'&lt;b&gt;近平指出，青年一代有理想&lt;/b&gt;'</span>, EMAIL_FROM, [<span class="string">'ivan15096000421@163.com'</span>,<span class="string">'15096000421@qq.com'</span>])</span><br><span class="line">    message2 = (<span class="string">'习近平回信勉励北京大学'</span>, <span class="string">'&lt;b&gt;近平指出，青年一代有理想&lt;/b&gt;'</span>, EMAIL_FROM, [<span class="string">'ivan15096000421@163.com'</span>,<span class="string">'15096000421@qq.com'</span>])</span><br><span class="line">    send_mass_mail((message1, message2), fail_silently=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#3.html格式邮件</span></span><br><span class="line">    html_content = loader.get_template(<span class="string">'active.html'</span>).render(&#123;<span class="string">'username'</span>: <span class="string">'小花猫'</span>&#125;)</span><br><span class="line">    msg = EmailMultiAlternatives(<span class="string">'小满博客温馨提示!'</span>, from_email=EMAIL_FROM, to=[<span class="string">'15096000421@qq.com'</span>])</span><br><span class="line">    msg.attach_alternative(html_content, <span class="string">"text/html"</span>)</span><br><span class="line">    msg.send()</span><br><span class="line">    <span class="comment"># 3.1 html格式邮件,第二种格式</span></span><br><span class="line">     <span class="comment"># 加载模板 并渲染模板</span></span><br><span class="line">    html = loader.get_template(<span class="string">'active.html'</span>).render(&#123;<span class="string">'url'</span>:url&#125;)</span><br><span class="line">    print(url)</span><br><span class="line">    send_mail(<span class="string">"账号激活"</span>,<span class="string">''</span>,EMAIL_FROM,[<span class="string">'15096000421@qq.com'</span>],html_message=html)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"邮件发送"</span>)</span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200828112618.png" alt=""></p>
<h2 id="邮箱验证激活"><a href="#邮箱验证激活" class="headerlink" title="邮箱验证激活"></a>邮箱验证激活</h2><h3 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h3><ol>
<li>处理用户注册数据,存入数据库,is_active字段设置为False,用户认证之前不允许登录</li>
<li>产⽣token，⽣成验证连接URL</li>
<li>发送验证邮箱</li>
<li>用户通过认证邮箱点击验证链接,设置is_active字段为True,可以登录</li>
<li>若验证链接过期,删除用户在数据库中的注册信息,允许用户重新注册(username,email字段具有唯一性)</li>
</ol>
<h3 id="验证邮箱链接"><a href="#验证邮箱链接" class="headerlink" title="验证邮箱链接"></a>验证邮箱链接</h3><ul>
<li>产生token,发送邮件</li>
<li>处理验证链接,这里采用base64加密,及itsdangerous第三方库序列化(自带时间戳)<ul>
<li>itsdangerous需要下载:<code>pip install  itsdangerous</code></li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> URLSafeTimedSerializer <span class="keyword">as</span> utsr</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings <span class="keyword">as</span> django_settings</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Token</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, security_key)</span>:</span></span><br><span class="line">        self.security_key = security_key</span><br><span class="line">        self.salt = base64.encodebytes(security_key.encode(<span class="string">'utf8'</span>))</span><br><span class="line">    <span class="comment"># 生成token (自带时间戳)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_validate_token</span><span class="params">(self, username)</span>:</span></span><br><span class="line">        serializer = utsr(self.security_key)</span><br><span class="line">        <span class="keyword">return</span> serializer.dumps(username, self.salt)</span><br><span class="line">    <span class="comment"># 验证token</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">confirm_validate_token</span><span class="params">(self, token, expiration=<span class="number">3600</span>)</span>:</span></span><br><span class="line">        serializer = utsr(self.security_key)</span><br><span class="line">        <span class="keyword">return</span> serializer.loads(token, salt=self.salt, max_age=expiration)</span><br><span class="line">    <span class="comment"># 移除token</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove_validate_token</span><span class="params">(self, token)</span>:</span></span><br><span class="line">        serializer = utsr(self.security_key)</span><br><span class="line">        print(serializer.loads(token, salt=self.salt))</span><br><span class="line">        <span class="keyword">return</span> serializer.loads(token, salt=self.salt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">token_confirm = Token(django_settings.SECRET_KEY)    <span class="comment"># 定义为全局变量</span></span><br></pre></td></tr></table></figure>

<h3 id="注册发送邮箱"><a href="#注册发送邮箱" class="headerlink" title="注册发送邮箱"></a>注册发送邮箱</h3><p>模型:models.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    uid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = models.CharField(unique=<span class="literal">True</span>, max_length=<span class="number">30</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">128</span>)</span><br><span class="line">    regtime = models.DateTimeField(auto_now=<span class="literal">True</span>)</span><br><span class="line">    sex = models.IntegerField(blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    is_active = models.IntegerField(default=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'user'</span></span><br></pre></td></tr></table></figure>

<p>路由:urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app_name=<span class="string">'App'</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 邮件验证</span></span><br><span class="line">    path(<span class="string">'checkuser/'</span>,views.check_user,name=<span class="string">'checkuser'</span>),</span><br><span class="line">    path(<span class="string">'active/&lt;token&gt;/'</span>,views.active_user,name=<span class="string">'activeuser'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>模板: register.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&#123;% url 'App:checkuser' %&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>active.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>账户激活<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>亲爱的用户：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>请点击链接 <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; url &#125;&#125;"</span>&gt;</span>激活 <span class="tag">&lt;/<span class="name">a</span>&gt;</span> 账号<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>视图: views.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_user</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">'POST'</span>:</span><br><span class="line">        username = request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">        password = request.POST.get(<span class="string">'password'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检测用户是否存在</span></span><br><span class="line">        user = User.objects.filter(username=username,password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">"用户已经存在"</span>)</span><br><span class="line">        <span class="comment"># 保存用户信息</span></span><br><span class="line">        <span class="comment"># 刚注册的用户是未激活</span></span><br><span class="line">        user = User.objects.create(username=username,password=password,is_active=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 发送邮件，确认激活</span></span><br><span class="line">        token = token_confirm.generate_validate_token(user.uid)</span><br><span class="line">        print(token)</span><br><span class="line">        <span class="comment"># 构造验证url</span></span><br><span class="line">        url = <span class="string">"http://"</span>+request.get_host()+reverse(<span class="string">"App:activeuser"</span>,kwargs=&#123;<span class="string">'token'</span>:token&#125;)</span><br><span class="line">        <span class="comment"># 加载模板 并渲染模板</span></span><br><span class="line">        html = loader.get_template(<span class="string">'active.html'</span>).render(&#123;<span class="string">'url'</span>:url&#125;)</span><br><span class="line">        print(url)</span><br><span class="line">        send_mail(<span class="string">"账号激活"</span>,<span class="string">''</span>,EMAIL_FROM,[<span class="string">'15096000421@qq.com'</span>],html_message=html)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"激活邮件已经发送，请登录邮箱确认激活"</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'register.html'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="激活用户"><a href="#激活用户" class="headerlink" title="激活用户"></a>激活用户</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">active_user</span><span class="params">(request,token)</span>:</span></span><br><span class="line">    <span class="comment"># 激活用户</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        uid = token_confirm.confirm_validate_token(token)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            uid = token_confirm.remove_validate_token(token)</span><br><span class="line">            user = User.objects.get(pk=uid)</span><br><span class="line">            user.delete()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"激活失败，请重新注册"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = User.objects.get(pk=uid)</span><br><span class="line">    <span class="keyword">except</span> User.DoesNotExist:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"你激活的用户不存在，请重新注册"</span>)</span><br><span class="line">    user.is_active = <span class="number">1</span>  <span class="comment"># 激活用户</span></span><br><span class="line">    user.save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"用户已激活，请登录系统"</span>)</span><br></pre></td></tr></table></figure>

<h1 id="Django-富文本编辑器"><a href="#Django-富文本编辑器" class="headerlink" title="Django 富文本编辑器"></a>Django 富文本编辑器</h1><p>⼀般⽤于写⽂章 编辑内容⾃带样式</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-tinymce</span><br></pre></td></tr></table></figure>

<h2 id="配置settings⽂件"><a href="#配置settings⽂件" class="headerlink" title="配置settings⽂件"></a>配置settings⽂件</h2><p>在INSTALL_APPS 添加如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS &#x3D; [</span><br><span class="line"> ...</span><br><span class="line"> &#39;tinymce&#39;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>在settings.py下添加如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#富⽂本编辑器的配置</span><br><span class="line">TINYMCE_DEFAULT_CONFIG &#x3D; &#123;</span><br><span class="line"> &#39;theme&#39;:&#39;advanced&#39;,</span><br><span class="line"> &#39;width&#39;:600,</span><br><span class="line"> &#39;height&#39;:400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加视图函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def index(req):</span><br><span class="line">    if req.method &#x3D;&#x3D; &#39;GET&#39;:</span><br><span class="line">    	return render(req,&#39;index.html&#39;)</span><br><span class="line">    if req.method &#x3D;&#x3D; &#39;POST&#39;:</span><br><span class="line">        # print(req.POST) </span><br><span class="line">        Posts(title&#x3D;req.POST.get(&#39;title&#39;),content&#x3D;req.POST.get(&#39;content&#39;)).save()</span><br><span class="line">        return HttpResponse(&#39;index&#39;)</span><br></pre></td></tr></table></figure>

<p> 前台模板的展示</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/static/tiny_mce/tiny_mce.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"> tinyMCE.init(&#123;</span><br><span class="line"><span class="actionscript">     <span class="string">'mode'</span>:<span class="string">'textareas'</span>,</span></span><br><span class="line"><span class="actionscript">     <span class="string">'width'</span>:<span class="number">800</span>,</span></span><br><span class="line"><span class="actionscript">     <span class="string">'height'</span>:<span class="number">600</span>,</span></span><br><span class="line"> &#125;)</span><br><span class="line"> <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">     &#123;% csrf_token %&#125;</span><br><span class="line"> <span class="tag">&lt;<span class="name">p</span>&gt;</span>标题 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"title"</span> <span class="attr">placeholder</span>=<span class="string">"请输⼊标题"</span><span class="attr">maxlength</span>=<span class="string">"20"</span> <span class="attr">required</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">"content"</span> <span class="attr">id</span>=<span class="string">""</span> <span class="attr">cols</span>=<span class="string">"30"</span> <span class="attr">rows</span>=<span class="string">"10"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="Django-文件上传"><a href="#Django-文件上传" class="headerlink" title="Django 文件上传"></a>Django 文件上传</h1><h2 id="表单注意"><a href="#表单注意" class="headerlink" title="表单注意"></a>表单注意</h2><ul>
<li><p>表单的enctype的值需要设置为：enctype=”multipart/form-data</p>
</li>
<li><p>表单提交类型为POST </p>
<h2 id="储存路径"><a href="#储存路径" class="headerlink" title="储存路径"></a>储存路径</h2></li>
</ul>
<p>在settings.py⽂件下添加如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#设置上传⽂件路径</span><br><span class="line">MDEIA_ROOT &#x3D; os.path.join(BASE_DIR,&#39;static&#x2F;upload&#39;)</span><br></pre></td></tr></table></figure>

<h2 id="文件上传对象的属性和方法"><a href="#文件上传对象的属性和方法" class="headerlink" title="文件上传对象的属性和方法"></a>文件上传对象的属性和方法</h2><table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>file.name</td>
<td>获取上传的名称</td>
</tr>
<tr>
<td>file.size</td>
<td>获取上传⽂件的大小(字节)</td>
</tr>
<tr>
<td>file.read()</td>
<td>读取全部(适用于小文件)</td>
</tr>
<tr>
<td>file.chunks()</td>
<td>按块来返回文件 通过for循环进⾏迭代，可以将大⽂件按照块来写入到服务器</td>
</tr>
<tr>
<td>file.multiple_chunks()</td>
<td>判断文件是否大于2.5M 返回True或者False</td>
</tr>
</tbody></table>
<h2 id="创建上传文件的表单"><a href="#创建上传文件的表单" class="headerlink" title="创建上传文件的表单"></a>创建上传文件的表单</h2><p>前端模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt; &lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;Title&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action&#x3D;&quot;&#x2F;doUpload&#x2F;&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;formdata&quot;&gt;</span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    &lt;p&gt;⽂件 &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot;&gt;&lt;&#x2F;p&gt;</span><br><span class="line">    &lt;p&gt;&lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;上传&quot;&gt;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>views.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment">#⽂件上传处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">doUpload</span><span class="params">(req)</span>:</span></span><br><span class="line">    file = req.FILES.get(<span class="string">'file'</span>)</span><br><span class="line">    <span class="comment"># print(file.name)</span></span><br><span class="line">    <span class="comment"># print(file.size)</span></span><br><span class="line">    savePath = os.path.join(settings.MDEIA_ROOT,file.name)</span><br><span class="line">    <span class="comment"># print(savePath)</span></span><br><span class="line">    <span class="keyword">with</span> open(savePath,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="comment"># f.write(file.read())</span></span><br><span class="line">        <span class="keyword">if</span> file.multiple_chunks():</span><br><span class="line">            <span class="keyword">for</span> myf <span class="keyword">in</span> file.chunks():</span><br><span class="line">                f.write(myf)</span><br><span class="line">            print(<span class="string">'⼤于2.5'</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			print(<span class="string">'⼩于2.5'</span>)</span><br><span class="line">			f.write(file.read())</span><br><span class="line">	<span class="keyword">return</span> HttpResponse(<span class="string">'文件上传'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="封装文件上传的类"><a href="#封装文件上传的类" class="headerlink" title="封装文件上传的类"></a>封装文件上传的类</h2><p>可以⾃定义⼀个类实现⽂件上传，⽂件上传类可以：</p>
<ul>
<li>检查文件类型</li>
<li>检查文件大小</li>
<li>是否生成随机文件名</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileUpload</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file, exts=<span class="params">(<span class="string">'png'</span>,<span class="string">'jpg'</span>,<span class="string">'jpeg'</span>)</span>, size=<span class="number">1024</span>*<span class="number">1024</span>,is_randomname=False)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param file: 文件上传对象</span></span><br><span class="line"><span class="string">        :param exts: 文件类型</span></span><br><span class="line"><span class="string">        :param size: 文件大小，默认1M</span></span><br><span class="line"><span class="string">        :param is_randomname: 是否是随机文件名，默认是否</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.file = file</span><br><span class="line">        self.exts = exts</span><br><span class="line">        self.size = size</span><br><span class="line">        self.is_randomname = is_randomname</span><br><span class="line"></span><br><span class="line">    <span class="comment">#文件上传</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(self,dest)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param dest: 文件上传的目标目录</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment">#1 判断文件类型是否匹配</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.check_type():</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">        <span class="comment">#2 判断文件大小是否符合要求</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.check_size():</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-2</span></span><br><span class="line">        <span class="comment">#3 如果是随机文件名，要生成随机文件名</span></span><br><span class="line">        <span class="keyword">if</span> self.is_randomname:</span><br><span class="line">            self.file_name = self.random_filename()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.file_name = self.file.name</span><br><span class="line">        <span class="comment">#4 拼接目标文件路径</span></span><br><span class="line">        path = os.path.join(dest,self.file_name)</span><br><span class="line">        <span class="comment">#5 保存文件</span></span><br><span class="line">        self.write_file(path)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_type</span><span class="params">(self)</span>:</span></span><br><span class="line">        ext = os.path.splitext(self.file.name)</span><br><span class="line">        <span class="keyword">if</span> len(ext) &gt; <span class="number">1</span>:</span><br><span class="line">            ext = ext[<span class="number">1</span>].lstrip(<span class="string">'.'</span>)</span><br><span class="line">            <span class="keyword">if</span> ext <span class="keyword">in</span> self.exts:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_size</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.size &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment">#如果文件大小于给定大小，返回True，否则返回False</span></span><br><span class="line">        <span class="keyword">return</span> self.file.size &lt;= self.size</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">random_filename</span><span class="params">(self)</span>:</span></span><br><span class="line">        filename = datetime.now().strftime(<span class="string">"%Y%m%d%H%M%S"</span>)+str(randint(<span class="number">1</span>,<span class="number">10000</span>))</span><br><span class="line">        ext = os.path.splitext(self.file.name)</span><br><span class="line">        <span class="comment">#获取文件后缀</span></span><br><span class="line">        ext = ext[<span class="number">1</span>] <span class="keyword">if</span> len(ext)&gt;<span class="number">1</span> <span class="keyword">else</span> <span class="string">''</span></span><br><span class="line">        filename += ext</span><br><span class="line">        <span class="keyword">return</span>  filename</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_file</span><span class="params">(self,path)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(path,<span class="string">'wb'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">            <span class="keyword">if</span> self.file.multiple_chunks():</span><br><span class="line">                <span class="keyword">for</span> chunk <span class="keyword">in</span> self.file.chunks():</span><br><span class="line">                    fp.write(chunk)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                fp.write(self.file.read())</span><br></pre></td></tr></table></figure>

<h1 id="Django-站点管理"><a href="#Django-站点管理" class="headerlink" title="Django 站点管理"></a>Django 站点管理</h1><h2 id="配置admin应用"><a href="#配置admin应用" class="headerlink" title="配置admin应用"></a>配置admin应用</h2><p>默认django添加这个应用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS &#x3D; [</span><br><span class="line">    django.contrib.admin</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="创建管理员用户"><a href="#创建管理员用户" class="headerlink" title="创建管理员用户"></a>创建管理员用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createsuperuser</span><br></pre></td></tr></table></figure>

<blockquote>
<p>依次输入用户名-&gt;邮箱-&gt;密码-&gt;确认密码</p>
</blockquote>
<h2 id="汉化"><a href="#汉化" class="headerlink" title="汉化"></a>汉化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGE_CODE &#x3D; &#39;zh-Hans&#39;</span><br><span class="line">TIME_ZONE &#x3D; &#39;Asia&#x2F;Shanghai&#39;</span><br></pre></td></tr></table></figure>

<h2 id="在App-admin-py-里面注册自己的模型类"><a href="#在App-admin-py-里面注册自己的模型类" class="headerlink" title="在App/admin.py 里面注册自己的模型类"></a>在App/admin.py 里面注册自己的模型类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from .models import Grade,Students</span><br><span class="line">#注册模型类 在后台展示</span><br><span class="line">admin.site.register(Grade)</span><br><span class="line">admin.site.register(Students)</span><br></pre></td></tr></table></figure>

<h2 id="配置后台页面和添加数据的展示"><a href="#配置后台页面和添加数据的展示" class="headerlink" title="配置后台页面和添加数据的展示"></a>配置后台页面和添加数据的展示</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置数据的展示</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GradeAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    <span class="comment">#设置显示哪些字段</span></span><br><span class="line">    list_display = [<span class="string">'pk'</span>,<span class="string">'gname'</span>,<span class="string">'gboynum'</span>,<span class="string">'ggirlnum'</span>]</span><br><span class="line">    <span class="comment">#添加搜索字段</span></span><br><span class="line">    search_fields = [<span class="string">'gname'</span>]</span><br><span class="line">    <span class="comment"># 分⻚</span></span><br><span class="line">    list_per_page = <span class="number">5</span></span><br><span class="line">    <span class="comment"># 过滤字段‘</span></span><br><span class="line">    list_filter = [<span class="string">'gname'</span>]</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentsAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'pk'</span>,<span class="string">'sname'</span>,<span class="string">'ssex'</span>,<span class="string">'sage'</span>,<span class="string">'grade'</span>]</span><br><span class="line">    search_fields = [<span class="string">'sname'</span>]</span><br><span class="line">    <span class="comment">#分⻚</span></span><br><span class="line">    list_per_page = <span class="number">5</span></span><br><span class="line">    <span class="comment">#过滤字段‘</span></span><br><span class="line">    list_filter = [<span class="string">'sname'</span>]</span><br><span class="line">    <span class="comment">#更改添加 修改的字段属性的位置</span></span><br><span class="line">    <span class="comment"># fields = ['sage','ssex','sname','grade','info']</span></span><br><span class="line">    fieldsets = [</span><br><span class="line">        (<span class="string">"基本信息"</span>,&#123;<span class="string">"fields"</span>:[<span class="string">'sname'</span>,<span class="string">'sage'</span>,<span class="string">'ssex'</span>]&#125;),</span><br><span class="line">        (<span class="string">"其它信息"</span>,&#123;<span class="string">'fields'</span>:[<span class="string">'info'</span>,<span class="string">'grade'</span>]&#125;),</span><br><span class="line">    ]</span><br><span class="line"><span class="comment">#字段顺序和字段分组不能同时使⽤</span></span><br><span class="line"><span class="comment">#注册模型类 在后台展示</span></span><br><span class="line">admin.site.register(Grade,GradeAdmin)</span><br><span class="line">admin.site.register(Students,StudentsAdmin)</span><br></pre></td></tr></table></figure>

<h2 id="关联对象"><a href="#关联对象" class="headerlink" title="关联对象"></a>关联对象</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#TabularInline 横着展示添加学⽣的布局</span></span><br><span class="line"><span class="comment">#StackedInline 竖着展示添加学⽣的布局</span></span><br><span class="line"><span class="comment"># class AddStudents(admin.TabularInline):</span></span><br><span class="line"><span class="comment">#class AddStudents(admin.StackedInline):</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddStudents</span><span class="params">(admin.TabularInline)</span>:</span></span><br><span class="line">    model = Students <span class="comment">#关联的模型名称</span></span><br><span class="line">    extra = <span class="number">2</span> <span class="comment">#添加学⽣的个数</span></span><br><span class="line"><span class="comment">#配置数据的展示</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GradeAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    inlines = [AddStudents]</span><br></pre></td></tr></table></figure>

<h2 id="bool值的显示男女"><a href="#bool值的显示男女" class="headerlink" title="bool值的显示男女"></a>bool值的显示男女</h2><p>models.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssex</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.sex:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'男'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'⼥'</span></span><br></pre></td></tr></table></figure>

<p>在admin.py中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list_display &#x3D; [&#39;pk&#39;,&#39;sname&#39;,ssex,&#39;sage&#39;,&#39;grade&#39;]</span><br></pre></td></tr></table></figure>

<h1 id="Django-中间件"><a href="#Django-中间件" class="headerlink" title="Django 中间件"></a>Django 中间件</h1><p>中间件其实就是⼀个类，是介于request与response处理之间的⼀道处理过程（类似装饰器），相对比较轻量级，每个中间件都会负责⼀个功能，例如，AuthenticationMiddleware,与sessions处理相关，中间件，在请求到来和结束后，django会根据⾃⼰的规则在合适的时机执行中间件中相应的方法并且在全局上改变django的输⼊与输出。因为改变的是全局，所以需要谨慎使用，用不好会影响到性能</p>
<h2 id="Django-中间件作用和可实现功能"><a href="#Django-中间件作用和可实现功能" class="headerlink" title="Django 中间件作用和可实现功能"></a>Django 中间件作用和可实现功能</h2><h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><ul>
<li>修改请求，即传送到 view 中的 HttpRequest 对象。</li>
<li>修改响应，即 view 返回的 HttpResponse 对象。</li>
</ul>
<h3 id="可实现功能"><a href="#可实现功能" class="headerlink" title="可实现功能"></a>可实现功能</h3><ul>
<li>统计</li>
<li>黑名单</li>
<li>白名单</li>
<li>界面友好化（捕获异常）</li>
</ul>
<p>Django 默认的中间件配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 中间件重上往下执行</span><br><span class="line">MIDDLEWARE &#x3D; [</span><br><span class="line">    &#39;django.middleware.security.SecurityMiddleware&#39;,</span><br><span class="line">    &#39;django.contrib.sessions.middleware.SessionMiddleware&#39;,</span><br><span class="line">    &#39;django.middleware.common.CommonMiddleware&#39;,</span><br><span class="line">    &#39;django.middleware.csrf.CsrfViewMiddleware&#39;,</span><br><span class="line">    &#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;,</span><br><span class="line">    &#39;django.contrib.messages.middleware.MessageMiddleware&#39;,</span><br><span class="line">    &#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="中间件执行过程"><a href="#中间件执行过程" class="headerlink" title="中间件执行过程"></a>中间件执行过程</h2><p>用户请求到达中间件之后，先按照正序执行每个注册中间件,的<code>process_request</code>方法，<code>process_request</code>方法返回的值是<code>None</code>，就依次执行，如果返回的值是<code>HttpResponse</code>对象，不再执行后面的<code>process_request</code>方法，而是执行当前对应中间件的<code>process_response</code>方法，将<code>HttpResponse</code>对象返回给浏览器。(<strong>下图红色路线进行</strong>)也就是说：如果MIDDLEWARE中注册了6个中间件，执行过程中，第3个中间件返回了⼀个<code>HttpResponse</code>对象，那么第4,5,6中间件的<code>process_request</code>和<code>process_response</code>方法都不执行，顺序执行3,2,1中间件的<code>process_response</code>方法。</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200828163018.png" alt=""></p>
<p><code>process_request</code>方法都执行完后，匹配路由，找到要执行的视图函数，先不执行视图函数，先执行中间件中的<code>process_view</code>方法，<code>process_view</code>方法返回 None，继续按顺序执行，所有<code>process_view</code>方法执行完后执行视图函数。假如中间件3 的<code>process_view</code>方法返回了<code>HttpResponse</code>对象，则4,5,6的<code>process_view</code>以及视图函数都不执行，直接从最后⼀个中间件，也就是中间件6的process_response方法开始倒序执行。</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200828154153.png" alt=""></p>
<h2 id="Django中的中间件方法"><a href="#Django中的中间件方法" class="headerlink" title="Django中的中间件方法"></a>Django中的中间件方法</h2><h3 id="process-request"><a href="#process-request" class="headerlink" title="process_request"></a>process_request</h3><p>在执行路由前被调⽤，每个请求上都会调⽤，不主动进行返回或返回HttpResponse对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process_request(self, request)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>request，是⼀个HttpRequest请求对象</li>
</ul>
<p>返回值：</p>
<p>返回None会继续调用下⼀个中间件的process_request方法，返回HttpResponse，则执行自己process_response</p>
<h3 id="process-view"><a href="#process-view" class="headerlink" title="process_view"></a>process_view</h3><p>调用视图之前执行，每个请求都会调用，不主动进行返回或返回HttpResponse对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process_view(self,request,view_func,view_args,view_kwargs)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>request：HttpRequest对象</li>
<li>view_func：是⼀个即将调⽤的视图函数，不是字符串函数名</li>
<li>view_args：传递给视图函数的位置参数</li>
<li>view_kwargs：传递给视图函数的关键字参数</li>
</ul>
<p>返回值：</p>
<p>如果返回None，会继续执行处理此请求，然后调⽤下⼀个中间件的process_view，直⾄执行视图函数；如果返回HttpResponse,则直接执行最后⼀个中间件的process_response</p>
<h3 id="process-template-response"><a href="#process-template-response" class="headerlink" title="process_template_response"></a>process_template_response</h3><p>在视图刚好执⾏完后进⾏调⽤，只要视图返回⼀个render⽅法返回的对象，就会调⽤process_template_response，不主动进⾏返回或返回HttpResponse对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process_template_response(self, request, response)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>request HttpRequest对象</li>
<li>response 是⼀个由Django view或者中间件返回的</li>
<li>TemplateResponse 对象</li>
</ul>
<p>返回值： </p>
<p>必须返回⼀个render⽅法执⾏后的response对象，它可以修改view中返回的 response.template_name 和 response.context_data，或者为view返回的模板增加⼀个商标等等。你不需要明确的渲染响应，当所有的template响应中间件处理完成后会被⾃动渲染</p>
<h3 id="process-response"><a href="#process-response" class="headerlink" title="process_response"></a>process_response</h3><p>所有响应返回浏览器之前调用，每个请求都会调用，返回HttpResponse对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process_response(self,request,response)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>request :HttpRequest对象</li>
<li>response : HttpResponse对象</li>
</ul>
<p>返回值：必须是HttpResponse对象</p>
<h3 id="process-exception"><a href="#process-exception" class="headerlink" title="process_exception"></a>process_exception</h3><p>当视图抛出异常时调⽤，返回None或返回HttpResponse对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process_exception(self,request,exception)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>request: HttpRequest 对象 </li>
<li>exception:view函数中raise的Exception对象，当view 函数raise⼀个exception的时候调⽤process_exception</li>
</ul>
<h2 id="自定义中间件"><a href="#自定义中间件" class="headerlink" title="自定义中间件"></a>自定义中间件</h2><p>App下<code>Mymiddleware.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"><span class="comment"># 自定义中间件必须继承MiddlewareMixin类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        print(<span class="string">"=====1. process_request===="</span>,request.method)</span><br><span class="line">        <span class="comment"># 全局路由保护</span></span><br><span class="line">        <span class="comment">#print(request.path)</span></span><br><span class="line">        username = request.session.get(<span class="string">'username'</span>)</span><br><span class="line">        <span class="keyword">if</span> username:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">elif</span> request.path <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'/login/'</span>]:  <span class="comment"># 请求的不是登录界面</span></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">"/login/"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self,request,view_func,view_args,view_kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">"=====2. process_view===="</span>,<span class="string">"先执行process_view视图函数在执行自定义的视图函数"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self,request,response)</span>:</span></span><br><span class="line">        print(<span class="string">"=====3. process_response===="</span>,<span class="string">"响应返回浏览器之前调用"</span>)</span><br><span class="line">        <span class="keyword">return</span> response   <span class="comment"># 必须返回相应对象  </span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 异常处理</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception)</span>:</span></span><br><span class="line">        print(<span class="string">"exception"</span>)</span><br><span class="line">        <span class="comment"># 对管理员展示错误页面，一般用户只能看到404,500等页面</span></span><br><span class="line">        ip = request.META.get(<span class="string">'REMOTE_ADDR'</span>)</span><br><span class="line">        <span class="keyword">if</span> ip == <span class="string">'127.0.0.9'</span>:</span><br><span class="line">            <span class="keyword">return</span> technical_500_response(request, *sys.exc_info())</span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">"App02:index"</span>))</span><br></pre></td></tr></table></figure>

<p>启用中间件</p>
<p>在settings中进⾏配置，MIDDLEWARE中添加：模块名.Mymiddleware.类名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line"> .......</span><br><span class="line"> <span class="string">'App.Mymiddleware.Mymiddleware'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h1 id="Django-缓存"><a href="#Django-缓存" class="headerlink" title="Django 缓存"></a>Django 缓存</h1><p>缓存是一类可以更快的读取数据的介质统称，也指其它可以加快数据读取的存储方式。</p>
<p>在Django中，当用户请求到达视图后，视图会先从数据库提取数据放到模板中进行动态渲染，渲染后的结果就是用户看到的网页。如果用户每次请求都从数据库提取数据并渲染，将极大降低性能，不仅服务器压力大，而且客户端也无法即时获得响应。如果能将渲染后的结果放到速度更快的缓存中，每次有请求过来，先检查缓存中是否有对应的资源，如果有，直接从缓存中取出来返回响应，节省取数据和渲染的时间，不仅能大大提高系统性能，还能提高用户体验。</p>
<blockquote>
<p><strong>缓存使用场景</strong>：缓存主要适用于对⻚面实时性要求不高的⻚面。存放在缓存的数据，通常是频繁访问的，而不会经常修改的数据。</p>
</blockquote>
<p> 缓存方式：</p>
<ul>
<li>数据库</li>
<li>文件</li>
<li>内存</li>
<li>redis等</li>
</ul>
<h2 id="缓存配置"><a href="#缓存配置" class="headerlink" title="缓存配置"></a>缓存配置</h2><h3 id="数据库缓存"><a href="#数据库缓存" class="headerlink" title="数据库缓存"></a>数据库缓存</h3><p>settings.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">'default'</span>:&#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>:<span class="string">'django.core.cache.backends.db.DatabaseCache'</span>, <span class="string">'LOCATION'</span>:<span class="string">'my_cache_table'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成缓存表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createcachetable</span><br></pre></td></tr></table></figure>

<h3 id="文件缓存"><a href="#文件缓存" class="headerlink" title="文件缓存"></a>文件缓存</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>:</span><br><span class="line">        <span class="string">'django.core.cache.backends.filebased.FileBasedCache'</span>, <span class="comment">#指定缓存使⽤的引擎</span></span><br><span class="line">        <span class="string">'LOCATION'</span>: <span class="string">'/var/tmp/django_cache'</span>, <span class="comment">#指定缓存的路径</span></span><br><span class="line">        <span class="string">'TIMEOUT'</span>:<span class="number">300</span>, <span class="comment">#缓存超时时间(默认为300秒,None表示永不过期)</span></span><br><span class="line">        <span class="string">'OPTIONS'</span>:&#123;</span><br><span class="line">            <span class="string">'MAX_ENTRIES'</span>: <span class="number">300</span>, <span class="comment"># 最⼤缓存记录的数量（默认300）</span></span><br><span class="line">            <span class="string">'CULL_FREQUENCY'</span>: <span class="number">3</span>, <span class="comment"># 缓存到达最⼤个数之后，剔除缓存个数的⽐例，即：1/CULL_FREQUENCY（默认3）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="redis缓存"><a href="#redis缓存" class="headerlink" title="redis缓存"></a>redis缓存</h3><p>需要安装：<code>pip install django-redis</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">'default'</span>:&#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>:<span class="string">'django_redis.cache.RedisCache'</span>,<span class="comment">#指定缓存类型redis缓存</span></span><br><span class="line">        <span class="string">'LOCATION'</span>:<span class="string">'redis://:123@127.0.0.1:6379/1'</span>, <span class="comment">#缓存地址，@前面是reids的密码，如果没有则去掉</span></span><br><span class="line">        <span class="comment"># 'LOCATION':'redis://127.0.0.1:6379/1', # 没密码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="缓存使用"><a href="#缓存使用" class="headerlink" title="缓存使用"></a>缓存使用</h2><h3 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page </span><br><span class="line"><span class="meta">@cache_page(60 * 0.5)	#缓存过期时间</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbcache</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'index.html'</span>,context=&#123;<span class="string">'content'</span>:<span class="number">77665</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="模板局部缓存"><a href="#模板局部缓存" class="headerlink" title="模板局部缓存"></a>模板局部缓存</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load cache %&#125;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        &#123;% cache 30 'content' %&#125;</span><br><span class="line">        &#123;&#123; content &#125;&#125;</span><br><span class="line">        &#123;% endcache %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="全站缓存"><a href="#全站缓存" class="headerlink" title="全站缓存"></a>全站缓存</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">'django.middleware.cache.UpdateCacheMiddleware'</span>, <span class="comment"># 必须是第一个中间件</span></span><br><span class="line">    .....</span><br><span class="line">    <span class="string">'django.middleware.cache.FetchFromCacheMiddleware'</span>, <span class="comment"># 必须是最后一个中间件</span></span><br><span class="line">]</span><br><span class="line">CACHE_MIDDLEWARE_SECONDS = <span class="number">20</span>	<span class="comment">#设置超时时间 20秒</span></span><br></pre></td></tr></table></figure>

<h3 id="手动设置缓存"><a href="#手动设置缓存" class="headerlink" title="手动设置缓存"></a>手动设置缓存</h3><ul>
<li>设置缓存：<code>cache.set（key,value,timeout)</code></li>
<li>获取缓存：<code>cache.get(key)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cache_data1</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 首先判断数据是否在缓存中，如果在直接获取</span></span><br><span class="line">    users = cache.get(<span class="string">'all_users'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> users:  <span class="comment"># 如果不在缓存,查询数据库，将结果写入缓存</span></span><br><span class="line">        users = User.objects.all()</span><br><span class="line">        <span class="comment"># cache可以直接把查询结果序列化</span></span><br><span class="line">        cache.set(<span class="string">'all_users'</span>,users)</span><br><span class="line">        print(<span class="string">"数据库"</span>)</span><br><span class="line">    print(users)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'index1.html'</span>,locals())</span><br></pre></td></tr></table></figure>

<h1 id="Django-异步任务队列"><a href="#Django-异步任务队列" class="headerlink" title="Django 异步任务队列"></a>Django 异步任务队列</h1><h2 id="Celery简介"><a href="#Celery简介" class="headerlink" title="Celery简介"></a>Celery简介</h2><p>Celery 是一个基于python开发的<strong>异步任务队列/基于分布式消息传递的作业队列</strong>， 通过它可以轻松的实现任务的异步处理。它侧重于实时操作，但对调度支持也很好。Celery用于生产系统每天处理数以百万计的任务。Celery是用Python编写的， 但该协议可以在任何语言实现。它也可以与其他语言通过webhooks实现。Celery建议的消息队列是<code>RabbitMQ</code>，但提供支持Redis, Beanstalk, MongoDB, CouchDB, 和数据库（使用SQLAlchemy的或Django的 ORM） 。<a href="http://docs.jinkan.org/docs/celery/" target="_blank" rel="noopener">Celery</a>是易于集成Django, Pylons 和 Flask，使用 django-celery, celery-pylons and Flask-Celery 附加包即可。它的特点：</p>
<ul>
<li><p>方便查看定时任务的执行情况, 如 是否成功, 当前状态, 执行任务花费的时间等. </p>
</li>
<li><p>使用功能齐备的管理后台或命令行添加,更新,删除任务</p>
</li>
<li><p>方便把任务和配置管理相关联</p>
</li>
<li><p>可选多进程, Eventlet 和 Gevent 三种模型并发执行</p>
</li>
<li><p>提供错误处理机制.</p>
</li>
<li><p>提供多种任务原语, 方便实现任务分组,拆分,和调用链</p>
</li>
<li><p>支持多种消息代理和存储后端.</p>
</li>
<li><p>Celery 是语言无关的，它提供了python 等常⻅语言的接口支持 </p>
</li>
</ul>
<h2 id="Celery的相关概念"><a href="#Celery的相关概念" class="headerlink" title="Celery的相关概念"></a>Celery的相关概念</h2><p>celery架构图</p>
<p><img src="http://cdn.panyucable.cn/zysheep/%E5%9B%BE%E7%89%871.png" alt=""></p>
<ul>
<li>task 就是任务，包括异步任务和定时任务</li>
<li>中间人，接收生产者发来的消息即Task，将任务存入队列。任务的消费者是Worker。Celery本身不提供队列服务，推荐用<code>Redis</code>或<code>RabbitMQ</code>实现 队列服务。</li>
<li>worker 执行任务的单元，它实时监控消息队列，如果有任务就获取任务并执行它</li>
<li>backend 用于存储任务的执行结果。Celery支持以不同方式存储任务的结果， 包括AMQP, <a href="http://lib.csdn.net/base/redis" target="_blank" rel="noopener">redis</a>，memcached, <a href="http://lib.csdn.net/base/mongodb" target="_blank" rel="noopener">mongodb</a>，SQLAlchemy, Django ORM， Apache Cassandra, IronCache 等。</li>
<li>beat 定时任务调度器，根据配置定时将任务发送给Broler。</li>
</ul>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li>异步调用：那些用户不关心的但是又存在在我们API里面的操作 我们就可以用异步调用的方式来优化（发送邮件或者上传头像）</li>
<li>定时任务：定期去统计日志，数据备份，或者其他的统计任务</li>
</ul>
<h2 id="Celery的安装"><a href="#Celery的安装" class="headerlink" title="Celery的安装"></a>Celery的安装</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install celery</span><br><span class="line">pip install celery-with-redis</span><br><span class="line">#django-celery-results库基于 Django ORM实现了结果存储后端</span><br><span class="line">pip install django-celery-results</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>在 settings.py文件中设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'celery'</span>,</span><br><span class="line">    <span class="string">'django_celery_results'</span>,	<span class="comment">#把 django_celery_results 加到INSTALLED_APPS 中</span></span><br><span class="line">    <span class="string">'自己的APP'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BROKER_URL=<span class="string">'redis://localhost:6379/5'</span></span><br><span class="line">     <span class="comment"># 任务序列化和反序列化使用json</span></span><br><span class="line">    CELERY_RESULT_BACKEND = <span class="string">'django-db'</span> </span><br><span class="line">    CELERY_TASK_SERIALIZER = <span class="string">'json'</span></span><br><span class="line">    CELERY_RESULT_SERIALIZER = <span class="string">'json'</span> <span class="comment"># 结果序列化为json</span></span><br></pre></td></tr></table></figure>

<h3 id="创建celery实例"><a href="#创建celery实例" class="headerlink" title="创建celery实例"></a>创建celery实例</h3><p>在settings.py的同级目录下新建celery.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import <span class="comment">#绝对路径导入</span></span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工程配置文件 os.environ.setdefault("DJANGO_SETTINGS_MODULE", "工程名.settings")</span></span><br><span class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"day08.settings"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例话celery对象</span></span><br><span class="line"><span class="comment"># 第一个参数是应用名称，必须给</span></span><br><span class="line">app = Celery(<span class="string">'mycelery'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置时区</span></span><br><span class="line">app.conf.timezone = <span class="string">"Asia/Shanghai"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取配置文件</span></span><br><span class="line">app.config_from_object(<span class="string">"django.conf:settings"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让celery 自动去发现我们的任务（task）</span></span><br><span class="line">app.autodiscover_tasks() <span class="comment">#你需要在app目录下 新建一个叫tasks.py（一定不要写错）文件</span></span><br></pre></td></tr></table></figure>

<p>在settings.py同级目录下的<strong>init</strong>.py加入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> future <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">from</span> .celery <span class="keyword">import</span> app <span class="keyword">as</span> celery_app</span><br></pre></td></tr></table></figure>

<h2 id="Celery的使用"><a href="#Celery的使用" class="headerlink" title="Celery的使用"></a>Celery的使用</h2><h3 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h3><p>在需要使用异步任务的APP目录下新建tasks.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 异步发送邮件</span></span><br><span class="line"><span class="meta">@shared_task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mail_send</span><span class="params">(mail)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    subject, message, from_email, recipient_list</span></span><br><span class="line"><span class="string">    :param mail: 字典  &#123;'subject':'hello'&#125;</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    send_mail(**mail,from_email=EMAIL_FROM)</span><br></pre></td></tr></table></figure>

<h3 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h3><p>在views.py内的调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任务函数名.delay(参数，，，，)</span></span><br><span class="line"><span class="comment"># 异步发送邮件</span></span><br><span class="line">    mail_send.delay(&#123;</span><br><span class="line">        <span class="string">'subject'</span>:<span class="string">'no zuo no die'</span>,</span><br><span class="line">        <span class="string">'message'</span>:<span class="string">'不作不死'</span>,</span><br><span class="line">        <span class="string">'recipient_list'</span>:[<span class="string">'15096000421@qq.com'</span>]</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="生成数据库表"><a href="#生成数据库表" class="headerlink" title="生成数据库表"></a>生成数据库表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate django_celery_results</span><br></pre></td></tr></table></figure>

<h3 id="启动worker"><a href="#启动worker" class="headerlink" title="启动worker"></a>启动worker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery -A 你的工程名 worker -l info</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：修改tasks.py的内容后 要重启celery的服务</p>
</blockquote>
<h3 id="获取任务执行结果"><a href="#获取任务执行结果" class="headerlink" title="获取任务执行结果"></a>获取任务执行结果</h3><p>异步任务执行完毕后，会自动触发信号：</p>
<ul>
<li>before_task_publish</li>
<li>after_task_publish</li>
<li>task_prerun </li>
<li>task_postrun </li>
<li>task_success </li>
<li>task_failure </li>
<li>task_revoked</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery.signals <span class="keyword">import</span> task_success </span><br><span class="line"><span class="meta">@task_success.connect(sender=add)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task_done_handler</span><span class="params">(sender=None,	result=None)</span>:</span> </span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure>

<h2 id="定时任务和计划任务"><a href="#定时任务和计划任务" class="headerlink" title="定时任务和计划任务"></a>定时任务和计划任务</h2><h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery -A 你的工程名称 beat -l info</span><br></pre></td></tr></table></figure>

<p>在settings.py文件添加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定时任务</span></span><br><span class="line">CELERYBEAT_SCHEDULE = &#123;</span><br><span class="line">     <span class="string">'schedule-test'</span>: &#123;</span><br><span class="line">         <span class="string">'task'</span>: <span class="string">'App.tasks.hello_world'</span>,</span><br><span class="line">         <span class="string">'schedule'</span>: timedelta(seconds=<span class="number">10</span>),</span><br><span class="line">         <span class="string">'args'</span>: (<span class="number">6</span>,)</span><br><span class="line">     &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="计划任务时间"><a href="#计划任务时间" class="headerlink" title="计划任务时间"></a>计划任务时间</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery.schedules <span class="keyword">import</span> crontab</span><br><span class="line">CELERYBEAT_SCHEDULE = &#123;</span><br><span class="line">	<span class="string">"every-ten-second-run-my_task"</span>: &#123;</span><br><span class="line">        <span class="string">"task"</span>: <span class="string">"App.tasks.do"</span>,</span><br><span class="line">        <span class="string">"schedule"</span>: crontab(minute=<span class="string">"05"</span>, hour=<span class="string">"16"</span>),</span><br><span class="line">       <span class="comment">#  "args": (2,)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong> 我们启动定时任务服务时 也要先开启worker。如果只开启定时服务 没有开启worker服务 那么定时任务会被放入任务队列，但是由于没有干活儿的worker  那么任务是不会被执行，当worker服务被启动后 会立刻去任务队列领任务并执行</p>
<blockquote>
<p>你的任务一定要确保是可以正常执行的</p>
</blockquote>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><h3 id="查看异步任务情况"><a href="#查看异步任务情况" class="headerlink" title="查看异步任务情况"></a><strong>查看异步任务情况</strong></h3><blockquote>
<p>Celery提供了一个工具ﬂower，将各个任务的执行情况、各个worker的健康  状态进行监控并以可视化的方式展现</p>
</blockquote>
<ol>
<li><p>安装flower</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flower</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动ﬂower（默认会启动一个webserver，端口为5555）:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery flower --broker&#x3D;redis:&#x2F;&#x2F;localhost:6379&#x2F;5</span><br></pre></td></tr></table></figure>
</li>
<li><p>即可查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:5555</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h3><blockquote>
<p>说明:⻓时间运行Celery有可能发生内存泄露，可以像下面这样设置</p>
<p>CELERYD_MAX_TASKS_PER_CHILD = 1000 # 每个worker执行了多少任务就会死掉</p>
</blockquote>
<h3 id="常用配置清单"><a href="#常用配置清单" class="headerlink" title="常用配置清单"></a>常用配置清单</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#from kombu import Queue, Exchange</span></span><br><span class="line"><span class="comment">#设置Broker和backend</span></span><br><span class="line">BROKER_URL = <span class="string">'redis://127.0.0.1:6379/0'</span></span><br><span class="line"><span class="comment"># 将数据存放到redis1数据库，redis默认有16个数据库</span></span><br><span class="line">CELERY_RESULT_BACKEND = <span class="string">'redis://127.0.0.1:6379/1'</span></span><br><span class="line"></span><br><span class="line">CELERY_TASK_SERIALIZER = <span class="string">'json'</span>	<span class="comment"># 任务序列化和反序列化使用json</span></span><br><span class="line">CELERY_RESULT_SERIALIZER = <span class="string">'json'</span>	<span class="comment">#结果序列化为json </span></span><br><span class="line">CELERY_ACCEPT_CONTENT = [<span class="string">'json'</span>]	<span class="comment">#分布式接受数据的类型为json</span></span><br><span class="line">CELERY_TIMEZONE = <span class="string">'Asia/Shanghai'</span>	<span class="comment">#使用中国上海时区</span></span><br><span class="line">CELERY_ENABLE_UTC = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">CELERY_TASK_RESULT_EXPIRES = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>	<span class="comment">#后端存储任务超过一天，则自动清理数据，单位为秒</span></span><br><span class="line">CELERYD_MAX_TASKS_PER_CHILD = <span class="number">1000</span>	<span class="comment">#每个worker最多执行1000个任务就会被销毁，可防止内存泄露</span></span><br></pre></td></tr></table></figure>

<h1 id="Django-LOG日志"><a href="#Django-LOG日志" class="headerlink" title="Django LOG日志"></a>Django LOG日志</h1><h2 id="Log简介"><a href="#Log简介" class="headerlink" title="Log简介"></a>Log简介</h2><p>logging模块是Python内置的标准模块，主要用于输出运行日志，可以设置输出日志的等级、日志保存路径、日志文件回滚等；相比print，具备如下优点：</p>
<p>通过log的分析，可以⽅便⽤户了解系统或软件、应⽤的运⾏情况；如果你的应⽤log⾜够丰富，也可以分析以往⽤户的操作⾏为、类型喜好、地域分布或其他更多信息；如果⼀个应⽤的log同时也分了多个级别，那么可以很轻易地分析得到该应⽤的健康状况，及时发现问题并快速定位、解决问题,补救损失</p>
<h2 id="Log的用途"><a href="#Log的用途" class="headerlink" title="Log的用途"></a>Log的用途</h2><p>不管是使⽤何种编程语⾔，⽇志输出⼏乎⽆处不再。总结起来，⽇志⼤致有以下⼏种⽤途：</p>
<ul>
<li><p>问题追踪：通过⽇志不仅仅包括我们程序的⼀些bug，也可以在安装配置时， 通过⽇志可以发现问题</p>
</li>
<li><p>状态监控：通过实时分析⽇志，可以监控系统的运⾏状态，做到早发现问题、 早处理问题</p>
</li>
<li><p>安全审计：审计主要体现在安全上，通过对⽇志进⾏分析，可以发现是否存在非授权的操作</p>
</li>
</ul>
<h2 id="Log的等级"><a href="#Log的等级" class="headerlink" title="Log的等级"></a>Log的等级</h2><ul>
<li><p>DEBUG最详细的⽇志信息，典型应⽤场景是 问题诊断</p>
</li>
<li><p>INFO信息详细程度仅次于DEBUG，通常只记录关键节点信息，⽤于确认⼀切都是按照我们预期的那样进⾏⼯作</p>
</li>
<li><p>WARNING当某些不期望的事情发⽣时记录的信息（如，磁盘可⽤空间较低），但是此时应⽤程序还是正常运⾏的</p>
</li>
<li><p>ERROR由于⼀个更严重的问题导致某些功能不能正常运⾏时记录的信息 如IO操作失败或者连接问题</p>
</li>
<li><p>CRITICAL当发⽣严重错误，导致应⽤程序不能继续运⾏时记录的信息</p>
</li>
</ul>
<h2 id="Log的四大组件"><a href="#Log的四大组件" class="headerlink" title="Log的四大组件"></a>Log的四大组件</h2><h3 id="Loggers"><a href="#Loggers" class="headerlink" title="Loggers"></a>Loggers</h3><p>提供应⽤程序代码直接使⽤的接⼝</p>
<h3 id="Handlers"><a href="#Handlers" class="headerlink" title="Handlers"></a>Handlers</h3><p>⽤于将⽇志记录发送到指定的⽬的位置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FileHandler：logging.FileHandler；⽇志输出到⽂件</span><br><span class="line">RotatingHandler：logging.handlers.RotatingHandler；⽇志回滚⽅式，⽀持⽇志⽂件最⼤数量和⽇志⽂件回滚</span><br><span class="line">SMTPHandler：logging.handlers.SMTPHandler；远程输出⽇志到邮件地址</span><br><span class="line">HTTPHandler：logging.handlers.HTTPHandler；通过<span class="string">"GET"</span>或者<span class="string">"POST"</span>远程输出到HTTP服务器</span><br></pre></td></tr></table></figure>

<h3 id="Filters"><a href="#Filters" class="headerlink" title="Filters"></a>Filters</h3><p>提供更细粒度的⽇志过滤功能，⽤于决定哪些⽇志记录将会被输出（其它的⽇志记录将会被忽略）</p>
<h3 id="Formatters"><a href="#Formatters" class="headerlink" title="Formatters"></a>Formatters</h3><p>⽤于控制⽇志信息的最终输出格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">%(levelno)s：打印⽇志级别的数值</span><br><span class="line">%(levelname)s：打印⽇志级别的名称</span><br><span class="line">%(pathname)s：打印当前执⾏程序的路径，其实就是sys.argv[<span class="number">0</span>]</span><br><span class="line">%(filename)s：打印当前执⾏程序名</span><br><span class="line">%(funcName)s：打印⽇志的当前函数</span><br><span class="line">%(lineno)d：打印⽇志的当前⾏号</span><br><span class="line">%(asctime)s：打印⽇志的时间</span><br><span class="line">%(thread)d：打印线程ID</span><br><span class="line">%(threadName)s：打印线程名称</span><br><span class="line">%(process)d：打印进程ID</span><br><span class="line">%(message)s：打印⽇志信息</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line">logger.setLevel(level = logging.INFO)</span><br><span class="line">handler = logging.FileHandler(“log.txt”)</span><br><span class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(handler)</span><br><span class="line">logger.info(<span class="string">"Start print log"</span>)</span><br><span class="line">logger.debug(<span class="string">"Do something"</span>)</span><br><span class="line">logger.warning(<span class="string">"Something maybe fail."</span>)</span><br><span class="line">logger.info(<span class="string">"Finish"</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Django中的配置"><a href="#Django中的配置" class="headerlink" title="Django中的配置"></a>Django中的配置</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line">ADMINS = (</span><br><span class="line">    (<span class="string">'tom'</span>, <span class="string">'15096000421@qq.com'</span>),</span><br><span class="line">)</span><br><span class="line"><span class="comment"># 配置邮件</span></span><br><span class="line">EMAIL_BACKEND = <span class="string">'django.core.mail.backends.smtp.EmailBackend'</span></span><br><span class="line">SERVER_EMAIL = EMAIL_HOST_USER</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'disable_existing_loggers'</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">'formatters'</span>: &#123;</span><br><span class="line">        <span class="string">'standard'</span>: &#123;</span><br><span class="line">            <span class="string">'format'</span>: <span class="string">'%(asctime)s [%(threadName)s:%(thread)d] [%(name)s:%(lineno)d] [%(module)s:%(funcName)s] [%(levelname)s]- %(message)s'</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'filters'</span>: &#123;  <span class="comment"># 过滤条件</span></span><br><span class="line">        <span class="comment"># 要求debug是False才记录</span></span><br><span class="line">        <span class="string">'require_debug_false'</span>: &#123;</span><br><span class="line">            <span class="string">'()'</span>: <span class="string">'django.utils.log.RequireDebugFalse'</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'handlers'</span>: &#123;</span><br><span class="line">        <span class="string">'null'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.NullHandler'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'mail_admins'</span>: &#123;  <span class="comment"># 一旦线上代码报错 邮件提示</span></span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'ERROR'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'django.utils.log.AdminEmailHandler'</span>,</span><br><span class="line">            <span class="string">'filters'</span>: [<span class="string">'require_debug_false'</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'debug'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.handlers.RotatingFileHandler'</span>,</span><br><span class="line">            <span class="string">'filename'</span>: os.path.join(BASE_DIR, <span class="string">"log"</span>, <span class="string">'debug.log'</span>),  <span class="comment"># 文件路径</span></span><br><span class="line">            <span class="string">'maxBytes'</span>: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,  <span class="comment"># 5兆的数据</span></span><br><span class="line">            <span class="string">'backupCount'</span>: <span class="number">5</span>,  <span class="comment"># 允许有5这样的文件</span></span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'standard'</span>,  <span class="comment"># 格式</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'console'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.StreamHandler'</span>,</span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'standard'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'loggers'</span>: &#123;</span><br><span class="line">        <span class="string">'django'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'console'</span>],</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="literal">False</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'django.request'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'debug'</span>, <span class="string">'mail_admins'</span>],</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'ERROR'</span>,</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="literal">True</span>,  <span class="comment"># 是否继承父类的log信息</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 对于不在 ALLOWED_HOSTS 中的请求不发送报错邮件</span></span><br><span class="line">        <span class="string">'django.security.DisallowedHost'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'null'</span>],</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="literal">False</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="基于类的视图"><a href="#基于类的视图" class="headerlink" title="基于类的视图"></a>基于类的视图</h1><p>视图是可调用的，它接收请求并返回响应。这可能不仅仅是一个函数，Django提供了一些可用作视图的类的示 </p>
<p>例。这些允许您通过利用继承和mixin来构建视图并重用代码</p>
<p>基于类的视图（Class-based views）提供了另一种将视图实现为Python对象而不是函数的方法。它们不替换基于 </p>
<p>函数的视图，但与基于函数的视图相比具有一定的差异和优势：</p>
<ul>
<li>提高了代码的复用性，可以使用面向对象的技术，比如Mixin（多继承）</li>
<li>可以用不同的函数针对不同的HTTP方法处理，而不是通过很多if判断，提高代码可读性</li>
</ul>
<p>Function Based View  FBV</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="comment"># Function Based View  FBV</span></span><br><span class="line"><span class="comment"># 简单，易懂</span></span><br><span class="line"><span class="comment"># 缺点：不能继承，不容易代码复用</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">"POST"</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">"App:register"</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"首页"</span>)</span><br></pre></td></tr></table></figure>

<p>CBV Class Based View 基于类的视图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CBV Class Based View 基于类的视图</span></span><br><span class="line"><span class="comment"># 优点：有继承，代码可复用、可维护性更强;一个请求对应一个方法，无需判断</span></span><br><span class="line"><span class="comment"># 缺点：比较抽象，不易懂</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterView</span><span class="params">(View)</span>:</span></span><br><span class="line">    a = <span class="number">10</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        print(self.a)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"GET"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"POST"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"PUT"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"DELETE"</span>)</span><br></pre></td></tr></table></figure>

<p>内建的基于类的视图的层次结构：</p>
<ul>
<li>基本视图：view 、TemplateView、RedirectView</li>
<li>通用显示视图：DetailView、ListView</li>
<li>通用编辑视图：FormView、CreateView、 UpdateView、DeleteView</li>
<li>通用日期视图： ArchiveIndexView、YearArchiveView、 MonthArchiveView、 WeekArchiveView、DayArchiveView、TodayArchiveView、DateDetailView </li>
<li>基于类的视图mixins<ul>
<li>简单的mixins：ContextMixin、TemplateResponseMixin</li>
<li>单个对象mixins：SingleObjectMixin、SingleObjectTemplateResponseMixin</li>
<li>多个对象混合：MultipleObjectMixin、MultipleObjectTemplateResponseMixin</li>
</ul>
</li>
</ul>
<h2 id="类视图的基本使用"><a href="#类视图的基本使用" class="headerlink" title="类视图的基本使用"></a>类视图的基本使用</h2><p>所有类视图都继承自Django提供的父类View，可以使用from django.views import View或from django.views.generic import View来导入父类View。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#views.py</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, redirect</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="comment"># 处理GET请求</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">"App/register.html"</span>)</span><br><span class="line">    <span class="comment"># 处理POST请求</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 注册业务处理</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">"App:login"</span>))</span><br></pre></td></tr></table></figure>

<p>路由注册： </p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line"> <span class="comment"># 函数注册</span></span><br><span class="line"> path(<span class="string">"register/"</span>,views.register,name=<span class="string">'register'</span>)</span><br><span class="line"> <span class="comment"># 类视图注册</span></span><br><span class="line"> path(<span class="string">r'register/'</span>,views.RegisterView.as_view(),name=<span class="string">'register'</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="基本视图"><a href="#基本视图" class="headerlink" title="基本视图"></a>基本视图</h2><h2 id="根视图View类"><a href="#根视图View类" class="headerlink" title="根视图View类"></a>根视图View类</h2><p>提供适合各种应用程序的基本视图类。所有视图都继承自 View 该类，该类处理将视图链接到URL，HTTP方法调度 和其他简单功能。</p>
<p>View类核心代码在<code>as_view</code>和<code>dispatch</code>方法中，其中<code>as_view</code>是类方法（<code>@classonlymethod</code>），只能通过类调用，不能通过对象调用，它是类视图的入口点。注意这里调用的时候是通过类名.as_view()调用的。 其中，as_view方法主要执行逻辑： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classonlymethod</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, **initkwargs)</span>:</span></span><br><span class="line">       <span class="string">"""Main entry point for a request-response process."""</span></span><br><span class="line">       <span class="comment"># 参数检查</span></span><br><span class="line">       <span class="keyword">for</span> key <span class="keyword">in</span> initkwargs:</span><br><span class="line">           <span class="keyword">if</span> key <span class="keyword">in</span> cls.http_method_names: <span class="comment"># 参数名不能是指定http的方法</span></span><br><span class="line">               <span class="keyword">raise</span> TypeError(<span class="string">"You tried to pass in the %s method name as a "</span></span><br><span class="line">                               <span class="string">"keyword argument to %s(). Don't do that."</span></span><br><span class="line">                               % (key, cls.__name__))</span><br><span class="line">           <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls, key): <span class="comment"># 参数名不能是已有类的属性 </span></span><br><span class="line">               <span class="keyword">raise</span> TypeError(<span class="string">"%s() received an invalid keyword %r. as_view "</span></span><br><span class="line">                               <span class="string">"only accepts arguments that are already "</span></span><br><span class="line">                               <span class="string">"attributes of the class."</span> % (cls.__name__, key))</span><br><span class="line"></span><br><span class="line">       <span class="comment"># 视图处理函数</span></span><br><span class="line">       <span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(request, *args, **kwargs)</span>:</span></span><br><span class="line">           self = cls(**initkwargs) <span class="comment"># 实例化当前类的对象</span></span><br><span class="line">           <span class="keyword">if</span> hasattr(self, <span class="string">'get'</span>) <span class="keyword">and</span> <span class="keyword">not</span> hasattr(self, <span class="string">'head'</span>):</span><br><span class="line">               self.head = self.get</span><br><span class="line">           self.setup(request, *args, **kwargs)</span><br><span class="line">           <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'request'</span>):</span><br><span class="line">               <span class="keyword">raise</span> AttributeError(</span><br><span class="line">                   <span class="string">"%s instance has no 'request' attribute. Did you override "</span></span><br><span class="line">                   <span class="string">"setup() and forget to call super()?"</span> % cls.__name__</span><br><span class="line">               )</span><br><span class="line">               <span class="comment"># 方法派发</span></span><br><span class="line">           <span class="keyword">return</span> self.dispatch(request, *args, **kwargs)</span><br><span class="line">       view.view_class = cls</span><br><span class="line">       view.view_initkwargs = initkwargs</span><br><span class="line"></span><br><span class="line">       <span class="comment"># take name and docstring from class</span></span><br><span class="line">       update_wrapper(view, cls, updated=())</span><br><span class="line"></span><br><span class="line">       <span class="comment"># and possible attributes set by decorators</span></span><br><span class="line">       <span class="comment"># like csrf_exempt from dispatch</span></span><br><span class="line">       update_wrapper(view, cls.dispatch, assigned=())</span><br><span class="line">       <span class="keyword">return</span> view <span class="comment"># 返回视图函数</span></span><br></pre></td></tr></table></figure>

<p>整个as_view方法是一个装饰器方法，它返回内部函数view，所以as_view()执行其实就是内部函数view执行。内部 函数view主要逻辑就是：<code>as_view()=&gt;view()=&gt;dispatch()=&gt;相应的http方法</code></p>
<ul>
<li>实例化本类对象</li>
<li>接受请求对象和参数(setup)</li>
<li>调用dispatch方法进行派发</li>
</ul>
<p>调用as_view方法可以传递参数，但要注意：</p>
<ul>
<li>不能使用请求方法的名字作为参数的名字</li>
<li>只能接受视图类已经存在的属性对应的参数 </li>
</ul>
<p><code>dispatch</code>方法是实例方法，它的主要代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">  <span class="comment">#检查请求方法是不是在http_method_names中包含</span></span><br><span class="line">  <span class="comment">#http_method_names包括八种方法：['get', 'post', 'put', 'patch', 'delete', 'head', 'options', 'trace']</span></span><br><span class="line">    <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">        <span class="comment"># 判断传入的对象是否有改方法,有则返回,没有返回默认值</span></span><br><span class="line">        handler = getattr(self, request.method.lower(), self.http_method_not_allowed)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        handler = self.http_method_not_allowed</span><br><span class="line">        <span class="keyword">return</span> handler(request, *args, **kwargs)</span><br></pre></td></tr></table></figure>

<p>dispatch主要完成http请求方法的派发，调用视图类对应实例方法处理用户请求，所有用户需要定义和http请求方 法同名的实例方法完成功能，所以一般CBV的模块写法是： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"post"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"put"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"delete"</span>)</span><br></pre></td></tr></table></figure>

<h2 id="TemplateView"><a href="#TemplateView" class="headerlink" title="TemplateView"></a>TemplateView</h2><p>TemplateView可以根据上下文渲染指定模板，返回响应对象。它继承了ContentMixin、View、TemplateResponseMix</p>
<ul>
<li>ContentMixin用于获取渲染模板的变量。你可以重写get_context_data方法返回模板渲染的参数</li>
<li>TemplateResponseMixin 用于渲染模板 <ul>
<li>template_name模板文名(必须设置)</li>
<li>template_engine模板引擎（有默认值）</li>
<li>response_class模板渲染类，默认是TemplateResponse</li>
<li>content_type内容类型，默认是text/html</li>
<li>get_template_names你可以重写这个方法返回模板名称</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#路由</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^hello/(\w+)/$'</span>,views.HelloView.as_view(template_name=<span class="string">'hello.html'</span>),name=<span class="string">'hello'</span>),</span><br><span class="line">]</span><br><span class="line"><span class="comment">#views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloView</span><span class="params">(TemplateView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        context = self.get_context_data(**kwargs)</span><br><span class="line">        context[<span class="string">'name'</span>] = args[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> self.render_to_response(context)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意as_view方法参数只能是template_name、template_engine、response_class、content_type</p>
</blockquote>
<h2 id="RedirectView"><a href="#RedirectView" class="headerlink" title="RedirectView"></a>RedirectView</h2><p>重定向的指定url</p>
<p>get_redirect_url用于构造重定向的目标URL，可以重写。默认实现url用作起始字符串，并%使用URL中捕获的命名组在该字符串中执行命名参数的扩展。如果url未设置，则get_redirect_url()尝试反转 pattern_name使用URL中捕获的内容（使用已命名和未命名的组）。如果请求query_string，它还会将查询字符串附加到生成的URL。子类可以实现他们希望的任何行为，只要该方法 返回可重定向的URL字符串即可</p>
<h2 id="通用显示视图"><a href="#通用显示视图" class="headerlink" title="通用显示视图"></a>通用显示视图</h2><p>本类视图主要用户数据展示，包括ListView显示对象列表信息和DetailView显示对象详细信息</p>
<h2 id="ListView"><a href="#ListView" class="headerlink" title="ListView"></a>ListView</h2><ul>
<li><p>MultipleObjectTemplateResponseMixin</p>
<ul>
<li>提供了模板文件名</li>
<li>如果没有指定模板文件名，则默认模板文件名规则是：应用名/模型名_list.html</li>
</ul>
</li>
<li><p>MultipleObjectMixin</p>
<p>核心类，提供了渲染模板所有需要的模型或查询结果集（不一定是QuerySet，可以是对象列表），分页。</p>
<ul>
<li><p>queryset属性用于渲染模板所需对象列表，也可以重写get_queryset方法获取</p>
</li>
<li><p>model，如果没指定queryset，则根据指定model获取对象列表</p>
</li>
<li><p>context_object_name模板中对象列表的名称，如果不指定，则根据model获取对象列表名称：model_list</p>
</li>
<li><p>paginate_by指定分页每页的记录个数，默认是None，不分页</p>
</li>
<li><p>page_kwarg指定分页请求路径中命名分组名或get传参中键的名称，默认是page</p>
</li>
<li><p>paginate_orphans是指分页最后一页如果记录不满一页的处理方式，默认是0，和前一页合并显示，如果不为0，则单独显示一页 </p>
</li>
<li><p>分页具体实现：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string"> Get the context for this view.</span></span><br><span class="line"><span class="string"> """</span></span><br><span class="line">    queryset = kwargs.pop(<span class="string">'object_list'</span>, self.object_list)</span><br><span class="line">    page_size = self.get_paginate_by(queryset)</span><br><span class="line">    context_object_name = self.get_context_object_name(queryset)</span><br><span class="line">    <span class="keyword">if</span> page_size:</span><br><span class="line">        paginator, page, queryset, is_paginated = self.paginate_queryset(queryset, </span><br><span class="line">                                                                         page_size)</span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">'paginator'</span>: paginator, <span class="comment">#在模板中可以使用分页器</span></span><br><span class="line">            <span class="string">'page_obj'</span>: page, <span class="comment">#分页对象</span></span><br><span class="line">            <span class="string">'is_paginated'</span>: is_paginated,</span><br><span class="line">            <span class="string">'object_list'</span>: queryset <span class="comment">#当前页数据</span></span><br><span class="line">        &#125;</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">'paginator'</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">'page_obj'</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">'is_paginated'</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">'object_list'</span>: queryset</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="keyword">if</span> context_object_name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="comment">#如果context_object_name不为空</span></span><br><span class="line">        context[context_object_name] = queryset</span><br><span class="line">        context.update(kwargs)</span><br><span class="line">        <span class="keyword">return</span> super(MultipleObjectMixin, self).get_context_data(**context)</span><br></pre></td></tr></table></figure>
</li>
<li><p>BaseListView默认实现get请求 </p>
</li>
</ul>
</li>
</ul>
<h2 id="DetailView"><a href="#DetailView" class="headerlink" title="DetailView"></a>DetailView</h2><p>显示对象的详细信息 </p>
<ul>
<li>SingleObjectMixin <ul>
<li>pk_url_kwarg 默认值pk，从请求路径中获取主键的值，请求路径中参数必须是命名组，组名必须和 pk_url_kwarg的值一样 </li>
<li>slug_url_kwarg默认值是slug，从请求路径中获取查询参数sug的值，请求路径中参数必须是命名组，组名必须和slug_url_kwarg的值一样，如果参数中有pk_url_kwarg的值，则slug_url_kwarg不起作用</li>
<li>slug_fifield查询字段的名称 </li>
<li>context_object_name模板中引用对象的名称，默认模板中对象名称是object </li>
</ul>
</li>
</ul>
<h2 id="通用编辑视图"><a href="#通用编辑视图" class="headerlink" title="通用编辑视图"></a>通用编辑视图</h2><p>本类视图主要完成对象的增删改。包括FormView、CreateView、 UpdateView、DeleteView</p>
<h2 id="FormView"><a href="#FormView" class="headerlink" title="FormView"></a>FormView</h2><p>显示表单的视图。出错时，重新显示带有验证错误的表单; 成功时，重定向到新的URL。</p>
<ul>
<li>FormMixin<ul>
<li>form_class 表单类名</li>
<li>success_url表单验证成功后调整的url</li>
<li>form_valid() 验证数据成功后的处理</li>
<li>form_invalid() 验证不成功的处理</li>
</ul>
</li>
<li>ProcessFormView<ul>
<li>get渲染表单</li>
<li>post表单提交</li>
<li>put创建或修改对象</li>
</ul>
</li>
</ul>
<h2 id="CreateView"><a href="#CreateView" class="headerlink" title="CreateView"></a>CreateView</h2><p>显示用于创建对象的表单的视图，使用验证错误（如果有）重新显示表单并保存对象。</p>
<p>重要属性：</p>
<ul>
<li>template_name 模板文件名 </li>
<li>fields指定的字段列表 </li>
<li>model关联模型名 </li>
<li>form_class表单类，如果没有设置会默认是模型名</li>
</ul>
<h2 id="UpdateView"><a href="#UpdateView" class="headerlink" title="UpdateView"></a>UpdateView</h2><p> UpdateView的用法和CreateView基本一样 </p>
<h2 id="DeleteView"><a href="#DeleteView" class="headerlink" title="DeleteView"></a>DeleteView</h2><p>删除指定对象的视图</p>
<h2 id="类视图使用装饰器"><a href="#类视图使用装饰器" class="headerlink" title="类视图使用装饰器"></a>类视图使用装饰器</h2><p>为类视图添加装饰器，可以使用两种方法。 </p>
<p>为了理解方便，我们先来定义一个为函数视图准备的装饰器（在设计装饰器时基本都以函数视图作为考虑的被装饰对象），及一个要被装饰的类视图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_decorator</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(request, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'自定义装饰器被调用了'</span>)</span><br><span class="line">        print(<span class="string">'请求路径%s'</span> % request.path)</span><br><span class="line">        <span class="keyword">return</span> func(request, *args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'get方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'post方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure>

<p>在类视图中使用为函数视图准备的装饰器时，不能直接添加装饰器，需要使用method_decorator将其转换为适用 于类视图方法的装饰器</p>
<p>method_decorator装饰器使用name参数指明被装饰的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为全部请求方法添加装饰器</span></span><br><span class="line"><span class="meta">@method_decorator(my_decorator, name='dispatch')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'get方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'post方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br><span class="line"><span class="comment"># 为特定请求方法添加装饰器</span></span><br><span class="line"><span class="meta">@method_decorator(my_decorator, name='get')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'get方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">'post方法'</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure>

<p>如果需要为类视图的多个方法添加装饰器，但又不是所有的方法（为所有方法添加装饰器参考上面例子），可以直 接在需要添加装饰器的方法上使用method_decorator,如下所示</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line"><span class="comment"># 为特定请求方法添加装饰器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoView</span><span class="params">(View)</span>:</span></span><br><span class="line"><span class="meta"> @method_decorator(my_decorator) # 为get方法添加了装饰器</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line"> print(<span class="string">'get方法'</span>)</span><br><span class="line"> <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br><span class="line"><span class="meta"> @method_decorator(my_decorator) # 为post方法添加了装饰器</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line"> print(<span class="string">'post方法'</span>)</span><br><span class="line"> <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request)</span>:</span> <span class="comment"># 没有为put方法添加装饰器</span></span><br><span class="line"> print(<span class="string">'put方法'</span>)</span><br><span class="line"> <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure>

<h1 id="Django-rest-framework"><a href="#Django-rest-framework" class="headerlink" title="Django-rest-framework"></a>Django-rest-framework</h1><h2 id="什么是RESTful"><a href="#什么是RESTful" class="headerlink" title="什么是RESTful"></a>什么是RESTful</h2><ul>
<li>REST与技术无关，代表的是一种软件架构风格，REST是Representational State Transfer的简称，中文翻译为“表征状态转移”</li>
<li>REST从资源的角度类审视整个网络，它将分布在网络中某个节点的资源通过URL进行标识，客户端应用通过URL来获取资源的表征，获得这些表征致使这些应用转变状态</li>
<li>REST与技术无关，代表的是一种软件架构风格，REST是Representational State Transfer的简称，中文翻译为“表征状态转移”</li>
<li>所有的数据，不过是通过网络获取的还是操作（增删改查）的数据，都是资源，将一切数据视为资源是REST区别与其他架构风格的最本质属性</li>
<li>对于REST这种面向资源的架构风格，有人提出一种全新的结构理念，即：面向资源架构（ROA：Resource Oriented Architecture）</li>
</ul>
<h2 id="RESTful-API设计"><a href="#RESTful-API设计" class="headerlink" title="RESTful API设计"></a>RESTful API设计</h2><ul>
<li><p>API与用户的通信协议，总是使用<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" target="_blank" rel="noopener">HTTPs协议</a>。</p>
</li>
<li><p>域名 </p>
<ul>
<li><a href="https://api.example.com" target="_blank" rel="noopener">https://api.example.com</a> 尽量将API部署在专用域名（会存在跨域问题）</li>
<li><a href="https://example.org/api/" target="_blank" rel="noopener">https://example.org/api/</a> API很简单</li>
</ul>
</li>
<li><p>版本</p>
<ul>
<li>URL，如：<a href="https://api.example.com/v1/" target="_blank" rel="noopener">https://api.example.com/v1/</a></li>
<li>请求头跨域时，引发发送多次请求</li>
</ul>
</li>
<li><p>路径，视网络上任何东西都是资源，均使用名词表示（可复数）</p>
<ul>
<li><a href="https://api.example.com/v1/zoos" target="_blank" rel="noopener">https://api.example.com/v1/zoos</a></li>
<li><a href="https://api.example.com/v1/animals" target="_blank" rel="noopener">https://api.example.com/v1/animals</a></li>
<li><a href="https://api.example.com/v1/employees" target="_blank" rel="noopener">https://api.example.com/v1/employees</a></li>
</ul>
</li>
<li><p>method</p>
<ul>
<li>GET      ：从服务器取出资源（一项或多项）</li>
<li>POST    ：在服务器新建一个资源</li>
<li>PUT      ：在服务器更新资源（客户端提供改变后的完整资源）</li>
<li>PATCH  ：在服务器更新资源（客户端提供改变的属性）</li>
<li>DELETE ：从服务器删除资源</li>
</ul>
</li>
<li><p>过滤，通过在url上传参的形式传递搜索条件</p>
<ul>
<li><a href="https://api.example.com/v1/zoos?limit=10：指定返回记录的数量" target="_blank" rel="noopener">https://api.example.com/v1/zoos?limit=10：指定返回记录的数量</a></li>
<li><a href="https://api.example.com/v1/zoos?offset=10：指定返回记录的开始位置" target="_blank" rel="noopener">https://api.example.com/v1/zoos?offset=10：指定返回记录的开始位置</a></li>
<li><a href="https://api.example.com/v1/zoos?page=2&amp;per_page=100：指定第几页，以及每页的记录数" target="_blank" rel="noopener">https://api.example.com/v1/zoos?page=2&amp;per_page=100：指定第几页，以及每页的记录数</a></li>
<li><a href="https://api.example.com/v1/zoos?sortby=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序" target="_blank" rel="noopener">https://api.example.com/v1/zoos?sortby=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序</a></li>
<li><a href="https://api.example.com/v1/zoos?animal_type_id=1：指定筛选条件" target="_blank" rel="noopener">https://api.example.com/v1/zoos?animal_type_id=1：指定筛选条件</a></li>
</ul>
</li>
<li><p>状态码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">200 OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。</span><br><span class="line">201 CREATED - [POST&#x2F;PUT&#x2F;PATCH]：用户新建或修改数据成功。</span><br><span class="line">202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</span><br><span class="line">204 NO CONTENT - [DELETE]：用户删除数据成功。</span><br><span class="line">400 INVALID REQUEST - [POST&#x2F;PUT&#x2F;PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</span><br><span class="line">401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</span><br><span class="line">403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</span><br><span class="line">404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</span><br><span class="line">406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</span><br><span class="line">410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</span><br><span class="line">422 Unprocesable entity - [POST&#x2F;PUT&#x2F;PATCH] 当创建一个对象时，发生一个验证错误。</span><br><span class="line">500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</span><br></pre></td></tr></table></figure>
</li>
<li><p>错误处理，状态码是4xx时，应返回错误信息，error当做key。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    error: &quot;Invalid API key&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回结果，针对不同操作，服务器向用户返回的结果应该符合以下规范。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;collection：返回资源对象的列表（数组）</span><br><span class="line">GET &#x2F;collection&#x2F;resource：返回单个资源对象</span><br><span class="line">POST &#x2F;collection：返回新生成的资源对象</span><br><span class="line">PUT &#x2F;collection&#x2F;resource：返回完整的资源对象</span><br><span class="line">PATCH &#x2F;collection&#x2F;resource：返回完整的资源对象</span><br><span class="line">DELETE &#x2F;collection&#x2F;resource：返回一个空文档</span><br></pre></td></tr></table></figure>
</li>
<li><p>Hypermedia API，RESTful API最好做到Hypermedia，即返回结果中提供链接，连向其他API方法，使得用户不查文档，也知道下一步应该做什么。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;link&quot;: &#123;</span><br><span class="line">  &quot;rel&quot;:   &quot;collection https:&#x2F;&#x2F;www.example.com&#x2F;zoos&quot;,</span><br><span class="line">  &quot;href&quot;:  &quot;https:&#x2F;&#x2F;api.example.com&#x2F;zoos&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;List of zoos&quot;,</span><br><span class="line">  &quot;type&quot;:  &quot;application&#x2F;vnd.yourformat+json&quot;</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="基于Django实现"><a href="#基于Django实现" class="headerlink" title="基于Django实现"></a>基于Django实现</h2><p>路由系统：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^users'</span>, Users.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>CBV视图：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Users</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        result = &#123;</span><br><span class="line">            <span class="string">'status'</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">'data'</span>: <span class="string">'response data'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result, status=<span class="number">200</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        result = &#123;</span><br><span class="line">            <span class="string">'status'</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">'data'</span>: <span class="string">'response data'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(result, status=<span class="number">200</span>)</span><br></pre></td></tr></table></figure>

<h2 id="基于Django-Rest-Framework框架实现"><a href="#基于Django-Rest-Framework框架实现" class="headerlink" title="基于Django Rest Framework框架实现"></a>基于Django Rest Framework框架实现</h2><blockquote>
<p>Django Rest Framework(DRF)是一个强大且灵活的工具包,用以构建Web API。DRF可以在Django的基础上迅速实现API,并且自身带有WEB的测试页面,可以方便的测试自己的API</p>
</blockquote>
<p>安装:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework</span><br></pre></td></tr></table></figure>

<p>url.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</span><br><span class="line"><span class="keyword">from</span> web.views.s1_api <span class="keyword">import</span> TestView</span><br><span class="line"> </span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^test/'</span>, TestView.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>views.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        请求到来之后，都要执行dispatch方法，dispatch方法根据请求方式不同触发 get/post/put等方法</span></span><br><span class="line"><span class="string">         </span></span><br><span class="line"><span class="string">        注意：APIView中的dispatch方法有好多好多的功能</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> super().dispatch(request, *args, **kwargs)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'GET请求，响应内容'</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'POST请求，响应内容'</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'PUT请求，响应内容'</span>)</span><br></pre></td></tr></table></figure>

<h1 id="Django上线部署"><a href="#Django上线部署" class="headerlink" title="Django上线部署"></a>Django上线部署</h1><p>安装 </p>
<ol>
<li><p>在线上服务器安装虚拟开发环境 </p>
</li>
<li><p>安装<code>nginx</code></p>
</li>
<li><p>安装<code>mysql</code></p>
</li>
<li><p>创建虚拟环境 </p>
</li>
<li><p>在虚拟开发环境中安装<code>django、pymysql、pillow</code></p>
</li>
<li><p>安装<code>uwsgi</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uwsgi</span><br></pre></td></tr></table></figure>
</li>
<li><p>上传项⽬ </p>
</li>
<li><p>在项⽬中根⽬录下创建<code>uconfifig.ini</code>的⽂件 代码在下⽅</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"># 外部访问地址，可以指定多种协议，⽤socket #</span><br><span class="line">socket &#x3D; 0.0.0.0:8000 # uwsgi的监听端⼝</span><br><span class="line"># 指向项⽬根⽬录</span><br><span class="line">chdir &#x3D; &#x2F;var&#x2F;www&#x2F;online</span><br><span class="line"># wsgi.py所在位置</span><br><span class="line">wsgi-file &#x3D; day09&#x2F;wsgi.py</span><br><span class="line">module &#x3D; day09.wsgi</span><br><span class="line"># 虚拟开发环境位置</span><br><span class="line">virtualenv &#x3D; &#x2F;home&#x2F;python&#x2F;.pyenv&#x2F;versions&#x2F;env3.6.6</span><br><span class="line">#plugins &#x3D; python</span><br><span class="line">master &#x3D; true</span><br><span class="line"># 处理器数</span><br><span class="line">processes &#x3D; 1</span><br><span class="line"># 线程数</span><br><span class="line">threads &#x3D; 2</span><br></pre></td></tr></table></figure>
</li>
<li><p>更改nginx的default⽂件代码在下方</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">     listen 80;</span><br><span class="line">     server_name www.blog.com;</span><br><span class="line">     location &#x2F; &#123;</span><br><span class="line">         # 转发端⼝必须和uconfig.ini中socket端⼝⼀致</span><br><span class="line">         uwsgi_pass 127.0.0.1:8000;</span><br><span class="line">         include uwsgi_params;</span><br><span class="line">         uwsgi_param UWSGI_SCRIPT online.wsgi;</span><br><span class="line">         # 项⽬的根⽬录</span><br><span class="line">         uwsgi_param UWSGI_CHDIR &#x2F;var&#x2F;www&#x2F;online;</span><br><span class="line"> &#125;</span><br><span class="line"> # 静态资源所在位置</span><br><span class="line"> location &#x2F;static &#123;</span><br><span class="line"> 	alias &#x2F;var&#x2F;www&#x2F;online&#x2F;static&#x2F;;</span><br><span class="line"> &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启nginx</p>
</li>
<li><p>回到虚拟环境⽬录启动 uwsgi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uwsgi uconfig</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭uwsgi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uwsgi —stop uconfig.ini</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果关闭不掉杀死进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep uwsgi</span><br><span class="line">Sudo kill 进程号</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述:"></a>问题描述:</h2><p>django admin没有样式 admin管理⻚⾯找不到base.css,dashboard.css⽂件</p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法:"></a>解决办法:</h2><p>在settings⽂件中设置STATIC_ROOT⽬录,该⽬录不能在STATICFILES_DIRS中. 然后, 执⾏命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py collectstatic</span><br></pre></td></tr></table></figure>

<p>执⾏后,django会将STATICFILES_DIRS下的所有⽂件以及admin所需要⽤到的js,css,image⽂件全都放到STATIC_ROOT⽬录下.例如, 像下⾯这样写:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL &#x3D; &#39;&#x2F;static&#x2F;&#39;</span><br><span class="line">STATIC_ROOT &#x3D; os.path.join(BASE_DIR, &#39;collectstatic&#39;)</span><br><span class="line">STATICFILES_DIRS &#x3D; [os.path.join(BASE_DIR, &#39;static&#39;), ]</span><br></pre></td></tr></table></figure>

<p>简单描述⼀下这几个变量的意思 STATIC_URL: 当访问什么样的⽹址时, 按照访问静态⽂件的⽅式去查找⽂件. STATICFILES_DIRS: 当访问静态⽂件是, 会在每个app中的static⽬录中查找, 然后再从STATICFILES_DIRS设置的路径列表中逐⼀查找. STATIC_ROOT: 当执⾏ python manage.py collectstatic 时, 收集的静态⽂件放在该⽬录下.</p>
<p>此刻项⽬下就会多出⼀个collectstatic的静态资源⽂件⽬录 </p>
<p>default代码更改为</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80; # 服务器监听端⼝</span><br><span class="line">    server_name 192.168.1.132; # 这⾥写你的域名或者公⽹IP</span><br><span class="line">    location / &#123;</span><br><span class="line">    uwsgi_pass 127.0.0.1:8000; # 转发端⼝，需要和uwsgi</span><br><span class="line">    配置当中的监听端⼝⼀致</span><br><span class="line">    include uwsgi_params; # 导⼊uwsgi配置</span><br><span class="line">    uwsgi_param UWSGI_PYTHON /home/xlg/axf/venv; #Python</span><br><span class="line">    解释器所在的路径（这⾥为虚拟环境）</span><br><span class="line">    uwsgi_param UWSGI_CHDIR /home/xlg/axf/;# ⾃⼰创建的⽬</span><br><span class="line">    录 项⽬根⽬录</span><br><span class="line">&#125;</span><br><span class="line">location /static&#123;</span><br><span class="line">    alias /home/xlg/axf/collectstatic/;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="访问可能会出现403没有权限的问题"><a href="#访问可能会出现403没有权限的问题" class="headerlink" title="访问可能会出现403没有权限的问题"></a>访问可能会出现403没有权限的问题</h3><p>解决办法:</p>
<p>找到nginx.conf⽂件的位置,将第⼀⾏的代码进⾏修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#user www-data;</span><br><span class="line">user root;</span><br><span class="line">或者将 www-data更改权限</span><br></pre></td></tr></table></figure>

<p>此刻就可以访问了</p>
<p>10.0.11.11/static/img/home.img</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">三月三</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zysheep.cn/2020/04/07/Python/%E5%AD%A6%E4%B9%A0Django/">https://zysheep.cn/2020/04/07/Python/学习Django/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zysheep.cn" target="_blank">三月三</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/Django/">Django</a></div><div class="post_share"><div class="social-share" data-image="http://cdn.panyucable.cn/zysheep/wallhaven-n673pw.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/zysheep/picgo-imgs/imgwechat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/zysheep/picgo-imgs/imgalipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/08/Spring/SpringBoot%E5%90%8E%E7%AB%AF%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83/"><img class="prev_cover" src="http://cdn.panyucable.cn/zysheep/spring-framework-logo.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringBoot后端接口规范</div></div></a></div><div class="next-post pull_right"><a href="/2020/04/07/Python/Centos7%E5%AE%89%E8%A3%85Python%E7%8E%AF%E5%A2%83/"><img class="next_cover" src="http://cdn.panyucable.cn/zysheep/QQ截图20200818165742.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Centos7安装Python环境</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/07/Python/Centos7安装Python环境/" title="Centos7安装Python环境"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/QQ截图20200818165742.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-07</div><div class="relatedPosts_title">Centos7安装Python环境</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/06/Python/学习Flask/" title="Flask学习"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/flask_cover1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-06</div><div class="relatedPosts_title">Flask学习</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/04/Python/虚拟环境管理/" title="虚拟环境管理"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/QQ截图20200818165742.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-04</div><div class="relatedPosts_title">虚拟环境管理</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/04/Python/uWSGI,WSGI和uwsgi/" title="WSGI，uWSGI和uwsgi区别详解"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/QQ截图20200818165742.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-04</div><div class="relatedPosts_title">WSGI，uWSGI和uwsgi区别详解</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/03/Python/Python几问/" title="Python3简介"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/QQ截图20200818165742.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-03</div><div class="relatedPosts_title">Python3简介</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '502b8308721b081071a5',
  clientSecret: '35220d15c7f8aaf585d6822cf5d49fedf5b602d6',
  repo: 'blog-comment',
  owner: 'zysheep',
  admin: ['zysheep'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" style="background-image: url(http://cdn.panyucable.cn/zysheep/django_top.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By 三月三</div><div class="footer_custom_text">生活不只是眼前的苟且,还有诗和远方</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/third-party/click_heart.js"></script><script src="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/js/hideCategory.min.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script></body></html>