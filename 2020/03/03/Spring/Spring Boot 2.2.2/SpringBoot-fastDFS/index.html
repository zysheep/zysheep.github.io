<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SpringBoot整合fastDFS | 三月三</title><meta name="description" content="fastDSF介绍FastDFS是用c语言编写的一款开源的分布式文件系统，它是由淘宝资深架构师余庆编写并开源。FastDFS专为互联 网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标，使用FastDFS很容易搭建一套高性能的文件服务器集群提供文件上传、下载等服务。   为什么要使用fastDFS呢？   上边介绍的NFS、GFS都是通用的分布式文件系统，通用的分"><meta name="keywords" content="Spring,Spring Boot2.2.2"><meta name="author" content="三月三"><meta name="copyright" content="三月三"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="http://cdn.panyucable.cn/zysheep/ico.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="SpringBoot整合fastDFS"><meta name="twitter:description" content="fastDSF介绍FastDFS是用c语言编写的一款开源的分布式文件系统，它是由淘宝资深架构师余庆编写并开源。FastDFS专为互联 网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标，使用FastDFS很容易搭建一套高性能的文件服务器集群提供文件上传、下载等服务。   为什么要使用fastDFS呢？   上边介绍的NFS、GFS都是通用的分布式文件系统，通用的分"><meta name="twitter:image" content="http://cdn.panyucable.cn/zysheep/springboot_cover_fastDFS.png"><meta property="og:type" content="article"><meta property="og:title" content="SpringBoot整合fastDFS"><meta property="og:url" content="https://zysheep.cn/2020/03/03/Spring/Spring%20Boot%202.2.2/SpringBoot-fastDFS/"><meta property="og:site_name" content="三月三"><meta property="og:description" content="fastDSF介绍FastDFS是用c语言编写的一款开源的分布式文件系统，它是由淘宝资深架构师余庆编写并开源。FastDFS专为互联 网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标，使用FastDFS很容易搭建一套高性能的文件服务器集群提供文件上传、下载等服务。   为什么要使用fastDFS呢？   上边介绍的NFS、GFS都是通用的分布式文件系统，通用的分"><meta property="og:image" content="http://cdn.panyucable.cn/zysheep/springboot_cover_fastDFS.png"><meta property="article:published_time" content="2020-03-03T02:30:45.000Z"><meta property="article:modified_time" content="2020-07-15T09:27:34.087Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://zysheep.cn/2020/03/03/Spring/Spring%20Boot%202.2.2/SpringBoot-fastDFS/"><link rel="prev" title="SpringBoot整合邮件任务" href="https://zysheep.cn/2020/03/03/Spring/Spring%20Boot%202.2.2/SpringBoot-mail-task/"><link rel="next" title="SpringBoot文件上传" href="https://zysheep.cn/2020/03/03/Spring/Spring%20Boot%202.2.2/SpringBoot-fileupload/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7f671f0f6d996680d21d5c32a23a9313";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://zysheep.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: false,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/hideCategory.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="http://cdn.panyucable.cn/zysheep/xiaoman.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">217</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">49</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">70</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bug" aria-hidden="true"></i><span> 编程路线</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/java/"><i class="fa-fw fa fa-coffee"></i><span> Java</span></a></li><li><a class="site-page" href="/python/"><i class="fa-fw fa fa-binoculars"></i><span> Python</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder-open" aria-hidden="true"></i><span> 面试宝典</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/interview/"><i class="fa-fw fa fa-file-text-o"></i><span> Java面试题</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 我的生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-picture-o"></i><span> Gallery</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#fastDSF介绍"><span class="toc-number">1.</span> <span class="toc-text">fastDSF介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fastDSF工作原理"><span class="toc-number">2.</span> <span class="toc-text">fastDSF工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#fastDSF架构"><span class="toc-number">2.1.</span> <span class="toc-text">fastDSF架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1）Tracker"><span class="toc-number">2.1.1.</span> <span class="toc-text">1）Tracker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2）Storage"><span class="toc-number">2.1.2.</span> <span class="toc-text">2）Storage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3）Storage状态收集"><span class="toc-number">2.1.3.</span> <span class="toc-text">3）Storage状态收集</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件上传流程"><span class="toc-number">2.2.</span> <span class="toc-text">文件上传流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件下载流程"><span class="toc-number">2.3.</span> <span class="toc-text">文件下载流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fastDFS入门"><span class="toc-number">3.</span> <span class="toc-text">fastDFS入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#fastDFS安装与配置"><span class="toc-number">3.1.</span> <span class="toc-text">fastDFS安装与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FastDFS-安装环境"><span class="toc-number">3.1.1.</span> <span class="toc-text">FastDFS 安装环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-libevent"><span class="toc-number">3.1.2.</span> <span class="toc-text">安装 libevent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-libfastcommon"><span class="toc-number">3.1.3.</span> <span class="toc-text">安装 libfastcommon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tracker-编译安装"><span class="toc-number">3.1.4.</span> <span class="toc-text">tracker 编译安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#配置"><span class="toc-number">3.1.4.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动"><span class="toc-number">3.1.4.2.</span> <span class="toc-text">启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastDFS–storage-安装"><span class="toc-number">3.1.5.</span> <span class="toc-text">FastDFS–storage 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#配置-FastDFS–storage"><span class="toc-number">3.1.5.1.</span> <span class="toc-text">配置 FastDFS–storage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动-1"><span class="toc-number">3.1.5.2.</span> <span class="toc-text">启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#上传图片测试"><span class="toc-number">3.2.</span> <span class="toc-text">上传图片测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过-fdfs-test-程序"><span class="toc-number">3.2.1.</span> <span class="toc-text">通过 fdfs_test 程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FastDFS-和-nginx-整合"><span class="toc-number">3.3.</span> <span class="toc-text">FastDFS 和 nginx 整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-代理"><span class="toc-number">3.3.1.</span> <span class="toc-text">nginx 代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在-Storage-上安装-nginx"><span class="toc-number">3.3.2.</span> <span class="toc-text">在 Storage 上安装 nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FastDFS-nginx-module"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">FastDFS-nginx-module</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-安装"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">nginx 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-配置文件"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">nginx 配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">3.4.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(http://cdn.panyucable.cn/zysheep/springboot_top_fastDFS.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">三月三</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-bug" aria-hidden="true"></i><span> 编程路线</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/java/"><i class="fa-fw fa fa-coffee"></i><span> Java</span></a></li><li><a class="site-page" href="/python/"><i class="fa-fw fa fa-binoculars"></i><span> Python</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder-open" aria-hidden="true"></i><span> 面试宝典</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/interview/"><i class="fa-fw fa fa-file-text-o"></i><span> Java面试题</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 我的生活</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-picture-o"></i><span> Gallery</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">SpringBoot整合fastDFS</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-03-03 10:30:45"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-03-03</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-15 17:27:34"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-07-15</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/">Spring全家桶</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring-Boot2-2-2/">Spring Boot2.2.2</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">3.8k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 15 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/2020/03/03/Spring/Spring%20Boot%202.2.2/SpringBoot-fastDFS/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="fastDSF介绍"><a href="#fastDSF介绍" class="headerlink" title="fastDSF介绍"></a>fastDSF介绍</h1><p><code>FastDFS</code>是用c语言编写的一款开源的分布式文件系统，它是由淘宝资深架构师余庆编写并开源。<code>FastDFS</code>专为互联 网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标，使用<code>FastDFS</code>很容易搭建一套高性能的文件服务器集群提供文件上传、下载等服务。 </p>
<blockquote>
<p>为什么要使用fastDFS呢？ </p>
</blockquote>
<p>上边介绍的NFS、GFS都是通用的分布式文件系统，通用的分布式文件系统的优点的是开发体验好，但是系统复杂 </p>
<p>性高、性能一般，而专用的分布式文件系统虽然开发体验性差，但是系统复杂性低并且性能高。<code>fastDFS</code>非常适合存储图片等那些小文件，<code>fastDFS</code>不对文件进行分块，所以它就没有分块合并的开销，<code>fastDFS</code>网络通信采用 </p>
<p><code>socket</code>，通信速度很快。 </p>
<h1 id="fastDSF工作原理"><a href="#fastDSF工作原理" class="headerlink" title="fastDSF工作原理"></a>fastDSF工作原理</h1><h2 id="fastDSF架构"><a href="#fastDSF架构" class="headerlink" title="fastDSF架构"></a>fastDSF架构</h2><p><code>FastDFS</code>架构包括 <code>Tracker server</code>和<code>Storageserver</code>。客户端请求<code>Tracker server</code>进行文件上传、下载，通过<code>Tracker server</code>调度最终由<code>Storage server</code>完成文件上传和下载。 </p>
<p>如下图： </p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715134118.png" alt=""></p>
<h3 id="1）Tracker"><a href="#1）Tracker" class="headerlink" title="1）Tracker"></a>1）Tracker</h3><p><code>Tracker Server</code>作用是负载均衡和调度，通过<code>Tracker server</code>在文件上传时可以根据一些策略找到<code>Storage server</code>提 供文件上传服务。可以将<code>tracker</code>称为追踪服务器或调度服务器。<code>FastDFS</code>集群中的<code>Tracker server</code>可以有多台，<code>Tracker server</code>之间是相互平等关系同时提供服务，<code>Tracker server</code>不存在单点故障。客户端请求<code>Tracker server</code>采用轮询方式，如果请求的<code>tracker</code>无法提供服务则换另一个<code>tracker</code>。 </p>
<h3 id="2）Storage"><a href="#2）Storage" class="headerlink" title="2）Storage"></a>2）Storage</h3><p><code>Storage Server</code>作用是文件存储，客户端上传的文件最终存储在<code>Storage</code>服务器上，<code>Storage server</code>没有实现自己的文件系统而是使用操作系统的文件系统来管理文件。可以将<code>storage</code>称为存储服务器。<code>Storage</code>集群采用了分组存储方式。<code>storage</code>集群由一个或多个组构成，集群存储总容量为集群中所有组的存储容量之和。一个组由一台或多台存储服务器组成，组内的<code>Storage server</code>之间是平等关系，不同组的<code>Storage server</code>之间不会相互通信，同组内的<code>Storage server</code>之间会相互连接进行文件同步，从而保证同组内每个<code>storage</code>上的文件 完全一致的。一个组的存储容量为该组内的存储服务器容量最小的那个，由此可见组内存储服务器的软硬件配置最 好是一致的。采用分组存储方式的好处是灵活、可控性较强。比如上传文件时，可以由客户端直接指定上传到的组也可以由tracker进行调度选择。一个分组的存储服务器访问压力较大时，可以在该组增加存储服务器来扩充服务能力（纵向扩容）。当系统容量不足时，可以增加组来扩充存储容量（横向扩容）。 </p>
<h3 id="3）Storage状态收集"><a href="#3）Storage状态收集" class="headerlink" title="3）Storage状态收集"></a>3）Storage状态收集</h3><p><code>Storage server</code>会连接集群中所有的<code>Tracker server</code>，定时向他们报告自己的状态，包括磁盘剩余空间、文件同步状况、文件上传下载次数等统计信息。 </p>
<h2 id="文件上传流程"><a href="#文件上传流程" class="headerlink" title="文件上传流程"></a>文件上传流程</h2><p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715134119.png" alt=""></p>
<p>客户端上传文件后存储服务器将文件<code>ID</code>返回给客户端，此文件ID用于以后访问该文件的索引信息。文件索引信息 包括：组名，虚拟磁盘路径，数据两级目录，文件名。 </p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715134228.png" alt=""></p>
<ul>
<li><p>组名：文件上传后所在的<code>storage</code>组名称，在文件上传成功后有<code>storage</code>服务器返回，需要客户端自行保存。</p>
</li>
<li><p>虚拟磁盘路径：<code>storage</code>配置的虚拟路径，与磁盘选项<code>store_path*</code>对应。如果配置了<code>store_path0</code>则是M00，如果配置了<code>store_path1</code>则是M01，以此类推。 </p>
</li>
<li><p>数据两级目录：<code>storage</code>服务器在每个虚拟磁盘路径下创建的两级目录，用于存储数据文件。 </p>
</li>
<li><p>文件名：与文件上传时不同。是由存储服务器根据特定信息生成，文件名包含：源存储服务器IP地址、文件创 建时间戳、文件大小、随机数和文件拓展名等信息。</p>
</li>
</ul>
<h2 id="文件下载流程"><a href="#文件下载流程" class="headerlink" title="文件下载流程"></a>文件下载流程</h2><p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715134213.png" alt=""></p>
<p><code>tracker</code>根据请求的文件路径即文件<code>ID</code>来快速定义文件。 </p>
<p>比如请求下边的文件： </p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715134228.png" alt=""></p>
<p>1.通过组名<code>tracker</code>能够很快的定位到客户端需要访问的存储服务器组是<code>group1</code>，并选择合适的存储服务器提供客户端访问。 </p>
<p>2.存储服务器根据“文件存储虚拟磁盘路径”和“数据文件两级目录”可以很快定位到文件所在目录，并根据文件名找到客户端需要访问的文件。 </p>
<h1 id="fastDFS入门"><a href="#fastDFS入门" class="headerlink" title="fastDFS入门"></a>fastDFS入门</h1><h2 id="fastDFS安装与配置"><a href="#fastDFS安装与配置" class="headerlink" title="fastDFS安装与配置"></a>fastDFS安装与配置</h2><h3 id="FastDFS-安装环境"><a href="#FastDFS-安装环境" class="headerlink" title="FastDFS 安装环境"></a>FastDFS 安装环境</h3><p><code>FastDFS</code> 是 C 语言开发，建议在 <code>linux</code> 上运行，使用 <code>Centos7</code>作为安装环境。安装 <code>FastDFS</code> 需要先将官网下载的源码进行编译，编译依赖 <code>gcc</code> 环境，如果没有 <code>gcc</code> 环境，需要安装 <code>gcc</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc-c++</span><br><span class="line"></span><br><span class="line">yum install make</span><br></pre></td></tr></table></figure>

<h3 id="安装-libevent"><a href="#安装-libevent" class="headerlink" title="安装 libevent"></a>安装 <code>libevent</code></h3><p><code>FastDFS</code>依赖<code>libevent</code> 库，需要安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libevent</span><br></pre></td></tr></table></figure>

<h3 id="安装-libfastcommon"><a href="#安装-libfastcommon" class="headerlink" title="安装 libfastcommon"></a>安装 <code>libfastcommon</code></h3><p><code>libfastcommon</code> 是 <code>FastDFS</code>官方提供的，<code>libfastcommon</code>包含了<code>FastDFS</code>运行所需 要的一些基础库。没有去官网下载。</p>
<p>将<code>libfastcommonV1.0.7.tar.gz</code>拷贝至<code>/usr/local/fastDFS</code>下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;fastDFS</span><br><span class="line">tar -zxvf libfastcommonV1.0.7.tar.gz</span><br><span class="line">cd libfastcommon-1.0.7</span><br><span class="line">.&#x2F;make.sh </span><br><span class="line">.&#x2F;make.sh install</span><br></pre></td></tr></table></figure>

<p><strong>注意：<code>libfastcommon</code> 安装好后会自动将库文件拷贝至<code>/usr/lib64</code> 下，由于<code>FastDFS</code> 程序引用 <code>usr/lib</code>目录所以需要将<code>/usr/lib64</code> 下的库文件拷贝至<code>/usr/lib</code> 下。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;lib64&#x2F;libfastcommon.so &#x2F;usr&#x2F;lib</span><br></pre></td></tr></table></figure>

<h3 id="tracker-编译安装"><a href="#tracker-编译安装" class="headerlink" title="tracker 编译安装"></a>tracker 编译安装</h3><p>将 <code>FastDFS_v5.05.tar.gz</code> 拷贝至<code>/usr/local/fastDFS</code>下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;fastDFS</span><br><span class="line">tar -zxvf FastDFS_v5.05.tar.gz</span><br><span class="line">cd FastDFS</span><br><span class="line">.&#x2F;make.sh 编译</span><br><span class="line">.&#x2F;make.sh install 安装</span><br></pre></td></tr></table></figure>

<p>安装成功将安装目录下的 <code>conf</code> 下的文件拷贝到<code>/etc/fdfs/</code>下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd conf</span><br><span class="line">cp *.* &#x2F;etc&#x2F;fdfs</span><br></pre></td></tr></table></figure>

<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>安装成功后进入<code>/etc/fdfs</code> 目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r--. 1 root root 23981 7月  14 22:54 anti-steal.jpg</span><br><span class="line">-rw-r--r--. 1 root root  1455 7月  14 23:56 client.conf</span><br><span class="line">-rw-r--r--. 1 root root  1461 7月  14 22:54 client.conf.sample</span><br><span class="line">-rw-r--r--. 1 root root   858 7月  14 22:54 http.conf</span><br><span class="line">-rw-r--r--. 1 root root 31172 7月  14 22:54 mime.types</span><br><span class="line">-rw-r--r--. 1 root root     0 7月  14 23:54 storage</span><br><span class="line">-rw-r--r--. 1 root root  7825 7月  14 23:54 storage.conf</span><br><span class="line">-rw-r--r--. 1 root root  7829 7月  14 22:54 storage.conf.sample</span><br><span class="line">-rw-r--r--. 1 root root   105 7月  14 22:54 storage_ids.conf</span><br><span class="line">-rw-r--r--. 1 root root  7093 7月  14 23:53 tracker.conf</span><br><span class="line">-rw-r--r--. 1 root root  7102 7月  14 22:54 tracker.conf.sample</span><br></pre></td></tr></table></figure>

<p>拷贝一份新的<code>tracker</code>配置文件： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cp tracker.conf.sample tracker.conf </span><br><span class="line"># 修改 tracker.conf </span><br><span class="line">vim tracker.conf</span><br><span class="line"># base_path&#x3D;&#x2F;home&#x2F;yuqing&#x2F;FastDFS 改为：</span><br><span class="line">base_path&#x3D;&#x2F;home&#x2F;FastDFS</span><br><span class="line"># 配置 http 端口：</span><br><span class="line">http.server_port&#x3D;80</span><br></pre></td></tr></table></figure>

<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;fdfs_trackerd &#x2F;etc&#x2F;fdfs&#x2F;tracker.conf restart</span><br></pre></td></tr></table></figure>

<blockquote>
<p>执行可以会报文件(/home/FastDFS)不存在</p>
<p>创建文件 <code>mkdir -p  /home/FastDFS</code></p>
</blockquote>
<p>启动的日志显示先停止<code>5619</code> 进程（实际环境不是 5619）再启动，如下图：</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715161809.png" alt=""></p>
<p><strong>注意：</strong>如果没有显示上图要注意是否正常停止原有进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查到trackerd的进程</span><br><span class="line">ps aux|grep  trackerd </span><br><span class="line">#杀死进程</span><br><span class="line">kill -s 9 pid</span><br><span class="line">重新执行命令</span><br></pre></td></tr></table></figure>

<h3 id="FastDFS–storage-安装"><a href="#FastDFS–storage-安装" class="headerlink" title="FastDFS–storage 安装"></a>FastDFS–storage 安装</h3><p>在解压<code>FastDFS_v5.05.tar.gz</code>时一起安装了<code>FastDFS--storage</code>和 <code>tracker</code>,只需要配置就可以了</p>
<h4 id="配置-FastDFS–storage"><a href="#配置-FastDFS–storage" class="headerlink" title="配置 FastDFS–storage"></a>配置 FastDFS–storage</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 进入&#x2F;etc&#x2F;fdfs目录：</span><br><span class="line">cd &#x2F;etc&#x2F;fdfs</span><br><span class="line"># 拷贝一份新的 storage 配置文件：</span><br><span class="line">cp storage.conf.sample storage.conf</span><br><span class="line"># 修改 storage.conf</span><br><span class="line">vi storage.conf</span><br></pre></td></tr></table></figure>

<p>修改<code>storage.conf</code>具体内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">group_name&#x3D;group1</span><br><span class="line">base_path&#x3D;&#x2F;home&#x2F;yuqing&#x2F;FastDFS 改为：base_path&#x3D;&#x2F;home&#x2F;fastdfs</span><br><span class="line">store_path0&#x3D;&#x2F;home&#x2F;yuqing&#x2F;FastDFS 改为：store_path0&#x3D;&#x2F;home&#x2F;fastdfs&#x2F;fdfs_storage</span><br><span class="line">#如果有多个挂载磁盘则定义多个 store_path，如下</span><br><span class="line">#store_path1&#x3D;.....</span><br><span class="line">#store_path2&#x3D;......</span><br><span class="line">tracker_server&#x3D;192.168.40.142:22122 #配置 tracker 服务器:IP</span><br><span class="line">#如果有多个则配置多个 tracker</span><br><span class="line">tracker_server&#x3D;192.168.40.143:22122</span><br><span class="line">#配置 http 端口</span><br><span class="line">http.server_port&#x3D;80</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>:上面的<code>base_path</code>和<code>store_path0</code>文件夹一定要存在,否则会上传失败,亲生经历,所以写下来,提醒大家</p>
</blockquote>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;fdfs_storaged &#x2F;etc&#x2F;fdfs&#x2F;storage.conf restart</span><br></pre></td></tr></table></figure>

<p>启动的日志显示先停止 8931 进程（实际环境不是 8931）再启动，如下图：</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715162848.png" alt=""></p>
<p><strong>注意：</strong>如果没有显示上图要注意是否正常停止原有进程</p>
<h2 id="上传图片测试"><a href="#上传图片测试" class="headerlink" title="上传图片测试"></a>上传图片测试</h2><h3 id="通过-fdfs-test-程序"><a href="#通过-fdfs-test-程序" class="headerlink" title="通过 fdfs_test 程序"></a>通过 fdfs_test 程序</h3><p><code>FastDFS</code>安装成功可通过<code>/usr/bin/fdfs_test</code> 程序来测试上传、下载等操作。 </p>
<blockquote>
<p> 修改<code>/etc/fdfs/client.conf</code></p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">base_path&#x3D;&#x2F;home&#x2F;fastdfs</span><br><span class="line"># tracker_server 根据自己部署虚拟机的情况配置 。</span><br><span class="line">tracker_server&#x3D;192.168.40.142:22122</span><br><span class="line">tracker_server&#x3D;192.168.40.143:22122</span><br></pre></td></tr></table></figure>

<p>上传格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;fdfs_test 客户端配置文件地址 upload 上传文件</span><br></pre></td></tr></table></figure>

<p>比如将/home 下的图片上传到 FastDFS 中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;fdfs_test &#x2F;etc&#x2F;fdfs&#x2F;client.conf upload &#x2F;home&#x2F;Vue-logo-001.png</span><br></pre></td></tr></table></figure>

<blockquote>
<p>打印如下日志： 代表上传成功</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost FastDFS]# &#x2F;usr&#x2F;bin&#x2F;fdfs_test &#x2F;etc&#x2F;fdfs&#x2F;client.conf upload &#x2F;home&#x2F;vue-newsletter-logo.png </span><br><span class="line">This is FastDFS client test program v5.05</span><br><span class="line"></span><br><span class="line">Copyright (C) 2008, Happy Fish &#x2F; YuQing</span><br><span class="line"></span><br><span class="line">FastDFS may be copied only under the terms of the GNU General</span><br><span class="line">Public License V3, which may be found in the FastDFS source kit.</span><br><span class="line">Please visit the FastDFS Home Page http:&#x2F;&#x2F;www.csource.org&#x2F; </span><br><span class="line">for more detail.</span><br><span class="line"></span><br><span class="line">[2020-07-15 04:35:52] DEBUG - base_path&#x3D;&#x2F;home&#x2F;fastdfs, connect_timeout&#x3D;30, network_timeout&#x3D;60, tracker_server_count&#x3D;1, anti_steal_token&#x3D;0, anti_steal_secret_key length&#x3D;0, use_connection_pool&#x3D;0, g_connection_pool_max_idle_time&#x3D;3600s, use_storage_id&#x3D;0, storage server id count: 0</span><br><span class="line"></span><br><span class="line">tracker_query_storage_store_list_without_group: </span><br><span class="line">	server 1. group_name&#x3D;, ip_addr&#x3D;192.168.40.142, port&#x3D;23000</span><br><span class="line"></span><br><span class="line">group_name&#x3D;group1, ip_addr&#x3D;192.168.40.142, port&#x3D;23000</span><br><span class="line">storage_upload_by_filename</span><br><span class="line">group_name&#x3D;group1, remote_filename&#x3D;M00&#x2F;00&#x2F;00&#x2F;wKgojl8Ov-iAMZvQAAB2OGvQkY4351.png</span><br><span class="line">source ip address: 192.168.40.142</span><br><span class="line">file timestamp&#x3D;2020-07-15 04:35:52</span><br><span class="line">file size&#x3D;30264</span><br><span class="line">file crc32&#x3D;1808830862</span><br><span class="line">example file url: http:&#x2F;&#x2F;192.168.40.142&#x2F;group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKgojl8Ov-iAMZvQAAB2OGvQkY4351.png</span><br><span class="line">storage_upload_slave_by_filename</span><br><span class="line">group_name&#x3D;group1, remote_filename&#x3D;M00&#x2F;00&#x2F;00&#x2F;wKgojl8Ov-iAMZvQAAB2OGvQkY4351_big.png</span><br><span class="line">source ip address: 192.168.40.142</span><br><span class="line">file timestamp&#x3D;2020-07-15 04:35:52</span><br><span class="line">file size&#x3D;30264</span><br><span class="line">file crc32&#x3D;1808830862</span><br><span class="line">example file url: http:&#x2F;&#x2F;192.168.40.142&#x2F;group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKgojl8Ov-iAMZvQAAB2OGvQkY4351_big.png</span><br></pre></td></tr></table></figure>

<p><strong>重点</strong>: <code>http://192.168.40.142/group1/M00/00/00/wKgojl8Ov-iAMZvQAAB2OGvQkY4351.png</code> 就是文件的下载路径。对应 <code>storage</code> 服务器上的 <code>/home/fastdfs/fdfs_storage/data/00/00/wKgojl8Ov-iAMZvQAAB2OGvQkY4351.png</code>文件。由于现在还没有和<code>nginx</code> 整合无法使用 <code>http</code>下载。 </p>
<h2 id="FastDFS-和-nginx-整合"><a href="#FastDFS-和-nginx-整合" class="headerlink" title="FastDFS 和 nginx 整合"></a>FastDFS 和 nginx 整合</h2><h3 id="nginx-代理"><a href="#nginx-代理" class="headerlink" title="nginx 代理"></a>nginx 代理</h3><p>单独安装<code>nginx</code> 代理服务，它的作用是代理访问 <code>storage</code>上的文件，实现负载均衡。<code>nginx</code> 的安装细节参考 <code>nginx</code> 文档，这里使用单机 <code>nginx</code>，也可以使用两台 <code>nginx</code>组成高可用或者采用<code>lvs+nginx</code>访问 <code>Storage</code> 上的<code>nginx</code>。 </p>
<h3 id="在-Storage-上安装-nginx"><a href="#在-Storage-上安装-nginx" class="headerlink" title="在 Storage 上安装 nginx"></a>在 Storage 上安装 nginx</h3><p> 在 <code>storage server</code> 上安装<code>nginx</code> 的目的是对外通过 http 访问<code>storage server</code> 上的文件。使用<code>nginx</code> 的模块<code>FastDFS-nginx-module</code> 的作用是通过 http 方式访问 <code>storage</code> 中的文件，当 storage 本机没有要找的文件时向源 <code>storage</code> 主机代理请求文件。 </p>
<h4 id="FastDFS-nginx-module"><a href="#FastDFS-nginx-module" class="headerlink" title="FastDFS-nginx-module"></a>FastDFS-nginx-module</h4><p>将<code>FastDFS-nginx-module_v1.16.tar.gz</code>传 至 <code>fastDFS</code> 的 <code>storage</code> 服 务 器 的<code>/usr/local/</code>下，执行如下命令： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 进入目录</span><br><span class="line">cd &#x2F;usr&#x2F;local</span><br><span class="line"># 解压</span><br><span class="line">tar -zxvf FastDFS-nginx-module_v1.16.tar.gz</span><br><span class="line"># 进入FastDFS-nginx-module&#x2F;src目录</span><br><span class="line">cd FastDFS-nginx-module&#x2F;src</span><br></pre></td></tr></table></figure>

<p>修改<code>config</code> 文件将<code>/usr/local/</code>路径改为<code>/usr/</code>,3处地方需要修改</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715164443.png" alt=""></p>
<p>将 <code>FastDFS-nginx-module/src</code> 下的<code>mod_fastdfs.conf</code>拷贝至<code>/etc/fdfs/</code>下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp mod_fastdfs.conf &#x2F;etc&#x2F;fdfs&#x2F;</span><br></pre></td></tr></table></figure>

<p>并修改 mod_fastdfs.conf 的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;fdfs&#x2F;mod_fastdfs.conf</span><br></pre></td></tr></table></figure>

<p>修改的具体内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">base_path&#x3D;&#x2F;home&#x2F;FastDFS</span><br><span class="line">tracker_server&#x3D;192.168.40.142:22122</span><br><span class="line">tracker_server&#x3D;192.168.40.143:22122</span><br><span class="line">url_have_group_name&#x3D;true #url 中包含 group 名称</span><br><span class="line">store_path0&#x3D;&#x2F;home&#x2F;fastdfs&#x2F;fdfs_storage #指定文件存储路径</span><br><span class="line">#如果有多个</span><br></pre></td></tr></table></figure>

<p>将 <code>libfdfsclient.so</code>拷贝至<code>/usr/lib</code> 下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;lib64&#x2F;libfdfsclient.so &#x2F;usr&#x2F;lib&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="nginx-安装"><a href="#nginx-安装" class="headerlink" title="nginx 安装"></a>nginx 安装</h4><ol>
<li><p>将 <a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">nginx-1.8.0.tar.gz</a>拷贝到<code>/usr/local</code>下</p>
</li>
<li><p>解压 nginx-1.8.0.tar.gz</p>
</li>
<li><p>进入<code>nginx-1.8.0</code>目录 使用 <code>configure</code> 命令创建 <code>makeFile</code> 文件。最后一条命令表示添加 <code>FastDFS-nginx-module</code> 模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure \</span><br><span class="line">--prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx \</span><br><span class="line">--pid-path&#x3D;&#x2F;var&#x2F;run&#x2F;nginx&#x2F;nginx.pid \</span><br><span class="line">--lock-path&#x3D;&#x2F;var&#x2F;lock&#x2F;nginx.lock \</span><br><span class="line">--error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log \</span><br><span class="line">--http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--http-client-body-temp-path&#x3D;&#x2F;var&#x2F;temp&#x2F;nginx&#x2F;client \</span><br><span class="line">--http-proxy-temp-path&#x3D;&#x2F;var&#x2F;temp&#x2F;nginx&#x2F;proxy \</span><br><span class="line">--http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;temp&#x2F;nginx&#x2F;fastcgi \</span><br><span class="line">--http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;temp&#x2F;nginx&#x2F;uwsgi \</span><br><span class="line">--http-scgi-temp-path&#x3D;&#x2F;var&#x2F;temp&#x2F;nginx&#x2F;scgi \</span><br><span class="line">--add-module&#x3D;&#x2F;usr&#x2F;local&#x2F;fastdfs-nginx-module&#x2F;src</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在配置信息的时候，出现了一下错误：</p>
<p>错误为：<code>./configure: error: the HTTP rewrite module requires the PCRE library.</code></p>
</blockquote>
</li>
</ol>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715171106.png" alt=""></p>
<blockquote>
<p> 安装<code>pcre-devel</code>解决问题</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install pcre-devel</span><br></pre></td></tr></table></figure>

<p>还有可能出现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">错误提示：.&#x2F;configure: error: the HTTP cache module requires md5 functions</span><br><span class="line">from OpenSSL library.   You can either disable the module by using</span><br><span class="line">--without-http-cache option, or install the OpenSSL library into the system,</span><br><span class="line">or build the OpenSSL library statically from the source with nginx by using</span><br><span class="line">--with-http_ssl_module --with-openssl&#x3D;&lt;path&gt; options.</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 解决办法：<code>yum -y install openssl openssl-devel</code></p>
</blockquote>
<p>安装后在linux下启动和关闭nginx：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep nginx</span><br><span class="line">kill nginx的进程ID</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>执行后可以看到<code>Makefile</code>文件,</li>
<li>执行<code>make</code>编译命令,如果没有,需要下载<code>yum install make</code></li>
</ol>
<blockquote>
<p>在执行make命令时出现错误:</p>
<p>src/os/unix/ngx_user.c: 在函数‘ngx_libc_crypt’中: src/os/unix/ngx_user.c:36:7: </p>
</blockquote>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715170257.png" alt=""></p>
<p>此处说明运行<code>make</code>时 其编译的函数发生措错误，查阅了网上大量资料发现均是说把 <code>objs/Makefile</code>文件中的<code>-werror</code>删除，可是发现其实根本没用。最后在放弃前一刻 想了一下是不是源代码的问题。 果然在源代码目录<strong>/nginx-1.12.2/src/os/unix/</strong>中修改<code>ngx_user.c</code> 文件,问题得到了解决</p>
<blockquote>
<p><strong>解决:</strong></p>
</blockquote>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715170100.png" alt=""></p>
<p>将对应的<code>makefile</code>文件夹中（如本文中在 <code>/nginx-1.12.2/objs/Makefile</code>） 找到<code>-Werrori</code>并去掉 在重新 回到<code>nginx</code>主目录 make即可</p>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715165726.png" alt=""></p>
<ol start="6">
<li>执行<code>make install</code>安装</li>
</ol>
<p><strong>注意：</strong>启动<code>nginx</code> 之前，上边将临时文件目录指定为<code>/var/temp/nginx/client</code>， 需要在<code>/var</code> 下创建此 目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;var&#x2F;temp&#x2F;nginx&#x2F;client</span><br></pre></td></tr></table></figure>

<h4 id="nginx-配置文件"><a href="#nginx-配置文件" class="headerlink" title="nginx 配置文件"></a>nginx 配置文件</h4><p>进入到<code>nginx</code>目录下的<code>conf</code>目录,执行编译–&gt;安装命令后会在<code>/usr/local</code>目录生成</p>
<blockquote>
<p>为什么会在/usr/local目录中?</p>
<p>因为在安装nginx时执行使用 <code>configure</code> 命令创建 <code>makeFile</code> 文件时指定了<code>--prefix=/usr/local/nginx \</code>,所以会在<code>/usr/local</code>目录下生成</p>
</blockquote>
<p><img src="http://cdn.panyucable.cn/zysheep/QQ%E6%88%AA%E5%9B%BE20200715171628.png" alt=""></p>
<p>进入<code>conf</code>目录,修改<code>nginx.conf</code>文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.conf</span><br></pre></td></tr></table></figure>

<p>添加虚拟主机:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"> listen 80;</span><br><span class="line"> server_name 192.168.40.142;</span><br><span class="line"> location &#x2F;group1&#x2F;M00&#x2F;&#123;</span><br><span class="line"> root &#x2F;home&#x2F;FastDFS&#x2F;fdfs_storage&#x2F;data;</span><br><span class="line"> ngx_fastdfs_module;</span><br><span class="line"> &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明： </p>
<ul>
<li>server_name 指定本机 ip </li>
<li>location /group1/M00/：<code>group1</code> 为 nginx 服务 <code>FastDFS</code> 的分组名称,<code>M00</code>是FastDFS 自动生成编号，对应 <code>store_path0=/home/FastDFS/fdfs_storage</code>，如果FastDFS 定义store_path1，这里就是 M01 </li>
</ul>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>使用浏览器<code>http</code> 访问文件，这里访问上传图片测试的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.40.142&#x2F;group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKgojl8Ov-iAMZvQAAB2OGvQkY4351.png</span><br></pre></td></tr></table></figure>

<p>有多台<code>storage</code>服务器的话,<code>ip</code> 地址改为 <code>192.168.40.143</code> 也可以访问到文件，因为同一个分组的 <code>storage</code>文件互相同步。前提是<code>192.168.40.143</code>必须安装<code>storage</code>服务器</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">三月三</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zysheep.cn/2020/03/03/Spring/Spring%20Boot%202.2.2/SpringBoot-fastDFS/">https://zysheep.cn/2020/03/03/Spring/Spring Boot 2.2.2/SpringBoot-fastDFS/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zysheep.cn" target="_blank">三月三</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring/">Spring</a><a class="post-meta__tags" href="/tags/Spring-Boot2-2-2/">Spring Boot2.2.2</a></div><div class="post_share"><div class="social-share" data-image="http://cdn.panyucable.cn/zysheep/2010x1125.jfif" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/zysheep/picgo-imgs/imgwechat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="https://cdn.jsdelivr.net/gh/zysheep/picgo-imgs/imgalipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/03/03/Spring/Spring%20Boot%202.2.2/SpringBoot-mail-task/"><img class="prev_cover" src="http://cdn.panyucable.cn/zysheep/springboot_cover_email.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringBoot整合邮件任务</div></div></a></div><div class="next-post pull_right"><a href="/2020/03/03/Spring/Spring%20Boot%202.2.2/SpringBoot-fileupload/"><img class="next_cover" src="http://cdn.panyucable.cn/zysheep/springboot_cover_fastDFS.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringBoot文件上传</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/08/Spring/SpringBoot后端接口规范/" title="SpringBoot后端接口规范"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/spring-framework-logo.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-08</div><div class="relatedPosts_title">SpringBoot后端接口规范</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/01/Spring/Spring Boot 2.2.2/SpringBoot-h2/" title="SpringBoot整合H2"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/1652x1101.jfif"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-01</div><div class="relatedPosts_title">SpringBoot整合H2</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/05/Spring/Spring Boot 2.2.2/SpringBoot与nacos/" title="Spring Boot与Nacos"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/springboot_cover_nacos.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-05</div><div class="relatedPosts_title">Spring Boot与Nacos</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/03/Spring/Spring Boot 2.2.2/SpringBoot-Jpa/" title="SpringBoot整合JPA"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/springboot_cover_JPA_1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-03</div><div class="relatedPosts_title">SpringBoot整合JPA</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/03/Spring/Spring Boot 2.2.2/SpringBoot-MongoDB/" title="SpringBoot整合MongDB"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/springboot_cover_mongodb.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-03</div><div class="relatedPosts_title">SpringBoot整合MongDB</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/03/Spring/Spring Boot 2.2.2/SpringBoot-Mybatis-xml/" title="SpringBoot整合Mybatis-XML版"><img class="relatedPosts_cover" src="http://cdn.panyucable.cn/zysheep/springboot_cover_mybaits.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-03</div><div class="relatedPosts_title">SpringBoot整合Mybatis-XML版</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '502b8308721b081071a5',
  clientSecret: '35220d15c7f8aaf585d6822cf5d49fedf5b602d6',
  repo: 'blog-comment',
  owner: 'zysheep',
  admin: ['zysheep'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" style="background-image: url(http://cdn.panyucable.cn/zysheep/springboot_top_fastDFS.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By 三月三</div><div class="footer_custom_text">生活不只是眼前的苟且,还有诗和远方</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/third-party/click_heart.js"></script><script src="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/js/hideCategory.min.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script></body></html>